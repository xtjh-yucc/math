<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™®æ™®é¢¨è¦ªå¸«è¯çµ¡ç°¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ QR Code ç”Ÿæˆå‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <!-- å¼•å…¥ jsPDF ç”¨æ–¼ç”Ÿæˆ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- å¼•å…¥ html2canvas ç”¨æ–¼ä¸­æ–‡æ”¯æ´ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- æ™®æ™®è—è¡“é¢¨æ ¼ CSS --- */
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            /* å‹•æ…‹çš„æ™®æ™®è—è¡“èƒŒæ™¯ */
            background: linear-gradient(-45deg, #ff6b6b, #feca57, #4ecdc4, #54a0ff, #ff9ff3);
            background-size: 400% 400%;
            animation: popArtBackground 15s ease infinite;
        }
        
        @keyframes popArtBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* æ™®æ™®è—è¡“æ¨™é¡Œ */
        .pop-title {
            font-weight: 900;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 
                3px 3px 0 #000,
                -1px -1px 0 #000,  
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000;
            letter-spacing: 2px;
        }
        
        /* æ™®æ™®è—è¡“æŒ‰éˆ• */
        .pop-button {
            background-color: #feca57; /* äº®é»ƒè‰² */
            color: #000;
            border: 3px solid #000;
            font-weight: 700;
            border-radius: 12px;
            box-shadow: 5px 5px 0px #000;
            transition: all 0.15s ease-out;
            transform: translate(0, 0);
        }
        .pop-button:hover {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px #000;
        }
        .pop-button:active {
            transform: translate(5px, 5px);
            box-shadow: 0px 0px 0px #000;
        }
        .pop-button-secondary {
            background-color: #4ecdc4; /* é’è‰² */
        }
        .pop-button-danger {
            background-color: #ff6b6b; /* ç´…è‰² */
        }
        
        /* æ™®æ™®è—è¡“å¡ç‰‡/å®¹å™¨ */
        .pop-card {
            background-color: #fff;
            border: 4px solid #000;
            border-radius: 16px;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.8);
            position: relative;
        }

        /* æ™®æ™®è—è¡“ Modal */
        .pop-modal-content {
            background-color: #fff;
            border: 4px solid #000;
            border-radius: 0px; /* å°–è§’ */
            box-shadow: 10px 10px 0px #ff6b6b;
            position: relative;
        }

        /* åŠè‰²èª¿ç¶²é»èƒŒæ™¯æ•ˆæœ */
        .halftone-bg {
            background-color: #f0f9ff;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,107,107,0.5) 2px, transparent 0),
                radial-gradient(circle at 75% 75%, rgba(78,205,196,0.5) 2px, transparent 0);
            background-size: 20px 20px;
        }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .pop-input, .pop-select {
            border: 3px solid #000;
            border-radius: 8px;
            padding: 10px;
            font-weight: 700;
            background-color: #fff;
            box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1);
        }
        .pop-input:focus, .pop-select:focus {
            outline: none;
            box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1), 0 0 0 3px #feca57;
        }
        
        /* å°è©±åˆ—è¡¨é …ç›® */
        .parent-list-item.selected-parent {
            background-color: #feca57 !important;
            border: 3px solid #000 !important;
            box-shadow: 4px 4px 0px #ff6b6b !important;
            transform: translate(-2px, -2px);
        }
        
        /* æ¼«ç•«é¢¨æ ¼å°è©±æ³¡æ³¡ */
        .speech-bubble {
            position: relative;
            background: #fff;
            border: 3px solid #000;
            border-radius: 20px;
            padding: 10px 15px;
            filter: drop-shadow(3px 3px 0px rgba(0,0,0,0.7));
        }
        .speech-bubble.is-me {
            background: #4ecdc4; /* é’è‰² */
        }
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border: 15px solid transparent;
            border-top-color: #000;
            border-bottom: 0;
            margin-bottom: -15px;
        }
        .speech-bubble.is-me:after {
            right: 20px;
            border-left-color: #000;
        }
        .speech-bubble.is-other:after {
            left: 20px;
            border-right-color: #000;
        }
        
        /* æ²è»¸æ¨£å¼ */
        .message-container::-webkit-scrollbar { width: 12px; }
        .message-container::-webkit-scrollbar-track { background: #feca57; border-left: 3px solid #000; }
        .message-container::-webkit-scrollbar-thumb { background: #ff6b6b; border: 3px solid #000; border-radius: 0;}
        
        /* æŒ‡å— Modal æ¨£å¼ */
        .instruction-content h3 { 
            font-size: 1.5rem; 
            font-weight: 900; 
            margin-bottom: 0.5rem; 
            border-bottom: 4px solid #ff6b6b; 
            padding-bottom: 0.5rem; 
            color: #000;
            text-transform: uppercase;
        }
        .instruction-content a { color: #ff6b6b; font-weight: bold; border-bottom: 2px solid #ff6b6b; }
        .instruction-content code { 
            background: #feca57; 
            padding: 0.2rem 0.4rem; 
            border: 2px solid #000; 
            font-weight: bold;
        }
        .instruction-content pre { 
            background: #4ecdc4; 
            padding: 0.75rem; 
            border: 3px solid #000; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-weight: bold;
        }
        #qrcode-container img { margin: auto; border: 4px solid #000; box-shadow: 4px 4px 0px #ff6b6b; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app-container" class="flex-grow overflow-hidden">

        <!-- 1. åˆå§‹é€²å…¥ç•«é¢ -->
        <div id="entry-view" class="h-full">
            <div class="min-h-full flex flex-col items-center justify-center p-4">
                <div class="text-center mb-10">
                    <h1 class="text-5xl md:text-6xl pop-title mb-4">æ™®æ™®é¢¨è¦ªå¸«è¯çµ¡ç°¿</h1>
                    <p class="text-black text-lg font-bold bg-white/50 px-4 py-1 rounded">è®“æºé€šæ›´ç°¡å–®ã€æ›´æœ‰è¶£ âœ¨</p>
                </div>
                <div class="space-y-6 w-full max-w-xs mt-8">
                    <button id="teacher-entry-btn" class="w-full pop-button text-xl px-6 py-4 text-center">
                        ğŸ æ•™å¸«é€²å…¥
                    </button>
                    <button id="show-parent-link-btn" class="w-full pop-button pop-button-secondary text-xl px-6 py-4 text-center">
                        ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç”¢ç”Ÿå®¶é•·é€£çµ
                    </button>
                </div>
                <div class="text-center mt-12">
                    <button id="show-instructions-btn" class="text-sm font-bold text-black bg-white/70 px-4 py-2 rounded-lg border-2 border-black hover:bg-white">
                        âš™ï¸ å¦‚ä½•è¨­å®šï¼Ÿ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 2. å®¶é•·ç™»å…¥ç•«é¢ -->
        <div id="parent-login-view" class="hidden h-full">
            <div class="min-h-full flex items-center justify-center p-4">
                <div class="max-w-md w-full space-y-8 pop-card p-8">
                    <div class="text-center">
                        <h2 class="mt-6 text-4xl pop-title text-black" style="text-shadow: 2px 2px 0 #ff6b6b;">
                            å®¶é•·ç™»å…¥
                        </h2>
                        <p class="mt-3 text-black font-bold">è«‹é¸æ“‡å­¸ç”Ÿä¸¦è¼¸å…¥å¯†ç¢¼ ğŸ”</p>
                    </div>
                    <form id="parent-login-form" class="mt-8 space-y-6">
                        <div class="space-y-4">
                            <select id="student-select" required class="w-full pop-select">
                                <option value="">ğŸ“š è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨ä¸­...</option>
                            </select>
                            <input id="password" type="password" required class="w-full pop-input" placeholder="ğŸ”‘ è«‹è¼¸å…¥å¯†ç¢¼">
                        </div>
                        <p id="login-error" class="text-red-500 text-sm text-center font-bold"></p>
                        <button type="submit" class="w-full pop-button text-lg py-4 px-6">
                            âœ¨ ç™»å…¥
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 3. æ•™å¸«ç«¯ä¸»ç•«é¢ -->
        <div id="teacher-view" class="hidden h-full flex flex-col">
            <!-- æ‰‹æ©Ÿç‰ˆæ¨™é ­ -->
            <div class="p-3 bg-black text-white shadow-lg flex-shrink-0 md:hidden">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold">ğŸ æ•™å¸«å¾Œå°</h1>
                    <button id="teacher-logout-btn-mobile" class="pop-button pop-button-danger text-sm py-1 px-3">ç™»å‡º</button>
                </div>
                <div class="flex gap-2 mt-3">
                    <button id="manage-parents-btn-mobile" class="flex-1 pop-button pop-button-secondary py-2 px-3 text-sm">
                        ğŸ‘¥ ç®¡ç†
                    </button>
                    <button id="broadcast-btn-mobile" class="flex-1 pop-button py-2 px-3 text-sm">
                        ğŸ“¢ ç¾¤æ’­
                    </button>
                </div>
            </div>

            <div class="flex-grow md:flex md:flex-row overflow-hidden">
                <div id="mobile-panels-container" class="h-full w-full md:contents relative">
                    <!-- å°è©±åˆ—è¡¨é¢æ¿ -->
                    <div id="parent-list-panel-mobile" class="absolute inset-0 md:relative md:w-1/3 bg-white border-r-4 border-black flex flex-col transition-transform duration-300 ease-in-out z-10">
                        <!-- PCç‰ˆæ¨™é ­ -->
                        <div class="hidden md:block p-4 border-b-4 border-black">
                            <h1 class="text-3xl pop-title text-black" style="text-shadow: 2px 2px 0 #4ecdc4;">
                                æ•™å¸«å¾Œå°
                            </h1>
                            <div class="flex gap-3 mt-4">
                                <button id="manage-parents-btn" class="flex-1 pop-button pop-button-secondary py-3 px-4">
                                    ğŸ‘¥ å®¶é•·ç®¡ç†
                                </button>
                                <button id="broadcast-btn" class="flex-1 pop-button py-3 px-4">
                                    ğŸ“¢ ç¾¤æ’­è¨Šæ¯
                                </button>
                            </div>
                        </div>
                        <!-- å®¶é•·åˆ—è¡¨ -->
                        <div class="flex-grow overflow-y-auto p-3">
                            <h3 class="text-lg font-black p-2 uppercase">ğŸ’¬ å°è©±åˆ—è¡¨</h3>
                            <div id="parent-list-container" class="space-y-2"></div>
                        </div>
                        <div class="hidden md:block p-4 border-t-4 border-black">
                            <button id="teacher-logout-btn" class="w-full pop-button pop-button-danger py-3 px-4">ğŸ‘‹ ç™»å‡º</button>
                        </div>
                    </div>

                    <!-- èŠå¤©é¢æ¿ -->
                    <div id="chat-panel-mobile" class="absolute inset-0 md:relative md:w-2/3 halftone-bg flex flex-col transition-transform duration-300 ease-in-out transform translate-x-full md:translate-x-0 z-20">
                        <!-- èŠå¤©æ¨™é ­ -->
                        <div class="bg-black shadow-lg flex-shrink-0">
                            <div class="p-3 flex items-center text-white">
                                <button id="back-to-list-btn" class="md:hidden mr-3 font-bold text-2xl hover:text-yellow-300">
                                    â€¹
                                </button>
                                <h2 id="chat-with-name" class="text-lg font-bold flex-grow">
                                    <span>é¸æ“‡å®¶é•·é–‹å§‹å°è©±</span>
                                </h2>
                                <div id="export-chat-controls" class="hidden ml-3">
                                    <button id="export-chat-btn" class="pop-button pop-button-secondary text-sm py-1 px-3" title="åŒ¯å‡ºå°è©±è¨˜éŒ„">
                                        åŒ¯å‡º
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- æ‰‹æ©Ÿç‰ˆè¨Šæ¯è¼¸å…¥å€ -->
                        <div id="message-input-area" class="hidden md:hidden bg-white border-b-4 border-black flex-shrink-0">
                            <div class="p-2">
                                <form id="message-form" class="flex items-center bg-white rounded-lg p-1 border-2 border-black">
                                    <input id="teacher-image-upload" type="file" accept="image/*" class="hidden">
                                    <button id="teacher-image-btn" type="button" title="ğŸ“¸" class="p-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    </button>
                                    <button id="teacher-url-btn" type="button" title="ğŸ”—" class="p-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                                    </button>
                                    <textarea id="message-input" class="flex-grow border-0 bg-transparent p-2 focus:outline-none resize-none font-bold" placeholder="è¼¸å…¥..." rows="1" style="min-height: 44px; max-height: 120px;"></textarea>
                                    <button type="submit" class="pop-button px-3 py-2 text-sm">ğŸ“¤</button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- æ­¡è¿ç•«é¢ -->
                        <div id="chat-welcome" class="flex items-center justify-center flex-grow p-4">
                            <div class="text-center p-8 pop-card">
                                <div class="text-6xl mb-4 animate-bounce">ğŸ’­</div>
                                <p class="font-bold text-lg">å¾å·¦é‚Šåˆ—è¡¨é¸æ“‡å®¶é•·</p>
                                <p class="text-sm mt-2 uppercase font-bold">Select a parent to start</p>
                            </div>
                        </div>
                        
                        <!-- èŠå¤©è¨Šæ¯å€åŸŸ -->
                        <div id="chat-window" class="hidden flex-1 flex flex-col overflow-hidden min-h-0">
                            <!-- PCç‰ˆç™¼é€å€åŸŸ -->
                            <div id="pc-message-input-container" class="hidden md:block bg-white border-t-4 border-black flex-shrink-0">
                                <div class="p-3">
                                    <form id="pc-message-form" class="flex items-center bg-white rounded-lg p-2 border-2 border-black">
                                        <input id="pc-teacher-image-upload" type="file" accept="image/*" class="hidden">
                                        <button id="pc-teacher-image-btn" type="button" title="ğŸ“¸ å‚³é€åœ–ç‰‡" class="p-2 text-black hover:text-blue-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                        </button>
                                        <button id="pc-teacher-url-btn" type="button" title="ğŸ”— å‚³é€ç¶²å€" class="p-2 text-black hover:text-blue-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                                        </button>
                                        <textarea id="pc-message-input" class="flex-grow border-0 bg-transparent p-2 focus:outline-none resize-none font-bold" placeholder="è¼¸å…¥è¨Šæ¯..." rows="1" style="min-height: 44px; max-height: 120px;"></textarea>
                                        <button type="submit" class="pop-button px-5 py-2">ç™¼é€</button>
                                    </form>
                                </div>
                            </div>
                            <div id="message-container" class="flex-grow p-4 overflow-y-auto message-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 4. å®¶é•·ç«¯ä¸»ç•«é¢ -->
        <div id="parent-view" class="hidden h-full flex flex-col halftone-bg">
            <div class="p-3 bg-black shadow-lg flex justify-between items-center text-white flex-shrink-0">
                <h1 id="parent-welcome-msg" class="text-lg font-bold">èˆ‡æ•™å¸«çš„å°è©±</h1>
                <button id="parent-logout-btn" class="pop-button pop-button-danger py-2 px-4">ç™»å‡º</button>
            </div>
            <!-- [MODIFIED] Parent message form moved here -->
            <div class="p-2 bg-white border-b-4 border-black flex-shrink-0">
                <form id="parent-message-form" class="flex items-center bg-white rounded-lg p-1 border-2 border-black">
                    <input id="parent-image-upload" type="file" accept="image/*" class="hidden">
                     <button id="parent-image-btn" type="button" title="ğŸ“¸" class="p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    </button>
                    <button id="parent-url-btn" type="button" title="ğŸ”—" class="p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                    </button>
                    <textarea id="parent-message-input" class="flex-grow border-0 bg-transparent p-2 focus:outline-none resize-none font-bold" placeholder="è¼¸å…¥è¨Šæ¯..." rows="1" style="min-height: 44px; max-height: 120px;"></textarea>
                    <button type="submit" class="pop-button px-4 py-2">ç™¼é€</button>
                </form>
            </div>
            <div id="parent-message-container" class="flex-grow p-4 overflow-y-auto message-container"></div>
        </div>

        <!-- Modals -->
        <div id="parent-management-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm h-full w-full flex items-center justify-center z-40 p-4">
            <div class="relative mx-auto w-full max-w-2xl max-h-[90vh] flex flex-col pop-modal-content">
                 <div class="p-4 flex-shrink-0 bg-black text-white flex justify-between items-center">
                    <h2 class="text-2xl font-black uppercase">å®¶é•·å¸³è™Ÿç®¡ç†</h2>
                    <button id="close-parent-management-btn" class="text-white hover:text-yellow-300 text-4xl font-bold">&times;</button>
                 </div>
                 <div class="flex-grow overflow-y-auto p-6 halftone-bg">
                    <form id="add-parent-form" class="space-y-4 p-6 border-4 border-black mb-6 bg-white">
                        <h3 class="font-black text-lg uppercase">â• å–®ç­†æ–°å¢</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="student-name" placeholder="å­¸ç”Ÿå§“å" required class="w-full pop-input">
                            <input type="text" id="parent-name" placeholder="å®¶é•·å§“å" required class="w-full pop-input">
                            <input type="text" id="parent-password" placeholder="ç™»å…¥å¯†ç¢¼(ç´”æ•¸å­—)" required pattern="[0-9]*" class="w-full pop-input">
                        </div>
                        <button type="submit" class="w-full md:w-auto pop-button py-3 px-6">âœ¨ å»ºç«‹å–®ç­†å¸³è™Ÿ</button>
                    </form>
                    <div class="p-6 border-4 border-black mb-6 bg-white">
                        <h3 class="font-black text-lg uppercase mb-3">ğŸ“‹ æ‰¹æ¬¡åŒ¯å…¥</h3>
                        <textarea id="bulk-import-data" rows="5" class="w-full mt-2 pop-input" placeholder="ğŸ“ è²¼ä¸Šå¤šç­†è³‡æ–™ï¼Œæ¯è¡Œä¸€ç­†ï¼Œæ ¼å¼ç‚ºï¼š&#10;å­¸ç”Ÿå§“å,å®¶é•·å§“å,å¯†ç¢¼&#10;å­¸ç”Ÿå§“å2,å®¶é•·å§“å2,å¯†ç¢¼2"></textarea>
                        <button id="bulk-import-btn" class="w-full md:w-auto mt-3 pop-button pop-button-secondary py-3 px-6">ğŸš€ åŒ¯å…¥å¤šç­†å¸³è™Ÿ</button>
                        <div id="bulk-import-status" class="mt-3 text-sm font-bold"></div>
                    </div>
                    <div class="p-6 border-4 border-black mb-6 bg-white">
                        <h3 class="font-black text-lg uppercase mb-3">ğŸ’¾ åŒ¯å‡ºåŠŸèƒ½</h3>
                        <div class="flex flex-col md:flex-row gap-3">
                            <button id="export-pdf-btn" class="flex-1 pop-button pop-button-secondary py-3 px-6">ğŸ“ åŒ¯å‡ºå®¶é•·å¯†ç¢¼ PDF</button>
                            <button id="fix-old-accounts-btn" class="flex-1 pop-button py-3 px-6">ğŸ”§ ä¿®å¾©èˆŠå¸³è™Ÿå¯†ç¢¼</button>
                        </div>
                        <div id="export-status" class="mt-3 text-sm font-bold"></div>
                        <div id="fix-status" class="mt-3 text-sm font-bold"></div>
                    </div>
                    <div class="p-6 border-4 border-dashed border-red-500 bg-red-100">
                        <h3 class="font-black text-lg uppercase text-red-700 mb-3">âš ï¸ å±éšªå€åŸŸ</h3>
                        <p class="text-sm text-red-600 mb-3 font-bold">æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…ä½¿ç”¨ã€‚</p>
                        <button id="delete-all-images-btn" class="w-full md:w-auto pop-button pop-button-danger py-3 px-6">ğŸ—‘ï¸ åˆªé™¤æ‰€æœ‰åœ–ç‰‡</button>
                    </div>
                 </div>
            </div>
        </div>
        <div id="parent-link-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm h-full w-full flex items-center justify-center z-40 p-4">
            <div class="relative mx-auto w-full max-w-md pop-modal-content">
                <div class="p-4 bg-black text-white flex justify-between items-center">
                    <h3 class="text-2xl font-black uppercase">å®¶é•·å°ˆç”¨é€£çµ</h3>
                    <button id="close-parent-link-btn" class="text-white hover:text-yellow-300 text-4xl font-bold">&times;</button>
                </div>
                <div class="p-6 halftone-bg">
                    <p class="text-sm font-bold mb-4">è«‹å®¶é•·ä½¿ç”¨æ‰‹æ©ŸæƒæQR Codeæˆ–é»æ“Šä¸‹æ–¹é€£çµï¼š</p>
                    <div id="qrcode-container" class="p-4 bg-white mb-4"></div>
                    <input id="parent-url-input" type="text" readonly class="w-full pop-input text-sm" onclick="this.select()">
                    <div class="mt-4 flex justify-center">
                        <button id="close-parent-link-btn-main" class="pop-button px-8 py-3">âœ“ é—œé–‰</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="broadcast-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm h-full w-full flex items-center justify-center z-40 p-4">
             <div class="relative mx-auto w-full max-w-lg pop-modal-content">
                <div class="p-4 bg-black text-white flex justify-between items-center">
                    <h3 class="text-2xl font-black uppercase">ç™¼é€ç¾¤æ’­è¨Šæ¯</h3>
                    <button id="cancel-broadcast-btn-close" class="text-white hover:text-yellow-300 text-4xl font-bold">&times;</button>
                </div>
                <div class="p-6 halftone-bg">
                    <form id="broadcast-form" class="space-y-4">
                        <textarea id="broadcast-input" rows="4" class="w-full pop-input" placeholder="ğŸ’¬ åœ¨æ­¤è¼¸å…¥è¦ç™¼é€çµ¦æ‰€æœ‰å®¶é•·çš„è¨Šæ¯..."></textarea>
                        <div class="flex items-center gap-4">
                            <input id="broadcast-image-upload" type="file" accept="image/*" class="hidden">
                            <button id="broadcast-image-btn" type="button" class="pop-button pop-button-secondary text-sm flex-grow">ğŸ“¸ åœ–ç‰‡</button>
                            <button id="broadcast-url-btn" type="button" class="pop-button pop-button-secondary text-sm flex-grow">ğŸ”— é€£çµ</button>
                        </div>
                        <div id="broadcast-attachment-preview" class="text-sm font-bold text-black"></div>
                        <div class="items-center gap-3 flex justify-end">
                            <button id="cancel-broadcast-btn" type="button" class="pop-button bg-gray-300">âŒ å–æ¶ˆ</button>
                            <button type="submit" class="pop-button pop-button-secondary">ğŸš€ ç¢ºèªç™¼é€</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="instructions-modal" class="hidden fixed inset-0 bg-black/75 h-full w-full flex items-center justify-center z-50 p-4">
            <div class="relative mx-auto w-full max-w-3xl shadow-lg bg-white border-4 border-black max-h-[85vh] flex flex-col">
                <div class="absolute top-2 right-2"><button id="close-instructions-btn" class="text-black hover:text-red-500 font-black text-2xl px-2">X</button></div>
                <div class="instruction-content overflow-y-auto p-6">
                    <h2 class="text-3xl font-black mb-4 uppercase">é¦–æ¬¡è¨­å®šæŒ‡å—</h2>
                    <p>æ­¡è¿ï¼æœ¬æŒ‡å—å°‡å¼•å°æ‚¨å®Œæˆæ­¤æ‡‰ç”¨ç¨‹å¼çš„é¦–æ¬¡è¨­å®šã€‚è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š</p>
                    <div class="space-y-6 mt-6">
                        <div>
                            <h3>ç¬¬ä¸€æ­¥ï¼šå»ºç«‹ Firebase å°ˆæ¡ˆ</h3>
                            <ol class="list-decimal list-inside mt-2 space-y-1 font-bold">
                                <li>å‰å¾€ <a href="https://firebase.google.com/" target="_blank">Firebase å®˜æ–¹ç¶²ç«™</a> ä¸¦ç™»å…¥ã€‚</li>
                                <li>é»æ“Šã€Œå‰å¾€ä¸»æ§å°ã€ï¼Œç„¶å¾Œã€Œæ–°å¢å°ˆæ¡ˆã€ã€‚</li>
                                <li>ç‚ºå°ˆæ¡ˆå‘½åï¼Œç„¶å¾Œé»æ“Šã€Œç¹¼çºŒã€ã€‚</li>
                                <li><b>é—œé–‰</b> Google Analytics åŠŸèƒ½ï¼Œç„¶å¾Œã€Œå»ºç«‹å°ˆæ¡ˆã€ã€‚</li>
                            </ol>
                        </div>
                        <div>
                            <h3>ç¬¬äºŒæ­¥ï¼šå•Ÿç”¨ Firebase æœå‹™</h3>
                            <p class="font-bold">åœ¨å·¦å´é¸å–®ã€Œå»ºæ§‹ã€å€å¡Šï¼Œå•Ÿç”¨ä»¥ä¸‹å…©é …æœå‹™ï¼š</p>
                            <ul class="list-disc list-inside mt-2 space-y-2 font-bold">
                                <li><b>Authentication (èªè­‰)</b>: é»æ“Šã€Œé–‹å§‹ä½¿ç”¨ã€ -> é¸æ“‡ã€Œé›»å­éƒµä»¶/å¯†ç¢¼ã€ -> <b>å•Ÿç”¨</b>ä¸¦å„²å­˜ã€‚</li>
                                <li><b>Firestore Database (è³‡æ–™åº«)</b>: é»æ“Šã€Œå»ºç«‹è³‡æ–™åº«ã€ -> é¸æ“‡<b>ã€Œåœ¨æ¸¬è©¦æ¨¡å¼ä¸‹å•Ÿå‹•ã€</b> -> é¸æ“‡ä¼ºæœå™¨ä½ç½® -> ã€Œå•Ÿç”¨ã€ã€‚</li>
                            </ul>
                        </div>
                        <div>
                            <h3>ç¬¬ä¸‰æ­¥ï¼šå–å¾— firebaseConfig</h3>
                            <ol class="list-decimal list-inside mt-2 space-y-1 font-bold">
                                <li>å›åˆ°å°ˆæ¡ˆé¦–é ï¼Œé»æ“Š âš™ï¸ åœ–ç¤ºï¼Œé¸ã€Œå°ˆæ¡ˆè¨­å®šã€ã€‚</li>
                                <li>åœ¨ã€Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ã€å€å¡Šï¼Œé»æ“Šç¶²é åœ–ç¤º ( <b>&lt;/&gt;</b> )ã€‚</li>
                                <li>å–ä¸€å€‹æš±ç¨±ï¼Œé»æ“Šã€Œè¨»å†Šæ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                                <li>è¨»å†Šå¾Œï¼Œ<b>å®Œæ•´è¤‡è£½</b>åç‚º <code>firebaseConfig</code> çš„ç¨‹å¼ç¢¼å€å¡Šã€‚</li>
                            </ol>
                        </div>
                        <div>
                            <h3>ç¬¬å››æ­¥ï¼šè²¼ä¸Šé‡‘é‘°</h3>
                             <ol class="list-decimal list-inside mt-2 space-y-1 font-bold">
                                <li>ç”¨æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹é€™å€‹ <code>index.html</code> æª”æ¡ˆã€‚</li>
                                <li>åœ¨æª”æ¡ˆåº•éƒ¨æ‰¾åˆ° <code>&lt;script type="module"&gt;</code> æ¨™ç±¤ã€‚</li>
                                <li>æ‰¾åˆ°è¨»è§£ <code>// --- è«‹å°‡æ‚¨å¾ Firebase å°ˆæ¡ˆè¤‡è£½çš„è¨­å®šè²¼åˆ°é€™è£¡ ---</code> çš„åœ°æ–¹ã€‚</li>
                                <li>å°‡æ‚¨è¤‡è£½çš„ <code>firebaseConfig</code> ç¨‹å¼ç¢¼ï¼Œ<b>å®Œæ•´å–ä»£</b>æ‰è©²è™•çš„ç¯„ä¾‹é‡‘é‘°ã€‚</li>
                            </ol>
                        </div>
                        <div>
                            <h3>ç¬¬äº”æ­¥ï¼šæ›´æ–° Firestore å®‰å…¨è¦å‰‡ (æœ€é‡è¦)</h3>
                            <ol class="list-decimal list-inside mt-2 space-y-1 font-bold">
                                <li>å›åˆ° Firebaseï¼Œé€²å…¥ <b>Firestore Database</b>ï¼Œé¸<b>ã€Œè¦å‰‡ã€</b>åˆ†é ã€‚</li>
                                <li>åˆªé™¤æ‰€æœ‰é è¨­æ–‡å­—ã€‚</li>
                                <li>è¤‡è£½ä¸‹æ–¹çš„<b>æ‰€æœ‰è¦å‰‡æ–‡å­—</b>ï¼Œä¸¦è²¼åˆ°ç·¨è¼¯å™¨ä¸­ï¼š
                                <pre><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</code></pre>
                                </li>
                                <li>é»æ“Š<b>ã€Œç™¼ä½ˆã€</b>æŒ‰éˆ•ï¼Œä¸¦ç­‰å¾…ç´„ 30 ç§’è®“è¦å‰‡ç”Ÿæ•ˆã€‚</li>
                            </ol>
                        </div>
                        <div>
                            <h3>ç¬¬å…­æ­¥ï¼šå®Œæˆï¼</h3>
                            <ul class="list-disc list-inside mt-2 space-y-1 font-bold">
                                <li><b>å„²å­˜</b>æ‚¨ä¿®æ”¹éçš„ <code>index.html</code> æª”æ¡ˆã€‚</li>
                                <li>ç”¨ç€è¦½å™¨é‡æ–°æ•´ç†æ­¤é é¢ã€‚</li>
                                <li>é»æ“Šã€Œæ•™å¸«é€²å…¥ã€ä¸¦è¼¸å…¥é è¨­å¯†ç¢¼ <code>tpet1234</code> å³å¯é–‹å§‹ä½¿ç”¨ï¼</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Custom Alert/Confirm/Prompt Modal -->
        <div id="custom-modal" class="hidden fixed inset-0 bg-black/50 h-full w-full flex items-center justify-center z-50 p-4">
            <div class="relative mx-auto w-full max-w-md pop-modal-content">
                <div class="p-4 bg-black text-white">
                    <h3 id="custom-modal-title" class="text-lg font-black uppercase">è¨Šæ¯</h3>
                </div>
                <div class="p-6">
                    <p id="custom-modal-text" class="text-sm font-bold"></p>
                    <input id="custom-modal-input" type="text" class="hidden w-full pop-input mt-2">
                </div>
                <div id="custom-modal-buttons" class="p-4 flex justify-end gap-3 bg-gray-100 border-t-4 border-black">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>
        <div id="image-viewer-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 h-full w-full flex items-center justify-center z-50 p-4">
            <button id="close-image-viewer-btn" class="absolute top-4 right-4 text-white text-5xl font-black">&times;</button>
            <img id="image-viewer-src" src="" class="max-w-full max-h-full border-8 border-white shadow-2xl">
        </div>
        
        <!-- åŒ¯å‡ºå°è©±æ¨¡æ…‹è¦–çª— -->
        <div id="export-chat-modal" class="hidden fixed inset-0 bg-black/50 h-full w-full flex items-center justify-center z-40 p-4">
            <div class="relative mx-auto w-full max-w-md pop-modal-content">
                <div class="p-4 bg-black text-white flex justify-between items-center">
                    <h3 class="text-2xl font-black uppercase">åŒ¯å‡ºå°è©±</h3>
                    <button id="close-export-modal-btn" class="text-white hover:text-yellow-300 text-4xl font-bold">&times;</button>
                </div>
                <div class="p-6 halftone-bg space-y-3">
                    <button id="export-csv-btn" class="w-full pop-button pop-button-secondary py-3 px-4">
                        ğŸ“Š åŒ¯å‡º CSV (ç´”æ–‡å­—)
                    </button>
                    <button id="export-html-btn" class="w-full pop-button py-3 px-4">
                        ğŸŒ åŒ¯å‡º HTML (å«åœ–ç‰‡)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-2 bg-black"><p class="text-xs text-white font-bold">Made by é˜¿å‰›è€å¸« (Pop Art Remix)</p></footer>

    <script type="module">
        // ç”Ÿç”¢ç’°å¢ƒä¸‹ç¦ç”¨æ‰€æœ‰consoleè¼¸å‡º
        if (window.location.protocol === 'https:' || window.location.hostname !== 'localhost') {
            // ç¦ç”¨æ‰€æœ‰consoleæ–¹æ³•
            console.log = function() {};
            console.info = function() {};
            console.warn = function() {};
            console.error = function() {};
            console.debug = function() {};
            console.trace = function() {};
            console.table = function() {};
            console.group = function() {};
            console.groupEnd = function() {};
            console.time = function() {};
            console.timeEnd = function() {};
            console.clear = function() {};
        }
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, getDocs, collection, query, where, writeBatch, onSnapshot, deleteDoc, serverTimestamp, orderBy, addDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            // --- è«‹å°‡æ‚¨å¾ Firebase å°ˆæ¡ˆè¤‡è£½çš„è¨­å®šè²¼åˆ°é€™è£¡ ---
            // ç¯„ä¾‹:
            apiKey: "AIzaSyAHmNpM9sf3p3E3C3UL_GvSzDM4wYqBVrw",
  authDomain: "parent-teacher-interacti-9346c.firebaseapp.com",
  projectId: "parent-teacher-interacti-9346c",
  storageBucket: "parent-teacher-interacti-9346c.firebasestorage.app",
  messagingSenderId: "122541005040",
  appId: "1:122541005040:web:7630eb1f339d8155424a35"
        };
        
        const TEACHER_EMAIL = 'teacher@example.com';
        const TEACHER_PASS = 'tpet1234';

        let app, auth, db;
        let isCreatingAccount = false; // ä¿®æ­£ï¼šæ–°å¢ä¸€å€‹æ——æ¨™ä¾†é¿å… auth ç‹€æ…‹è¡çª

        const state = { currentUser: null, activeChatId: null, unsubscribeChat: null, unsubscribeParentList: null, unsubscribeChats: null, broadcastAttachment: null };
        const views = { entry: document.getElementById('entry-view'), parentLogin: document.getElementById('parent-login-view'), teacher: document.getElementById('teacher-view'), parent: document.getElementById('parent-view') };
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');

        // --- Custom Modal Functions ---
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalText = document.getElementById('custom-modal-text');
        const modalInput = document.getElementById('custom-modal-input');
        const modalButtons = document.getElementById('custom-modal-buttons');

        function showModal(config) {
            if (!customModal) return; 
            modalTitle.textContent = config.title || 'è¨Šæ¯';
            modalText.textContent = config.text || '';
            modalInput.classList.add('hidden');
            modalInput.value = '';
            modalButtons.innerHTML = '';

            if (config.type === 'prompt') {
                modalInput.classList.remove('hidden');
                modalInput.placeholder = config.placeholder || '';
            }

            config.buttons.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.class;
                button.onclick = () => {
                    customModal.classList.add('hidden');
                    btnConfig.onClick();
                };
                modalButtons.appendChild(button);
            });
            
            customModal.classList.remove('hidden');
        }

        function showAlert(text, title = 'é€šçŸ¥') {
            return new Promise(resolve => {
                showModal({
                    title, text, type: 'alert',
                    buttons: [{ text: 'ç¢ºå®š', class: 'pop-button pop-button-secondary px-4 py-2', onClick: resolve }]
                });
            });
        }

        function showConfirm(text, title = 'è«‹ç¢ºèª') {
            return new Promise(resolve => {
                showModal({
                    title, text, type: 'confirm',
                    buttons: [
                        { text: 'å–æ¶ˆ', class: 'pop-button bg-gray-300 px-4 py-2', onClick: () => resolve(false) },
                        { text: 'ç¢ºå®š', class: 'pop-button pop-button-danger px-4 py-2', onClick: () => resolve(true) }
                    ]
                });
            });
        }

        function showPrompt(text, title = 'è«‹è¼¸å…¥', placeholder = '') {
            return new Promise(resolve => {
                showModal({
                    title, text, type: 'prompt', placeholder,
                    buttons: [
                        { text: 'å–æ¶ˆ', class: 'pop-button bg-gray-300 px-4 py-2', onClick: () => resolve(null) },
                        { text: 'ç¢ºå®š', class: 'pop-button pop-button-secondary px-4 py-2', onClick: () => resolve(modalInput.value) }
                    ]
                });
            });
        }

        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) {
                return ''; // å¦‚æœæ™‚é–“æˆ³ç„¡æ•ˆï¼Œè¿”å›ç©ºå­—ä¸²
            }
            const date = timestamp.toDate();
            // ä½¿ç”¨ 'sv-SE' æ ¼å¼å¯ä»¥ç©©å®šå¾—åˆ° YYYY-MM-DD HH:mm çš„æ ¼å¼ï¼Œä¸¦æŒ‡å®šå°ç£æ™‚å€
            return date.toLocaleString('sv-SE', {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // è¨ˆç®—ä¸¦æ ¼å¼åŒ–åœ–ç‰‡åˆ°æœŸæ™‚é–“
        function formatImageExpiry(expireAt) {
            if (!expireAt) return '';
            
            let expireDate;
            if (expireAt.toDate) {
                expireDate = expireAt.toDate();
            } else if (expireAt instanceof Date) {
                expireDate = expireAt;
            } else {
                expireDate = new Date(expireAt);
            }
            
            const now = new Date();
            const diffTime = expireDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays <= 0) {
                return '<span class="text-red-500 text-xs font-bold">åœ–ç‰‡å·²éæœŸ</span>';
            } else if (diffDays <= 3) {
                return `<span class="text-orange-500 text-xs font-bold">åœ–ç‰‡å°‡æ–¼ ${diffDays} å¤©å¾Œåˆªé™¤</span>`;
            } else {
                return `<span class="text-gray-400 text-xs font-bold">åœ–ç‰‡å°‡æ–¼ ${diffDays} å¤©å¾Œåˆªé™¤</span>`;
            }
        }

        // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å·²éæœŸ
        function isImageExpired(expireAt) {
            if (!expireAt) return false;
            
            let expireDate;
            if (expireAt.toDate) {
                expireDate = expireAt.toDate();
            } else if (expireAt instanceof Date) {
                expireDate = expireAt;
            } else {
                expireDate = new Date(expireAt);
            }
            
            return new Date() > expireDate;
        }

        // æ¸…ç†éæœŸåœ–ç‰‡
        async function cleanupExpiredImages() {
            try {
                console.log("é–‹å§‹æ¸…ç†éæœŸåœ–ç‰‡...");
                
                // ç²å–æ‰€æœ‰èŠå¤©è¨˜éŒ„
                const chatsQuery = query(collection(db, "chats"));
                const chatsSnapshot = await getDocs(chatsQuery);
                
                let cleanupCount = 0;
                
                for (const chatDoc of chatsSnapshot.docs) {
                    const chatId = chatDoc.id;
                    
                    // ç²å–è©²èŠå¤©çš„æ‰€æœ‰è¨Šæ¯
                    const messagesQuery = query(collection(db, "chats", chatId, "messages"));
                    const messagesSnapshot = await getDocs(messagesQuery);
                    
                    for (const messageDoc of messagesSnapshot.docs) {
                        const messageData = messageDoc.data();
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡è¨Šæ¯ä¸”å·²éæœŸ
                        if (messageData.type === 'image' && messageData.imageExpireAt && isImageExpired(messageData.imageExpireAt)) {
                            // æ¸…é™¤base64Imageè³‡æ–™ä½†ä¿ç•™è¨Šæ¯è¨˜éŒ„
                            await updateDoc(doc(db, "chats", chatId, "messages", messageDoc.id), {
                                base64Image: null,
                                imageCleanedAt: new Date()
                            });
                            cleanupCount++;
                            console.log(`æ¸…ç†éæœŸåœ–ç‰‡: ${chatId}/${messageDoc.id}`);
                        }
                    }
                }
                
                if (cleanupCount > 0) {
                    console.log(`âœ… æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç† ${cleanupCount} å¼µéæœŸåœ–ç‰‡`);
                } else {
                    console.log("âœ… æ²’æœ‰ç™¼ç¾éæœŸåœ–ç‰‡");
                }
                
            } catch (error) {
                console.error("æ¸…ç†éæœŸåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            }
        }

        // å®šæœŸåŸ·è¡Œæ¸…ç†ä»»å‹™
        function scheduleImageCleanup() {
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡æ¸…ç†
            cleanupExpiredImages();
            
            // æ¯24å°æ™‚åŸ·è¡Œä¸€æ¬¡æ¸…ç†
            setInterval(() => {
                cleanupExpiredImages();
            }, 24 * 60 * 60 * 1000); // 24å°æ™‚
        }

        // åŒ¯å‡ºå°è©±è¨˜éŒ„ç‚ºCSVæ ¼å¼
        async function exportChatToCSV() {
            if (!state.activeChatId) {
                await showAlert("è«‹å…ˆé¸æ“‡ä¸€å€‹å°è©±ã€‚", "æé†’");
                return;
            }

            try {
                // ç²å–èŠå¤©è¨˜éŒ„
                const messagesRef = collection(db, "chats", state.activeChatId, "messages");
                const q = query(messagesRef, orderBy("timestamp"));
                const snapshot = await getDocs(q);
                
                // CSVæ¨™é ­
                let csvContent = "\uFEFFç™¼é€è€…,è¨Šæ¯å…§å®¹,ç™¼é€æ™‚é–“\n"; // \uFEFFæ˜¯BOMï¼Œç¢ºä¿Excelæ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const sender = msg.senderName || 'æœªçŸ¥';
                    let content = '';
                    
                    switch(msg.type) {
                        case 'image':
                            content = 'æ­¤ç‚ºåœ–ç‰‡ç„¡æ³•åŒ¯å‡º';
                            break;
                        case 'url':
                            content = msg.url || '';
                            break;
                        default: // text
                            content = (msg.text || '').replace(/"/g, '""'); // è™•ç†CSVä¸­çš„å¼•è™Ÿ
                    }
                    
                    const timestamp = formatTimestamp(msg.timestamp);
                    csvContent += `"${sender}","${content}","${timestamp}"\n`;
                });
                
                // ä¸‹è¼‰æª”æ¡ˆ
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const chatTitle = document.getElementById('chat-with-name').querySelector('span:last-child').textContent;
                const filename = `å°è©±è¨˜éŒ„_${chatTitle}_${new Date().toISOString().slice(0,10)}.csv`;
                
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                await showAlert("CSVæª”æ¡ˆå·²æˆåŠŸåŒ¯å‡ºï¼", "å®Œæˆ");
            } catch (error) {
                console.error("åŒ¯å‡ºCSVå¤±æ•—:", error);
                await showAlert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "éŒ¯èª¤");
            }
        }

        // åŒ¯å‡ºå°è©±è¨˜éŒ„ç‚ºHTMLæ ¼å¼
        async function exportChatToHTML() {
            if (!state.activeChatId) {
                await showAlert("è«‹å…ˆé¸æ“‡ä¸€å€‹å°è©±ã€‚", "æé†’");
                return;
            }

            try {
                // ç²å–èŠå¤©è¨˜éŒ„
                const messagesRef = collection(db, "chats", state.activeChatId, "messages");
                const q = query(messagesRef, orderBy("timestamp"));
                const snapshot = await getDocs(q);
                
                const chatTitle = document.getElementById('chat-with-name').querySelector('span:last-child').textContent;
                
                // HTMLæ¨¡æ¿
                let htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${chatTitle} - å°è©±è¨˜éŒ„</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: top; }
        th { background-color: #007bff; color: white; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .sender { font-weight: bold; min-width: 100px; }
        .timestamp { color: #666; font-size: 0.9em; min-width: 150px; }
        .message-content { word-wrap: break-word; white-space: pre-wrap; }
        .message-image { max-width: 300px; height: auto; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 5px 0; display: block; }
        .message-url { color: #007bff; text-decoration: none; }
        .message-url:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>${chatTitle}</h1>
        <p style="text-align: center; color: #666;">åŒ¯å‡ºæ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
        <table>
            <thead>
                <tr>
                    <th>ç™¼é€è€…</th>
                    <th>è¨Šæ¯å…§å®¹</th>
                    <th>ç™¼é€æ™‚é–“</th>
                </tr>
            </thead>
            <tbody>`;
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const sender = msg.senderName || 'æœªçŸ¥';
                    let content = '';
                    
                    switch(msg.type) {
                        case 'image':
                            // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦éæœŸ
                            const isExpiredForExport = isImageExpired(msg.imageExpireAt);
                            const imageData = msg.base64Image || msg.imageUrl || '';
                            
                            if (isExpiredForExport || !imageData) {
                                content = `<div style="color:#666; font-style:italic; padding:10px; background:#f9f9f9; border-radius:5px; border:2px dashed #ccc; text-align:center;">
                                    ğŸ“· åœ–ç‰‡å·²éæœŸæˆ–éºå¤±<br>
                                    <small style="color:#999;">æ­¤åœ–ç‰‡å·²æ–¼ä¿å­˜æœŸé™å¾Œè‡ªå‹•åˆªé™¤</small>
                                </div>`;
                            } else {
                                const expiryInfoForExport = formatImageExpiry(msg.imageExpireAt);
                                content = `
                                    <img src="${imageData}" alt="èŠå¤©åœ–ç‰‡" class="message-image" onerror="this.alt='åœ–ç‰‡è¼‰å…¥å¤±æ•—'; this.style.background='#f0f0f0'; this.style.padding='20px'; this.style.textAlign='center';" />
                                    ${expiryInfoForExport ? `<div style="font-size:0.8em; color:#666; margin-top:5px;">${expiryInfoForExport.replace(/class="[^"]*"/g, 'style="color:#666;"')}</div>` : ''}
                                `;
                            }
                            break;
                        case 'url':
                            content = `<a href="${msg.url}" target="_blank" class="message-url">${msg.url}</a>`;
                            break;
                        default: // text
                            content = `<div class="message-content">${(msg.text || '').replace(/\n/g, '<br>')}</div>`;
                    }
                    
                    const timestamp = formatTimestamp(msg.timestamp);
                    htmlContent += `
                <tr>
                    <td class="sender">${sender}</td>
                    <td>${content}</td>
                    <td class="timestamp">${timestamp}</td>
                </tr>`;
                });
                
                htmlContent += `
            </tbody>
        </table>
    </div>
</body>
</html>`;
                
                // ä¸‹è¼‰æª”æ¡ˆ
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
                const link = document.createElement('a');
                const filename = `å°è©±è¨˜éŒ„_${chatTitle}_${new Date().toISOString().slice(0,10)}.html`;
                
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                await showAlert("HTMLæª”æ¡ˆå·²æˆåŠŸåŒ¯å‡ºï¼", "å®Œæˆ");
            } catch (error) {
                console.error("åŒ¯å‡ºHTMLå¤±æ•—:", error);
                await showAlert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "éŒ¯èª¤");
            }
        }

        function showView(viewId) { Object.values(views).forEach(view => view.classList.add('hidden')); if (views[viewId]) views[viewId].classList.remove('hidden'); }

        function startApp() {
            if (firebaseConfig.apiKey.startsWith("AIzaSyXXXX")) {
                showView('entry');
                showAlert("æ‚¨å°šæœªè¨­å®š Firebase é‡‘é‘°ï¼è«‹é»æ“Š 'å¦‚ä½•è¨­å®šæ­¤ç¨‹å¼ï¼Ÿ' æŒ‰éˆ•å®Œæˆè¨­å®šã€‚", "è¨­å®šæé†’");
                return;
            }
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            setPersistence(auth, browserLocalPersistence);

            if (mode === 'parents') {
                setupParentAuthentication();
            } else {
                // Main entry logic with persistent login check
                onAuthStateChanged(auth, async (user) => {
                    if (isCreatingAccount) return; // ä¿®æ­£ï¼šç•¶æ­£åœ¨å»ºç«‹å¸³è™Ÿæ™‚ï¼Œå¿½ç•¥ auth ç‹€æ…‹çš„è®ŠåŒ–
                    if (user && user.email === TEACHER_EMAIL) {
                        console.log("æ•™å¸«ç™»å…¥æˆåŠŸ:", user.uid, user.email);
                        state.currentUser = user;
                        
                        // ç¢ºèªæ•™å¸«è³‡æ–™å·²å­˜åœ¨æ–¼ Firestore
                        try {
                            const teacherDoc = await getDoc(doc(db, "users", user.uid));
                            if (!teacherDoc.exists()) {
                                console.log("æ•™å¸«ç”¨æˆ¶è³‡æ–™ä¸å­˜åœ¨ï¼Œé‡æ–°å»ºç«‹...");
                                await setDoc(doc(db, "users", user.uid), { 
                                    uid: user.uid, 
                                    email: TEACHER_EMAIL,
                                    role: 'teacher',
                                    displayName: 'æ•™å¸«'
                                });
                                console.log("æ•™å¸«ç”¨æˆ¶è³‡æ–™å»ºç«‹å®Œæˆ");
                            } else {
                                const teacherExistingData = teacherDoc.data();
                                console.log("æ•™å¸«ç”¨æˆ¶è³‡æ–™å·²å­˜åœ¨:", {
                                    role: teacherExistingData.role,
                                    email: teacherExistingData.email,
                                    displayName: teacherExistingData.displayName
                                });
                            }
                        } catch (error) {
                            console.error("æª¢æŸ¥æˆ–å»ºç«‹æ•™å¸«ç”¨æˆ¶è³‡æ–™å¤±æ•—:", error);
                        }
                        
                        requestNotificationPermission();
                        showView('teacher');
                        setupTeacherDashboard();
                        
                        // å•Ÿå‹•åœ–ç‰‡æ¸…ç†èª¿åº¦å™¨
                        scheduleImageCleanup();
                    } else if (user) { // Parent is logged in but on main page
                        window.location.href = `?mode=parents`;
                    }
                    else {
                        showView('entry');
                    }
                });
            }
            document.getElementById('teacher-entry-btn').addEventListener('click', () => handleTeacherLogin());
            document.getElementById('show-parent-link-btn').addEventListener('click', showParentLink);
        }

        async function handleTeacherLogin() {
            const pass = await showPrompt('è«‹è¼¸å…¥æ•™å¸«å¯†ç¢¼ï¼š', 'æ•™å¸«ç™»å…¥');
            if (pass === TEACHER_PASS) {
                try {
                    await signInWithEmailAndPassword(auth, TEACHER_EMAIL, TEACHER_PASS);
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        try {
                            console.log("é¦–æ¬¡å»ºç«‹æ•™å¸«å¸³è™Ÿ...");
                            const userCredential = await createUserWithEmailAndPassword(auth, TEACHER_EMAIL, TEACHER_PASS);
                            await setDoc(doc(db, "users", userCredential.user.uid), { 
                                uid: userCredential.user.uid, 
                                email: TEACHER_EMAIL,
                                role: 'teacher',
                                displayName: 'æ•™å¸«'
                            });
                            console.log("æ•™å¸«å¸³è™Ÿå»ºç«‹æˆåŠŸ:", userCredential.user.uid);
                        } catch (creationError) { 
                            console.error("Teacher account creation failed:", creationError);
                            await showAlert("é¦–æ¬¡è¨­å®šæ•™å¸«å¸³è™Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase è¨­å®šèˆ‡å®‰å…¨è¦å‰‡ã€‚", "éŒ¯èª¤"); 
                            return; 
                        }
                    } else { 
                        console.error("Teacher login failed:", error);
                        await showAlert("ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "éŒ¯èª¤"); 
                        return; 
                    }
                }
                // onAuthStateChanged will handle the rest
            } else if (pass !== null) { await showAlert("å¯†ç¢¼éŒ¯èª¤ï¼", "éŒ¯èª¤"); }
        }

        async function setupParentAuthentication() {
            onAuthStateChanged(auth, async (user) => {
                if (state.unsubscribeChat) state.unsubscribeChat();
                if (user && user.email !== TEACHER_EMAIL) {
                    state.currentUser = user;
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        requestNotificationPermission();
                        showView('parent');
                        setupParentDashboard(userDoc.data().parentName);
                    } else { 
                        await signOut(auth); // Data mismatch, force logout
                        showView('parentLogin');
                        setTimeout(() => {
                            populateStudentList();
                        }, 100);
                    }
                } else {
                    showView('parentLogin');
                    // å»¶é²ä¸€ä¸‹ç¢ºä¿ Firebase å®Œå…¨åˆå§‹åŒ–
                    setTimeout(() => {
                        populateStudentList();
                    }, 100);
                }
            });
            document.getElementById('parent-login-form').addEventListener('submit', async (e) => { e.preventDefault(); const studentUid = document.getElementById('student-select').value; const password = document.getElementById('password').value; const errorEl = document.getElementById('login-error'); errorEl.textContent = ''; if (!studentUid) { errorEl.textContent = 'è«‹é¸æ“‡å­¸ç”Ÿå§“åã€‚'; return; } const userDoc = await getDoc(doc(db, "users", studentUid)); if (!userDoc.exists()) { errorEl.textContent = 'æ‰¾ä¸åˆ°è©²å­¸ç”Ÿè³‡æ–™ã€‚'; return; } const fakeEmail = userDoc.data().email; try { await signInWithEmailAndPassword(auth, fakeEmail, password); } catch (error) { errorEl.textContent = 'å¯†ç¢¼éŒ¯èª¤ã€‚'; } });
        }
        
        async function populateStudentList() {
            const selectEl = document.getElementById('student-select');
            selectEl.innerHTML = '<option value="">æ­£åœ¨è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨...</option>';
            
            console.log("é–‹å§‹è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨...");
            console.log("ç•¶å‰èªè­‰ç‹€æ…‹:", auth.currentUser ? auth.currentUser.uid : "æœªèªè­‰");
            
            try {
                // å…ˆæ¸¬è©¦åŸºæœ¬é€£æ¥æ€§ - å˜—è©¦ç°¡å–®æŸ¥è©¢
                console.log("æ¸¬è©¦ Firebase é€£æ¥...");
                console.log("æ•¸æ“šåº«å¯¦ä¾‹:", db);
                
                // å˜—è©¦å…ˆæŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶ï¼ˆä¸ä½¿ç”¨ where æ¢ä»¶ï¼‰
                try {
                    console.log("æ¸¬è©¦æŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶...");
                    const allUsersQuery = query(collection(db, "users"));
                    const allUsersSnapshot = await getDocs(allUsersQuery);
                    console.log("æˆåŠŸæŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶ï¼Œç¸½æ•¸:", allUsersSnapshot.size);
                    
                    let parentCount = 0;
                    allUsersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        console.log("ç”¨æˆ¶è³‡æ–™:", doc.id, userData);
                        if (userData.role === 'parent') {
                            parentCount++;
                        }
                    });
                    console.log("å…¶ä¸­å®¶é•·ç”¨æˆ¶æ•¸é‡:", parentCount);
                } catch (allUsersError) {
                    console.error("æŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶å¤±æ•—:", allUsersError);
                    throw allUsersError;
                }
                
                // ç¾åœ¨å˜—è©¦å…·é«”çš„å®¶é•·æŸ¥è©¢
                console.log("å˜—è©¦æŸ¥è©¢å®¶é•·ç”¨æˆ¶...");
                const q = query(collection(db, "users"), where("role", "==", "parent"));
                const querySnapshot = await getDocs(q);
                
                console.log("æŸ¥è©¢æˆåŠŸï¼Œæ‰¾åˆ°", querySnapshot.size, "ç­†å®¶é•·è³‡æ–™");
                selectEl.innerHTML = '<option value="">-- è«‹é¸æ“‡å­¸ç”Ÿå§“å --</option>';
                
                if (querySnapshot.empty) {
                    selectEl.innerHTML = '<option value="">ç›®å‰æ²’æœ‰ä»»ä½•å­¸ç”Ÿè³‡æ–™</option>';
                    console.log("è³‡æ–™åº«ä¸­æ²’æœ‰å®¶é•·è³‡æ–™ï¼Œå¯èƒ½åŸå› ï¼š");
                    console.log("1. é‚„æ²’æœ‰å»ºç«‹ä»»ä½•å®¶é•·å¸³è™Ÿ");
                    console.log("2. å®¶é•·å¸³è™Ÿçš„ role æ¬„ä½ä¸æ˜¯ 'parent'");
                    console.log("è«‹å…ˆä½¿ç”¨æ•™å¸«æ¨¡å¼å»ºç«‹å®¶é•·å¸³è™Ÿ");
                    return;
                }
                
                let validStudentCount = 0;
                querySnapshot.forEach((doc) => {
                    const parent = doc.data();
                    console.log("è™•ç†å®¶é•·è³‡æ–™:", doc.id, parent);
                    if (parent.studentName && parent.uid) {
                        const option = document.createElement('option');
                        option.value = parent.uid;
                        option.textContent = parent.studentName;
                        selectEl.appendChild(option);
                        validStudentCount++;
                    } else {
                        console.warn("å®¶é•·è³‡æ–™ä¸å®Œæ•´:", doc.id, parent);
                    }
                });
                
                console.log(`æˆåŠŸè¼‰å…¥ ${validStudentCount} ç­†æœ‰æ•ˆå­¸ç”Ÿè³‡æ–™`);
                
                if (validStudentCount === 0) {
                    selectEl.innerHTML = '<option value="">è³‡æ–™æ ¼å¼ç•°å¸¸ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡</option>';
                }
                
            } catch (error) {
                console.error("è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨å¤±æ•—:");
                console.error("éŒ¯èª¤ä»£ç¢¼:", error.code);
                console.error("éŒ¯èª¤è¨Šæ¯:", error.message);
                console.error("å®Œæ•´éŒ¯èª¤:", error);
                
                if (error.code === 'permission-denied') {
                    selectEl.innerHTML = '<option value="">æ¬Šé™ä¸è¶³ï¼è«‹æ›´æ–° Firebase å®‰å…¨è¦å‰‡</option>';
                    console.error("â•â•â• Firebase å®‰å…¨è¦å‰‡éŒ¯èª¤ â•â•â•");
                    console.error("è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿä¿®æ­£ï¼š");
                    console.error("1. åˆ° Firebase æ§åˆ¶å° > Firestore Database > è¦å‰‡");
                    console.error("2. å°‡æ‰€æœ‰å…§å®¹æ›¿æ›ç‚ºï¼š");
                    console.error(`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}`);
                    console.error("3. é»æ“Šã€Œç™¼ä½ˆã€æŒ‰éˆ•");
                    console.error("4. é‡æ–°æ•´ç†æ­¤é é¢");
                    console.error("æ³¨æ„ï¼šé€™æ˜¯é–‹ç™¼ç”¨è¦å‰‡ï¼Œæ­£å¼ä¸Šç·šå‰è«‹ä½¿ç”¨æ›´å®‰å…¨çš„è¦å‰‡");
                    
                    // é¡¯ç¤ºç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤æç¤º
                    setTimeout(() => {
                        alert("Firebase å®‰å…¨è¦å‰‡è¨­å®šæœ‰èª¤ï¼\n\nè«‹é»æ“Šé é¢ä¸Šçš„ã€Œå¦‚ä½•è¨­å®šæ­¤ç¨‹å¼ï¼Ÿã€æŒ‰éˆ•ï¼Œ\næŒ‰ç…§ç¬¬äº”æ­¥çš„èªªæ˜æ›´æ–°å®‰å…¨è¦å‰‡ã€‚");
                    }, 1000);
                } else if (error.code === 'unavailable') {
                    selectEl.innerHTML = '<option value="">ç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦</option>';
                } else {
                    selectEl.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—: ' + error.message + '</option>';
                }
            }
        }

        let isTeacherDashboardSetup = false;
        function setupTeacherDashboard() {
            if (isTeacherDashboardSetup) return;
            isTeacherDashboardSetup = true;
            // æ¬Šé™æª¢æŸ¥ï¼šå˜—è©¦ç°¡å–®æŸ¥è©¢ä»¥ç¢ºèªè¦å‰‡è¨­å®šæ­£ç¢º
            async function checkFirebasePermissions() {
                try {
                    console.log("æª¢æŸ¥ Firebase æ¬Šé™...");
                    const testQuery = query(collection(db, "users"), where("role", "==", "parent"));
                    await getDocs(testQuery);
                    console.log("âœ… Firebase æ¬Šé™æª¢æŸ¥é€šé");
                } catch (error) {
                    if (error.code === 'permission-denied') {
                        console.error("âŒ Firebase æ¬Šé™ä¸è¶³");
                        await showAlert(
                            "Firebase å®‰å…¨è¦å‰‡éœ€è¦æ›´æ–°ï¼\n\n" +
                            "è«‹é»æ“Šã€Œå¦‚ä½•è¨­å®šæ­¤ç¨‹å¼ï¼Ÿã€æŒ‰éˆ•ï¼Œ\n" +
                            "æŒ‰ç…§ç¬¬äº”æ­¥çš„èªªæ˜æ›´æ–°å®‰å…¨è¦å‰‡ã€‚\n\n" +
                            "è«‹æŒ‰ç…§èªªæ˜æ›´æ–°å®‰å…¨è¦å‰‡ã€‚",
                            "æ¬Šé™éŒ¯èª¤"
                        );
                    }
                }
            }
            
            // å»¶é²åŸ·è¡Œæ¬Šé™æª¢æŸ¥
            setTimeout(checkFirebasePermissions, 1000);
            
            // PCç‰ˆç™»å‡ºæŒ‰éˆ•
            document.getElementById('teacher-logout-btn').addEventListener('click', () => { 
                if (state.unsubscribeParentList) state.unsubscribeParentList();
                if (state.unsubscribeChat) state.unsubscribeChat();
                if (state.unsubscribeChats) state.unsubscribeChats();
                
                // é‡ç½®é˜²é‡è¤‡è¨­å®šæ——æ¨™
                isTeacherDashboardSetup = false;
                isBroadcastListenerSetup = false;
                
                signOut(auth); 
            });
            
            // æ‰‹æ©Ÿç‰ˆç™»å‡ºæŒ‰éˆ•
            document.getElementById('teacher-logout-btn-mobile').addEventListener('click', () => { 
                if (state.unsubscribeParentList) state.unsubscribeParentList();
                if (state.unsubscribeChat) state.unsubscribeChat();
                if (state.unsubscribeChats) state.unsubscribeChats();
                
                // é‡ç½®é˜²é‡è¤‡è¨­å®šæ——æ¨™
                isTeacherDashboardSetup = false;
                isBroadcastListenerSetup = false;
                
                signOut(auth); 
            });
            
            // æ‰‹æ©Ÿç‰ˆç®¡ç†æŒ‰éˆ•
            document.getElementById('manage-parents-btn-mobile').addEventListener('click', () => {
                document.getElementById('parent-management-modal').classList.remove('hidden');
            });
            
            // æ‰‹æ©Ÿç‰ˆç¾¤æ’­æŒ‰éˆ•
            document.getElementById('broadcast-btn-mobile').addEventListener('click', () => {
                document.getElementById('broadcast-modal').classList.remove('hidden');
            });
            
            // è¿”å›å°è©±åˆ—è¡¨æŒ‰éˆ•
            document.getElementById('back-to-list-btn').addEventListener('click', () => {
                backToParentList();
            });
            // åŒæ™‚è¨­å®šPCç‰ˆå’Œæ‰‹æ©Ÿç‰ˆçš„ç®¡ç†æŒ‰éˆ•
            const manageBtns = ['manage-parents-btn'];
            manageBtns.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', () => {
                        document.getElementById('parent-management-modal').classList.remove('hidden');
                    });
                }
            });
            
            const broadcastBtns = ['broadcast-btn'];
            broadcastBtns.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', () => {
                        document.getElementById('broadcast-modal').classList.remove('hidden');
                    });
                }
            });

            document.getElementById('add-parent-form').addEventListener('submit', (e) => { e.preventDefault(); handleAddSingleParent(); });
            document.getElementById('bulk-import-btn').addEventListener('click', () => handleBulkImport());
            document.getElementById('delete-all-images-btn').addEventListener('click', handleDeleteAllImages);
            document.getElementById('export-pdf-btn').addEventListener('click', handleExportPDF);
            document.getElementById('fix-old-accounts-btn').addEventListener('click', handleFixOldAccounts);
            setupBroadcastListener();

            // æ•™å¸«ç™¼é€è¨Šæ¯è¡¨å–®
            document.getElementById('message-form').addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const input = document.getElementById('message-input'); 
                const text = input.value.trim(); 
                if (text && state.activeChatId) { 
                    input.value = ''; 
                    await sendMessage(state.activeChatId, { 
                        type: 'text', 
                        text: text, 
                        senderId: auth.currentUser.uid, 
                        senderName: "æ•™å¸«" 
                    }); 
                } 
            });

            // æ‰‹æ©Ÿç‰ˆå’ŒPCç‰ˆçš„ç™¼é€åŠŸèƒ½
            document.getElementById('teacher-image-btn').addEventListener('click', () => document.getElementById('teacher-image-upload').click());
            
            // PCç‰ˆç™¼é€åŠŸèƒ½ï¼ˆåŠ å…¥éŒ¯èª¤è™•ç†ï¼‰
            const pcImageBtn = document.getElementById('pc-teacher-image-btn');
            const pcImageUpload = document.getElementById('pc-teacher-image-upload');
            const pcUrlBtn = document.getElementById('pc-teacher-url-btn');
            
            if (pcImageBtn && pcImageUpload) {
                pcImageBtn.addEventListener('click', () => pcImageUpload.click());
                pcImageUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && state.activeChatId) {
                        handleImageUpload(file, state.activeChatId, auth.currentUser.uid, "æ•™å¸«");
                    }
                });
            }
            
            if (pcUrlBtn) {
                pcUrlBtn.addEventListener('click', async () => {
                    if (!state.activeChatId) return;
                    const url = await showPrompt("è«‹è¼¸å…¥è¦åˆ†äº«çš„ç¶²å€ï¼š", "é™„åŠ é€£çµ", "https://");
                    if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                        await sendMessage(state.activeChatId, { type: 'url', url: url, senderId: auth.currentUser.uid, senderName: "æ•™å¸«" });
                    } else if (url) {
                        await showAlert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶²å€ (é–‹é ­ç‚º http:// æˆ– https://)", "æ ¼å¼éŒ¯èª¤");
                    }
                });
            }
            
            // PCç‰ˆè¡¨å–®äº‹ä»¶ç›£è½å™¨ï¼ˆåŠ å…¥éŒ¯èª¤è™•ç†ï¼‰
            const pcForm = document.getElementById('pc-message-form');
            if (pcForm) {
                pcForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const input = document.getElementById('pc-message-input');
                    if (!input) {
                        console.error('PCç‰ˆè¼¸å…¥æ¡†å…ƒç´ æ‰¾ä¸åˆ°');
                        return;
                    }
                    const text = input.value.trim();
                    if (text && state.activeChatId) {
                        input.value = '';
                        await sendMessage(state.activeChatId, { type: 'text', text: text, senderId: auth.currentUser.uid, senderName: "æ•™å¸«" });
                    }
                });
            } else {
                console.error('PCç‰ˆè¡¨å–®å…ƒç´ æ‰¾ä¸åˆ°');
            }
            
            // å¤šè¡Œæ–‡å­—è¼¸å…¥åŠŸèƒ½ï¼šShift+Enteræ›è¡Œï¼ŒEnterç™¼é€
            function setupTextareaKeyHandling(textareaId, formId) {
                const textarea = document.getElementById(textareaId);
                const form = document.getElementById(formId);
                
                if (textarea && form) {
                    // è‡ªå‹•èª¿æ•´é«˜åº¦
                    textarea.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                    });
                    
                    // Shift+Enteræ›è¡Œï¼ŒEnterç™¼é€
                    textarea.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            if (e.shiftKey) {
                                // Shift+Enterï¼šå…è¨±æ›è¡Œï¼ˆç€è¦½å™¨é è¨­è¡Œç‚ºï¼‰
                                return;
                            } else {
                                // Enterï¼šç™¼é€è¨Šæ¯
                                e.preventDefault();
                                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                                form.dispatchEvent(submitEvent);
                            }
                        }
                    });
                }
            }
            
            // è¨­ç½®æ‰€æœ‰textareaçš„éµç›¤è™•ç†
            setupTextareaKeyHandling('pc-message-input', 'pc-message-form');
            setupTextareaKeyHandling('message-input', 'message-form');
            setupTextareaKeyHandling('parent-message-input', 'parent-message-form');
            
            // [MODIFIED] è¦–çª—å¤§å°è®ŠåŒ–ç›£è½å™¨ï¼Œè™•ç†PCå’Œæ‰‹æ©Ÿæ¨¡å¼åˆ‡æ›
            window.addEventListener('resize', () => {
                const chatPanel = document.getElementById('chat-panel-mobile');
                const parentListPanel = document.getElementById('parent-list-panel-mobile');
                const messageInputArea = document.getElementById('message-input-area');
                
                if (window.innerWidth >= 768) { // PCç‰ˆ
                    // é‡ç½®æ‰€æœ‰è®Šæ›
                    chatPanel.style.transform = '';
                    parentListPanel.style.transform = '';
                    // PCç‰ˆä¸é¡¯ç¤ºæ‰‹æ©Ÿè¼¸å…¥å€
                    if (state.activeChatId) {
                        messageInputArea.classList.add('hidden');
                    }
                } else { // æ‰‹æ©Ÿç‰ˆ
                    if (state.activeChatId) {
                        // å¦‚æœæ­£åœ¨èŠå¤©ï¼Œé¡¯ç¤ºèŠå¤©é¢æ¿
                        chatPanel.style.transform = 'translateX(0)';
                        parentListPanel.style.transform = 'translateX(-100%)';
                        messageInputArea.classList.remove('hidden');
                    } else {
                        // å¦å‰‡é¡¯ç¤ºåˆ—è¡¨
                        chatPanel.style.transform = 'translateX(100%)';
                        parentListPanel.style.transform = 'translateX(0)';
                        messageInputArea.classList.add('hidden');
                    }
                }
            });
            document.getElementById('teacher-image-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && state.activeChatId) {
                    handleImageUpload(file, state.activeChatId, state.currentUser.uid, "æ•™å¸«");
                }
                e.target.value = '';
            });
            document.getElementById('teacher-url-btn').addEventListener('click', async () => {
                if (state.activeChatId) {
                    await handleUrlSend(state.activeChatId, state.currentUser.uid, "æ•™å¸«");
                } else {
                    await showAlert("è«‹å…ˆé¸æ“‡ä¸€ä½å®¶é•·ã€‚", "æé†’");
                }
            });

            if (state.unsubscribeParentList) state.unsubscribeParentList();
            if (state.unsubscribeChats) state.unsubscribeChats();

            const parentListContainer = document.getElementById('parent-list-container');
            let parentDataMap = new Map();
            let chatDataMap = new Map();

            const renderParentList = () => {
                parentListContainer.innerHTML = '';
                if (parentDataMap.size === 0) {
                    parentListContainer.innerHTML = '<p class="p-2 text-slate-500">ç›®å‰æ²’æœ‰ä»»ä½•å®¶é•·å¸³è™Ÿã€‚</p>';
                    return;
                }

                const displayList = Array.from(parentDataMap.values()).map(parent => {
                    const chatId = [auth.currentUser.uid, parent.uid].sort().join('_');
                    const chat = chatDataMap.get(chatId);
                    const unreadCount = chat?.teacherUnreadCount || 0;
                    const isUnread = unreadCount > 0;
                    
                    let lastMessageTimestamp = 0;
                    if (chat?.lastMessage?.timestamp) {
                        try {
                            lastMessageTimestamp = chat.lastMessage.timestamp.toMillis ? 
                                chat.lastMessage.timestamp.toMillis() : 
                                chat.lastMessage.timestamp.seconds * 1000;
                        } catch (e) {
                            console.warn("æ™‚é–“æˆ³è½‰æ›éŒ¯èª¤:", e);
                            lastMessageTimestamp = 0;
                        }
                    }
                    
                    return {
                        ...parent,
                        chatId: chatId,
                        chat: chat, 
                        lastMessageTimestamp: lastMessageTimestamp,
                        isUnread: isUnread
                    };
                });

                displayList.sort((a, b) => {
                    // æœªè®€è¨Šæ¯å„ªå…ˆæ’åº
                    if (a.isUnread && !b.isUnread) return -1;
                    if (!a.isUnread && b.isUnread) return 1;
                    // æŒ‰æœ€å¾Œè¨Šæ¯æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
                    return b.lastMessageTimestamp - a.lastMessageTimestamp;
                });
                
                
                displayList.forEach(parent => {
                    const el = document.createElement('div');
                    const isSelected = state.activeChatId === parent.chatId;
                    
                    el.id = `parent-item-${parent.uid}`;
                    el.className = `parent-list-item flex items-center justify-between p-3 rounded-lg border-2 border-black cursor-pointer hover:bg-yellow-100 bg-white`;
                    if(isSelected) el.classList.add('selected-parent');

                    el.innerHTML = `
                        <div class="text-sm flex-grow">
                            <div class="flex items-center">
                                <p class="font-bold text-black">${parent.studentName}å®¶é•·</p>
                                ${parent.isUnread ? '<span class="ml-2 px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full animate-pulse">æ–°</span>' : ''}
                            </div>
                            <p class="text-gray-600 font-mono">å¸³è™Ÿ: ${parent.username}</p>
                        </div>
                        <button data-uid="${parent.uid}" data-name="${parent.studentName}" class="delete-parent-btn text-red-500 hover:text-red-700 font-bold ml-2">X</button>`;
                    el.querySelector('.delete-parent-btn').onclick = (e) => { e.stopPropagation(); handleDeleteParent(e.target.dataset.uid, e.target.dataset.name); };
                    el.onclick = () => selectParentChat(parent.uid, parent.parentName);
                    parentListContainer.appendChild(el);
                });
            };

            const parentQuery = query(collection(db, "users"), where("role", "==", "parent"));
            state.unsubscribeParentList = onSnapshot(parentQuery, (parentSnapshot) => {
                parentSnapshot.docChanges().forEach((change) => {
                    if (change.type === "added" || change.type === "modified") {
                        parentDataMap.set(change.doc.id, change.doc.data());
                    } else if (change.type === "removed") {
                        parentDataMap.delete(change.doc.id);
                    }
                });
                renderParentList();
            }, (error) => {
                console.error("å®¶é•·åˆ—è¡¨ç›£è½å¤±æ•—:", error);
                if (error.code === 'permission-denied') {
                    parentListContainer.innerHTML = `<div class="p-4 bg-red-100 border-2 border-red-500 rounded-lg m-2"><h4 class="font-bold text-red-800">æ¬Šé™éŒ¯èª¤</h4><p class="text-sm">ç„¡æ³•è¼‰å…¥å®¶é•·åˆ—è¡¨ï¼Œè«‹æ›´æ–°Firebaseå®‰å…¨è¦å‰‡ã€‚</p></div>`;
                }
            });

            const chatQuery = query(collection(db, "chats"), where("participants", "array-contains", auth.currentUser.uid));
            state.unsubscribeChats = onSnapshot(chatQuery, (chatSnapshot) => {
                chatSnapshot.docChanges().forEach((change) => {
                    if (change.type === "added" || change.type === "modified") {
                        const chatData = change.doc.data();
                        chatDataMap.set(change.doc.id, chatData);
                    } else if (change.type === "removed") {
                        chatDataMap.delete(change.doc.id);
                    }
                });
                renderParentList();
            }, (error) => {
                console.error("èŠå¤©ç›£è½å¤±æ•—:", error);
            });
        }

        async function createParentAccount(studentName, parentName, password) {
            if (!/^\d+$/.test(password)) { throw new Error("å¯†ç¢¼å¿…é ˆç‚ºç´”æ•¸å­—ã€‚"); }
            if (password.length < 6) { throw new Error("å®¶é•·å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½æ•¸ã€‚"); }
            
            // ç¢ºä¿å¸³è™Ÿå”¯ä¸€æ€§ï¼šçµåˆæ™‚é–“æˆ³ã€éš¨æ©Ÿæ•¸å’Œå¾®ç§’
            const now = Date.now();
            const timestamp = now.toString().slice(-6);
            const microsecond = (performance.now() * 1000).toString().split('.')[1]?.slice(0, 2) || '00';
            const randomNum = Math.floor(100 + Math.random() * 900).toString();
            const username = timestamp + microsecond + randomNum;
            const fakeEmail = `p${username}@example.com`;
            
            if (!auth.currentUser) throw new Error("æ•™å¸«æœªç™»å…¥ï¼Œç„¡æ³•å»ºç«‹å¸³è™Ÿã€‚");
            
            isCreatingAccount = true;
            const tempAppName = `creator-${Date.now()}`;
            const tempApp = initializeApp(firebaseConfig, tempAppName);
            const tempAuth = getAuth(tempApp);
            await setPersistence(tempAuth, inMemoryPersistence);

            try {
                const userCredential = await createUserWithEmailAndPassword(tempAuth, fakeEmail, password);
                const user = userCredential.user;
                
                await signOut(tempAuth);
                
                const parentData = { 
                    uid: user.uid, 
                    username, 
                    email: fakeEmail, 
                    studentName, 
                    parentName, 
                    password: password,
                    role: "parent" 
                };
                
                await setDoc(doc(db, "users", user.uid), parentData);
                
                return { success: true, username, studentName };
            } catch (error) {
                console.error("å»ºç«‹å¸³è™Ÿå¤±æ•—:", error);
                throw error;
            } finally {
                isCreatingAccount = false;
            }
        }

        let isSubmittingParent = false;
        async function handleAddSingleParent() {
            if (isSubmittingParent) return;
            isSubmittingParent = true;
            
            const submitBtn = document.querySelector('#add-parent-form button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'å»ºç«‹ä¸­...';
            
            try {
                const studentName = document.getElementById('student-name').value;
                const parentName = document.getElementById('parent-name').value;
                const password = document.getElementById('parent-password').value;
                
                if (!studentName || !parentName || !password) { 
                    await showAlert("æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«ã€‚", "æé†’"); 
                    return; 
                }
                
                const result = await createParentAccount(studentName, parentName, password);
                await showAlert(`æˆåŠŸå»ºç«‹å¸³è™Ÿï¼\nå­¸ç”Ÿ: ${result.studentName}\nç™»å…¥å¸³è™Ÿ: ${result.username}\nè«‹å°‡å¸³è™Ÿå¯†ç¢¼æä¾›çµ¦å®¶é•·ã€‚`, "å»ºç«‹æˆåŠŸ");
                document.getElementById('add-parent-form').reset();
            } catch (error) { 
                await showAlert(`éŒ¯èª¤: ${error.message}`, "éŒ¯èª¤"); 
            } finally {
                isSubmittingParent = false;
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function handleBulkImport() {
            const data = document.getElementById('bulk-import-data').value.trim();
            const lines = data.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) { return; }
            const statusEl = document.getElementById('bulk-import-status');
            statusEl.innerHTML = 'åŒ¯å…¥ä¸­...';
            const results = { success: [], failure: [] };
            for (const line of lines) {
                const parts = line.split(/[,ï¼Œ\t]/).map(p => p.trim());
                if (parts.length === 3) {
                    try {
                        const result = await createParentAccount(parts[0], parts[1], parts[2]);
                        results.success.push(`${result.studentName} (å¸³è™Ÿ: ${result.username})`);
                    } catch (error) { results.failure.push(`${parts[0]} - ${error.message}`); }
                } else { results.failure.push(`${line} - æ ¼å¼éŒ¯èª¤`); }
            }
            statusEl.innerHTML = `<b>åŒ¯å…¥å®Œæˆ</b><br>æˆåŠŸ: ${results.success.length}ç­†<br>${results.success.join('<br>')}<br><br>å¤±æ•—: ${results.failure.length}ç­†<br>${results.failure.join('<br>')}`;
            document.getElementById('bulk-import-data').value = '';
        }

        async function deleteChatHistory(chatId) {
            const messagesRef = collection(db, "chats", chatId, "messages");
            const messagesSnapshot = await getDocs(messagesRef);
            if (messagesSnapshot.empty) return;

            const batch = writeBatch(db);
            messagesSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        }

        async function handleDeleteParent(uid, name) {
            const confirmed = await showConfirm(`ç¢ºå®šè¦åˆªé™¤ [${name}] ã®å¸³è™Ÿå—ï¼Ÿ\næ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤è©²å®¶é•·çš„å¸³è™ŸåŠå…¶æ‰€æœ‰å°è©±ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚`);
            if (confirmed) {
                try {
                    const teacherUid = auth.currentUser.uid;
                    const chatId = [teacherUid, uid].sort().join('_');
                    
                    await deleteChatHistory(chatId);
                    await deleteDoc(doc(db, "chats", chatId));
                    await deleteDoc(doc(db, "users", uid));
                    
                    if(state.activeChatId === chatId) {
                        backToParentList();
                    }

                    await showAlert(`å·²æˆåŠŸåˆªé™¤ [${name}] ã®æ‰€æœ‰è³‡æ–™ã€‚`);
                } catch (error) { 
                    console.error("åˆªé™¤å®¶é•·å¤±æ•—:", error);
                    await showAlert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ Firebase å®‰å…¨è¦å‰‡æ¬Šé™æˆ–ç¶²è·¯é€£ç·šã€‚', "éŒ¯èª¤"); 
                }
            }
        }
        
        function showParentLink() {
            const modal = document.getElementById('parent-link-modal');
            const url = window.location.origin + window.location.pathname + '?mode=parents';
            const urlInput = document.getElementById('parent-url-input');
            const qrContainer = document.getElementById('qrcode-container');
            
            urlInput.value = url;
            qrContainer.innerHTML = '';
            try {
                const qr = qrcode(0, 'L');
                qr.addData(url);
                qr.make();
                qrContainer.innerHTML = qr.createImgTag(4);
            } catch (e) {
                qrContainer.innerHTML = 'QR Code ç”Ÿæˆå¤±æ•—';
            }
            modal.classList.remove('hidden');
        }
        document.getElementById('close-parent-link-btn').addEventListener('click', () => document.getElementById('parent-link-modal').classList.add('hidden'));
        document.getElementById('close-parent-link-btn-main').addEventListener('click', () => document.getElementById('parent-link-modal').classList.add('hidden'));


        function backToParentList() {
            const chatPanel = document.getElementById('chat-panel-mobile');
            const parentListPanel = document.getElementById('parent-list-panel-mobile');
            const messageInputArea = document.getElementById('message-input-area');
            
            if (window.innerWidth < 768) { // æ‰‹æ©Ÿç‰ˆ
                chatPanel.style.transform = 'translateX(100%)';
                parentListPanel.style.transform = 'translateX(0)';
                messageInputArea.classList.add('hidden');
            }
            
            if (state.unsubscribeChat) {
                state.unsubscribeChat();
                state.unsubscribeChat = null;
            }
            state.activeChatId = null;
            
            document.querySelectorAll('.parent-list-item').forEach(item => {
                item.classList.remove('selected-parent');
            });
            
            document.getElementById('chat-window').classList.add('hidden');
            document.getElementById('chat-welcome').classList.remove('hidden');
            document.getElementById('chat-with-name').querySelector('span').textContent = 'é¸æ“‡å®¶é•·é–‹å§‹å°è©±';
            
            document.getElementById('export-chat-controls').classList.add('hidden');
        }

        async function selectParentChat(parentUid, parentName) { 
            document.querySelectorAll('.parent-list-item').forEach(item => {
                item.classList.remove('selected-parent');
            });
            
            const selectedItem = document.getElementById(`parent-item-${parentUid}`);
            if (selectedItem) {
                selectedItem.classList.add('selected-parent');
            }
            
            const chatPanel = document.getElementById('chat-panel-mobile');
            const parentListPanel = document.getElementById('parent-list-panel-mobile');
            const messageInputArea = document.getElementById('message-input-area');
            
            if (window.innerWidth < 768) { // æ‰‹æ©Ÿç‰ˆ
                chatPanel.style.transform = 'translateX(0)';
                parentListPanel.style.transform = 'translateX(-100%)';
                messageInputArea.classList.remove('hidden');
            }
            
            document.getElementById('chat-welcome').classList.add('hidden'); 
            document.getElementById('chat-window').classList.remove('hidden'); 
            document.getElementById('chat-with-name').querySelector('span').textContent = `èˆ‡ ${parentName} ã®å°è©±`;
            
            document.getElementById('export-chat-controls').classList.remove('hidden'); 
            if (state.unsubscribeChat) state.unsubscribeChat(); 
            
            const chatId = [auth.currentUser.uid, parentUid].sort().join('_'); 
            state.activeChatId = chatId; 

            const chatDocRef = doc(db, "chats", chatId);
            const chatDoc = await getDoc(chatDocRef);
            if (!chatDoc.exists()) {
                await setDoc(chatDocRef, {
                    participants: [auth.currentUser.uid, parentUid],
                    teacherUnreadCount: 0,
                    lastMessage: null
                });
            } else {
                const currentUnreadCount = chatDoc.data().teacherUnreadCount || 0;
                if (currentUnreadCount > 0) {
                    await updateDoc(chatDocRef, { teacherUnreadCount: 0 });
                }
            }

            const messagesRef = collection(db, "chats", chatId, "messages"); 
            const q = query(messagesRef, orderBy("timestamp")); 
            state.unsubscribeChat = onSnapshot(q, (snapshot) => { 
                const container = document.getElementById('message-container'); 
                container.innerHTML = ''; 
                snapshot.forEach(doc => { renderMessage(doc.data(), container); }); 
                container.scrollTop = container.scrollHeight; 
            }); 
        }
        
        let isParentDashboardSetup = false;
        async function setupParentDashboard(displayName) { 
            if (isParentDashboardSetup) return;
            isParentDashboardSetup = true;
            
            document.getElementById('parent-logout-btn').addEventListener('click', () => { 
                // é‡ç½®é˜²é‡è¤‡è¨­å®šæ——æ¨™
                isParentDashboardSetup = false;
                signOut(auth); 
            }); 
            document.getElementById('parent-welcome-msg').textContent = `æ­¡è¿, ${displayName}`; 
            
            const teacherQuery = query(collection(db, "users"), where("role", "==", "teacher"));
            const teacherSnapshot = await getDocs(teacherQuery);
            
            if (teacherSnapshot.empty) {
                await showAlert("æ‰¾ä¸åˆ°æ•™å¸«å¸³è™Ÿã€‚è«‹ç¢ºèªæ•™å¸«å·²ç¶“ç™»å…¥éç³»çµ±ã€‚", "éŒ¯èª¤");
                return;
            }
            
            const teacherUid = teacherSnapshot.docs[0].id;

            const parentMessageForm = document.getElementById('parent-message-form');
            const newParentMessageForm = parentMessageForm.cloneNode(true);
            parentMessageForm.parentNode.replaceChild(newParentMessageForm, parentMessageForm);
            
            newParentMessageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('parent-message-input');
                const text = input.value.trim();
                if (text) {
                    try {
                        input.value = '';
                        const chatId = [teacherUid, state.currentUser.uid].sort().join('_');
                        await sendMessage(chatId, { 
                            type: 'text', 
                            text: text, 
                            senderId: state.currentUser.uid, 
                            senderName: displayName 
                        });
                    } catch (error) {
                        input.value = text;
                        await showAlert("ç™¼é€è¨Šæ¯å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "éŒ¯èª¤");
                    }
                }
            });
            
            const parentTextarea = document.getElementById('parent-message-input');
            if (parentTextarea) {
                parentTextarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
                parentTextarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        newParentMessageForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                });
            }

            document.getElementById('parent-image-btn').addEventListener('click', () => document.getElementById('parent-image-upload').click());
            document.getElementById('parent-image-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                const chatId = [teacherUid, state.currentUser.uid].sort().join('_');
                if (file) {
                    handleImageUpload(file, chatId, state.currentUser.uid, displayName);
                }
                e.target.value = '';
            });
            document.getElementById('parent-url-btn').addEventListener('click', () => {
                const chatId = [teacherUid, state.currentUser.uid].sort().join('_');
                handleUrlSend(chatId, state.currentUser.uid, displayName);
            });

            const chatId = [teacherUid, state.currentUser.uid].sort().join('_'); 
            
            const chatDocRef = doc(db, "chats", chatId);
            const chatDoc = await getDoc(chatDocRef);
            if (!chatDoc.exists()) {
                await setDoc(chatDocRef, {
                    participants: [teacherUid, state.currentUser.uid],
                    teacherUnreadCount: 0,
                    lastMessage: null
                });
            }

            const messagesRef = collection(db, "chats", chatId, "messages"); 
            const q = query(messagesRef, orderBy("timestamp")); 
            state.unsubscribeChat = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('parent-message-container'); 
                container.innerHTML = ''; 
                if (snapshot.empty) {
                    container.innerHTML = '<div class="p-4 text-gray-500 text-center font-bold">ç›®å‰æ²’æœ‰è¨Šæ¯ï¼Œé–‹å§‹èˆ‡æ•™å¸«å°è©±å§ï¼</div>';
                } else {
                    snapshot.forEach(doc => { 
                        renderMessage(doc.data(), container); 
                    }); 
                }
                container.scrollTop = container.scrollHeight; 
            }, (error) => {
                console.error("å®¶é•·ç«¯è¨Šæ¯ç›£è½å¤±æ•—:", error);
                const container = document.getElementById('parent-message-container');
                container.innerHTML = '<div class="p-4 text-red-500 text-center">è¨Šæ¯è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢<br>éŒ¯èª¤: ' + error.message + '</div>';
            }); 
        }
        
        async function sendMessage(chatId, messageData) {
            const chatRef = doc(db, "chats", chatId);
            
            // é¦–å…ˆæª¢æŸ¥èŠå¤©å®¤æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å»ºç«‹
            const chatDoc = await getDoc(chatRef);
            if (!chatDoc.exists()) {
                console.log("èŠå¤©å®¤ä¸å­˜åœ¨ï¼Œè‡ªå‹•å»ºç«‹:", chatId);
                const participants = chatId.split('_');
                await setDoc(chatRef, {
                    participants: participants,
                    teacherUnreadCount: 0,
                    lastMessage: null
                });
            }
            
            const batch = writeBatch(db);
            const newMsgRef = doc(collection(db, "chats", chatId, "messages"));
            batch.set(newMsgRef, { ...messageData, timestamp: serverTimestamp() });

            const lastMessage = {
                text: messageData.type === 'text' ? messageData.text.substring(0, 20) : (messageData.type === 'image' ? '[åœ–ç‰‡]' : '[é€£çµ]'),
                timestamp: serverTimestamp(),
                senderId: messageData.senderId
            };
            
            const updateData = { lastMessage };
            const updatedChatDoc = await getDoc(chatRef);
            
            const participants = updatedChatDoc.data().participants;
            if (!participants || participants.length < 2) return;
            
            const otherUserId = participants.find(p => p !== messageData.senderId);
            
            try {
                const otherUserDoc = await getDoc(doc(db, "users", otherUserId));
                if (otherUserDoc.exists()) {
                    const otherUserData = otherUserDoc.data();
                    if (otherUserData.role === 'teacher') {
                        updateData.teacherUnreadCount = increment(1);
                    }
                }
            } catch (error) {
                console.error("æŸ¥è©¢æ¥æ”¶è€…è³‡æ–™å¤±æ•—:", error);
            }
            
            batch.set(chatRef, updateData, { merge: true });
            await batch.commit();
        }

        
        function handleImageUpload(file, chatId, senderId, senderName) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    const expireDate = new Date();
                    expireDate.setDate(expireDate.getDate() + 10);
                    sendMessage(chatId, { 
                        type: 'image', 
                        base64Image: dataUrl, 
                        senderId: senderId, 
                        senderName: senderName,
                        imageExpireAt: expireDate
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function handleUrlSend(chatId, senderId, senderName) {
            const url = await showPrompt("è«‹è¼¸å…¥è¦åˆ†äº«ã®ç¶²å€ï¼š", "é™„åŠ é€£çµ", "https://");
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                await sendMessage(chatId, { type: 'url', url: url, senderId: senderId, senderName: senderName });
            } else if (url) {
                await showAlert("è«‹è¼¸å…¥æœ‰æ•ˆã®ç¶²å€ (é–‹é ­ç‚º http:// æˆ– https://)", "æ ¼å¼éŒ¯èª¤");
            }
        }

        function renderMessage(msg, container) { 
            const el = document.createElement('div'); 
            const isMe = msg.senderId === auth.currentUser.uid; 
            el.className = `flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'}`; 
            const timeString = formatTimestamp(msg.timestamp);

            let contentHtml = '';
            switch(msg.type) {
                case 'image':
                    const isExpired = isImageExpired(msg.imageExpireAt);
                    const hasImageData = msg.base64Image && msg.base64Image !== null;
                    
                    if (isExpired || !hasImageData || msg.imageCleanedAt) {
                        contentHtml = `<div class="bg-gray-200 border-2 border-dashed border-gray-400 rounded-lg p-4 text-center text-gray-500 font-bold">ğŸ“· åœ–ç‰‡å·²éæœŸ</div>`;
                    } else {
                        contentHtml = `<div><img src="${msg.base64Image}" class="rounded-lg max-w-full h-auto cursor-pointer border-2 border-black" onclick="viewImage('${msg.base64Image}')">${formatImageExpiry(msg.imageExpireAt)}</div>`;
                    }
                    break;
                case 'url':
                    contentHtml = `<a href="${msg.url}" target="_blank" rel="noopener noreferrer" class="underline font-bold">${msg.url}</a>`;
                    break;
                default: // text
                    contentHtml = `<p class="whitespace-pre-wrap break-words">${msg.text || ''}</p>`;
            }
            
            el.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                    <div class="flex items-baseline gap-2 mb-1 ${isMe ? 'justify-end' : 'justify-start'}">
                        ${!isMe ? `<p class="text-sm font-bold text-black">${msg.senderName}</p>` : ''}
                        <p class="text-xs text-gray-600">${timeString}</p>
                    </div>
                    <div class="speech-bubble ${isMe ? 'is-me' : 'is-other'}">
                        ${msg.isBroadcast ? '<span class="text-xs font-bold text-red-600 block">(ç¾¤æ’­è¨Šæ¯)</span>' : ''}
                        ${contentHtml}
                    </div>
                </div>`; 
            container.appendChild(el); 
        }
        
        window.viewImage = function(src) {
            document.getElementById('image-viewer-src').src = src;
            document.getElementById('image-viewer-modal').classList.remove('hidden');
        }
        document.getElementById('close-image-viewer-btn').addEventListener('click', () => {
            document.getElementById('image-viewer-modal').classList.add('hidden');
        });

        let isBroadcastListenerSetup = false;
        function setupBroadcastListener() {
            if (isBroadcastListenerSetup) return;
            isBroadcastListenerSetup = true;
            const broadcastModal = document.getElementById('broadcast-modal');
            const previewEl = document.getElementById('broadcast-attachment-preview');
            
            document.getElementById('broadcast-btn').addEventListener('click', () => {
                state.broadcastAttachment = null;
                previewEl.innerHTML = '';
                broadcastModal.classList.remove('hidden');
            });
            document.getElementById('cancel-broadcast-btn').addEventListener('click', () => broadcastModal.classList.add('hidden'));
            document.getElementById('cancel-broadcast-btn-close').addEventListener('click', () => broadcastModal.classList.add('hidden'));

            document.getElementById('broadcast-image-btn').addEventListener('click', () => document.getElementById('broadcast-image-upload').click());
            document.getElementById('broadcast-image-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    state.broadcastAttachment = { type: 'image', file: file };
                    previewEl.innerHTML = `å·²é™„åŠ åœ–ç‰‡: <span class="font-semibold">${file.name}</span>`;
                }
                e.target.value = '';
            });

            document.getElementById('broadcast-url-btn').addEventListener('click', async () => {
                const url = await showPrompt("è«‹è¼¸å…¥è¦åˆ†äº«ã®ç¶²å€ï¼š", "é™„åŠ é€£çµ", "https://");
                if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                    state.broadcastAttachment = { type: 'url', url: url };
                    previewEl.innerHTML = `å·²é™„åŠ é€£çµ: <span class="font-semibold">${url}</span>`;
                } else if (url) {
                    await showAlert("è«‹è¼¸å…¥æœ‰æ•ˆã®ç¶²å€ (é–‹é ­ç‚º http:// æˆ– https://)", "æ ¼å¼éŒ¯èª¤");
                }
            });

            document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('broadcast-input');
                const text = input.value.trim();

                if (!text && !state.broadcastAttachment) {
                    await showAlert("è«‹è¼¸å…¥è¨Šæ¯æˆ–é™„åŠ åœ–ç‰‡/é€£çµã€‚", "æé†’");
                    return;
                }
                
                const confirmed = await showConfirm("ç¢ºå®šè¦ç™¼é€æ­¤ç¾¤æ’­è¨Šæ¯çµ¦æ‰€æœ‰å®¶é•·å—ï¼Ÿ");
                if (!confirmed) return;

                const q = query(collection(db, "users"), where("role", "==", "parent"));
                const parentsSnapshot = await getDocs(q);
                if (parentsSnapshot.empty) { await showAlert("ç›®å‰æ²’æœ‰ä»»ä½•å®¶é•·å¯ä¾›ç™¼é€ã€‚", "æé†’"); return; }

                let messageData = {
                    senderId: auth.currentUser.uid,
                    senderName: "æ•™å¸«",
                    isBroadcast: true
                };

                if (state.broadcastAttachment) {
                    if (state.broadcastAttachment.type === 'url') {
                        messageData.type = 'url';
                        messageData.url = state.broadcastAttachment.url;
                        if (text) messageData.text = text;
                    } else if (state.broadcastAttachment.type === 'image') {
                        const file = state.broadcastAttachment.file;
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const img = new Image();
                            img.onload = async () => {
                                const canvas = document.createElement('canvas');
                                const MAX_WIDTH = 800;
                                let width = img.width; let height = img.height;
                                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                                canvas.width = width; canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                                
                                // è¨­å®š10å¤©å¾ŒéæœŸ
                                const expireDate = new Date();
                                expireDate.setDate(expireDate.getDate() + 10);
                                
                                messageData.type = 'image';
                                messageData.base64Image = dataUrl;
                                messageData.imageExpireAt = expireDate;
                                if (text) messageData.text = text;

                                const batch = writeBatch(db);
                                parentsSnapshot.forEach(parentDoc => {
                                    const parentUid = parentDoc.id;
                                    const chatId = [auth.currentUser.uid, parentUid].sort().join('_');
                                    const messageRef = doc(collection(db, "chats", chatId, "messages"));
                                    batch.set(messageRef, { ...messageData, timestamp: serverTimestamp() });
                                    batch.set(doc(db, "chats", chatId), { lastMessage: { text: '[åœ–ç‰‡]', timestamp: serverTimestamp(), senderId: auth.currentUser.uid } }, { merge: true });
                                });
                                await batch.commit();
                                await showAlert("ç¾¤æ’­è¨Šæ¯å·²æˆåŠŸç™¼é€ï¼");
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                        input.value = '';
                        broadcastModal.classList.add('hidden');
                        return; 
                    }
                } else {
                    messageData.type = 'text';
                    messageData.text = text;
                }

                const batch = writeBatch(db);
                parentsSnapshot.forEach(parentDoc => {
                    const parentUid = parentDoc.id;
                    const chatId = [auth.currentUser.uid, parentUid].sort().join('_');
                    const messageRef = doc(collection(db, "chats", chatId, "messages"));
                    batch.set(messageRef, { ...messageData, timestamp: serverTimestamp() });
                     batch.set(doc(db, "chats", chatId), { lastMessage: { text: text.substring(0,20), timestamp: serverTimestamp(), senderId: auth.currentUser.uid } }, { merge: true });
                });
                await batch.commit();
                await showAlert("ç¾¤æ’­è¨Šæ¯å·²æˆåŠŸç™¼é€ï¼");
                input.value = '';
                broadcastModal.classList.add('hidden');
            });
        }

        // --- Notification Functions ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notification");
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        function showNotification(body, title = "æ–°è¨Šæ¯") {
            if (Notification.permission === "granted") {
                new Notification(title, { body });
            }
        }

        // --- Image Cleanup Functions ---
        async function handleDeleteAllImages() {
            const confirmed = await showConfirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰å°è©±ä¸­ã®åœ–ç‰‡å—ï¼Ÿ\næ­¤æ“ä½œæœƒæ°¸ä¹…ç§»é™¤æ‰€æœ‰åœ–ç‰‡è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼");
            if (!confirmed) return;

            await showAlert("æ­£åœ¨é–‹å§‹åˆªé™¤æ‰€æœ‰åœ–ç‰‡ï¼Œè«‹ç¨å€™... è™•ç†å®Œæˆå¾Œæœƒå†æ¬¡é€šçŸ¥æ‚¨ã€‚");

            const chatsQuery = query(collection(db, "chats"));
            const chatsSnapshot = await getDocs(chatsQuery);
            let imageCount = 0;

            for (const chatDoc of chatsSnapshot.docs) {
                const messagesQuery = query(collection(db, `chats/${chatDoc.id}/messages`), where("type", "==", "image"));
                const messagesSnapshot = await getDocs(messagesQuery);
                if(!messagesSnapshot.empty) {
                    const batch = writeBatch(db);
                    messagesSnapshot.forEach(msgDoc => {
                        imageCount++;
                        batch.update(msgDoc.ref, {
                            type: "text",
                            text: "[åœ–ç‰‡å·²ç”±è€å¸«åˆªé™¤]",
                            base64Image: null
                        });
                    });
                     await batch.commit();
                }
            }

            if (imageCount > 0) {
                await showAlert(`æ“ä½œå®Œæˆï¼å…± ${imageCount} å¼µåœ–ç‰‡å·²è¢«æˆåŠŸåˆªé™¤ã€‚`);
            } else {
                await showAlert("è³‡æ–™åº«ä¸­æ²’æœ‰ä»»ä½•åœ–ç‰‡å¯ä¾›åˆªé™¤ã€‚");
            }
        }
        
        // åŒ¯å‡ºPDFåŠŸèƒ½
        async function handleExportPDF() {
            const statusEl = document.getElementById('export-status');
            statusEl.innerHTML = '<div class="text-blue-600">ğŸ”„ æ­£åœ¨ç”ŸæˆPDF...</div>';
            
            try {
                // ç²å–æ‰€æœ‰å®¶é•·è³‡æ–™
                const parentsQuery = query(collection(db, "users"), where("role", "==", "parent"));
                const querySnapshot = await getDocs(parentsQuery);
                
                if (querySnapshot.empty) {
                    statusEl.innerHTML = '<div class="text-red-600">âš ï¸ æ²’æœ‰æ‰¾åˆ°å®¶é•·è³‡æ–™</div>';
                    return;
                }
                
                const parentsData = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    if (data.studentName && data.parentName) {
                        parentsData.push({
                            studentName: data.studentName,
                            parentName: data.parentName,
                            username: data.username || 'æœªè¨­å®š',
                            password: data.password || `â—â—â—â—â—â—`, 
                            hasPassword: !!data.password,
                            docId: doc.id
                        });
                    }
                });
                
                if (parentsData.length === 0) {
                    statusEl.innerHTML = '<div class="text-red-600">âš ï¸ æ²’æœ‰æ‰¾åˆ°å¯åŒ¯å‡ºã®å®¶é•·è³‡æ–™ï¼</div>';
                    return;
                }
                
                statusEl.innerHTML = '<div class="text-blue-600">ğŸ¨ æ­£åœ¨ç¹ªè£½å¡ç‰‡...</div>';
                await generateChinesePDF(parentsData);
                
                statusEl.innerHTML = `<div class="text-green-600">âœ“ PDFå·²æˆåŠŸç”Ÿæˆä¸¦ä¸‹è¼‰ï¼å…± ${parentsData.length} ç­†è³‡æ–™</div>`;
                
            } catch (error) {
                console.error('ç”ŸæˆPDFéŒ¯èª¤:', error);
                statusEl.innerHTML = '<div class="text-red-600">âš ï¸ ç”ŸæˆPDFå¤±æ•—ï¼Œè«‹é‡è©¦</div>';
            }
        }
        
        // ä¿®å¾©èˆŠå¸³è™Ÿå¯†ç¢¼åŠŸèƒ½
        async function handleFixOldAccounts() {
            const statusEl = document.getElementById('fix-status');
            statusEl.innerHTML = '<div class="text-blue-600">ğŸ” æ­£åœ¨æª¢æŸ¥å¸³è™Ÿ...</div>';
            
            try {
                // ç²å–æ‰€æœ‰å®¶é•·è³‡æ–™
                const parentsQuery = query(collection(db, "users"), where("role", "==", "parent"));
                const querySnapshot = await getDocs(parentsQuery);
                
                if (querySnapshot.empty) {
                    statusEl.innerHTML = '<div class="text-yellow-600">âš ï¸ æ²’æœ‰æ‰¾åˆ°å®¶é•·è³‡æ–™</div>';
                    return;
                }
                
                const accountsWithoutPassword = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.studentName && data.parentName && !data.password) {
                        accountsWithoutPassword.push({
                            id: doc.id,
                            studentName: data.studentName,
                            parentName: data.parentName,
                            username: data.username
                        });
                    }
                });
                
                if (accountsWithoutPassword.length === 0) {
                    statusEl.innerHTML = '<div class="text-green-600">âœ“ æ‰€æœ‰å¸³è™Ÿéƒ½å·²æœ‰å¯†ç¢¼è¨˜éŒ„</div>';
                    return;
                }
                
                for (let account of accountsWithoutPassword) {
                    const password = await showPrompt(
                        `è«‹ç‚ºã€Œ${account.studentName}ã€ã®å®¶é•·ã€Œ${account.parentName}ã€è¨­å®šå¯†ç¢¼ï¼š`,
                        "è¨­å®šå¯†ç¢¼",
                        ""
                    );
                    
                    if (!password) {
                        statusEl.innerHTML = '<div class="text-yellow-600">âš ï¸ æ“ä½œè¢«å–æ¶ˆ</div>';
                        return;
                    }
                    
                    if (!/^\d+$/.test(password) || password.length < 6) {
                        await showAlert("å¯†ç¢¼å¿…é ˆç‚º6ä½ä»¥ä¸Šç´”æ•¸å­—ï¼", "éŒ¯èª¤");
                        statusEl.innerHTML = '<div class="text-red-600">âš ï¸ å¯†ç¢¼æ ¼å¼æˆ–é•·åº¦éŒ¯èª¤</div>';
                        return;
                    }
                    
                    try {
                        await updateDoc(doc(db, "users", account.id), {
                            password: password
                        });
                    } catch (error) {
                        statusEl.innerHTML = `<div class="text-red-600">âš ï¸ æ›´æ–° ${account.studentName} ã®å¯†ç¢¼å¤±æ•—</div>`;
                        return;
                    }
                }
                
                statusEl.innerHTML = `<div class="text-green-600">âœ“ å·²æˆåŠŸç‚º ${accountsWithoutPassword.length} å€‹å¸³è™Ÿè¨­å®šå¯†ç¢¼ï¼</div>`;
                
            } catch (error) {
                console.error('ä¿®å¾©èˆŠå¸³è™ŸéŒ¯èª¤:', error);
                statusEl.innerHTML = '<div class="text-red-600">âš ï¸ ä¿®å¾©å¤±æ•—ï¼Œè«‹é‡è©¦</div>';
            }
        }
        
        // ç”ŸæˆQR Codeçš„å‡½æ•¸
        function generateQRCode(text, size = 80) {
            const qr = qrcode(0, 'M');
            qr.addData(text);
            qr.make();
            return qr.createDataURL(4); // 4æ˜¯æ¨¡çµ„å¤§å°ï¼Œæ•¸å­—è¶Šå¤§QR Codeè¶Šå¤§
        }

        // ç”Ÿæˆä¸­æ–‡PDFã®å‡½æ•¸
        async function generateChinesePDF(parentsData) {
            if (!parentsData || parentsData.length === 0) throw new Error('æ²’æœ‰å¯ç¹ªè£½ã®è³‡æ–™');
            if (!window.html2canvas || !window.jspdf) throw new Error('PDF åº«æœªåŠ è¼‰');
            
            const container = document.createElement('div');
            container.style.cssText = 'position:absolute;left:-9999px;width:210mm;background:white;font-family:Noto Sans TC,sans-serif;padding:15mm;box-sizing:border-box';
            document.body.appendChild(container);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const cardsPerPage = 4; // æ¯é é¡¯ç¤º4å€‹å®¶é•·å¡ç‰‡
            
            // ç²å–ç•¶å‰ç¶²ç«™çš„åŸºç¤URL
            const baseUrl = window.location.origin + window.location.pathname;
            const parentUrl = `${baseUrl}?mode=parents`;
            
            for (let i = 0; i < parentsData.length; i += cardsPerPage) {
                const pageData = parentsData.slice(i, i + cardsPerPage);
                
                // ç‚ºæ¯å€‹å®¶é•·ç”ŸæˆQR Code
                const cardsWithQR = await Promise.all(pageData.map(async (p) => {
                    const qrCodeDataUrl = generateQRCode(parentUrl);
                    return {
                        ...p,
                        qrCode: qrCodeDataUrl
                    };
                }));
                
                container.innerHTML = `<h1 style="text-align:center;font-size:28px;font-weight:900;margin-bottom:10mm;">å®¶é•·ç™»å…¥è³‡è¨Š</h1><div style="display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:12mm 8mm;height:240mm;">${cardsWithQR.map(p => `
                    <div style="border:3px solid #000;padding:6mm;background:#fefae0;box-shadow:4px 4px 0 #000;display:flex;flex-direction:column;justify-content:space-between;border-radius:3mm;">
                        <div>
                            <div style="font-size:18px;font-weight:900;color:#2c3e50;">å­¸ç”Ÿï¼š${p.studentName}</div>
                            <div style="font-size:16px;margin-top:3mm;color:#34495e;">å®¶é•·ï¼š${p.parentName}</div>
                            <div style="font-size:13px;margin-top:3mm;font-family:monospace;color:#7f8c8d;">å¸³è™Ÿï¼š${p.username || 'N/A'}</div>
                            <div style="font-size:20px;font-weight:900;color:#d90429;margin-top:4mm;background:#fff;padding:2mm;border:2px solid #000;text-align:center;border-radius:2mm;">å¯†ç¢¼ï¼š${p.password || 'æœªè¨­å®š'}</div>
                        </div>
                        <div style="margin-top:4mm;border-top:2px solid #bdc3c7;padding-top:3mm;">
                            <div style="font-size:12px;font-weight:700;margin-bottom:2mm;color:#2c3e50;">å®¶é•·å°ˆç”¨ç¶²å€ï¼š</div>
                            <div style="font-size:10px;word-break:break-all;margin-bottom:3mm;color:#0066cc;background:#ecf0f1;padding:1mm;border-radius:1mm;">${parentUrl}</div>
                            <div style="display:flex;align-items:center;justify-content:center;">
                                <img src="${p.qrCode}" style="width:30mm;height:30mm;border:2px solid #34495e;border-radius:2mm;" alt="QR Code">
                            </div>
                        </div>
                    </div>`).join('')}</div>`;
                
                await new Promise(resolve => setTimeout(resolve, 200)); // å¢åŠ ç­‰å¾…æ™‚é–“è®“QR Codeæ¸²æŸ“
                
                const canvas = await html2canvas(container, { scale: 2, useCORS: true, allowTaint: true });
                if (i > 0) doc.addPage();
                doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
            }
            
            document.body.removeChild(container);
            doc.save(`å®¶é•·ç™»å…¥è³‡è¨Š_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        // --- App Entry Point ---
        const instructionsModal = document.getElementById('instructions-modal');
        const parentManagementModal = document.getElementById('parent-management-modal');

        document.getElementById('show-instructions-btn').addEventListener('click', () => instructionsModal.classList.remove('hidden'));
        document.getElementById('close-instructions-btn').addEventListener('click', () => instructionsModal.classList.add('hidden'));
        instructionsModal.addEventListener('click', (e) => { if (e.target === instructionsModal) instructionsModal.classList.add('hidden'); });

        document.getElementById('close-parent-management-btn').addEventListener('click', () => parentManagementModal.classList.add('hidden'));
        
        document.getElementById('export-chat-btn').addEventListener('click', () => {
            document.getElementById('export-chat-modal').classList.remove('hidden');
        });
        document.getElementById('close-export-modal-btn').addEventListener('click', () => {
            document.getElementById('export-chat-modal').classList.add('hidden');
        });
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            exportChatToCSV();
            document.getElementById('export-chat-modal').classList.add('hidden');
        });
        document.getElementById('export-html-btn').addEventListener('click', () => {
            exportChatToHTML();
            document.getElementById('export-chat-modal').classList.add('hidden');
        });
        
        startApp();
    </script>
</body>
</html>