<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師課堂管理整合工具(更新日1140723)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Bangers&family=Noto+Serif+TC:wght@700;900&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background-color: #64B5F6;
        }
        h1 {
            font-family: 'Bangers', cursive;
            font-size: 3.5em;
            letter-spacing: 0.1em;
            margin: 0;
            padding: 20px 0;
            color: white;
            text-shadow: 4px 4px 0px #1A237E;
            transform: rotate(-2deg);
        }
        #header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #FFA726;
            padding: 15px;
            border: 4px solid #000000;
            border-radius: 0;
            box-shadow: 8px 8px 0px #000000;
            box-sizing: border-box;
            transform: rotate(1deg);
        }
        
        .header-spacer {
            width: 120px; /* 與作業追蹤按鈕寬度相同，確保標題居中 */
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        /* 普普風日曆樣式 */
        #calendar {
            width: 100%;
            max-width: 1200px;
            background: #FFF9C4;
            padding: 30px;
            border: 4px solid #000000;
            border-radius: 0;
            box-shadow: 12px 12px 0px #000000;
            margin-top: 20px;
            box-sizing: border-box;
            margin-bottom: 20px;
            transform: rotate(-1deg);
        }
        
        #calendarHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            background: #29B6F6;
            padding: 20px 25px;
            border: 3px solid #000000;
            border-radius: 0;
            box-shadow: 6px 6px 0px #000000;
            box-sizing: border-box;
            margin-bottom: 25px;
        }
        
        #calendarHeader button {
            background: #FFA726;
            color: #000000;
            border: 3px solid #000000;
            padding: 12px 20px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            font-family: 'Noto Sans TC', sans-serif;
            box-shadow: 4px 4px 0px #000000;
            transition: all 0.1s ease;
        }
        
        #calendarHeader button:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        #calendarHeader button:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        #calendarMonth {
            font-family: 'Bangers', cursive;
            font-size: 2.5em;
            font-weight: 700;
            color: #FFFFFF;
            text-shadow: 3px 3px 0px #000000;
            text-align: center;
            flex: 1;
            letter-spacing: 0.05em;
        }
        
        #calendarDays {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 12px;
            max-width: 1200px;
        }
        
        .calendarHeaderDay {
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            font-size: 1.2em;
            text-align: center;
            background: #FF6F61;
            padding: 15px 8px;
            border: 2px solid #000000;
            border-radius: 0;
            color: #FFFFFF;
            text-shadow: 2px 2px 0px #000000;
            box-shadow: 4px 4px 0px #000000;
            position: relative;
            overflow: hidden;
        }
        
        .calendarDay {
            width: auto;
            height: 110px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            position: relative;
            background: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 0;
            box-shadow: 6px 6px 0px #000000;
            box-sizing: border-box;
            overflow: hidden;
            transition: all 0.1s ease;
        }
        
        .calendarDay:hover {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px #000000;
            background: #F0F4C3;
        }
        
        .calendarDay:active {
            transform: translate(6px, 6px);
            box-shadow: none;
        }
        
        .calendarDay > div:first-child {
            font-size: 1.4em;
            font-weight: 700;
            color: #1A237E;
            margin-bottom: 5px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* 週末樣式 - 週日和週六 */
        .calendarDay:nth-child(8n+1), .calendarDay:nth-child(8n+7) {
            background: #FFCDD2;
            border: 3px solid #000000;
        }
        
        .calendarDay:nth-child(8n+1):hover, .calendarDay:nth-child(8n+7):hover {
            background: #FFAB91;
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px #000000;
        }
        
        /* 有資料的週末 */
        .calendarDay:nth-child(8n+1).hasData, .calendarDay:nth-child(8n+7).hasData {
            background: linear-gradient(135deg, rgba(173, 216, 230, 0.9) 0%, rgba(135, 206, 250, 0.9) 100%);
            border: 1px solid rgba(30, 144, 255, 0.3);
        }
        
        .calendarDay:nth-child(8n+1).hasData:hover, .calendarDay:nth-child(8n+7).hasData:hover {
            background: linear-gradient(135deg, rgba(173, 216, 230, 0.95) 0%, rgba(135, 206, 250, 0.95) 100%);
            border: 1px solid rgba(30, 144, 255, 0.4);
        }
        
        /* 統計欄樣式 */
        .calendarDay:nth-child(8n+8) {
            background: linear-gradient(135deg, rgba(255, 228, 181, 0.9) 0%, rgba(255, 218, 155, 0.9) 100%);
            border: 1px solid rgba(255, 165, 0, 0.3);
        }
        
        .calendarDay:nth-child(8n+8):hover {
            background: linear-gradient(135deg, rgba(255, 228, 181, 0.95) 0%, rgba(255, 215, 148, 0.95) 100%);
            border: 1px solid rgba(255, 165, 0, 0.4);
        }
        /* 今天的日期樣式 */
        .today {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%) !important;
            border: 2px solid rgba(239, 68, 68, 0.5) !important;
            position: relative;
        }
        
        .today::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ef4444, #dc2626, #b91c1c, #ef4444);
            border-radius: 17px;
            z-index: -1;
            animation: todayGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes todayGlow {
            0% { opacity: 0.3; }
            100% { opacity: 0.6; }
        }
        
        .today > div:first-child {
            color: #dc2626 !important;
            font-weight: 800 !important;
            font-size: 1.6em !important;
        }
        
        /* 有資料的日期樣式 */
        .hasData {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(22, 163, 74, 0.1) 100%) !important;
            border: 1px solid rgba(34, 197, 94, 0.3) !important;
            position: relative;
        }
        
        .hasData::after {
            content: '●';
            position: absolute;
            top: 5px;
            right: 8px;
            color: #22c55e;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .hasData:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.15) 100%) !important;
            border: 1px solid rgba(34, 197, 94, 0.4) !important;
        }
        
        /* 日曆內按鈕樣式 - 小圓形設計 */
        .calendarDay .additionalText {
            display: flex;
            gap: 3px;
            justify-content: center;
            align-items: center;
            flex-wrap: nowrap; /* 確保不換行 */
        }
        
        .calendarDay button {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.9) 0%, rgba(139, 92, 246, 0.9) 100%);
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%; /* 圓形按鈕 */
            font-size: 7px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }
        
        .calendarDay button:hover {
            transform: scale(1.2);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .calendarDay .homeworkButton {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(29, 78, 216, 0.9) 100%);
        }
        
        .calendarDay .homeworkButton:hover {
            background: linear-gradient(135deg, rgba(29, 78, 216, 1) 0%, rgba(37, 99, 235, 1) 100%);
        }
        
        /* 聯絡簿按鈕 (第二個按鈕) */
        .calendarDay button:nth-of-type(2) {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.9) 0%, rgba(5, 150, 105, 0.9) 100%);
            color: yellow !important;
        }
        
        .calendarDay button:nth-of-type(2):hover {
            background: linear-gradient(135deg, rgba(5, 150, 105, 1) 0%, rgba(4, 120, 87, 1) 100%);
        }
        
        /* 檢核按鈕 (第三個按鈕) */
        .calendarDay button:nth-of-type(3) {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.9) 0%, rgba(147, 51, 234, 0.9) 100%);
            color: yellow !important;
        }
        
        .calendarDay button:nth-of-type(3):hover {
            background: linear-gradient(135deg, rgba(147, 51, 234, 1) 0%, rgba(126, 34, 206, 1) 100%);
        }
        
        /* 統計按鈕樣式調整 */
        .calendarDay .weekSummaryButton {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 0.9) 100%);
            width: 80% !important;
            height: 80% !important;
            padding: 8px !important;
            font-size: 24px !important;
            border-radius: 8px !important;
            font-weight: 600;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
        }
        
        .calendarDay .weekSummaryButton:hover {
            background: linear-gradient(135deg, rgba(217, 119, 6, 1) 0%, rgba(180, 83, 9, 1) 100%);
            transform: scale(1.05) !important;
        }
        
        /* 前一個月和下一個月的日期樣式 */
        .prevMonthDay, .nextMonthDay {
            background: linear-gradient(135deg, rgba(156, 163, 175, 0.3) 0%, rgba(209, 213, 219, 0.3) 100%) !important;
            color: #9ca3af !important;
        }
        
        .prevMonthDay > div:first-child, .nextMonthDay > div:first-child {
            color: #9ca3af !important;
        }
        #studentNamesInput {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            z-index: 1000;
        }
        #studentNamesInput h3, #studentNamesInput textarea, #studentNamesInput button {
            margin-bottom: 10px;
        }
        #studentNamesInputOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        #groupCountOverlay, #groupStudentsOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }
        #groupCount, #groupStudents {
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            text-align: left;
            position: relative;
            overflow-y: auto;
            max-height: 90%;
        }
        #groupStudents {
            width: calc(800px + 200px);
        }
        #inputSection {
            display: none;
            width: 100%;
            text-align: center;
        }
        #checklistSection {
            display: none;
            width: 100%;
            text-align: center;
        }
        textarea {
            width: 80%;
            height: 150px;
            margin-bottom: 12px;
            font-size: 16px;
            font-family: 'Noto Sans TC', sans-serif;
            padding: 12px;
            border: 3px solid #000000;
            border-radius: 0;
            background: #FFFFFF;
            box-shadow: 4px 4px 0px #000000;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            cursor: pointer;
            border: 3px solid #000000;
            border-radius: 0;
            color: #000000;
            margin: 6px;
            transition: all 0.1s ease;
            background-color: #FFEB3B;
            box-shadow: 4px 4px 0px #000000;
        }
        button:hover {
            transform: translate(2px, 2px);
            background-color: #FFF59D;
            box-shadow: 2px 2px 0px #000000;
        }
        .resetButton {
            padding: 12px 24px;
            font-size: 16px;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        .resetButton:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* header區塊其他按鈕統一樣式 */
        #header button:not(.resetButton) {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        /* 作業追蹤按鈕 */
        .homeworkTrackingButton {
            background: #4CAF50;
            color: #000000;
            border: 3px solid #000000;
            border-radius: 0;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 4px 4px 0px #000000;
        }
        
        .homeworkTrackingButton:hover {
            background: #8BC34A;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        .homeworkTrackingButton:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        /* 抽籤按鈕 */
        .lotteryButton {
            background: #E91E63;
            color: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 0;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 4px 4px 0px #000000;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .lotteryButton:hover {
            background: #F06292;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        .lotteryButton:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        /* 計時按鈕 */
        .timerButton {
            background: #9C27B0;
            color: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 0;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 4px 4px 0px #000000;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .timerButton:hover {
            background: #BA68C8;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        .timerButton:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        /* 抽籤系統樣式 */
        #lotteryOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        #lotteryPanel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #FFF9C4;
            border: 4px solid #000000;
            border-radius: 0;
            box-shadow: 12px 12px 0px #000000;
            padding: 30px;
            z-index: 1001;
            min-width: 600px;
            max-width: 80vw;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #lotteryPanel h3 {
            font-family: 'Bangers', cursive;
            font-size: 2em;
            color: #1A237E;
            text-shadow: 2px 2px 0px #FFD700;
            margin: 0 0 20px 0;
            text-align: center;
        }
        
        #lotteryStudentGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .lottery-student {
            background: #64B5F6;
            color: #000000;
            border: 3px solid #000000;
            border-radius: 0;
            padding: 15px 10px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-align: center;
            box-shadow: 4px 4px 0px #000000;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .lottery-student.drawn {
            background: #BDBDBD;
            color: #666666;
            opacity: 0.6;
        }
        
        .lottery-student.current-drawn {
            background: #64B5F6;
            color: #FF0000;
            font-weight: 900;
            animation: current-drawn-pulse 1s ease-in-out;
        }
        
        @keyframes current-drawn-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .lottery-student:hover:not(.drawn) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        .lottery-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .lottery-buttons button {
            background: #FF6B6B;
            color: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 0;
            padding: 15px 25px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            box-shadow: 4px 4px 0px #000000;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .lottery-buttons button:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        .lottery-buttons button:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        #drawButton {
            background: #4CAF50 !important;
        }
        
        #resetLotteryButton {
            background: #FF9800 !important;
            color: #000000 !important;
        }
        
        /* 抽中學生全螢幕顯示 */
        #winnerDisplay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        #winnerName {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 8vw;
            color: #FFFFFF;
            text-shadow: 6px 6px 0px #000000;
            text-align: center;
            animation: winner-bounce 0.5s ease-out;
            font-weight: 400;
        }
        
        @keyframes winner-bounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* 計時器系統樣式 */
        #timerOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        #timerPanel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #E1BEE7;
            border: 4px solid #000000;
            border-radius: 0;
            box-shadow: 12px 12px 0px #000000;
            padding: 30px;
            z-index: 1001;
            min-width: 400px;
        }
        
        #timerPanel h3 {
            font-family: 'Bangers', cursive;
            font-size: 2em;
            color: #1A237E;
            text-shadow: 2px 2px 0px #FFD700;
            margin: 0 0 20px 0;
            text-align: center;
        }
        
        .timer-presets {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .timer-presets button {
            background: #9C27B0;
            color: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 0;
            padding: 12px 20px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            box-shadow: 4px 4px 0px #000000;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .timer-presets button:hover {
            background: #BA68C8;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        .timer-custom {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
        }
        
        .timer-custom input {
            width: 60px;
            padding: 8px;
            border: 3px solid #000000;
            border-radius: 0;
            box-shadow: 2px 2px 0px #000000;
            text-align: center;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .timer-custom button {
            background: #4CAF50;
            color: #000000;
            border: 3px solid #000000;
            border-radius: 0;
            padding: 8px 15px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            box-shadow: 4px 4px 0px #000000;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .timer-controls button {
            background: #FF6B6B;
            color: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 0;
            padding: 15px 25px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            box-shadow: 4px 4px 0px #000000;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .timer-controls button:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        .timer-controls button:disabled {
            background: #BDBDBD;
            color: #666666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #startTimerButton:not(:disabled) {
            background: #4CAF50 !important;
            color: #000000 !important;
        }
        
        /* 計時器全螢幕顯示 */
        #timerDisplay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #9C27B0, #E91E63);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        #timerTime {
            font-family: 'Bangers', cursive;
            font-size: 15vw;
            color: #FFFFFF;
            text-shadow: 8px 8px 0px #000000;
            text-align: center;
            margin-bottom: 50px;
        }
        
        #timerTime.finished {
            font-family: 'Noto Serif TC', serif;
            font-weight: 900;
            font-size: 12vw;
        }
        
        #timerDisplay.tension {
            animation: tension-pulse 1s infinite;
            background: linear-gradient(45deg, #FF0000, #FF6B6B);
        }
        
        @keyframes tension-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #stopTimerButton {
            background: #FF6B6B;
            color: #FFFFFF;
            border: 4px solid #000000;
            border-radius: 0;
            padding: 20px 40px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            font-size: 1.2em;
            box-shadow: 6px 6px 0px #000000;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        #stopTimerButton:hover {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px #000000;
        }
        
        .timer-fullscreen-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        #pauseTimerButton, #resumeTimerButton {
            background: #FF9800;
            color: #000000;
            border: 4px solid #000000;
            border-radius: 0;
            padding: 20px 40px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            font-size: 1.2em;
            box-shadow: 6px 6px 0px #000000;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        #pauseTimerButton:hover, #resumeTimerButton:hover {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px #000000;
        }
        
        #resumeTimerButton {
            background: #4CAF50 !important;
            color: #FFFFFF !important;
        }
        
        /* 輸入學生姓名按鈕 */
        #header button[onclick="showStudentNamesInput()"] {
            background: #E91E63;
            color: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 0;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 4px 4px 0px #000000;
        }
        
        #header button[onclick="showStudentNamesInput()"]:hover {
            background: #F06292;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        #header button[onclick="showStudentNamesInput()"]:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        /* 學生分組按鈕 */
        #groupButton {
            background: #9C27B0;
            color: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 0;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 4px 4px 0px #000000;
        }
        
        #groupButton:hover {
            background: #BA68C8;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        #groupButton:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        /* 座位表按鈕 */
        #header button[onclick="showSeatingChart()"] {
            background: #FF9800;
            color: #000000;
            border: 3px solid #000000;
            border-radius: 0;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 4px 4px 0px #000000;
        }
        
        #header button[onclick="showSeatingChart()"]:hover {
            background: #FFCC02;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        #header button[onclick="showSeatingChart()"]:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        /* 兌獎按鈕 */
        #header button[onclick="showRedeemOverlay()"] {
            background: #F44336;
            color: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 0;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 4px 4px 0px #000000;
        }
        
        #header button[onclick="showRedeemOverlay()"]:hover {
            background: #EF5350;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        #header button[onclick="showRedeemOverlay()"]:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        .monthlySummaryButton {
            background: #CDDC39;
            color: #000000;
            border: 3px solid #000000;
            border-radius: 0;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 4px 4px 0px #000000;
        }
        .monthlySummaryButton:hover {
            background: #D4E157;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        .monthlySummaryButton:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        .scoreTable {
            margin-top: 20px;
            border-collapse: separate;
            border-spacing: 2px;
            display: inline-block;
            vertical-align: top;
            margin-right: 20px;
            background-color: transparent;
            border: 4px solid #000000;
            border-radius: 0;
            overflow: visible;
            box-shadow: 8px 8px 0px #000000;
            transition: all 0.1s ease;
        }
        
        .scoreTable:hover {
            transform: translate(4px, 4px);
            box-shadow: 4px 4px 0px #000000;
        }
        
        .groupScoreTable {
            background: #C8E6C9;
            border: 4px solid #000000;
        }
        
        .scoreTable, .scoreTable th, .scoreTable td, .groupScoreTable th, .groupScoreTable td {
            border: 2px solid #000000;
        }
        
        .scoreTable td, .groupScoreTable td {
            background: #FFFFFF;
        }
        
        .scoreTable th, .groupScoreTable th {
            background: #9C27B0;
            color: #FFFFFF;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            text-shadow: 2px 2px 0px #000000;
        }
        
        .scoreTable th, .scoreTable td, .groupScoreTable th, .groupScoreTable td {
            padding: 12px;
            text-align: center;
        }
        
        .scoreTable tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .scoreTable tbody tr:hover {
            background-color: #e3f2fd;
            transform: scale(1.02);
        }
        
        .scoreTable button {
            background: #FF5722;
            color: #FFFFFF;
            border: 2px solid #000000;
            padding: 6px 12px;
            border-radius: 0;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            transition: all 0.1s ease;
            margin: 0 3px;
            box-shadow: 3px 3px 0px #000000;
        }
        
        .scoreTable button:hover {
            background: #FF7043;
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        .scoreTable button:active {
            transform: translate(3px, 3px);
            box-shadow: none;
        }
        .highlight {
            font-weight: bold;
            color: red;
        }
        #chart {
            margin-top: 20px;
            width: 500px;
        }
        #controlSection {
            margin-top: 20px;
            text-align: center;
        }
        #footer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 14px;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }
        #footer a {
            color: #fff;
            text-decoration: none;
        }
        #footer a:hover {
            text-decoration: underline;
        }
        .batchControl {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        .batchControl input {
            margin: 0 10px;
            padding: 5px;
            font-size: 16px;
            width: 60px;
            text-align: center;
        }
        #selectedDate {
            margin-top: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }
        .weekSummaryButton {
            font-size: 24px;
            color: white;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 0.9) 100%);
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            white-space: pre-wrap;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 80%;
            width: 80%;
            font-weight: 600;
            text-align: center;
        }
        .weekSummaryButton:hover {
            background: linear-gradient(135deg, rgba(217, 119, 6, 1) 0%, rgba(180, 83, 9, 1) 100%);
            transform: scale(1.05);
        }
        #weeklySummaryOverlay, #monthlySummaryOverlay {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 60%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transform: translate(-50%, -50%);
        }
        #weeklySummaryContent, #monthlySummaryContent {
            background: white;
            width: 75%;
            height: 100%;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        #inputButton2, #saveButton2, #loadButton2, #resetButton2 {
            display: none;
        }
        .summary-text-overlay {
            position: absolute;
            top: 10px;
            left: 20px;
            width: 100px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            padding: 10px;
            text-align: left;
        }
        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }
        .control-buttons button {
            flex: 1;
        }
        .control-buttons button:first-child {
            margin-right: auto;
            background-color: #4caf50;
            color: white;
        }
        .control-buttons button:nth-child(2) {
            background-color: #2196f3;
            color: white;
        }
        .control-buttons button:nth-child(3) {
            background-color: #9c27b0;
            color: white;
        }
        
        .control-buttons button:last-child {
            margin-left: auto;
            background-color: #ff9800;
            color: white;
        }
        .bottom-buttons {
            display: flex;
            gap: 10px;
        }
        .additionalText {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            background-color: transparent;
            font-size: 25px;
            color: red;
        }
        .additionalText button {
            cursor: pointer;
            padding: 5px;
            margin: 2px;
            border: none;
            background-color: #d8f3dc;
            font-size: 15px;
            color: red;
            font-weight: bold;
            border-radius: 50%;
            width: 30px;
            height: 30px;
        }
        .additionalText button:hover {
            background-color: #c2e7c7;
        }
        .additionalText .homeworkButton {
            background-color: blue;
            color: white;
            font-size: 15px;
            font-weight: bold;
        }
        .additionalText .hide {
            display: none;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .overlayContent {
            background: #FFF9C4;
            background-image: radial-gradient(#FF5722 8%, transparent 9%),
                              radial-gradient(#FF5722 8%, transparent 9%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            padding: 25px;
            border: 4px solid #000000;
            border-radius: 0;
            text-align: center;
            position: relative;
            box-shadow: 12px 12px 0px #000000;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            color: #000000;
            max-height: 95%;
            min-height: 80%;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        .assignmentList {
            text-align: left;
            font-size: 100px;
            color: blue;
            list-style-type: none;
            padding: 0;
        }
        .status-table {
            width: 48%;
            margin: 1%;
            border-collapse: collapse;
            box-shadow: none;
            border-radius: 0;
        }
        .status-table th, .status-table td {
            border: 2px solid #000;
            padding: 10px;
            text-align: center;
            color: #333;
            font-weight: bold;
        }
        .status-table th {
            font-size: 18px;
            color: blue;
        }
        .status-table th:nth-child(2), .status-table td:nth-child(2) {
            width: 33.33%;
        }
        .status-table th:nth-child(3), .status-table td:nth-child(3) {
            width: 33.33%;
        }
        .status-table th:nth-child(4), .status-table td:nth-child(4) {
            width: 33.33%;
        }
        .status-table td {
            color: initial;
        }
        @media print {
            @page {
                size: landscape;
            }
            body {
                -webkit-print-color-adjust: exact;
            }
        }
        #tables-container table, #tables-container th, #tables-container td {
            width: 90px;
            height: 15px;
            border: 2px solid #000;
            background-color: #dcdcdc;
        }
        #tables-container th, #tables-container td {
            padding: 0;
            text-align: center;
            text-shadow: 2px 2px 4px #aaa;
            background-color: #f0e68c;
        }
        #tables-container th {
            font-weight: bold;
            border: 2px solid #000;
        }
        .status-button {
            width: 100%;
            height: 100%;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 2px 2px 4px #aaa;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: initial;
            border-radius: 4px;
            transition: background-color 0.3s ease, color 0.3s ease;
            border: 2px solid #000;
            background-color: #dcdcdc;
            margin-left: 0px;
        }
        .status-button:hover {
            opacity: 0.8;
        }
        .status-toggle-button {
            margin: 20px auto;
            padding: 12px 24px;
            font-size: 16px;
            background: linear-gradient(135deg, #9370db 0%, #7b68ee 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        .status-toggle-button:hover {
            background: linear-gradient(135deg, #7b68ee 0%, #6a5acd 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* 作業狀態表格美化 */
        #statusContainer table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 10px;
            border-collapse: collapse;
        }
        
        #statusContainer table th {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px;
            font-weight: bold;
            text-align: center;
        }
        
        #statusContainer table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        #statusContainer table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        #statusContainer table tbody tr:hover {
            background-color: #e3f2fd;
        }
        
        /* 作業檢核表格美化 */
        #tablesContainer table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 15px;
            border-collapse: collapse;
            transition: transform 0.2s ease;
        }
        
        #tablesContainer table:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        #tablesContainer table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 12px;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }
        
        #tablesContainer table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        #tablesContainer table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        #tablesContainer table tbody tr:hover {
            background-color: #e8f4fd;
        }
        
        #tablesContainer table .student-name {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            font-weight: bold;
            color: #2d3436;
            border-right: 2px solid #e17055;
        }
        
        #tablesContainer .status-button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        #tablesContainer .status-button:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }
        
        /* 學生姓名表格美化 */
        #studentTable {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            margin: 20px 0;
        }
        
        #studentTable thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        #studentTable tbody td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        #studentTable tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        #studentTable tbody tr:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            transform: scale(1.02);
            transition: all 0.3s ease;
        }
        
        #studentTable tbody tr td:first-child {
            font-weight: bold;
            color: #2c3e50;
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        }
        
        #studentTable button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        #studentTable button:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .export-button {
            padding: 12px 24px;
            font-size: 16px;
            background: linear-gradient(135deg, #008cba 0%, #005f73 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        .export-button:hover {
            background: linear-gradient(135deg, #005f73 0%, #003f4f 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* 控制按鈕統一樣式 */
        .control-buttons button:not(.status-toggle-button):not(.export-button) {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        /* 回上一頁按鈕 */
        .control-buttons button[onclick="saveAndBack()"] {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .control-buttons button[onclick="saveAndBack()"]:hover {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* 點名按鈕樣式 */
        .control-buttons button[onclick="showAttendance()"] {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .control-buttons button[onclick="showAttendance()"]:hover {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* 隱藏/顯示學生按鈕 */
        #toggleHideBtn {
            background: linear-gradient(135deg, #fd7e14 0%, #e85d04 100%);
        }
        
        #toggleHideBtn:hover {
            background: linear-gradient(135deg, #e85d04 0%, #d00000 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .highlight {
            background-color: #ADD8E6;
        }
        .tables-container-wrapper {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .import-button, .export-button-main {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .import-button {
            background: linear-gradient(135deg, #d8bfd8 0%, #c8a2c8 100%);
            color: #2c3e50;
        }
        
        .import-button:hover {
            background: linear-gradient(135deg, #c8a2c8 0%, #b899b8 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .export-button-main {
            background: linear-gradient(135deg, #c8a2c8 0%, #d8bfd8 100%);
            color: #2c3e50;
        }
        
        .export-button-main:hover {
            background: linear-gradient(135deg, #b899b8 0%, #c8a2c8 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* 側邊選單樣式 */
        #sideMenu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: #FFF9C4;
            background-image: radial-gradient(#FF5722 10%, transparent 11%),
                              radial-gradient(#FF5722 10%, transparent 11%);
            background-size: 25px 25px;
            background-position: 0 0, 12px 12px;
            border-right: 5px solid #000000;
            box-shadow: 8px 0 0px #000000;
            transition: left 0.3s ease-in-out;
            z-index: 1000;
            padding: 70px 20px 20px 20px;
            box-sizing: border-box;
            border-radius: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        #sideMenu.open {
            left: 0;
        }
        
        #menuToggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #E91E63;
            border: 4px solid #000000;
            border-radius: 0;
            width: 55px;
            height: 55px;
            font-size: 24px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            color: #FFFFFF;
            cursor: pointer;
            box-shadow: 6px 6px 0px #000000;
            transition: all 0.1s ease;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(3deg);
        }
        
        #menuToggle:hover {
            background: #F06292;
            transform: rotate(3deg) translate(3px, 3px);
            box-shadow: 3px 3px 0px #000000;
        }
        
        #menuToggle:active {
            transform: rotate(3deg) translate(6px, 6px);
            box-shadow: none;
        }
        
        .menu-button {
            width: 100%;
            margin: 7px 0;
            padding: 11px 13px;
            font-size: 14px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            border: 3px solid #000000;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 4px 4px 0px #000000;
            text-shadow: none;
            color: #000000;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 9px;
        }
        
        .menu-button:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        .menu-button:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        .menu-button.student-input {
            background: #4CAF50;
        }
        
        .menu-button.group-manage {
            background: #9C27B0;
            color: #FFFFFF;
        }
        
        .menu-button.seating-chart {
            background: #FF9800;
        }
        
        .menu-button.reward-system {
            background: #F44336;
            color: #FFFFFF;
        }
        
        .menu-button.export-data {
            background: #00BCD4;
        }
        
        .menu-button.import-data {
            background: #795548;
            color: #FFFFFF;
        }
        
        .menu-button.reset-data {
            background: #E91E63;
            color: #FFFFFF;
        }
        
        .menu-section {
            margin: 15px 0;
            border-bottom: 3px solid #000000;
            padding-bottom: 15px;
        }
        
        .menu-section:last-child {
            border-bottom: none;
        }
        
        /* 點名圖層普普風樣式 */
        #attendanceOverlay .overlayContent {
            background: #E1F5FE;
            background-image: radial-gradient(#2196F3 10%, transparent 11%),
                              radial-gradient(#2196F3 10%, transparent 11%);
            background-size: 25px 25px;
            background-position: 0 0, 12px 12px;
            border: 5px solid #000000;
            border-radius: 0;
            box-shadow: 15px 15px 0px #000000;
        }
        
        #attendanceOverlay h2 {
            text-align: center;
            color: #FFFFFF;
            background: #2196F3;
            font-family: 'Bangers', cursive;
            font-size: 28px;
            margin: -25px -25px 20px -25px;
            padding: 15px 25px;
            border-bottom: 4px solid #000000;
            text-shadow: 3px 3px 0px #000000;
            letter-spacing: 0.05em;
        }
        
        #attendanceTableContainer table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 3px;
            background: transparent;
            border-radius: 0;
            overflow: visible;
            box-shadow: none;
        }
        
        #attendanceTableContainer th {
            background: #FF6F61;
            color: #FFFFFF;
            padding: 12px 8px;
            text-align: center;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            border: 3px solid #000000;
            cursor: pointer;
            transition: all 0.1s ease;
            text-shadow: 2px 2px 0px #000000;
            box-shadow: 4px 4px 0px #000000;
        }
        
        #attendanceTableContainer th:hover {
            background: #FF8A65;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000000;
        }
        
        #attendanceTableContainer th:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        
        #attendanceTableContainer td {
            padding: 10px 8px;
            text-align: center;
            border: 2px solid #000000;
            background: #FFFFFF;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        #attendanceTableContainer td:first-child {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.9) 0%, rgba(255, 235, 59, 0.9) 100%);
            color: #2c3e50;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        #attendanceTableContainer td:first-child:hover {
            background: linear-gradient(135deg, rgba(255, 235, 59, 1) 0%, rgba(255, 193, 7, 1) 100%);
            transform: scale(1.05);
        }
        
        #attendanceTableContainer td:not(:first-child) {
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            margin: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        #attendanceTableContainer td:not(:first-child):hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* 出席狀態樣式 */
        .attendance-present {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: white !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .attendance-absent {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%) !important;
            color: white !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        .themeButton {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            transition: transform 0.3s ease;
        }
        .themeButton:hover {
            transform: scale(1.1);
        }
        .theme1 {
            background: linear-gradient(to right, #ffecd2, #fcb69f);
        }
        .theme2 {
            background: linear-gradient(to right, #3a1c71, #d76d77, #ffaf7b);
        }
        .theme3 {
            background: linear-gradient(to right, #43cea2, #185a9d);
        }
        .theme4 {
            background: linear-gradient(to right, #4568dc, #b06ab3);
        }
        .themeButtonText {
            font-size: 18px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .buttonContainer {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .status-table-bg-1 {
            background-color: #ffe4e1;
        }
        .status-table-bg-2 {
            background-color: #e6e6fa;
        }
        .status-table-bg-3 {
            background-color: #f0fff0;
        }
        .status-table-bg-4 {
            background-color: #fff5ee;
        }
        .status-table-bg-5 {
            background-color: #f5f5dc;
        }
        .student-name {
            background-color: #f0e68c;
            border: 2px solid #000;
        }
        .summarySection {
            width: 100%;
            height: 100%;
            display: flex;
            transition: transform 0.5s ease;
        }
        .summarySection > div {
            width: 100%;
            flex-shrink: 0;
        }
        .rightArrow, .leftArrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            cursor: pointer;
            border-radius: 50%;
            z-index: 10;
        }
        .rightArrow {
            right: 10px;
        }
        .leftArrow {
            left: 10px;
        }
        .groupContainer {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .group {
            background: linear-gradient(135deg, #fff9c4 0%, #f4d03f 100%);
            padding: 20px;
            border-radius: 12px;
            width: 22%;
            min-width: 180px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            border: 2px solid #f39c12;
            transition: all 0.3s ease;
        }
        .group:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border-color: #e67e22;
        }
        .group h4 {
            margin: 0 0 15px;
            font-size: 18px;
            text-align: center;
            color: #d35400;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        .group ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .group ul li {
            padding: 10px 12px;
            margin: 8px 0;
            background: linear-gradient(135deg, #ffffff 0%, #ecf0f1 100%);
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            font-weight: 500;
            color: #2c3e50;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .group ul li:hover {
            background: linear-gradient(135deg, #e8f4fd 0%, #d6eaf8 100%);
            border-color: #3498db;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        body2 {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f5e6f8;
        }
        header2 {
            background-color: #d7aefb;
            color: white;
            padding: 10px 0;
            width: 100%;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        main2 {
            width: 90%;
            max-width: 1200px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        section2 {
            margin-bottom: 20px;
        }
        h22 {
            color: #5e35b1;
        }
        button2 {
            background-color: #d7aefb;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
        }
        button2:hover {
            background-color: #ba68c8;
        }
        #inputSection2 {
            display: inline-block;
            vertical-align: top;
        }
        #selectSection2, #settingsSection2, #groupSettingsSection2 {
            display: inline-block;
            vertical-align: top;
            margin-left: 20px;
        }
        #settingsSection2, #groupSettingsSection2 {
            display: none;
        }
        #seatingChart2 {
            display: grid;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .seat2, .student-seat2 {
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            min-height: 40px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-line; /* 支援換行顯示 */
            line-height: 1.3;
            flex-direction: column;
        }
        .blackboard2 {
            grid-column: span 5;
            text-align: center;
            background-color: #5e35b1;
            color: white;
            padding: 10px;
            border-radius: 4px;
        }
        .group2 {
            border: 2px solid #d7aefb;
            border-radius: 4px;
            padding: 10px;
            margin: 10px;
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(3, 1fr);
            min-height: 150px;
        }
        .footer2 {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: #5e35b1;
        }
        .footer2 a {
            color: #5e35b1;
            text-decoration: none;
        }
        .footer2 a:hover {
            text-decoration: underline;
        }

        #homeworkTrackingContent {
            width:80%;
            height:80%;
            overflow:auto;
        }

        #seatingChartOverlay {
            display: none;
            position: fixed;
            top: 0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.5);
            justify-content:center;
            align-items:center;
            z-index:1000;
        }
        #seatingChartContent {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align:center;
            position:relative;
            box-shadow:0px 0px 10px black;
            font-weight:bold;
            color:black;
            max-height:90%;
            overflow-y:auto;
        }

        #homeworkTrackingOverlay {
            display:none;
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background:rgba(0,0,0,0.5);
            justify-content:center;
            align-items:center;
            z-index:1000;
        }
        #homeworkTrackingContent {
            background:white;
            width:80%;
            height:80%;
            overflow:auto;
            border-radius:10px;
            padding:20px;
            position:relative;
        }

        #redeemOverlay {
            display:none;
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background: radial-gradient(circle at 20px 20px, #FFD700 2px, transparent 2px),
                       radial-gradient(circle at 60px 60px, #FF69B4 2px, transparent 2px),
                       #4169E1;
            background-size: 80px 80px, 120px 120px;
            z-index:1000;
            justify-content:center;
            align-items:center;
        }
        #redeemOverlayContent {
            width:80%;
            height:80%;
            background-color:white;
            overflow:auto;
            position:relative;
            padding:20px;
            border:4px solid #000;
            box-shadow:8px 8px 0px #000;
        }
        #redeemOverlayContent h1 {
            color: #333;
            margin-bottom: 20px;
        }
        #redeemOverlayContent .container {
            max-width: 800px;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
        }
        #redeemOverlayContent table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        #redeemOverlayContent th, #redeemOverlayContent td {
            padding: 10px;
            border: 2px solid #000;
            text-align: center;
            font-family: 'Noto Sans TC', sans-serif;
        }
        #redeemOverlayContent th {
            background-color: #FFD700;
            color: #000;
            font-weight: 700;
        }
        #redeemOverlayContent .button {
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border: 3px solid #000;
            background-color: #FF69B4;
            color: #000;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            transition: transform 0.2s ease;
            box-shadow: 4px 4px 0px #000;
        }
        #redeemOverlayContent .button:hover {
            transform: translate(-2px, -2px);
        }
        #redeemOverlayContent .reset-button {
            background-color: #FF4444;
        }
        #redeemOverlayContent .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        #redeemOverlayContent .import-label {
            font-size: 16px;
            padding: 10px 15px;
            color: #000;
            background-color: #32CD32;
            border: 3px solid #000;
            cursor: pointer;
            box-shadow: 4px 4px 0px #000;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            transition: transform 0.2s ease;
            display: inline-block;
            text-align: center;
        }
        #redeemOverlayContent .import-label:hover {
            transform: translate(-2px, -2px);
        }
        #redeemOverlayContent .reset-container {
            position: fixed;
            bottom: 10px;
            left: 10px;
        }
        #redeemOverlayContent .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        #redeemOverlayContent .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            width: 300px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        #redeemOverlayContent .modal-content h3 {
            margin-top: 0;
        }
        #redeemOverlayContent .modal-content input {
            width: 80%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
		
#viewHomeworkOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 30px 30px, #FF69B4 2px, transparent 2px),
               radial-gradient(circle at 70px 70px, #32CD32 2px, transparent 2px),
               #9370DB;
    background-size: 100px 100px, 140px 140px;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

#viewHomeworkOverlay .overlayContent {
    background: white;
    padding: 20px;
    border: 4px solid #000;
    box-shadow: 8px 8px 0px #000;
    text-align: center;
    max-width: 80%;
    max-height: 80%;
    overflow: auto;
    font-family: 'Noto Sans TC', sans-serif;
}

#assignmentList {
    list-style-type: none;
    padding: 0;
}

.highlighted-assignment {
    font-size: 5rem; /* 加大字體 */
    font-weight: bold;
    color: #333;
    text-align: left;
    margin: 10px 0;
    animation: fadeIn 0.5s ease-in-out; /* 添加淡入效果 */
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
		
		
		
        
        /* 作業追蹤區塊美化 */
        .homework-search-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .homework-search-panel {
            flex: 1;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .homework-search-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .date-search-panel {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
        }
        
        .student-search-panel {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-left: 4px solid #9c27b0;
        }
        
        .homework-search-panel h4 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .homework-search-panel p {
            color: #555;
            margin-bottom: 10px;
        }
        
        .homework-search-panel input,
        .homework-search-panel select {
            border: 3px solid #000;
            padding: 8px;
            font-size: 14px;
            font-family: 'Noto Sans TC', sans-serif;
            transition: transform 0.2s ease;
            box-shadow: 2px 2px 0px #000;
        }
        
        .homework-search-panel input:focus,
        .homework-search-panel select:focus {
            outline: none;
            transform: translate(-1px, -1px);
        }
        
        .homework-search-panel button {
            background: #32CD32;
            color: #000;
            border: 3px solid #000;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            transition: transform 0.2s ease;
            box-shadow: 4px 4px 0px #000;
        }
        
        .homework-search-panel button:hover {
            transform: translate(-2px, -2px);
        }
        
        .homework-search-panel button:active {
            transform: translate(0, 0);
        }
		
    </style>
</head>
<body>
    <!-- 側邊選單切換按鈕 -->
    <button id="menuToggle" onclick="toggleSideMenu()">☰</button>
    
    <!-- 側邊選單 -->
    <div id="sideMenu">
        <div class="menu-section">
            <button class="menu-button student-input" onclick="showStudentNamesInput(); closeSideMenu();">
                👥 輸入學生姓名
            </button>
            <button class="menu-button group-manage" id="groupButton" onclick="handleGroupButtonClick(); closeSideMenu();">
                🔀 學生分組
            </button>
            <button class="menu-button seating-chart" onclick="showSeatingChart(); closeSideMenu();">
                🪑 座位表
            </button>
            <button class="menu-button reward-system" onclick="showRedeemOverlay(); closeSideMenu();">
                🏆 兌獎
            </button>
        </div>
        
        <div class="menu-section">
            <button class="menu-button export-data" onclick="exportData(); closeSideMenu();">
                📤 匯出資料
            </button>
            <button class="menu-button import-data" onclick="document.getElementById('importFile').click(); closeSideMenu();">
                📥 匯入資料
            </button>
        </div>
        
        <div class="menu-section">
            <button class="menu-button reset-data" onclick="confirmReset(); closeSideMenu();">
                🔄 重置
            </button>
        </div>
        
        <div class="menu-section">
            <h5 style="margin: 0 0 12px 0; color: #000000; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 2px 2px 0px #FFEB3B; font-family: 'Noto Sans TC', sans-serif;">主題配色</h5>
            <button class="menu-button theme-button" onclick="changeTheme('theme1'); closeSideMenu();" style="background: #FF6B6B; color: white;">
                🌅 暖陽之晨
            </button>
            <button class="menu-button theme-button" onclick="changeTheme('theme2'); closeSideMenu();" style="background: #4ECDC4; color: black;">
                🌈 繽紛繽紛
            </button>
            <button class="menu-button theme-button" onclick="changeTheme('theme3'); closeSideMenu();" style="background: #45B7D1; color: white;">
                🌿 清新一夏
            </button>
            <button class="menu-button theme-button" onclick="changeTheme('theme4'); closeSideMenu();" style="background: #A8E6CF; color: black;">
                💜 紫霞仙子
            </button>
        </div>
    </div>

    <div id="header">
        <div class="header-spacer"></div>
        <h1>教師課堂管理整合工具V3</h1>
        <div class="header-buttons">
            <button class="homeworkTrackingButton" onclick="showHomeworkTracking()">作業追蹤</button>
            <button class="lotteryButton" onclick="showLottery()">抽籤</button>
            <button class="timerButton" onclick="showTimer()">計時</button>
        </div>
    </div>

    <div id="calendar">
        <div id="calendarHeader">
            <button onclick="changeMonth(-1)">上一個月</button>
            <h2 id="calendarMonth"></h2>
            <button class="monthlySummaryButton" onclick="showMonthlySummary()">每月統計</button>
            <button onclick="changeMonth(1)">下一個月</button>
        </div>
        <div id="calendarDays">
            <div class="calendarHeaderDay">日</div>
            <div class="calendarHeaderDay">一</div>
            <div class="calendarHeaderDay">二</div>
            <div class="calendarHeaderDay">三</div>
            <div class="calendarHeaderDay">四</div>
            <div class="calendarHeaderDay">五</div>
            <div class="calendarHeaderDay">六</div>
            <div class="calendarHeaderDay">統計</div>
        </div>
    </div>
    
    <div id="studentNamesInputOverlay" onclick="hideStudentNamesInput()"></div>
    <div id="studentNamesInput">
        <h3 style="font-family: 'Noto Sans TC', sans-serif; color: #000;">輸入學生姓名，每一行一個名字<br><small style="color: #666;">提示：在姓名前加上 - 可刪除學生（如：-王小明）</small></h3>
        <textarea id="studentNames" placeholder="每行輸入一個學生姓名" style="border: 3px solid #000; font-family: 'Noto Sans TC', sans-serif; box-shadow: 4px 4px 0px #000; padding: 10px; width: 90%; height: 200px;"></textarea><br>
        <button onclick="submitNames()" style="border: 3px solid #000; background: #32CD32; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 20px; margin-top: 10px; transition: transform 0.2s ease;">送出</button>
    </div>

    <!-- 抽籤系統 -->
    <div id="lotteryOverlay" onclick="hideLottery()"></div>
    <div id="lotteryPanel">
        <h3>學生抽籤系統</h3>
        <div id="lotteryStudentGrid"></div>
        <div class="lottery-buttons">
            <button id="drawButton" onclick="drawStudent()">抽籤</button>
            <button id="resetLotteryButton" onclick="resetLottery()">全部重抽</button>
            <button onclick="hideLottery()">關閉</button>
        </div>
    </div>

    <!-- 抽中學生全螢幕顯示 -->
    <div id="winnerDisplay">
        <div id="winnerName"></div>
    </div>

    <!-- 計時器系統 -->
    <div id="timerOverlay" onclick="hideTimer()"></div>
    <div id="timerPanel">
        <h3>倒數計時器</h3>
        <div class="timer-presets">
            <button onclick="setTimer(60)">1分鐘</button>
            <button onclick="setTimer(180)">3分鐘</button>
            <button onclick="setTimer(300)">5分鐘</button>
        </div>
        <div class="timer-custom">
            <label>自訂時間：</label>
            <input type="number" id="customMinutes" min="0" max="59" value="0" placeholder="分">分
            <input type="number" id="customSeconds" min="0" max="59" value="30" placeholder="秒">秒
            <button onclick="setCustomTimer()">設定</button>
        </div>
        <div class="timer-controls">
            <button id="startTimerButton" onclick="startTimer()" disabled>開始計時</button>
            <button onclick="hideTimer()">關閉</button>
        </div>
    </div>

    <!-- 計時器全螢幕顯示 -->
    <div id="timerDisplay">
        <div id="timerTime"></div>
        <div class="timer-fullscreen-controls">
            <button id="pauseTimerButton" onclick="pauseTimer()">暫停</button>
            <button id="resumeTimerButton" onclick="resumeTimer()" style="display: none;">繼續</button>
            <button id="stopTimerButton" onclick="stopTimer()">停止</button>
        </div>
    </div>

    <div id="groupCountOverlay" onclick="hideGroupCount()">
        <div id="groupCount" onclick="event.stopPropagation()">
            <h3 style="font-family: 'Noto Sans TC', sans-serif; color: #000;">設定分組數量</h3>
            <p style="font-family: 'Noto Sans TC', sans-serif; color: #000;">設定分幾組：</p>
            <input type="number" id="groupCountInput" value="2" min="1" style="border: 3px solid #000; font-family: 'Noto Sans TC', sans-serif; box-shadow: 2px 2px 0px #000; padding: 8px; margin: 10px;">
            <button onclick="submitGroupCount()" style="border: 3px solid #000; background: #32CD32; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 20px; margin: 5px; transition: transform 0.2s ease;">送出</button>
            <button id="adjustGroupsButton" style="display: none; border: 3px solid #000; background: #FFD700; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 20px; margin: 5px; transition: transform 0.2s ease;" onclick="showGroupStudents()">調整分組</button>
        </div>
    </div>
    
    <div id="groupStudentsOverlay" onclick="hideGroupStudents()">
        <div id="groupStudents" onclick="event.stopPropagation()">
            <h3 style="font-family: 'Noto Sans TC', sans-serif; color: #000;">設定分組</h3>
            <div id="groupContainer" class="groupContainer"></div>
            <button onclick="submitGroups()" style="border: 3px solid #000; background: #32CD32; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 20px; margin: 10px; transition: transform 0.2s ease;">送出</button>
            <button id="adjustGroupsButton" style="display: none; border: 3px solid #000; background: #FFD700; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 20px; margin: 10px; transition: transform 0.2s ease;" onclick="adjustGroups()">調整分組</button>
        </div>
    </div>

    <div id="inputSection">
        <div id="controlSection" class="control-buttons">
            <button onclick="goBack()" style="border: 3px solid #000; background: #FF69B4; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 15px; transition: transform 0.2s ease;">回上一頁</button>
            <button onclick="showScoreSection()" style="border: 3px solid #000; background: #32CD32; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 15px; transition: transform 0.2s ease;">加扣分</button>
            <button onclick="showChartSection()" style="border: 3px solid #000; background: #FFD700; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 15px; transition: transform 0.2s ease;">呈現直條圖</button>
			<button onclick="showAttendance()" style="border: 3px solid #000; background: #FF4444; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 15px; transition: transform 0.2s ease;">點名</button>

        </div>
        <div id="selectedDate"></div>
        <div id="scoreSection" class="centered-section">
            <div id="studentScoreTable"></div>
            <div id="groupScoreTable"></div>
        </div>
        <div id="chartSection">
            <canvas id="chart"></canvas>
        </div>
    </div>

    <div id="checklistSection">
        <div class="control-buttons">
            <button onclick="saveAndBack()" style="border: 3px solid #000; background: #FF69B4; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 15px; transition: transform 0.2s ease;">回上一頁</button>
            <button class="status-toggle-button" onclick="toggleStatusTables()" style="border: 3px solid #000; background: #32CD32; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 15px; transition: transform 0.2s ease;">作業狀態</button>
            <button class="export-button" onclick="exportImage()" style="border: 3px solid #000; background: #FFD700; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 15px; transition: transform 0.2s ease;">匯出圖片</button>
	    <button onclick="toggleHideStudents()" id="toggleHideBtn" style="border: 3px solid #000; background: #9370DB; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 15px; transition: transform 0.2s ease;">隱藏已繳交作業學生</button>
        </div>
        <h3 id="checklistDate"></h3>
        <div id="statusContainer" style="display: none; flex-wrap: wrap; justify-content: space-between; background-color: white;"></div>
        <div class="tables-container-wrapper">
            <div id="tablesContainer" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
        </div>
    </div>

    <div id="weeklySummaryOverlay" class="overlay" onclick="hideWeeklySummary()">
        <div id="weeklySummaryContent" class="overlayContent" onclick="event.stopPropagation()">
            <div class="summary-text-overlay" id="weeklySummaryText">每週統計</div>
            <div class="summarySection">
                <div id="weeklyScoreSection"></div>
                <canvas id="weeklyChart" style="width: 50%; height: 175px;"></canvas>
            </div>
            <div class="rightArrow" onclick="slideRight('weeklySummaryContent')">&#9654;</div>
            <div class="leftArrow" onclick="slideLeft('weeklySummaryContent')" style="display: none;">&#9664;</div>
        </div>
    </div>

    <div id="monthlySummaryOverlay" class="overlay" onclick="hideWeeklySummary()">
        <div id="monthlySummaryContent" class="overlayContent" onclick="event.stopPropagation()">
            <div class="summary-text-overlay" id="monthlySummaryText">每月統計</div>
            <div class="summarySection">
                <div id="monthlyScoreSection"></div>
                <canvas id="monthlyChart" style="width: 50%; height: 175px;"></canvas>
            </div>
            <div class="rightArrow" onclick="slideRight('monthlySummaryContent')">&#9654;</div>
            <div class="leftArrow" onclick="slideLeft('monthlySummaryContent')" style="display: none;">&#9664;</div>
        </div>
    </div>

    <div id="footer">
        Designed by <a href="https://kentxchang.blogspot.tw" target="_blank">阿剛老師</a>
    </div>

    <div id="homeworkOverlay" class="overlay" onclick="hideOverlay(event, 'homeworkOverlay')">
        <div class="overlayContent" onclick="event.stopPropagation()" style="max-height: 60%; min-height: 40%;">
            <h3 id="homeworkDate"></h3>
            <textarea id="homeworkText" placeholder="每行輸入一項作業" style="width: 90%; height: 200px; border: 3px solid #000; font-family: 'Noto Sans TC', sans-serif; box-shadow: 4px 4px 0px #000; padding: 10px;"></textarea><br>
            <button onclick="submitHomework()" style="border: 3px solid #000; background: #32CD32; color: #000; font-family: 'Noto Sans TC', sans-serif; font-weight: 700; box-shadow: 4px 4px 0px #000; padding: 10px 20px; margin-top: 15px; transition: transform 0.2s ease;">送出</button>
        </div>
    </div>

    <div id="viewHomeworkOverlay" class="overlay" onclick="hideOverlay(event, 'viewHomeworkOverlay')">
        <div class="overlayContent" onclick="event.stopPropagation()">
            <ul id="assignmentList" class="homeworkContent"></ul>
            <h3 id="viewHomeworkDate"></h3>
        </div>
    </div>

<!-- 點名 Overlay -->
<div id="attendanceOverlay" class="overlay" onclick="hideAttendance()">
    <div id="attendanceContent" class="overlayContent" onclick="event.stopPropagation()" style="width: 90%; max-height: 80%; overflow-y: auto;">
        <h2>今日點名紀錄</h2>
        <div id="attendanceTableContainer"></div>
    </div>
</div>


    <!-- 隱藏的檔案輸入，給側邊選單的匯入功能使用 -->
    <input type="file" id="importFile" style="display: none;" onchange="importData(event)">


    <div id="seatingChartOverlay" class="overlay" onclick="hideSeatingChart()">
        <div id="seatingChartContent" class="overlayContent" onclick="event.stopPropagation()">
            <header2>
                <h1>教室座位表生成器</h1>
            </header2>
            <main2>
                <div id="inputSection2">
                    <section2>
                        <h22></h22>
                        <button2 id="inputButton2">輸入學生</button2>
                    </section2>
                </div>
                <div id="selectSection2">
                    <section2>
                        <h22>選擇分組方式</h22>
                        <label>分組方式：
                            <select id="groupingMethod2">
                                <option value="">請選擇</option>
                                <option value="byColumn">按列分組</option>
                                <option value="byGroup">按組分組</option>
                            </select>
                        </label>
                    </section2>
                </div>
                <div id="settingsSection2">
                    <section2>
                        <h22>座位表設置</h22>
                        <label>列數：<input type="number" id="columns2" min="1" value="5"></label>
                        <button2 id="generateButton2">生成座位表</button2>
                    </section2>
                </div>
                <div id="groupSettingsSection2">
                    <section2>
                        <h22>分組設置</h22>
                        <label>組數：<input type="number" id="groups2" min="1" max="9" value="9"></label>
                        <button2 id="groupButton2">按組排列座位</button2>
                    </section2>
                </div>
                <section2>
                    <h22>座位表</h22>
                    <div id="seatingChart2"></div>
                </section2>
                <section2>
                    <h22>選項</h22>
                    <button2 id="saveButton2">保存座位表</button2>
                    <button2 id="loadButton2">加載座位表</button2>
                    <button2 id="previewButton2">預覽座位表</button2>
                    <button2 id="resetButton2">重置</button2>
                </section2>
            </main2>
        </div>
    </div>

    <div id="homeworkTrackingOverlay" class="overlay" onclick="hideHomeworkTracking()">
        <div id="homeworkTrackingContent" class="overlayContent" onclick="event.stopPropagation()">
            <h3>作業追蹤</h3>
            <div class="homework-search-container">
                <div class="homework-search-panel date-search-panel">
                    <h4>依日期區間搜尋未完成</h4>
                    <p>選擇日期區間：</p>
                    <input type="date" id="homeworkTrackingStart" /> 到 <input type="date" id="homeworkTrackingEnd" />
                    <br><br>
                    <button onclick="searchHomeworkTracking()">搜尋</button>
                </div>
                <div class="homework-search-panel student-search-panel">
                    <h4>依學生查詢未完成</h4>
                    <p>選擇學生：</p>
                    <select id="studentHomeworkSelect" style="padding: 5px;"></select>
                    <button onclick="searchHomeworkByStudent()">查詢</button>
                </div>
            </div>
            <div id="homeworkTrackingResult" style="margin-top:20px; text-align:left; position:relative; max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="redeemOverlay" class="overlay" onclick="hideRedeemOverlay()">
        <div id="redeemOverlayContent" onclick="event.stopPropagation()">
            <h1>學生加扣分管理與兌換獎勵工具</h1>
            <div class="container">
                <div class="top-bar">
                    <label class="import-label" onclick="renderStudentTable()">更新資料顯示</label>
                    <div>
                        <button onclick="sortTableByGroup()" class="button">按小組排序</button>
                        <button onclick="sortTableByScore()" class="button">按得分排序</button>
                    </div>
                </div>

                <table id="studentTable">
                    <thead>
                        <tr>
                            <th>學生姓名</th>
                            <th>總得分</th>
                            <th>兌換獎勵</th>
                            <th>兌換記錄</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <button onclick="saveRedemptionHistoryAsDoc()" class="button">另存兌獎紀錄</button>
            </div>

            <div class="reset-container">
                <button onclick="resetRedemptionData()" class="button reset-button">重置本頁兌換紀錄</button>
            </div>

            <div class="modal-overlay" id="redeemModal">
                <div class="modal-content">
                    <h3>兌換獎勵</h3>
                    <input type="number" id="redeemPoints" placeholder="輸入兌換分數" min="1">
                    <input type="text" id="redeemContent" placeholder="輸入兌換內容 (可選)">
                    <button onclick="confirmRedeem()" class="button" style="margin-top: 10px;">確認兌換</button>
                    <button onclick="closeModal()" class="button reset-button" style="margin-top: 10px;">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>
    <script>
        const backgroundColors = ['#FFFACD', '#FFDAB9', '#E6E6FA', '#E0FFFF', '#F0E68C'];
        document.body.style.backgroundColor = backgroundColors[Math.floor(Math.random() * backgroundColors.length)];

        const fileName = window.location.pathname.split("/").pop().split(".")[0];
        const localStoragePrefix = `${fileName}_`;

        let students = JSON.parse(localStorage.getItem(localStoragePrefix + 'students')) || [];
        let scores = JSON.parse(localStorage.getItem(localStoragePrefix + 'scores')) || {};
        let homeworks = JSON.parse(localStorage.getItem(localStoragePrefix + 'homeworks')) || {};
        let groups = JSON.parse(localStorage.getItem(localStoragePrefix + 'groups')) || {};
        let redemptionHistory = JSON.parse(localStorage.getItem(localStoragePrefix + 'redemptionHistory')) || {};

        let chart;
        let weeklyChart;
        let monthlyChart;
        let currentMonth = new Date();
        let currentDay = null;
        let scoresChanged = false;

	let hideCompletedStudents = false;

        let savedTheme = localStorage.getItem(localStoragePrefix + 'selectedTheme');
        if (savedTheme) {
            changeTheme(savedTheme);
        }

        // 初始化函數
        function initializeApp() {
            document.getElementById('calendar').style.display = 'block';
            document.getElementById('header').style.display = 'flex';
            showSideMenuToggle(); // 顯示側邊選單按鈕
            renderCalendar();
        }
        
        // 確保DOM完全載入後再執行初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // 側邊選單功能
        function toggleSideMenu() {
            const sideMenu = document.getElementById('sideMenu');
            
            if (sideMenu.classList.contains('open')) {
                sideMenu.classList.remove('open');
            } else {
                sideMenu.classList.add('open');
            }
        }
        
        function closeSideMenu() {
            const sideMenu = document.getElementById('sideMenu');
            sideMenu.classList.remove('open');
        }
        
        function showSideMenuToggle() {
            document.getElementById('menuToggle').style.display = 'flex';
        }
        
        function hideSideMenuToggle() {
            document.getElementById('menuToggle').style.display = 'none';
            closeSideMenu(); // 確保選單也關閉
        }

        function showStudentNamesInput() {
            document.getElementById('studentNamesInput').style.display = 'block';
            document.getElementById('studentNamesInputOverlay').style.display = 'block';
        }

        function hideStudentNamesInput() {
            document.getElementById('studentNamesInput').style.display = 'none';
            document.getElementById('studentNamesInputOverlay').style.display = 'none';
        }

        function handleGroupButtonClick() {
            if (Object.keys(scores).length > 0) {
                if (confirm("分組已有加扣分資料，重新分組將清除所有組別分數記錄。是否繼續？")) {
                    clearGroupScores();
                    showGroupCount();
                }
            } else {
                showGroupCount();
            }
        }

        function clearGroupScores() {
            Object.keys(scores).forEach(dateKey => {
                Object.keys(scores[dateKey]).forEach(key => {
                    if (key.startsWith('group-')) {
                        delete scores[dateKey][key];
                    }
                });
            });
            localStorage.setItem(localStoragePrefix + 'scores', JSON.stringify(scores));
            updateScoreTables();
        }

        function showGroupCount() {
            document.getElementById('groupCountOverlay').style.display = 'flex';
            if (Object.keys(groups).length > 0) {
                document.getElementById('adjustGroupsButton').style.display = 'block';
            } else {
                document.getElementById('adjustGroupsButton').style.display = 'none';
            }
        }

        function hideGroupCount() {
            document.getElementById('groupCountOverlay').style.display = 'none';
        }

        function showGroupStudents() {
            document.getElementById('groupStudentsOverlay').style.display = 'flex';
            renderGroups();
        }

        function hideGroupStudents() {
            document.getElementById('groupStudentsOverlay').style.display = 'none';
        }


	    function toggleHideStudents() {
        hideCompletedStudents = !hideCompletedStudents;
        const toggleBtn = document.getElementById('toggleHideBtn');
        if (hideCompletedStudents) {
            toggleBtn.textContent = '顯示已繳交作業學生';
        } else {
            toggleBtn.textContent = '隱藏已繳交作業學生';
        }
        const rows = document.querySelectorAll('#tablesContainer table tbody tr');
        rows.forEach(row => {
            const statusButtons = row.querySelectorAll('.status-button');
            let allCompleted = true;
            statusButtons.forEach(btn => {
                const bgColor = btn.style.backgroundColor;
                if (bgColor !== 'green' && bgColor !== 'blue') {
                    allCompleted = false;
                }
            });
            if (hideCompletedStudents && allCompleted) {
                row.style.display = 'none';
            } else {
                row.style.display = '';
            }
        });
    }

        function submitNames() {
            const names = document.getElementById('studentNames').value.trim().split('\n').map(name => name.trim());
            const studentsToAdd = [];
            const studentsToRemove = [];
            
            names.forEach(name => {
                if (name === '') return; // 忽略空行
                
                if (name.startsWith('-')) {
                    // 刪除學生 (移除 - 符號)
                    const studentToRemove = name.substring(1).trim();
                    if (studentToRemove && students.includes(studentToRemove)) {
                        studentsToRemove.push(studentToRemove);
                    }
                } else {
                    // 添加學生
                    if (!students.includes(name)) {
                        studentsToAdd.push(name);
                    }
                }
            });
            
            // 刪除學生
            studentsToRemove.forEach(studentName => {
                const index = students.indexOf(studentName);
                if (index > -1) {
                    students.splice(index, 1);
                    
                    // 從所有分組中移除該學生
                    Object.keys(groups).forEach(groupIndex => {
                        if (groups[groupIndex]) {
                            const studentIndex = groups[groupIndex].indexOf(studentName);
                            if (studentIndex > -1) {
                                groups[groupIndex].splice(studentIndex, 1);
                            }
                        }
                    });
                    
                    // 從所有分數記錄中移除該學生
                    Object.keys(scores).forEach(dateKey => {
                        if (scores[dateKey] && scores[dateKey][studentName] !== undefined) {
                            delete scores[dateKey][studentName];
                        }
                    });
                    
                    // 從兌獎記錄中移除該學生
                    if (redemptionHistory[studentName]) {
                        delete redemptionHistory[studentName];
                    }
                }
            });
            
            // 添加新學生
            studentsToAdd.forEach(name => {
                students.push(name);
            });
            
            // 自動分配新學生到分組
            if (studentsToAdd.length > 0) {
                autoAssignNewStudents(studentsToAdd);
            }
            
            // 儲存所有更新
            localStorage.setItem(localStoragePrefix + 'students', JSON.stringify(students));
            localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
            localStorage.setItem(localStoragePrefix + 'scores', JSON.stringify(scores));
            localStorage.setItem(localStoragePrefix + 'redemptionHistory', JSON.stringify(redemptionHistory));
            
            hideStudentNamesInput();
            renderCalendar();
            
            // 顯示操作結果
            if (studentsToAdd.length > 0 || studentsToRemove.length > 0) {
                let message = '';
                if (studentsToAdd.length > 0) {
                    message += `新增學生：${studentsToAdd.join(', ')}\n`;
                }
                if (studentsToRemove.length > 0) {
                    message += `刪除學生：${studentsToRemove.join(', ')}\n`;
                }
                alert(message.trim());
            }
        }

        function autoAssignNewStudents(newStudents) {
            // 如果沒有分組，先建立一個預設分組
            if (Object.keys(groups).length === 0) {
                groups['0'] = [];
            }
            
            newStudents.forEach(student => {
                let minGroupIndex = 0;
                let minGroupSize = Infinity;
                Object.keys(groups).forEach(groupIndex => {
                    if (groups[groupIndex] && groups[groupIndex].length < minGroupSize) {
                        minGroupSize = groups[groupIndex].length;
                        minGroupIndex = groupIndex;
                    }
                });
                
                // 確保目標分組存在
                if (!groups[minGroupIndex]) {
                    groups[minGroupIndex] = [];
                }
                
                groups[minGroupIndex].push(student);
            });
            localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
        }

        function renderCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = `
                <div class="calendarHeaderDay">日</div>
                <div class="calendarHeaderDay">一</div>
                <div class="calendarHeaderDay">二</div>
                <div class="calendarHeaderDay">三</div>
                <div class="calendarHeaderDay">四</div>
                <div class="calendarHeaderDay">五</div>
                <div class="calendarHeaderDay">六</div>
                <div class="calendarHeaderDay">統計</div>
            `;
            const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const firstDayIndex = firstDayOfMonth.getDay();
            const lastDayIndex = lastDayOfMonth.getDay();
            const prevLastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 0).getDate();
            const lastDay = lastDayOfMonth.getDate();
            const today = new Date();
            let weekDayCount = 0;

            document.getElementById('calendarMonth').textContent = currentMonth.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });

            for (let i = firstDayIndex; i > 0; i--) {
                const day = document.createElement('div');
                day.classList.add('calendarDay');
                day.classList.add('prevMonthDay');
                day.textContent = prevLastDay - i + 1;
                calendarDays.appendChild(day);
                weekDayCount++;
            }

            for (let i = 1; i <= lastDay; i++) {
                const day = document.createElement('div');
                day.classList.add('calendarDay');
                const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${i}`;
                day.innerHTML = `<div onclick="showDailyScoreSection(${i})">${i}</div>
                                <div class="additionalText">
                                    <button class="homeworkButton" onclick="showHomeworkOverlay(event, '${dateKey}')">作</button>
                                    <button class="hide" onclick="showViewHomeworkOverlay(event, '${dateKey}')">聯</button>
                                    <button class="hide" onclick="showChecklistSection('${dateKey}')">檢</button>
                                </div>`;
                if (today.getFullYear() === currentMonth.getFullYear() && 
                    today.getMonth() === currentMonth.getMonth() && 
                    today.getDate() === i) {
                    day.classList.add('today');
                }
                if (homeworks[dateKey]) {
                    day.querySelector(".homeworkButton").nextElementSibling.classList.remove('hide');
                    day.querySelector(".homeworkButton").nextElementSibling.nextElementSibling.classList.remove('hide');
                }
                if (scores[dateKey]) {
                    day.classList.add('hasData');
                }
                calendarDays.appendChild(day);
                weekDayCount++;
                if (weekDayCount === 7) {
                    const weekSummary = document.createElement('div');
                    weekSummary.classList.add('calendarDay');
                    weekSummary.innerHTML = `<button class="weekSummaryButton" onclick="showWeeklySummary(${i - 6}, ${i})">每週\n統計</button>`;
                    calendarDays.appendChild(weekSummary);
                    weekDayCount = 0;
                }
            }

            for (let i = 1; i < 7 - lastDayIndex; i++) {
                const day = document.createElement('div');
                day.classList.add('calendarDay');
                day.classList.add('nextMonthDay');
                day.textContent = i;
                calendarDays.appendChild(day);
                weekDayCount++;
                if (weekDayCount === 7) {
                    const weekSummary = document.createElement('div');
                    weekSummary.classList.add('calendarDay');
                    weekSummary.innerHTML = `<button class="weekSummaryButton" onclick="showWeeklySummary(${lastDay + i - 6}, ${lastDay + i})">每週\n統計</button>`;
                    calendarDays.appendChild(weekSummary);
                    weekDayCount = 0;
                }
            }

            if (Object.keys(scores).length > 0) {
                document.getElementById('groupButton').textContent = '已分組';
            }
        }

        function changeMonth(months) {
            currentMonth.setMonth(currentMonth.getMonth() + months);
            renderCalendar();
        }

        function showDailyScoreSection(day) {
            currentDay = day;
            scoresChanged = false;
            document.getElementById('selectedDate').textContent = `日期: ${currentMonth.getFullYear()}${(currentMonth.getMonth() + 1).toString().padStart(2, '0')}${day.toString().padStart(2, '0')}`;
            document.getElementById('calendar').style.display = 'none';
            document.getElementById('header').style.display = 'none';
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('controlSection').style.display = 'flex';
            hideSideMenuToggle();
            updateScoreTables();
            showScoreSection();
        }

        function showScoreSection() {
            document.getElementById('scoreSection').style.display = 'block';
            document.getElementById('chartSection').style.display = 'none';
        }

        function showChartSection() {
            document.getElementById('scoreSection').style.display = 'none';
            document.getElementById('chartSection').style.display = 'block';
            renderChart();
        }

        function goBack() {
            if (scoresChanged) {
                const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
                const dayElement = [...document.getElementsByClassName('calendarDay')].find(day => day.innerHTML.includes(`showDailyScoreSection(${currentDay})`));
                if (dayElement) {
                    dayElement.classList.add('hasData');
                }
            }
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('checklistSection').style.display = 'none';
            document.getElementById('calendar').style.display = 'block';
            document.getElementById('header').style.display = 'flex';
            showSideMenuToggle();
        }

/* -------------------------------------
   (C) 點名功能的變數與初始化
------------------------------------- */
// 用來儲存各日期的點名資料
// 格式預計: attendanceRecords[dateKey][studentName][periodIndex] = 'red' or 'green'
let attendanceRecords = JSON.parse(localStorage.getItem(localStoragePrefix + 'attendanceRecords')) || {};

/* -------------------------------------
   (C1) 顯示與隱藏「點名」Overlay
------------------------------------- */
function showAttendance() {
    // 取得目前操作的日期 (與加扣分相同)
    const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
    
    // 若此 dateKey 尚未初始化，就先建一個空物件
    if (!attendanceRecords[dateKey]) {
        attendanceRecords[dateKey] = {};
    }

    // 產生點名表格
    renderAttendanceTable(dateKey);

    // 顯示 Overlay
    document.getElementById('attendanceOverlay').style.display = 'flex';
}

function hideAttendance() {
    document.getElementById('attendanceOverlay').style.display = 'none';
}

/* -------------------------------------
   (C2) 產生點名表格
------------------------------------- */
function renderAttendanceTable(dateKey) {
    const container = document.getElementById('attendanceTableContainer');
    container.innerHTML = '';  // 清空

    // 假設「8節課」，可根據需要調整
    const totalPeriods = 8;

    // 建立表格
    const table = document.createElement('table');

    // 產生表頭
    const thead = table.createTHead();
    const headRow = thead.insertRow();

    // 左上角空白，並設置點擊事件以選擇所有學生
    let th = document.createElement('th');
    th.textContent = '學生\\節次';
    th.onclick = () => toggleAllStudentsAttendance(dateKey);
    headRow.appendChild(th);

    // 建立 8 節課的欄位，並設置點擊事件以選擇所有學生在該節次
    for (let p = 1; p <= totalPeriods; p++) {
        let thP = document.createElement('th');
        thP.textContent = `第${p}節`;
        thP.onclick = () => toggleAllPeriodsAttendance(dateKey, p);
        headRow.appendChild(thP);
    }

    // 產生表身 (學生列表)
    const tbody = table.createTBody();

    students.forEach(student => {
        // 若該學生尚無紀錄，先初始化
        if (!attendanceRecords[dateKey]) {
            attendanceRecords[dateKey] = {};
        }
        if (!attendanceRecords[dateKey][student]) {
            attendanceRecords[dateKey][student] = {};
        }

        const row = tbody.insertRow();

        // 第一格放學生姓名，並設置點擊事件以切換該學生所有節次
        const nameCell = row.insertCell();
        nameCell.textContent = student;
        nameCell.onclick = () => toggleStudentAttendance(dateKey, student);

        // 產生 8 個節次的儲存格
        for (let p = 1; p <= totalPeriods; p++) {
            if (!attendanceRecords[dateKey][student][p]) {
                // 預設為 'red' (X)
                attendanceRecords[dateKey][student][p] = 'red';
            }

            const cell = row.insertCell();

            // 根據目前紀錄給予底色與文字
            const color = attendanceRecords[dateKey][student][p];
            cell.className = (color === 'red') ? 'attendance-absent' : 'attendance-present';
            cell.textContent = (color === 'red') ? '✗' : '✓';

            // 點擊切換
            cell.onclick = () => {
                toggleAttendance(dateKey, student, p, cell);
            };
        }
    });

    container.appendChild(table);

    // 同步存檔
    localStorage.setItem(localStoragePrefix + 'attendanceRecords', JSON.stringify(attendanceRecords));
}



/* -------------------------------------
   (C3) 點擊切換出席狀態
------------------------------------- */
function toggleAttendance(dateKey, student, period, cell) {
    // 若原本是 'red' => 切成 'green'
    // 若原本是 'green' => 切回 'red'
    const current = attendanceRecords[dateKey][student][period];
    const newStatus = (current === 'red') ? 'green' : 'red';
    attendanceRecords[dateKey][student][period] = newStatus;

    // 即時更新畫面
    cell.className = (newStatus === 'red') ? 'attendance-absent' : 'attendance-present';
    cell.textContent = (newStatus === 'red') ? '✗' : '✓';

    // 存回 localStorage
    localStorage.setItem(localStoragePrefix + 'attendanceRecords', JSON.stringify(attendanceRecords));
}

/* -------------------------------------
   (C4) 批次點名功能
------------------------------------- */

/**
 * 點擊學生姓名時，切換該學生所有節次的點名狀態
 * @param {string} dateKey - 日期鍵值
 * @param {string} student - 學生姓名
 */
function toggleStudentAttendance(dateKey, student) {
    const totalPeriods = 8; // 節次數，可根據需求調整
    let allPresent = true;

    // 檢查是否所有節次已點名
    for (let p = 1; p <= totalPeriods; p++) {
        if (attendanceRecords[dateKey][student][p] !== 'green') {
            allPresent = false;
            break;
        }
    }

    // 根據當前狀態決定要切換為哪一種狀態
    const newStatus = allPresent ? 'red' : 'green';

    for (let p = 1; p <= totalPeriods; p++) {
        attendanceRecords[dateKey][student][p] = newStatus;
    }

    // 更新畫面
    const row = Array.from(document.querySelectorAll('#attendanceTableContainer table tbody tr'))
        .find(r => r.querySelector('td').textContent === student);

    if (row) {
        for (let p = 1; p <= totalPeriods; p++) {
            const cell = row.cells[p];
            cell.className = (newStatus === 'red') ? 'attendance-absent' : 'attendance-present';
            cell.textContent = (newStatus === 'red') ? '✗' : '✓';
        }
    }

    // 存回 localStorage
    localStorage.setItem(localStoragePrefix + 'attendanceRecords', JSON.stringify(attendanceRecords));
}

/**
 * 點擊節次標題時，切換所有學生在該節次的點名狀態
 * @param {string} dateKey - 日期鍵值
 * @param {number} period - 節次
 */
function toggleAllPeriodsAttendance(dateKey, period) {
    let allPresent = true;

    // 檢查是否所有學生在該節次已點名
    for (let student of students) {
        if (attendanceRecords[dateKey][student][period] !== 'green') {
            allPresent = false;
            break;
        }
    }

    // 根據當前狀態決定要切換為哪一種狀態
    const newStatus = allPresent ? 'red' : 'green';

    students.forEach(student => {
        attendanceRecords[dateKey][student][period] = newStatus;
    });

    // 更新畫面
    const table = document.querySelector('#attendanceTableContainer table');
    if (table) {
        const rows = table.rows;
        for (let i = 1; i < rows.length; i++) { // 從1開始，跳過表頭
            const cell = rows[i].cells[period];
            cell.className = (newStatus === 'red') ? 'attendance-absent' : 'attendance-present';
            cell.textContent = (newStatus === 'red') ? '✗' : '✓';
        }
    }

    // 存回 localStorage
    localStorage.setItem(localStoragePrefix + 'attendanceRecords', JSON.stringify(attendanceRecords));
}

/**
 * 點擊最上方的「學生\\節次」單元格時，切換所有學生的所有節次點名狀態
 * @param {string} dateKey - 日期鍵值
 */
function toggleAllStudentsAttendance(dateKey) {
    const totalPeriods = 8; // 節次數，可根據需求調整
    let allPresent = true;

    // 檢查是否所有學生所有節次都已點名
    for (let student of students) {
        for (let p = 1; p <= totalPeriods; p++) {
            if (attendanceRecords[dateKey][student][p] !== 'green') {
                allPresent = false;
                break;
            }
        }
        if (!allPresent) break;
    }

    // 根據當前狀態決定要切換為哪一種狀態
    const newStatus = allPresent ? 'red' : 'green';

    students.forEach(student => {
        for (let p = 1; p <= totalPeriods; p++) {
            attendanceRecords[dateKey][student][p] = newStatus;
        }
    });

    // 更新畫面
    const table = document.querySelector('#attendanceTableContainer table');
    if (table) {
        const rows = table.rows;
        for (let i = 1; i < rows.length; i++) { // 從1開始，跳過表頭
            for (let p = 1; p <= totalPeriods; p++) {
                const cell = rows[i].cells[p];
                cell.className = (newStatus === 'red') ? 'attendance-absent' : 'attendance-present';
                cell.textContent = (newStatus === 'red') ? '✗' : '✓';
            }
        }
    }

    // 存回 localStorage
    localStorage.setItem(localStoragePrefix + 'attendanceRecords', JSON.stringify(attendanceRecords));
}



        function updateScoreTables() {
            const studentScoreTable = document.getElementById('studentScoreTable');
            const groupScoreTable = document.getElementById('groupScoreTable');
            studentScoreTable.innerHTML = '';
            groupScoreTable.innerHTML = '';
            let currentStudentTable = createScoreTable();
            let currentGroupTable = createGroupScoreTable();
            studentScoreTable.appendChild(currentStudentTable);
            groupScoreTable.appendChild(currentGroupTable);
            students.forEach((name, index) => {
                if (index % 10 === 0 && index !== 0) {
                    currentStudentTable = createScoreTable();
                    studentScoreTable.appendChild(currentStudentTable);
                }
                addRowToTable(currentStudentTable, name, index);
            });
            Object.keys(groups).forEach((groupIndex, index) => {
                if (index % 5 === 0 && index !== 0) {
                    currentGroupTable = createGroupScoreTable();
                    groupScoreTable.appendChild(currentGroupTable);
                }
                addGroupRowToTable(currentGroupTable, groupIndex, index);
            });
            highlightTopScore();
        }

        function createScoreTable() {
            const table = document.createElement('table');
            table.className = 'scoreTable';
            const thead = table.createTHead();
            const row = thead.insertRow();
            const thName = document.createElement('th');
            const thAdd = document.createElement('th');
            const thScore = document.createElement('th');
            const thSubtract = document.createElement('th');
            thName.textContent = '姓名';
            thAdd.textContent = '加分';
            thScore.textContent = '得分';
            thSubtract.textContent = '扣分';
            row.appendChild(thName);
            row.appendChild(thAdd);
            row.appendChild(thScore);
            row.appendChild(thSubtract);
            table.createTBody();
            return table;
        }

        function createGroupScoreTable() {
            const table = document.createElement('table');
            table.className = 'scoreTable groupScoreTable';
            const thead = table.createTHead();
            const row = thead.insertRow();
            const thName = document.createElement('th');
            const thAdd = document.createElement('th');
            const thScore = document.createElement('th');
            const thSubtract = document.createElement('th');
            const thMembers = document.createElement('th');
            thName.textContent = '組別';
            thAdd.textContent = '加分';
            thScore.textContent = '得分';
            thSubtract.textContent = '扣分';
            thMembers.textContent = '組員';
            row.appendChild(thName);
            row.appendChild(thAdd);
            row.appendChild(thScore);
            row.appendChild(thSubtract);
            row.appendChild(thMembers);
            table.createTBody();
            return table;
        }

        function addRowToTable(table, name, index) {
            const tbody = table.getElementsByTagName('tbody')[0];
            const row = tbody.insertRow();
            const cellName = row.insertCell(0);
            const cellAdd = row.insertCell(1);
            const cellScore = row.insertCell(2);
            const cellSubtract = row.insertCell(3);

            cellName.textContent = name;
            cellAdd.innerHTML = `<button onclick="changeScore('${name}-${index}', 1)">+</button>`;
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) {
                scores[dateKey] = {};
            }
            cellScore.textContent = scores[dateKey][`${name}-${index}`] || 0;
            cellSubtract.innerHTML = `<button onclick="changeScore('${name}-${index}', -1)">-</button>`;
        }

        function addGroupRowToTable(table, groupIndex, index) {
            const tbody = table.getElementsByTagName('tbody')[0];
            const row = tbody.insertRow();
            const cellName = row.insertCell(0);
            const cellAdd = row.insertCell(1);
            const cellScore = row.insertCell(2);
            const cellSubtract = row.insertCell(3);
            const cellMembers = row.insertCell(4);

            cellName.textContent = `第${parseInt(groupIndex) + 1}組`;
            cellAdd.innerHTML = `<button onclick="changeGroupScore('${groupIndex}', 1, this)">+</button>`;
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) {
                scores[dateKey] = {};
            }
            cellScore.textContent = scores[dateKey][`group-${groupIndex}`] || 0;
            cellSubtract.innerHTML = `<button onclick="changeGroupScore('${groupIndex}', -1, this)">-</button>`;
            cellMembers.textContent = groups[groupIndex].join(', ');
        }

        function changeScore(key, delta) {
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) {
                scores[dateKey] = {};
            }
            scores[dateKey][key] = (scores[dateKey][key] || 0) + delta;
            localStorage.setItem(localStoragePrefix + 'scores', JSON.stringify(scores));
            updateScoreTables();
            scoresChanged = true;
        }

        function changeGroupScore(groupIndex, delta, button) {
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) {
                scores[dateKey] = {};
            }
            groups[groupIndex].forEach(student => {
                const key = `${student}-${students.indexOf(student)}`;
                scores[dateKey][key] = (scores[dateKey][key] || 0) + delta;
            });
            scores[dateKey][`group-${groupIndex}`] = (scores[dateKey][`group-${groupIndex}`] || 0) + delta;
            localStorage.setItem(localStoragePrefix + 'scores', JSON.stringify(scores));
            updateScoreTables();
            scoresChanged = true;
        }

        function highlightTopScore() {
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) return;
            const maxScore = Math.max(...Object.values(scores[dateKey]));
            const cells = document.querySelectorAll('.scoreTable td:nth-child(3)');
            cells.forEach(cell => {
                cell.classList.remove('highlight');
                if (parseInt(cell.textContent) === maxScore) {
                    cell.classList.add('highlight');
                }
            });
        }

        function renderChart() {
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: students,
                    datasets: [{
                        label: '得分',
                        data: students.map((name, index) => scores[dateKey] ? (scores[dateKey][`${name}-${index}`] || 0) : 0),
                        backgroundColor: students.map((name, index) => scores[dateKey] && (scores[dateKey][`${name}-${index}`] === Math.max(...Object.values(scores[dateKey])) ? 'darkblue' : 'rgba(54, 162, 235, 0.7)')),
                        borderColor: students.map((name, index) => scores[dateKey] && (scores[dateKey][`${name}-${index}`] === Math.max(...Object.values(scores[dateKey])) ? 'darkblue' : 'rgba(54, 162, 235, 1)')),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: students.length <= 6 ? 0 : 90,
                                minRotation: 0,
                                font: function(context) {
                                    const width = context.chart.width;
                                    const size = students.length <= 6 ? 14 : Math.round(width / students.length / 1.5);
                                    return {
                                        size: size > 8 ? size : 8,
                                    };
                                }
                            }
                        }
                    }
                }
            });
        }

        function confirmReset() {
            if (confirm("確定要重置所有資料嗎？")) {
                localStorage.removeItem(localStoragePrefix + 'students');
                localStorage.removeItem(localStoragePrefix + 'scores');
                localStorage.removeItem(localStoragePrefix + 'homeworks');
                localStorage.removeItem(localStoragePrefix + 'groups');
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('checklist_')) {
                        localStorage.removeItem(key);
                    }
                });
                localStorage.removeItem(localStoragePrefix + 'selectedTheme');
                localStorage.removeItem(localStoragePrefix + 'redemptionHistory');

                students = [];
                scores = {};
                homeworks = {};
                groups = {};
                redemptionHistory = {};

                document.getElementById('calendar').style.display = 'block';
                document.getElementById('inputSection').style.display = 'none';
                document.getElementById('checklistSection').style.display = 'none';
                document.getElementById('studentNamesInput').style.display = 'none';
                document.getElementById('header').style.display = 'flex';
                renderCalendar();
            }
        }

        function showWeeklySummary(startDay, endDay) {
            const summaryData = {};
            for (let i = startDay; i <= endDay; i++) {
                const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${i}`;
                if (scores[dateKey]) {
                    Object.keys(scores[dateKey]).forEach(key => {
                        summaryData[key] = (summaryData[key] || 0) + scores[dateKey][key];
                    });
                }
            }

            document.getElementById('weeklySummaryOverlay').style.display = 'flex';
            document.getElementById('weeklySummaryText').textContent = '每週統計';

            const weeklyScoreSection = document.getElementById('weeklyScoreSection');
            weeklyScoreSection.innerHTML = '';
            let currentTable = createWeeklySummaryTable();
            weeklyScoreSection.appendChild(currentTable);
            const sortedScores = Object.entries(summaryData).sort(([,a],[,b]) => b-a);
            const topScores = sortedScores.slice(0, 3);
            students.forEach((name, index) => {
                if (index % 7 === 0 && index !== 0) {
                    currentTable = createWeeklySummaryTable();
                    weeklyScoreSection.appendChild(currentTable);
                }
                addSummaryRowToTable(currentTable, name, index, summaryData, topScores);
            });
            renderSummaryChart(summaryData, 'weeklyChart');
        }

        function showMonthlySummary() {
            const summaryData = {};
            const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            for (let i = 1; i <= lastDay; i++) {
                const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${i}`;
                if (scores[dateKey]) {
                    Object.keys(scores[dateKey]).forEach(key => {
                        summaryData[key] = (summaryData[key] || 0) + scores[dateKey][key];
                    });
                }
            }

            document.getElementById('monthlySummaryOverlay').style.display = 'flex';
            document.getElementById('monthlySummaryText').textContent = '每月統計';

            const monthlyScoreSection = document.getElementById('monthlyScoreSection');
            monthlyScoreSection.innerHTML = '';
            let currentTable = createWeeklySummaryTable();
            monthlyScoreSection.appendChild(currentTable);
            const sortedScores = Object.entries(summaryData).sort(([,a],[,b]) => b-a);
            const topScores = sortedScores.slice(0, 3);
            students.forEach((name, index) => {
                if (index % 7 === 0 && index !== 0) {
                    currentTable = createWeeklySummaryTable();
                    monthlyScoreSection.appendChild(currentTable);
                }
                addSummaryRowToTable(currentTable, name, index, summaryData, topScores);
            });
            renderSummaryChart(summaryData, 'monthlyChart');
        }

        function createWeeklySummaryTable() {
            const table = document.createElement('table');
            table.className = 'scoreTable';
            const thead = table.createTHead();
            const row = thead.insertRow();
            const thName = document.createElement('th');
            const thScore = document.createElement('th');
            thName.textContent = '姓名';
            thScore.textContent = '得分';
            row.appendChild(thName);
            row.appendChild(thScore);
            table.createTBody();
            return table;
        }

        function addSummaryRowToTable(table, name, index, summaryData, topScores) {
            const tbody = table.getElementsByTagName('tbody')[0];
            const row = tbody.insertRow();
            const cellName = row.insertCell(0);
            const cellScore = row.insertCell(1);
            const score = summaryData[`${name}-${index}`] || 0;

            const topScoreIndex = topScores.findIndex(([key, value]) => key === `${name}-${index}`);
            if (topScoreIndex !== -1) {
                cellName.innerHTML = `<span style="font-weight: bold; color: red;">${name} (${topScoreIndex + 1})</span>`;
                cellScore.innerHTML = `<span style="font-weight: bold; color: red;">${score}</span>`;
            } else {
                cellName.textContent = name;
                cellScore.textContent = score;
            }
        }

        function renderSummaryChart(summaryData, chartId) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if (chartId === 'weeklyChart' && weeklyChart) {
                weeklyChart.destroy();
            } else if (chartId === 'monthlyChart' && monthlyChart) {
                monthlyChart.destroy();
            }

            const newChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: students,
                    datasets: [{
                        label: '得分',
                        data: students.map((name, index) => summaryData[`${name}-${index}`] || 0),
                        backgroundColor: students.map((name, index) => summaryData[`${name}-${index}`] === Math.max(...Object.values(summaryData)) ? 'darkblue' : 'rgba(54, 162, 235, 0.2)'),
                        borderColor: students.map((name, index) => summaryData[`${name}-${index}`] === Math.max(...Object.values(summaryData)) ? 'darkblue' : 'rgba(54, 162, 235, 1)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: students.length <= 6 ? 0 : 90,
                                minRotation: 0,
                                font: function(context) {
                                    const width = context.chart.width;
                                    const size = students.length <= 6 ? 14 : Math.round(width / students.length / 1.5);
                                    return {
                                        size: size > 8 ? size : 8,
                                    };
                                }
                            }
                        }
                    }
                }
            });

            if (chartId === 'weeklyChart') {
                weeklyChart = newChart;
            } else if (chartId === 'monthlyChart') {
                monthlyChart = newChart;
            }
        }

        function hideWeeklySummary() {
            document.getElementById('weeklySummaryOverlay').style.display = 'none';
            document.getElementById('monthlySummaryOverlay').style.display = 'none';
        }

        function showHomeworkOverlay(event, dateKey) {
            event.stopPropagation();
            document.getElementById('homeworkOverlay').style.display = 'flex';
            document.getElementById('homeworkDate').textContent = new Date(dateKey).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('homeworkDate').dataset.dateKey = dateKey;
            document.getElementById('homeworkText').value = homeworks[dateKey] ? homeworks[dateKey].join('\n') : '';
        }

        function hideOverlay(event, overlayId) {
            event.stopPropagation();
            document.getElementById(overlayId).style.display = 'none';
        }

        function submitHomework() {
            const dateKey = document.getElementById('homeworkDate').dataset.dateKey;
            const homeworkText = document.getElementById('homeworkText').value.trim();
            if (homeworkText) {
                homeworks[dateKey] = homeworkText.split('\n').map(item => item.trim()).filter(item => item);
                localStorage.setItem(localStoragePrefix + 'homeworks', JSON.stringify(homeworks));
                try {
                    const dayElement = document.querySelector(`.calendarDay button[onclick*="showHomeworkOverlay(event, '${dateKey}')"]`).parentNode;
                    if (dayElement) {
                        const hideElement = dayElement.querySelector('.hide');
                        if (hideElement) {
                            hideElement.classList.remove('hide');
                        }
                        const buttons = dayElement.querySelectorAll('button');
                        if (buttons[2]) {
                            buttons[2].classList.remove('hide');
                        }
                    }
                } catch (error) {
                    console.log('無法更新日曆按鈕顯示狀態:', error);
                }
            }
            document.getElementById('homeworkOverlay').style.display = 'none';
        }

function showViewHomeworkOverlay(event, dateKey) {
    event.stopPropagation();
    document.getElementById('viewHomeworkOverlay').style.display = 'flex';
    document.getElementById('viewHomeworkDate').textContent = new Date(dateKey).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
    const assignmentList = document.getElementById('assignmentList');
    assignmentList.innerHTML = ''; // 清空舊內容
    if (homeworks[dateKey]) {
        homeworks[dateKey].forEach((item, index) => {
            const li = document.createElement('li');
            li.textContent = `${index + 1}. ${item}`;
            li.classList.add('highlighted-assignment'); // 添加樣式
            assignmentList.appendChild(li);
        });
    }
}

        function showChecklistSection(dateKey) {
            const storedData = JSON.parse(localStorage.getItem(`${localStoragePrefix}checklist_${dateKey}`)) || {};
            const homeworkList = homeworks[dateKey] || [];
            document.getElementById('checklistDate').textContent = new Date(dateKey).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('checklistDate').dataset.dateKey = dateKey;
            document.getElementById('statusContainer').innerHTML = generateStatusTables(homeworkList);
            document.getElementById('tablesContainer').innerHTML = generateChecklistTables(homeworkList, storedData);
            document.getElementById('calendar').style.display = 'none';
            document.getElementById('header').style.display = 'none';
            document.getElementById('checklistSection').style.display = 'block';
            hideSideMenuToggle();
            updateStatusLists();

            // 重新加入作業名稱及學生姓名點擊事件
            const assignmentHeaders = document.querySelectorAll('#tablesContainer table thead th:not(.student-name)');
            assignmentHeaders.forEach(th => {
                const assignmentName = th.textContent.trim();
                if (assignmentName !== '') {
                    th.style.cursor = 'pointer';
                    th.addEventListener('click', () => {
                        toggleAssignmentStatus(assignmentName);
                    });
                }
            });

            const studentNameCells = document.querySelectorAll('#tablesContainer table tbody .student-name');
            studentNameCells.forEach(td => {
                const studentName = td.textContent.trim();
                if (studentName !== '') {
                    td.style.cursor = 'pointer';
                    td.addEventListener('click', () => {
                        toggleStudentStatus(studentName);
                    });
                }
            });
        }

        function generateStatusTables(cols) {
            const colorSchemes = [
                { bg: 'linear-gradient(135deg, #ffcccb 0%, #ffd1dc 100%)', border: '#ff6b6b', title: '#2c3e50' },
                { bg: 'linear-gradient(135deg, #e6e6fa 0%, #dda0dd 100%)', border: '#9370db', title: '#2c3e50' },
                { bg: 'linear-gradient(135deg, #f0fff0 0%, #98fb98 100%)', border: '#32cd32', title: '#2c3e50' },
                { bg: 'linear-gradient(135deg, #fff5ee 0%, #ffa07a 100%)', border: '#ff7f50', title: '#2c3e50' },
                { bg: 'linear-gradient(135deg, #f5f5dc 0%, #f0e68c 100%)', border: '#daa520', title: '#2c3e50' }
            ];
            return cols.map((col, index) => {
                const scheme = colorSchemes[index % colorSchemes.length];
                return `
                <table class="status-table status-table-${index}" style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                    <thead>
                        <tr>
                            <th colspan="3" style="border: 1px solid ${scheme.border}; background: ${scheme.bg}; font-size: 18px; color: ${scheme.title}; font-weight: bold; padding: 15px; text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">${col}</th>
                        </tr>
                        <tr>
                            <th style="border: 1px solid ${scheme.border}; background: ${scheme.bg}; padding: 12px; color: ${scheme.title}; font-weight: bold;">未繳交</th>
                            <th style="border: 1px solid ${scheme.border}; background: ${scheme.bg}; padding: 12px; color: ${scheme.title}; font-weight: bold;">待訂正</th>
                            <th style="border: 1px solid ${scheme.border}; background: ${scheme.bg}; padding: 12px; color: ${scheme.title}; font-weight: bold;">已訂正</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="not-submitted-${col}" style="border: 1px solid ${scheme.border}; background-color: #f8f9fa; padding: 12px; min-height: 60px;"></td>
                            <td id="correction-${col}" style="border: 1px solid ${scheme.border}; background-color: #f8f9fa; padding: 12px; min-height: 60px;"></td>
                            <td id="corrected-${col}" style="border: 1px solid ${scheme.border}; background-color: #f8f9fa; padding: 12px; min-height: 60px;"></td>
                        </tr>
                    </tbody>
                </table>
            `;
            }).join('');
        }

        function generateChecklistTables(cols, storedData) {
            const colors = ['#ffe4e1', '#e6e6fa', '#f0fff0', '#fff5ee', '#f5f5dc'];
            let tables = '';
            const chunkSize = 10;
            for (let i = 0; i < students.length; i += chunkSize) {
                tables += `
                    <table style="table-layout: fixed; margin: 10px; border-collapse: collapse; background-color: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
                        <thead>
                            <tr>
                                <th class="student-name" style="width: 90px; height: 15px;">學生姓名</th>
                                ${cols.map((col, index) => col.trim() !== '' ? `<th style="width: 90px; height: 15px; border: 2px solid #000; background-color: ${colors[index % colors.length]};">${col}</th>` : '').join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${generateChecklistRows(cols, i, i + chunkSize, storedData)}
                        </tbody>
                    </table>
                `;
            }
            return tables;
        }

        function generateChecklistRows(cols, start, end, storedData) {
            let rows = '';
            const chunk = students.slice(start, end);
            chunk.forEach((student, index) => {
                let assignments = '';
                for (let i = 0; i < cols.length; i++) {
                    if (cols[i].trim() !== '') {
                        const assignment = cols[i].trim();
                        const status = storedData[assignment] && storedData[assignment][student] ? storedData[assignment][student] : 'red'; 
                        const text = status === 'red' ? '未繳交' : status === 'green' ? '已繳交' : status === 'orange' ? '待訂正' : '已訂正';
                        assignments += `
                            <td style="width: 90px; height: 15px; background-color: #dcdcdc; border: 2px solid #000;">
                                <button class="status-button" style="background-color: ${status}; color: white;" onclick="toggleButtonStatus(this, '${student}', '${assignment}')" data-assignment="${assignment}" data-student="${student}" data-datekey="${document.getElementById('checklistDate').dataset.dateKey || ''}">${text}</button>
                            </td>
                        `;
                    }
                }
                rows += `
                    <tr>
                        <td class="student-name" style="width: 90px; height: 15px; background-color: #f0e68c; font-weight: bold; border: 2px solid #000;">${student}</td>
                        ${assignments}
                    </tr>
                `;
            });
            return rows;
        }

        function toggleButtonStatus(button, student, assignment) {
            const currentColor = button.style.backgroundColor;
            let newColor = 'red';
            let newText = '未繳交';
            if (currentColor === 'red') {
                newColor = 'green';
                newText = '已繳交';
            } else if (currentColor === 'green') {
                newColor = 'orange';
                newText = '待訂正';
            } else if (currentColor === 'orange') {
                newColor = 'blue';
                newText = '已訂正';
            } else {
                newColor = 'red';
                newText = '未繳交';
            }

            button.style.backgroundColor = newColor;
            button.textContent = newText;

            const dateKey = button.dataset.datekey;
            const stu = button.dataset.student;
            const asg = button.dataset.assignment;
            if (dateKey && asg && stu) {
                updateChecklistLocalStorage(dateKey, asg, stu, newColor);
            }
            const checklistDateElem = document.getElementById('checklistDate');
            if (checklistDateElem && checklistDateElem.dataset.dateKey) {
                saveChecklistData();
            }
            updateStatusLists();
            
            // 如果座位表開啟中，同步更新座位表的作業狀態顯示
            const seatingChartOverlay = document.getElementById('seatingChartOverlay');
            if (seatingChartOverlay && seatingChartOverlay.style.display === 'flex') {
                setTimeout(() => {
                    refreshAllSeatsScoreDisplay();
                }, 100);
            }
        }

        function toggleAssignmentStatus(assignment) {
            const buttons = document.querySelectorAll(`button[data-assignment="${assignment}"]`);
            buttons.forEach(button => {
                const stu = button.dataset.student;
                toggleButtonStatus(button, stu, assignment);
            });
        }

        function toggleStudentStatus(student) {
            const tables = document.querySelectorAll('#tablesContainer table');
            tables.forEach(table => {
                const tr = Array.from(table.querySelectorAll('tbody tr')).find(tr => tr.querySelector('.student-name') && tr.querySelector('.student-name').textContent.trim() === student);
                if (tr) {
                    Array.from(tr.querySelectorAll('.status-button')).forEach(button => {
                        const asg = button.dataset.assignment;
                        toggleButtonStatus(button, student, asg);
                    });
                }
            });
        }

        function updateStatusLists() {
            const notSubmittedLists = {};
            const correctionLists = {};
            const correctedLists = {};

            document.querySelectorAll('.status-table th').forEach(th => {
                const col = th.textContent.trim();
                notSubmittedLists[col] = document.getElementById(`not-submitted-${col}`);
                correctionLists[col] = document.getElementById(`correction-${col}`);
                correctedLists[col] = document.getElementById(`corrected-${col}`);
                if (notSubmittedLists[col]) notSubmittedLists[col].innerHTML = '';
                if (correctionLists[col]) correctionLists[col].innerHTML = '';
                if (correctedLists[col]) correctedLists[col].innerHTML = '';
            });

            const buttons = document.querySelectorAll('.status-button');
            buttons.forEach(button => {
                const tr = button.closest('tr');
                const td = button.closest('td');
                const table = button.closest('table');
                if (!tr || !td || !table) return;

                const studentNameElem = tr.querySelector('.student-name');
                if (!studentNameElem) return;
                const student = studentNameElem.textContent;

                const index = Array.from(tr.children).indexOf(td) + 1;
                const th = table.querySelector('thead th:nth-child(' + index + ')');
                if (!th) return;

                const assignment = th.textContent.trim();

                if (button.style.backgroundColor === 'red' && notSubmittedLists[assignment]) {
                    notSubmittedLists[assignment].innerHTML += `${notSubmittedLists[assignment].innerHTML ? ', ' : ''}${student}`;
                } else if (button.style.backgroundColor === 'orange' && correctionLists[assignment]) {
                    correctionLists[assignment].innerHTML += `${correctionLists[assignment].innerHTML ? ', ' : ''}${student}`;
                } else if (button.style.backgroundColor === 'blue' && correctedLists[assignment]) {
                    correctedLists[assignment].innerHTML += `${correctedLists[assignment].innerHTML ? ', ' : ''}${student}`;
                }
            });
        }

        function saveChecklistData() {
            const checklistDateElem = document.getElementById('checklistDate');
            if (!checklistDateElem || !checklistDateElem.dataset.dateKey) {
                return;
            }
            const dateKey = checklistDateElem.dataset.dateKey;
            const statusData = {};
            const buttons = document.querySelectorAll('.status-button');
            buttons.forEach(button => {
                const tr = button.closest('tr');
                const td = button.closest('td');
                const table = button.closest('table');
                if (!tr || !td || !table) return;

                const studentNameElem = tr.querySelector('.student-name');
                if (!studentNameElem) return;
                const student = studentNameElem.textContent;

                const index = Array.from(tr.children).indexOf(td) + 1;
                const th = table.querySelector('thead th:nth-child(' + index + ')');
                if (!th) return;

                const assignment = th.textContent.trim();
                if (!statusData[assignment]) statusData[assignment] = {};
                statusData[assignment][student] = button.style.backgroundColor;
            });
            localStorage.setItem(`${localStoragePrefix}checklist_${dateKey}`, JSON.stringify(statusData));
        }

        function saveAndBack() {
            saveChecklistData();
            goBack();
        }

        function exportData() {
            // 收集所有作業狀態數據（支援帶前綴和不帶前綴的格式）
            const checklistData = {};
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('checklist_') || key.startsWith(localStoragePrefix + 'checklist_')) {
                    let dateKey;
                    if (key.startsWith(localStoragePrefix + 'checklist_')) {
                        dateKey = key.replace(localStoragePrefix + 'checklist_', '');
                    } else {
                        dateKey = key.replace('checklist_', '');
                    }
                    if (dateKey) {
                        checklistData[dateKey] = JSON.parse(localStorage.getItem(key));
                    }
                }
            });

            // 收集座位表數據
            const seatingChartData = localStorage.getItem(localStoragePrefix + 'seatingChartData2');

            const data = {
                students,
                scores,
                homeworks,
                groups,
                checklist: checklistData,
                redemptionHistory,
                attendanceRecords, // 點名記錄
                seatingChartData: seatingChartData ? JSON.parse(seatingChartData) : null, // 座位表數據
                exportDate: new Date().toISOString() // 匯出時間戳
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');

            const currentDate = new Date();
            const formattedDate = currentDate.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '-'); 

            const fileName = `教師課堂管理整合工具資料備份_${formattedDate}.json`;

            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            document.body.removeChild(downloadAnchorNode);
        }

function importData(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(event) {
        const importedData = JSON.parse(event.target.result);

        // 匯入基本數據
        students = importedData.students || [];
        scores = importedData.scores || {};
        homeworks = importedData.homeworks || {};
        groups = importedData.groups || {};
        redemptionHistory = importedData.redemptionHistory || {};

        // 匯入作業狀態數據
        if (importedData.checklist) {
            // 先清除舊的作業狀態數據
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('checklist_') || key.startsWith(localStoragePrefix + 'checklist_')) {
                    localStorage.removeItem(key);
                }
            });
            
            // 匯入新的作業狀態數據（使用帶前綴的格式）
            Object.keys(importedData.checklist).forEach(dateKey => {
                localStorage.setItem(`${localStoragePrefix}checklist_${dateKey}`, JSON.stringify(importedData.checklist[dateKey]));
            });
        }

        // 匯入點名記錄
        if (importedData.attendanceRecords) {
            attendanceRecords = importedData.attendanceRecords;
        } else {
            attendanceRecords = {};
        }

        // 匯入座位表數據
        if (importedData.seatingChartData) {
            localStorage.setItem(localStoragePrefix + 'seatingChartData2', JSON.stringify(importedData.seatingChartData));
        }

        // 保存所有數據到localStorage
        localStorage.setItem(localStoragePrefix + 'students', JSON.stringify(students));
        localStorage.setItem(localStoragePrefix + 'scores', JSON.stringify(scores));
        localStorage.setItem(localStoragePrefix + 'homeworks', JSON.stringify(homeworks));
        localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
        localStorage.setItem(localStoragePrefix + 'redemptionHistory', JSON.stringify(redemptionHistory));
        localStorage.setItem(localStoragePrefix + 'attendanceRecords', JSON.stringify(attendanceRecords));

        renderCalendar();
        alert('資料已成功匯入，包含所有加扣分、作業紀錄及座位表紀錄！');
    };
            reader.readAsText(file);
        }

        function exportImage() {
            const element = document.querySelector('#checklistSection');
            html2canvas(element).then(canvas => {
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = `checklist-${document.getElementById('checklistDate').dataset.dateKey}.png`;
                link.click();
            });
        }

        function changeTheme(theme) {
            const themes = {
                'theme1': 'linear-gradient(to right, #ffecd2, #fcb69f)',
                'theme2': 'linear-gradient(to right, #3a1c71, #d76d77, #ffaf7b)',
                'theme3': 'linear-gradient(to right, #43cea2, #185a9d)',
                'theme4': 'linear-gradient(to right, #4568dc, #b06ab3)'
            };
            document.body.style.background = themes[theme];
            localStorage.setItem(localStoragePrefix + 'selectedTheme', theme);
        }

        function toggleStatusTables() {
            const statusContainer = document.getElementById('statusContainer');
            if (statusContainer.style.display === 'none') {
                statusContainer.style.display = 'flex';
            } else {
                statusContainer.style.display = 'none';
            }
        }

        function slideRight(contentId) {
            const content = document.getElementById(contentId);
            const summarySection = content.querySelector('.summarySection');
            const leftArrow = content.querySelector('.leftArrow');
            const rightArrow = content.querySelector('.rightArrow');
            summarySection.style.transform = 'translateX(-100%)';
            leftArrow.style.display = 'block';
            rightArrow.style.display = 'none';
        }

        function slideLeft(contentId) {
            const content = document.getElementById(contentId);
            const summarySection = content.querySelector('.summarySection');
            const leftArrow = content.querySelector('.leftArrow');
            const rightArrow = content.querySelector('.rightArrow');
            summarySection.style.transform = 'translateX(0)';
            leftArrow.style.display = 'none';
            rightArrow.style.display = 'block';
        }

        function submitGroupCount() {
            const groupCount = document.getElementById('groupCountInput').value;
            groups = {};
            for (let i = 0; i < groupCount; i++) {
                groups[i] = [];
            }

            students.forEach((student, index) => {
                groups[index % groupCount].push(student);
            });

            localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
            hideGroupCount();
            showGroupStudents();
        }

        function renderGroups() {
            const groupContainer = document.getElementById('groupContainer');
            groupContainer.innerHTML = '';
            Object.keys(groups).forEach(groupIndex => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group';
                groupDiv.innerHTML = `<h4>第 ${parseInt(groupIndex) + 1} 組</h4><ul id="group-${groupIndex}">${groups[groupIndex].map(student => `<li draggable="true" ondragstart="drag(event)" id="${student}">${student}</li>`).join('')}</ul>`;
                groupContainer.appendChild(groupDiv);
            });

            const uls = document.querySelectorAll('.group ul');
            uls.forEach(ul => {
                ul.ondragover = function (event) {
                    event.preventDefault();
                };
                ul.ondrop = function (event) {
                    event.preventDefault();
                    const studentId = event.dataTransfer.getData("text");
                    const studentElement = document.getElementById(studentId);
                    if (studentElement) {
                        ul.appendChild(studentElement);
                        updateGroups();
                    }
                };
            });
        }

        function drag(event) {
            event.dataTransfer.setData("text", event.target.id);
        }

        function updateGroups() {
            const groupCount = document.getElementById('groupCountInput').value;
            groups = {};
            for (let i = 0; i < groupCount; i++) {
                groups[i] = [];
            }

            Object.keys(groups).forEach(groupIndex => {
                const ul = document.getElementById(`group-${groupIndex}`);
                ul.querySelectorAll('li').forEach(studentElement => {
                    groups[groupIndex].push(studentElement.id);
                });
            });

            localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
        }

        function submitGroups() {
            localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
            hideGroupStudents();
        }

        function adjustGroups() {
            renderGroups();
        }

        let studentList2 = [];
        let seatingChartData2 = [];
        let draggedElement2 = null;

        // 計算學生總分的函數
        function calculateStudentTotalScore(studentName) {
            let totalScore = 0;
            const studentIndex = students.indexOf(studentName);
            if (studentIndex === -1) return 0;
            
            const studentKey = `${studentName}-${studentIndex}`;
            Object.keys(scores).forEach(dateKey => {
                if (scores[dateKey] && scores[dateKey][studentKey] !== undefined) {
                    totalScore += scores[dateKey][studentKey];
                }
            });
            return totalScore;
        }

        // 檢查學生是否有未完成的作業
        function hasIncompleteHomework(studentName) {
            let hasIncomplete = false;
            
            // 遍歷所有作業日期
            Object.keys(homeworks).forEach(dateKey => {
                if (homeworks[dateKey] && homeworks[dateKey].length > 0) {
                    const checklistData = JSON.parse(localStorage.getItem(`${localStoragePrefix}checklist_${dateKey}`)) || {};
                    
                    // 檢查該日期的每項作業
                    homeworks[dateKey].forEach(assignment => {
                        const status = checklistData[assignment] && checklistData[assignment][studentName] 
                                     ? checklistData[assignment][studentName] 
                                     : 'red';
                        
                        // 如果狀態是紅色(未繳交)或橙色(待訂正)，視為未完成
                        if (status === 'red' || status === 'orange') {
                            hasIncomplete = true;
                        }
                    });
                }
            });
            
            return hasIncomplete;
        }

        // 格式化座位顯示內容（姓名+分數+作業狀態）
        function formatSeatContent(studentName) {
            if (!studentName || studentName.trim() === '') {
                return '';
            }
            const totalScore = calculateStudentTotalScore(studentName);
            const hasIncomplete = hasIncompleteHomework(studentName);
            
            if (hasIncomplete) {
                return `${studentName}\n(${totalScore}) ❌`;
            } else {
                return `${studentName}\n(${totalScore})`;
            }
        }

        // 檢查點擊是否在❌圖示區域
        function isClickOnHomeworkIcon(event, seatElement) {
            const seatRect = seatElement.getBoundingClientRect();
            const seatText = seatElement.textContent;
            
            // 如果沒有❌圖示，返回false
            if (!seatText.includes('❌')) {
                return false;
            }
            
            // 計算❌圖示的區域（在座位格子的右半部分）
            const clickX = event.clientX;
            const clickY = event.clientY;
            
            // 簡化檢測：如果點擊在座位格子的右半部分且下半部分，視為點擊❌圖示
            const isRightHalf = clickX > (seatRect.left + seatRect.right) / 2;
            const isBottomHalf = clickY > (seatRect.top + seatRect.bottom) / 2;
            
            return isRightHalf && isBottomHalf;
        }

        // 打開作業追蹤並查詢指定學生
        function openHomeworkTrackingForStudent(studentName) {
            // 關閉座位表
            hideSeatingChart();
            
            // 開啟作業追蹤
            showHomeworkTracking();
            
            // 延遲一下確保界面已載入
            setTimeout(() => {
                // 設定學生選擇器的值
                const studentSelect = document.getElementById('studentHomeworkSelect');
                if (studentSelect) {
                    studentSelect.value = studentName;
                    
                    // 自動執行查詢
                    searchHomeworkByStudent();
                }
            }, 200);
        }

        // 刷新所有座位的分數顯示
        function refreshAllSeatsScoreDisplay() {
            const seats = document.querySelectorAll('.seat2, .student-seat2');
            seats.forEach(seat => {
                const studentName = extractStudentNameFromSeat(seat.textContent);
                if (studentName) {
                    seat.textContent = formatSeatContent(studentName);
                }
            });
        }

        document.getElementById('inputButton2').addEventListener('click', inputStudentList2);
        document.getElementById('generateButton2').addEventListener('click', generateSeatingChart2);
        document.getElementById('groupButton2').addEventListener('click', generateGroupedSeatingChart2);
        document.getElementById('saveButton2').addEventListener('click', saveSeatingChart2);
        document.getElementById('loadButton2').addEventListener('click', loadSeatingChart2);
        document.getElementById('previewButton2').addEventListener('click', previewSeatingChart2);
        document.getElementById('resetButton2').addEventListener('click', resetSeatingChart2);
        document.getElementById('groupingMethod2').addEventListener('change', toggleSettings2);

        function showSeatingChart() {
            document.getElementById('seatingChartOverlay').style.display = 'flex';
            studentList2 = students.map(name => ({ name }));
            
            // 檢查是否有保存的座位表數據
            const savedData2 = localStorage.getItem(localStoragePrefix + 'seatingChartData2');
            if (savedData2) {
                const data2 = JSON.parse(savedData2);
                if (data2.seatingChartData && data2.seatingChartData.length > 0) {
                    seatingChartData2 = data2.seatingChartData;
                    document.getElementById('groupingMethod2').value = data2.groupingMethod || '';
                    document.getElementById('columns2').value = data2.columns || 5;
                    document.getElementById('groups2').value = data2.groups || 9;
                    toggleSettings2();
                    renderSeatingChart2FromData();
                    
                    // 延遲更新分數顯示，確保DOM元素已創建
                    setTimeout(() => {
                        refreshAllSeatsScoreDisplay();
                    }, 100);
                } else {
                    renderSeatingChart2();
                }
            } else {
                renderSeatingChart2();
            }
        }

        function hideSeatingChart() {
            document.getElementById('seatingChartOverlay').style.display = 'none';
        }

        function inputStudentList2() {
            const input = prompt('輸入學生姓名，每行一個:');
            if (input) {
                studentList2 = input.split('\n').map(name => ({ name: name.trim() })).filter(student => student.name);
                const method = document.getElementById('groupingMethod2').value;
                if (method === 'byColumn') {
                    generateSeatingChart2();
                } else {
                    generateGroupedSeatingChart2();
                }
            }
        }

        function toggleSettings2() {
            const method = document.getElementById('groupingMethod2').value;
            if (method === 'byColumn') {
                document.getElementById('settingsSection2').style.display = 'inline-block';
                document.getElementById('groupSettingsSection2').style.display = 'none';
            } else if (method === 'byGroup') {
                document.getElementById('settingsSection2').style.display = 'none';
                document.getElementById('groupSettingsSection2').style.display = 'inline-block';
            } else {
                document.getElementById('settingsSection2').style.display = 'none';
                document.getElementById('groupSettingsSection2').style.display = 'none';
            }
        }

        function generateSeatingChart2() {
            const columns = parseInt(document.getElementById('columns2').value);
            const seatingChart2 = document.getElementById('seatingChart2');
            seatingChart2.innerHTML = '';

            const blackboard2 = document.createElement('div');
            blackboard2.className = 'blackboard2';
            blackboard2.textContent = '黑板';
            blackboard2.style.gridColumn = `span ${columns}`;
            seatingChart2.appendChild(blackboard2);

            seatingChart2.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;

            seatingChartData2 = [];
            shuffleArray(studentList2);

            const totalSeats = Math.ceil(studentList2.length / columns) * columns;
            for (let i = 0; i < totalSeats; i++) {
                const seat2 = document.createElement('div');
                seat2.className = 'seat2';
                if (i < studentList2.length) {
                    seat2.textContent = formatSeatContent(studentList2[i].name);
                }
                seat2.draggable = true;
                seat2.addEventListener('dragstart', handleDragStart2);
                seat2.addEventListener('dragover', handleDragOver2);
                seat2.addEventListener('drop', handleDrop2);
                seat2.addEventListener('dragend', handleDragEnd2);
                seat2.addEventListener('click', handleSeatClick);
                seatingChart2.appendChild(seat2);
                seatingChartData2.push({ index: i + 1, name: i < studentList2.length ? studentList2[i].name : '' });
            }
            
            // 自動保存座位表數據
            saveSeatingChartToLocalStorage2();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateGroupedSeatingChart2() {
            const groupsNum = parseInt(document.getElementById('groups2').value);
            const totalGroups = 9;
            const columns = 3;

            const groupSizes = calculateGroupSizes2(studentList2.length, groupsNum);
            const groupedStudents = assignStudentsToGroups2(studentList2, groupSizes);

            const seatingChart2 = document.getElementById('seatingChart2');
            seatingChart2.innerHTML = '';
            seatingChart2.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;

            const blackboard2 = document.createElement('div');
            blackboard2.className = 'blackboard2';
            blackboard2.textContent = '黑板';
            blackboard2.style.gridColumn = `span ${columns}`;
            seatingChart2.appendChild(blackboard2);

            for (let i = 0; i < totalGroups; i++) {
                const groupContainer2 = document.createElement('div');
                groupContainer2.className = `group2 group-${i}`;
                groupContainer2.style.gridColumn = `span 1`;
                groupContainer2.draggable = true;
                groupContainer2.addEventListener('dragstart', handleDragStart2);
                groupContainer2.addEventListener('dragover', handleDragOver2);
                groupContainer2.addEventListener('drop', handleDropGroup2);
                groupContainer2.addEventListener('dragend', handleDragEnd2);
                seatingChart2.appendChild(groupContainer2);

                if (i < groupedStudents.length) {
                    groupedStudents[i].forEach(student => {
                        const seat2 = document.createElement('div');
                        seat2.className = 'student-seat2';
                        seat2.textContent = formatSeatContent(student.name);
                        seat2.draggable = true;
                        seat2.addEventListener('dragstart', handleDragStart2);
                        seat2.addEventListener('dragover', handleDragOver2);
                        seat2.addEventListener('drop', handleDrop2);
                        seat2.addEventListener('dragend', handleDragEnd2);
                        seat2.addEventListener('click', handleSeatClick);
                        groupContainer2.appendChild(seat2);
                    });
                }

                const totalSpaces = 9;
                while (groupContainer2.children.length < totalSpaces) {
                    const emptySeat2 = document.createElement('div');
                    emptySeat2.className = 'student-seat2';
                    emptySeat2.draggable = true;
                    emptySeat2.addEventListener('dragstart', handleDragStart2);
                    emptySeat2.addEventListener('dragover', handleDragOver2);
                    emptySeat2.addEventListener('drop', handleDrop2);
                    emptySeat2.addEventListener('dragend', handleDragEnd2);
                    emptySeat2.addEventListener('click', handleSeatClick);
                    groupContainer2.appendChild(emptySeat2);
                }
            }
            updateSeatingChartData2();
            
            // 自動保存座位表數據 (按組分組)
            saveSeatingChartToLocalStorage2();
        }

        function calculateGroupSizes2(totalStudents, numberOfGroups) {
            const groupSizes = new Array(numberOfGroups).fill(Math.floor(totalStudents / numberOfGroups));
            for (let i = 0; i < totalStudents % numberOfGroups; i++) {
                groupSizes[i]++;
            }
            return groupSizes;
        }

        function assignStudentsToGroups2(studentList, groupSizes) {
            const shuffledStudents = [...studentList];
            shuffleArray(shuffledStudents);
            const groups = [];
            let studentIndex = 0;
            for (let size of groupSizes) {
                const group = shuffledStudents.slice(studentIndex, studentIndex + size);
                groups.push(group);
                studentIndex += size;
            }
            return groups;
        }

        function handleDragStart2(event) {
            draggedElement2 = event.target;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', event.target.textContent);
        }

        function handleDragOver2(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        function handleDrop2(event) {
            event.preventDefault();
            if (event.target.classList.contains('seat2') || event.target.classList.contains('student-seat2')) {
                // 提取學生姓名進行交換
                const draggedName = extractStudentNameFromSeat(draggedElement2.textContent);
                const targetName = extractStudentNameFromSeat(event.target.textContent);

                // 重新格式化並顯示
                draggedElement2.textContent = formatSeatContent(targetName);
                event.target.textContent = formatSeatContent(draggedName);

                updateSeatingChartData2();
            }
        }

        function handleDropGroup2(event) {
            event.preventDefault();
            if (event.target.classList.contains('group2')) {
                const draggedHTML2 = draggedElement2.innerHTML;
                const targetHTML2 = event.target.innerHTML;

                draggedElement2.innerHTML = targetHTML2;
                event.target.innerHTML = draggedHTML2;

                reattachEventListeners2(draggedElement2);
                reattachEventListeners2(event.target);

                // 重新更新分數顯示
                refreshAllSeatsScoreDisplay();
                updateSeatingChartData2();
            }
        }

        function handleDragEnd2() {
            draggedElement2 = null;
        }

        // 處理座位點擊事件
        function handleSeatClick(event) {
            event.stopPropagation();
            
            const seatElement = event.currentTarget;
            const studentName = extractStudentNameFromSeat(seatElement.textContent);
            
            // 檢查是否點擊在❌圖示區域
            if (studentName && hasIncompleteHomework(studentName) && isClickOnHomeworkIcon(event, seatElement)) {
                // 點擊❌圖示，打開作業追蹤
                openHomeworkTrackingForStudent(studentName);
            }
            // 如果不是點擊❌圖示，不做任何處理（保持拖拽功能）
        }

        function reattachEventListeners2(groupContainer) {
            Array.from(groupContainer.children).forEach(seat => {
                seat.draggable = true;
                seat.addEventListener('dragstart', handleDragStart2);
                seat.addEventListener('dragover', handleDragOver2);
                seat.addEventListener('drop', handleDrop2);
                seat.addEventListener('dragend', handleDragEnd2);
                seat.addEventListener('click', handleSeatClick);
            });
            groupContainer.draggable = true;
            groupContainer.addEventListener('dragstart', handleDragStart2);
            groupContainer.addEventListener('dragover', handleDragOver2);
            groupContainer.addEventListener('drop', handleDropGroup2);
            groupContainer.addEventListener('dragend', handleDragEnd2);
        }

        // 從座位內容提取學生姓名
        function extractStudentNameFromSeat(seatText) {
            if (!seatText || seatText.trim() === '') {
                return '';
            }
            // 如果包含換行符，取第一行作為姓名
            return seatText.split('\n')[0].trim();
        }

        function updateSeatingChartData2() {
            const seats2 = document.querySelectorAll('.seat2, .student-seat2');
            seatingChartData2 = Array.from(seats2).map((seat2, index) => ({
                index: index + 1,
                name: extractStudentNameFromSeat(seat2.textContent)
            }));
            
            // 自動保存座位表數據 (拖拽後)
            saveSeatingChartToLocalStorage2();
        }

        function renderSeatingChart2() {
            // 可根據需要擴充
        }

        function saveSeatingChart2() {
            const data2 = {
                seatingChartData: seatingChartData2,
                groupingMethod: document.getElementById('groupingMethod2').value
            };
            const dataStr2 = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data2));
            const downloadAnchorNode2 = document.createElement('a');
            downloadAnchorNode2.setAttribute("href", dataStr2);
            downloadAnchorNode2.setAttribute("download", "seating_chart.json");
            document.body.appendChild(downloadAnchorNode2);
            downloadAnchorNode2.click();
            downloadAnchorNode2.remove();
        }

        function loadSeatingChart2() {
            const input2 = document.createElement('input');
            input2.type = 'file';
            input2.accept = '.json';
            input2.addEventListener('change', event => {
                const file2 = event.target.files[0];
                const reader2 = new FileReader();
                reader2.onload = function(e) {
                    const data2 = JSON.parse(e.target.result);
                    seatingChartData2 = data2.seatingChartData;
                    document.getElementById('groupingMethod2').value = data2.groupingMethod;
                    toggleSettings2();
                    renderSeatingChart2FromData();
                };
                reader2.readAsText(file2);
            });
            input2.click();
        }

        function renderSeatingChart2FromData() {
            if (!seatingChartData2 || seatingChartData2.length === 0) {
                return;
            }
            
            const seatingChart2 = document.getElementById('seatingChart2');
            seatingChart2.innerHTML = '';
            
            const groupingMethod = document.getElementById('groupingMethod2').value;
            
            if (groupingMethod === 'byGroup') {
                // 按組分組的顯示方式
                const totalGroups = 9;
                const columns = 3;
                seatingChart2.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
                
                const blackboard2 = document.createElement('div');
                blackboard2.className = 'blackboard2';
                blackboard2.textContent = '黑板';
                blackboard2.style.gridColumn = `span ${columns}`;
                seatingChart2.appendChild(blackboard2);
                
                // 重建9個分組容器
                for (let i = 0; i < totalGroups; i++) {
                    const groupContainer2 = document.createElement('div');
                    groupContainer2.className = `group2 group-${i}`;
                    groupContainer2.style.gridColumn = `span 1`;
                    groupContainer2.draggable = true;
                    groupContainer2.addEventListener('dragstart', handleDragStart2);
                    groupContainer2.addEventListener('dragover', handleDragOver2);
                    groupContainer2.addEventListener('drop', handleDropGroup2);
                    groupContainer2.addEventListener('dragend', handleDragEnd2);
                    seatingChart2.appendChild(groupContainer2);
                    
                    // 在每個分組中創建9個空座位
                    const totalSpaces = 9;
                    for (let j = 0; j < totalSpaces; j++) {
                        const seat2 = document.createElement('div');
                        seat2.className = 'student-seat2';
                        seat2.draggable = true;
                        seat2.addEventListener('dragstart', handleDragStart2);
                        seat2.addEventListener('dragover', handleDragOver2);
                        seat2.addEventListener('drop', handleDrop2);
                        seat2.addEventListener('dragend', handleDragEnd2);
                        seat2.addEventListener('click', handleSeatClick);
                        groupContainer2.appendChild(seat2);
                    }
                }
                
                // 根據保存的數據填入學生姓名和分數
                const allSeats = document.querySelectorAll('.student-seat2');
                seatingChartData2.forEach((seatData, index) => {
                    if (allSeats[index]) {
                        allSeats[index].textContent = formatSeatContent(seatData.name);
                    }
                });
            } else {
                // 按列分組的顯示方式
                const columns = parseInt(document.getElementById('columns2').value) || 5;
                seatingChart2.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
                
                const blackboard2 = document.createElement('div');
                blackboard2.className = 'blackboard2';
                blackboard2.textContent = '黑板';
                blackboard2.style.gridColumn = `span ${columns}`;
                seatingChart2.appendChild(blackboard2);
                
                seatingChartData2.forEach(seatData => {
                    const seat2 = document.createElement('div');
                    seat2.className = 'seat2';
                    seat2.textContent = formatSeatContent(seatData.name);
                    seat2.draggable = true;
                    seat2.addEventListener('dragstart', handleDragStart2);
                    seat2.addEventListener('dragover', handleDragOver2);
                    seat2.addEventListener('drop', handleDrop2);
                    seat2.addEventListener('dragend', handleDragEnd2);
                    seat2.addEventListener('click', handleSeatClick);
                    seatingChart2.appendChild(seat2);
                });
            }
        }

        function previewSeatingChart2() {
            const className2 = prompt('請輸入班級名稱:');
            if (className2) {
                const previewWindow2 = window.open('', '_blank');
                previewWindow2.document.write(`
                    <html>
                    <head>
                        <title>${className2} 座位表</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                background-color: #f4f4f9;
                                margin: 0;
                                padding: 20px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            }
                            h1 {
                                color: #333;
                            }
                            .seatingChart {
                                display: grid;
                                gap: 10px;
                                justify-content: center;
                                margin-top: 20px;
                                width: 1200px;
                            }
                            .student-seat2, .seat2 {
                                background-color: #f1f1f1;
                                border: 1px solid #ddd;
                                padding: 10px;
                                border-radius: 4px;
                                text-align: center;
                                min-height: 30px;
                            }
                            .blackboard2 {
                                text-align: center;
                                background-color: #333;
                                color: white;
                                padding: 10px;
                                border-radius: 4px;
                            }
                            .group2 {
                                border: 2px solid #4CAF50;
                                border-radius: 4px;
                                padding: 10px;
                                margin: 10px;
                                display: grid;
                                gap: 10px;
                                grid-template-columns: repeat(3, 1fr);
                                min-height: 150px;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${className2} 座位表</h1>
                        <div class="seatingChart">${document.getElementById('seatingChart2').innerHTML}</div>
                    </body>
                    </html>
                `);
                previewWindow2.document.close();
            }
        }

        function resetSeatingChart2() {
            seatingChartData2 = [];
            studentList2 = [];
            document.getElementById('groupingMethod2').value = '';
            document.getElementById('columns2').value = 5;
            document.getElementById('groups2').value = 9;
            toggleSettings2();
            document.getElementById('seatingChart2').innerHTML = '';
        }

        function saveSeatingChartToLocalStorage2() {
            const data2 = {
                seatingChartData: seatingChartData2,
                groupingMethod: document.getElementById('groupingMethod2').value,
                columns: document.getElementById('columns2').value,
                groups: document.getElementById('groups2').value
            };
            localStorage.setItem(localStoragePrefix + 'seatingChartData2', JSON.stringify(data2));
        }

        function loadSeatingChartFromLocalStorage2() {
            const savedData2 = localStorage.getItem(localStoragePrefix + 'seatingChartData2');
            if (savedData2) {
                const data2 = JSON.parse(savedData2);
                seatingChartData2 = data2.seatingChartData || [];
                document.getElementById('groupingMethod2').value = data2.groupingMethod || '';
                document.getElementById('columns2').value = data2.columns || 5;
                document.getElementById('groups2').value = data2.groups || 9;
                toggleSettings2();
            }
        }

        window.addEventListener('load', loadSeatingChartFromLocalStorage2);
        window.addEventListener('beforeunload', saveSeatingChartToLocalStorage2);

        function showHomeworkTracking() {
            document.getElementById('homeworkTrackingStart').value = '';
            document.getElementById('homeworkTrackingEnd').value = '';
            document.getElementById('homeworkTrackingResult').innerHTML = '';

            const studentSelect = document.getElementById('studentHomeworkSelect');
            studentSelect.innerHTML = '<option value="">請選擇學生</option>'; // Clear previous options and add a default

            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student;
                option.textContent = student;
                studentSelect.appendChild(option);
            });

            document.getElementById('homeworkTrackingOverlay').style.display = 'flex';
        }

        function hideHomeworkTracking() {
            document.getElementById('homeworkTrackingOverlay').style.display = 'none';
            location.reload(); 
        }

        function updateChecklistLocalStorage(dateKey, assignment, student, color) {
            let statusData = JSON.parse(localStorage.getItem(`${localStoragePrefix}checklist_${dateKey}`)) || {};
            if (!statusData[assignment]) statusData[assignment] = {};
            statusData[assignment][student] = color;
            localStorage.setItem(`${localStoragePrefix}checklist_${dateKey}`, JSON.stringify(statusData));
        }

        function searchHomeworkTracking() {
            const start = document.getElementById('homeworkTrackingStart').value;
            const end = document.getElementById('homeworkTrackingEnd').value;
            if (!start || !end) {
                alert("請選擇日期區間");
                return;
            }

            const startDate = new Date(start);
            const endDate = new Date(end);
            if (endDate < startDate) {
                alert("結束日期不能早於開始日期");
                return;
            }

            const resultDiv = document.getElementById('homeworkTrackingResult');
            resultDiv.innerHTML = '';

            const dateKeys = [];
            let d = new Date(startDate);
            while (d <= endDate) {
                const dateKey = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
                dateKeys.push(dateKey);
                d.setDate(d.getDate() + 1);
            }

            const trackingData = {};
            let assignmentDatePairs = [];

            dateKeys.forEach(dateKey => {
                if (homeworks[dateKey]) {
                    const checklistData = JSON.parse(localStorage.getItem(`${localStoragePrefix}checklist_${dateKey}`)) || {};
                    const assignments = homeworks[dateKey];

                    assignments.forEach(a => {
                        assignmentDatePairs.push({dateKey: dateKey, assignment:a});
                        students.forEach(stu => {
                            const status = checklistData[a] && checklistData[a][stu] ? checklistData[a][stu] : 'green';
                            if (!trackingData[stu]) trackingData[stu] = {};
                            if (!trackingData[stu][a]) trackingData[stu][a] = {};
                            trackingData[stu][a][dateKey] = status;
                        });
                    });
                }
            });

            const filteredStudents = students.filter(stu => {
                for (const {assignment, dateKey} of assignmentDatePairs) {
                    if (trackingData[stu] && trackingData[stu][assignment] && trackingData[stu][assignment][dateKey]) {
                        const st = trackingData[stu][assignment][dateKey];
                        if (st === 'red' || st === 'orange') {
                            return true;
                        }
                    }
                }
                return false;
            });

            if (filteredStudents.length === 0) {
                resultDiv.textContent = "沒有符合條件的學生";
                return;
            }

            assignmentDatePairs.sort((a,b) => {
                const ad = new Date(a.dateKey.replace(/-/g,'/'));
                const bd = new Date(b.dateKey.replace(/-/g,'/'));
                if(ad < bd) return -1;
                if(ad > bd) return 1;
                if(a.assignment < b.assignment) return -1;
                if(a.assignment > b.assignment) return 1;
                return 0;
            });

            const dateSet = Array.from(new Set(assignmentDatePairs.map(p => p.dateKey)));
            const dateColors = ['#ffe4e1', '#e6e6fa', '#f0fff0', '#fff5ee', '#f5f5dc'];
            const dateColorMap = {};
            dateSet.forEach((dateKey, i) => {
                dateColorMap[dateKey] = dateColors[i % dateColors.length];
            });

            const saveButtonContainer = document.createElement('div');
            saveButtonContainer.style.textAlign = 'right';
            saveButtonContainer.style.marginBottom = '10px';
            const forceSaveButton = document.createElement('button');
            forceSaveButton.textContent = '立即儲存';
            forceSaveButton.onclick = saveHomeworkTrackingData;
            saveButtonContainer.appendChild(forceSaveButton);
            resultDiv.appendChild(saveButtonContainer);

            const table = document.createElement('table');
            table.style.borderCollapse = 'collapse';
            table.style.width = '100%';
            table.style.border = '2px solid black';

            const thead = table.createTHead();
            const headRow = thead.insertRow();
            let th = document.createElement('th');
            th.style.border = '2px solid black';
            th.textContent = '學生/作業';
            th.style.fontSize = '16px';
            th.style.color = 'blue';
            th.style.fontWeight = 'bold';
            headRow.appendChild(th);

            assignmentDatePairs.forEach(({assignment, dateKey}) => {
                let th2 = document.createElement('th');
                th2.style.border = '2px solid black';
                const dateText = new Date(dateKey.replace(/-/g,'/')).toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
                th2.innerHTML = `${assignment}<br><span style="font-size:16px; color:blue; font-weight:bold;">${dateText}</span>`;
                th2.style.backgroundColor = dateColorMap[dateKey]; 
                headRow.appendChild(th2);
            });

            const tbody = table.createTBody();
            filteredStudents.forEach(stu => {
                const row = tbody.insertRow();
                let cell = row.insertCell();
                cell.style.border = '2px solid black';
                cell.textContent = stu;
                cell.style.fontSize = '16px';
                cell.style.color = 'blue';
                cell.style.fontWeight = 'bold';

                assignmentDatePairs.forEach(({assignment, dateKey}) => {
                    const c = row.insertCell();
                    c.style.border = '2px solid black';
                    c.style.backgroundColor = dateColorMap[dateKey]; 
                    let finalStatus = 'green';
                    let text = '已繳交';

                    if (trackingData[stu] && trackingData[stu][assignment] && trackingData[stu][assignment][dateKey]) {
                        const st = trackingData[stu][assignment][dateKey];
                        if (st === 'red') {
                            finalStatus = 'red';
                            text = '未繳交';
                        } else if (st === 'orange') {
                            finalStatus = 'orange';
                            text = '待訂正';
                        } else if (st === 'blue') {
                            finalStatus = 'blue';
                            text = '已訂正';
                        } else {
                            finalStatus = 'green';
                            text = '已繳交';
                        }
                    }

                    const btn = document.createElement('button');
                    btn.className = 'status-button';
                    btn.style.backgroundColor = finalStatus;
                    btn.style.color = 'white';
                    btn.textContent = text;
                    btn.dataset.assignment = assignment;
                    btn.dataset.student = stu;
                    btn.dataset.datekey = dateKey;
                    btn.onclick = () => {
                        toggleButtonStatus(btn, stu, assignment);
                    };
                    c.appendChild(btn);
                });
            });

            resultDiv.appendChild(table);
        }

        function saveHomeworkTrackingData() {
            const buttons = document.querySelectorAll('#homeworkTrackingResult .status-button');
            buttons.forEach(button => {
                const dateKey = button.dataset.datekey;
                const stu = button.dataset.student;
                const asg = button.dataset.assignment;
                const color = button.style.backgroundColor;
                if (dateKey && asg && stu) {
                    let statusData = JSON.parse(localStorage.getItem(`${localStoragePrefix}checklist_${dateKey}`)) || {};
                    if (!statusData[asg]) statusData[asg] = {};
                    statusData[asg][stu] = color;
                    localStorage.setItem(`${localStoragePrefix}checklist_${dateKey}`, JSON.stringify(statusData));
                }
            });
            alert("目前的作業狀態已強制儲存！");
        }

        function searchHomeworkByStudent() {
            const studentSelect = document.getElementById('studentHomeworkSelect');
            const selectedStudent = studentSelect.value;
 
            if (!selectedStudent) {
                alert("請選擇一位學生");
                return;
            }
 
            const resultDiv = document.getElementById('homeworkTrackingResult');
            resultDiv.innerHTML = '';
 
            let assignmentDatePairs = [];
 
            // Get all date keys from homeworks and sort them
            const sortedDateKeys = Object.keys(homeworks).sort((a, b) => new Date(a) - new Date(b));
 
            sortedDateKeys.forEach(dateKey => {
                if (homeworks[dateKey]) {
                    const checklistData = JSON.parse(localStorage.getItem(`${localStoragePrefix}checklist_${dateKey}`)) || {};
                    const assignments = homeworks[dateKey];
 
                    assignments.forEach(assignmentName => {
                        const studentStatus = checklistData[assignmentName] ? checklistData[assignmentName][selectedStudent] : undefined;
                        // We only care about incomplete assignments for this view
                        if (studentStatus === 'red' || studentStatus === 'orange') {
                            assignmentDatePairs.push({ dateKey: dateKey, assignment: assignmentName });
                        }
                    });
                }
            });
 
            if (assignmentDatePairs.length === 0) {
                resultDiv.innerHTML = `<h4>${selectedStudent} 的未完成作業列表：</h4><p>太棒了！沒有未完成的作業。</p>`;
                return;
            }
 
            // Sort assignments by date
            assignmentDatePairs.sort((a,b) => {
                const ad = new Date(a.dateKey.replace(/-/g,'/'));
                const bd = new Date(b.dateKey.replace(/-/g,'/'));
                if(ad < bd) return -1;
                if(ad > bd) return 1;
                if(a.assignment < b.assignment) return -1;
                if(a.assignment > b.assignment) return 1;
                return 0;
            });
 
            // Create color map for dates
            const dateSet = Array.from(new Set(assignmentDatePairs.map(p => p.dateKey)));
            const dateColors = ['#ffe4e1', '#e6e6fa', '#f0fff0', '#fff5ee', '#f5f5dc'];
            const dateColorMap = {};
            dateSet.forEach((dateKey, i) => {
                dateColorMap[dateKey] = dateColors[i % dateColors.length];
            });
 
            // Add a save button
            const saveButtonContainer = document.createElement('div');
            saveButtonContainer.style.textAlign = 'right';
            saveButtonContainer.style.marginBottom = '10px';
            const forceSaveButton = document.createElement('button');
            forceSaveButton.textContent = '立即儲存';
            forceSaveButton.onclick = saveHomeworkTrackingData;
            saveButtonContainer.appendChild(forceSaveButton);
            resultDiv.appendChild(saveButtonContainer);
 
            // Create the table
            const table = document.createElement('table');
            table.style.borderCollapse = 'collapse';
            table.style.width = '100%';
            table.style.border = '2px solid black';
 
            // Table Header
            const thead = table.createTHead();
            const headRow = thead.insertRow();
            let th = document.createElement('th');
            th.style.border = '2px solid black';
            th.textContent = '學生/作業';
            th.style.fontSize = '16px';
            th.style.color = 'blue';
            th.style.fontWeight = 'bold';
            headRow.appendChild(th);
 
            assignmentDatePairs.forEach(({assignment, dateKey}) => {
                let th2 = document.createElement('th');
                th2.style.border = '2px solid black';
                const dateText = new Date(dateKey.replace(/-/g,'/')).toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
                th2.innerHTML = `${assignment}<br><span style="font-size:16px; color:blue; font-weight:bold;">${dateText}</span>`;
                th2.style.backgroundColor = dateColorMap[dateKey]; 
                headRow.appendChild(th2);
            });
 
            // Table Body
            const tbody = table.createTBody();
            const row = tbody.insertRow();
            let cell = row.insertCell();
            cell.style.border = '2px solid black';
            cell.textContent = selectedStudent;
            cell.style.fontSize = '16px';
            cell.style.color = 'blue';
            cell.style.fontWeight = 'bold';
 
            assignmentDatePairs.forEach(({assignment, dateKey}) => {
                const c = row.insertCell();
                c.style.border = '2px solid black';
                c.style.backgroundColor = dateColorMap[dateKey]; 
                
                const checklistData = JSON.parse(localStorage.getItem(`${localStoragePrefix}checklist_${dateKey}`)) || {};
                const status = checklistData[assignment] ? checklistData[assignment][selectedStudent] : 'red';
 
                let finalStatus = status === 'orange' ? 'orange' : 'red';
                let text = status === 'orange' ? '待訂正' : '未繳交';
 
                const btn = document.createElement('button');
                btn.className = 'status-button';
                btn.style.backgroundColor = finalStatus;
                btn.style.color = 'white';
                btn.textContent = text;
                btn.dataset.assignment = assignment;
                btn.dataset.student = selectedStudent;
                btn.dataset.datekey = dateKey;
                btn.onclick = () => {
                    toggleButtonStatus(btn, selectedStudent, assignment);
                };
                c.appendChild(btn);
            });
 
            resultDiv.appendChild(table);
        }

        // 兌獎功能
        let selectedStudentIndex = null;

        function showRedeemOverlay() {
            renderStudentTable();
            document.getElementById('redeemOverlay').style.display = 'flex';
        }

        function hideRedeemOverlay() {
            document.getElementById('redeemOverlay').style.display = 'none';
        }

        function openRedeemModal(studentIndex) {
            selectedStudentIndex = studentIndex;
            document.getElementById("redeemModal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("redeemModal").style.display = "none";
            document.getElementById("redeemPoints").value = '';
            document.getElementById("redeemContent").value = '';
        }

        function calculateTotalScore(studentIndex) {
            let totalScore = 0;
            Object.keys(scores).forEach(dateKey => {
                const score = scores[dateKey][`${students[studentIndex]}-${studentIndex}`];
                if (score) totalScore += score;
            });
            return totalScore;
        }

        function getStudentGroupIndex(studentIndex) {
            for (const [groupIndex, members] of Object.entries(groups)) {
                if (members.includes(students[studentIndex])) return parseInt(groupIndex);
            }
            return -1;
        }

        function renderStudentTable(sortedStudents = students.map((student, index) => ({ student, index }))) {
            const studentTableBody = document.querySelector("#studentTable tbody");
            if(!studentTableBody) return;
            studentTableBody.innerHTML = '';
            const groupColors = ["#e0f7fa", "#e8f5e9", "#fce4ec", "#fff3e0", "#ede7f6"];

            sortedStudents.forEach(({ student, index }) => {
                const totalScore = calculateTotalScore(index);
                const studentKey = `${student}-${index}`;
                const redemptionRecords = redemptionHistory[studentKey] || [];
                const groupIndex = getStudentGroupIndex(index);
                const backgroundColor = groupColors[groupIndex % groupColors.length];

                let redemptionDisplay = redemptionRecords.map((record, idx) => 
                    `第${idx + 1}次: ${record.points} 分，${record.content || "無內容"}，${record.date}`
                ).join('<br>');

                const row = document.createElement('tr');
                row.style.backgroundColor = backgroundColor;
                row.innerHTML = `
                    <td>${student}</td>
                    <td>${totalScore}</td>
                    <td><button class="button" onclick="openRedeemModal(${index})">兌換獎勵</button></td>
                    <td>${redemptionDisplay || "無"}</td>
                `;
                studentTableBody.appendChild(row);
            });
        }

        function confirmRedeem() {
            const points = parseInt(document.getElementById("redeemPoints").value);
            const content = document.getElementById("redeemContent").value.trim();
            
            if (!points || points <= 0) {
                alert("請輸入有效的兌換分數");
                return;
            }

            const totalScore = calculateTotalScore(selectedStudentIndex);
            if (totalScore < points) {
                alert("分數不足以兌換");
                return;
            }

            const studentKey = `${students[selectedStudentIndex]}-${selectedStudentIndex}`;
            const currentDate = new Date().toISOString().split('T')[0];

            if (!scores[currentDate]) scores[currentDate] = {};
            scores[currentDate][studentKey] = (scores[currentDate][studentKey] || 0) - points;

            if (!redemptionHistory[studentKey]) redemptionHistory[studentKey] = [];
            redemptionHistory[studentKey].push({ points, content, date: currentDate });
            localStorage.setItem(localStoragePrefix + 'redemptionHistory', JSON.stringify(redemptionHistory));
            localStorage.setItem(localStoragePrefix + 'scores', JSON.stringify(scores));

            // 若目前頁面正顯示當日加扣分表，立即更新
            if (document.getElementById('inputSection').style.display === 'block') {
                const displayedDateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
                if (displayedDateKey === currentDate) {
                    updateScoreTables();
                }
            }

            renderStudentTable();
            closeModal();
            alert(`兌換成功！${students[selectedStudentIndex]}的分數減去 ${points}`);
        }

        function saveRedemptionHistoryAsDoc() {
            const today = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const originalTable = document.querySelector("#studentTable").outerHTML;
            const cleanTable = originalTable
                .replace(/<th>兌換獎勵<\/th>/g, '')
                .replace(/<td><button[^>]*>兌換獎勵<\/button><\/td>/g, '');

            const docContent = `
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <meta charset="UTF-8">
                    <title>兌換紀錄</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 10px; border: 1px solid black; text-align: center; }
                    </style>
                </head>
                <body>
                    <h1>學生兌換紀錄 - ${today}</h1>
                    ${cleanTable}
                </body>
                </html>
            `;

            const blob = new Blob([docContent], { type: "application/msword" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `兌換紀錄_${today}.doc`;
            link.click();
        }

        function resetRedemptionData() {
            if (confirm("確定要清空本地儲存的兌換資料嗎？")) {
                localStorage.removeItem(localStoragePrefix + 'redemptionHistory');
                redemptionHistory = {};
                renderStudentTable();
                alert("本地資料已重置");
            }
        }

        function sortTableByGroup() {
            const sortedStudents = students.map((student, index) => ({ student, index }))
                .sort((a, b) => getStudentGroupIndex(a.index) - getStudentGroupIndex(b.index));
            renderStudentTable(sortedStudents);
        }

        function sortTableByScore() {
            const sortedStudents = students.map((student, index) => ({
                student,
                index,
                score: calculateTotalScore(index)
            })).sort((a, b) => b.score - a.score);
            renderStudentTable(sortedStudents);
        }
        // 抽籤系統
        let lotteryState = {
            drawnStudents: [],
            allStudents: [],
            currentDrawnStudent: null
        };

        function showLottery() {
            const studentNames = getStudentNames();
            
            if (studentNames.length === 0) {
                alert('請先輸入學生姓名！');
                return;
            }

            // 載入抽籤狀態
            loadLotteryState();
            
            // 更新學生列表
            lotteryState.allStudents = studentNames;
            
            document.getElementById('lotteryOverlay').style.display = 'block';
            document.getElementById('lotteryPanel').style.display = 'block';
            
            updateLotteryGrid();
        }

        function hideLottery() {
            document.getElementById('lotteryOverlay').style.display = 'none';
            document.getElementById('lotteryPanel').style.display = 'none';
        }

        function updateLotteryGrid() {
            const grid = document.getElementById('lotteryStudentGrid');
            grid.innerHTML = '';
            
            lotteryState.allStudents.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'lottery-student';
                studentDiv.textContent = student;
                
                if (student === lotteryState.currentDrawnStudent) {
                    // 當次抽中的學生用紅色顯示
                    studentDiv.classList.add('current-drawn');
                } else if (lotteryState.drawnStudents.includes(student)) {
                    // 之前抽中的學生用灰色顯示
                    studentDiv.classList.add('drawn');
                }
                
                grid.appendChild(studentDiv);
            });
            
            // 更新抽籤按鈕狀態
            const remainingStudents = lotteryState.allStudents.filter(s => !lotteryState.drawnStudents.includes(s));
            document.getElementById('drawButton').disabled = remainingStudents.length === 0;
        }

        function drawStudent() {
            const remainingStudents = lotteryState.allStudents.filter(s => !lotteryState.drawnStudents.includes(s));
            
            if (remainingStudents.length === 0) {
                alert('所有學生都已經被抽過了！');
                return;
            }
            
            // 隨機抽選
            const randomIndex = Math.floor(Math.random() * remainingStudents.length);
            const selectedStudent = remainingStudents[randomIndex];
            
            // 設定當次抽中的學生
            lotteryState.currentDrawnStudent = selectedStudent;
            
            // 加入已抽選列表
            lotteryState.drawnStudents.push(selectedStudent);
            
            // 儲存狀態
            saveLotteryState();
            
            // 更新顯示
            updateLotteryGrid();
            
            // 全螢幕顯示抽中學生
            showWinner(selectedStudent);
        }

        function showWinner(studentName) {
            document.getElementById('winnerName').textContent = studentName;
            document.getElementById('winnerDisplay').style.display = 'flex';
            
            // 3秒後自動關閉
            setTimeout(() => {
                document.getElementById('winnerDisplay').style.display = 'none';
            }, 3000);
        }

        function resetLottery() {
            if (confirm('確定要重新開始抽籤嗎？')) {
                lotteryState.drawnStudents = [];
                lotteryState.currentDrawnStudent = null;
                saveLotteryState();
                updateLotteryGrid();
            }
        }

        function loadLotteryState() {
            const saved = localStorage.getItem('lotteryState');
            if (saved) {
                lotteryState = JSON.parse(saved);
            }
        }

        function saveLotteryState() {
            localStorage.setItem('lotteryState', JSON.stringify(lotteryState));
        }

        // 計時器系統
        let timerInterval = null;
        let timerSeconds = 0;
        let isTimerRunning = false;
        let isTimerPaused = false;

        function showTimer() {
            document.getElementById('timerOverlay').style.display = 'block';
            document.getElementById('timerPanel').style.display = 'block';
        }

        function hideTimer() {
            document.getElementById('timerOverlay').style.display = 'none';
            document.getElementById('timerPanel').style.display = 'none';
        }

        function setTimer(seconds) {
            timerSeconds = seconds;
            document.getElementById('startTimerButton').disabled = false;
            
            // 高亮選中的預設時間按鈕
            document.querySelectorAll('.timer-presets button').forEach(btn => {
                btn.style.background = '#9C27B0';
            });
            
            event.target.style.background = '#4CAF50';
        }

        function setCustomTimer() {
            const minutes = parseInt(document.getElementById('customMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('customSeconds').value) || 0;
            
            if (minutes === 0 && seconds === 0) {
                alert('請設定時間！');
                return;
            }
            
            timerSeconds = minutes * 60 + seconds;
            document.getElementById('startTimerButton').disabled = false;
            
            // 重置預設按鈕
            document.querySelectorAll('.timer-presets button').forEach(btn => {
                btn.style.background = '#9C27B0';
            });
        }

        function startTimer() {
            if (timerSeconds <= 0) return;
            
            isTimerRunning = true;
            
            // 隱藏設定面板，顯示倒數
            hideTimer();
            document.getElementById('timerDisplay').style.display = 'flex';
            
            // 開始倒數
            timerInterval = setInterval(() => {
                updateTimerDisplay();
                timerSeconds--;
                
                // 最後10秒加上緊張效果
                if (timerSeconds <= 10 && timerSeconds > 0) {
                    document.getElementById('timerDisplay').classList.add('tension');
                    playTensionSound();
                }
                
                // 時間到了
                if (timerSeconds < 0) {
                    clearInterval(timerInterval);
                    timerFinished();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerTime').textContent = timeString;
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            isTimerPaused = false;
            document.getElementById('timerDisplay').style.display = 'none';
            document.getElementById('timerDisplay').classList.remove('tension');
            
            // 重置按鈕顯示狀態
            document.getElementById('pauseTimerButton').style.display = 'inline-block';
            document.getElementById('resumeTimerButton').style.display = 'none';
        }
        
        function pauseTimer() {
            if (isTimerRunning && !isTimerPaused) {
                clearInterval(timerInterval);
                isTimerPaused = true;
                
                // 切換按鈕顯示
                document.getElementById('pauseTimerButton').style.display = 'none';
                document.getElementById('resumeTimerButton').style.display = 'inline-block';
            }
        }
        
        function resumeTimer() {
            if (isTimerRunning && isTimerPaused) {
                isTimerPaused = false;
                
                // 重新開始計時器
                timerInterval = setInterval(() => {
                    updateTimerDisplay();
                    timerSeconds--;
                    
                    // 最後10秒加上緊張效果
                    if (timerSeconds <= 10 && timerSeconds > 0) {
                        document.getElementById('timerDisplay').classList.add('tension');
                        playTensionSound();
                    }
                    
                    // 時間到了
                    if (timerSeconds < 0) {
                        clearInterval(timerInterval);
                        timerFinished();
                    }
                }, 1000);
                
                // 切換按鈕顯示
                document.getElementById('pauseTimerButton').style.display = 'inline-block';
                document.getElementById('resumeTimerButton').style.display = 'none';
            }
        }

        function timerFinished() {
            isTimerRunning = false;
            isTimerPaused = false;
            const timerTimeElement = document.getElementById('timerTime');
            timerTimeElement.textContent = '時間到！';
            timerTimeElement.classList.add('finished');
            document.getElementById('timerDisplay').classList.remove('tension');
            
            // 重置按鈕顯示狀態
            document.getElementById('pauseTimerButton').style.display = 'inline-block';
            document.getElementById('resumeTimerButton').style.display = 'none';
            
            // 播放結束音效
            playFinishSound();
            
            // 5秒後自動關閉
            setTimeout(() => {
                document.getElementById('timerDisplay').style.display = 'none';
                // 移除finished樣式，為下次使用做準備
                timerTimeElement.classList.remove('finished');
            }, 5000);
        }

        function playTensionSound() {
            // 創建簡單的嗶聲
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function playFinishSound() {
            // 創建結束音效
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            [523, 659, 784].forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                
                const startTime = audioContext.currentTime + index * 0.2;
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.3);
            });
        }

        // 獲取學生姓名的輔助函數
        function getStudentNames() {
            // 直接使用全域的 students 陣列
            return students || [];
        }

    </script>
</body>
</html>
