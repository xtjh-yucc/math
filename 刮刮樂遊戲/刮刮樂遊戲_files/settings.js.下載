class SettingsManager {
  constructor() {
    this.symbols = ["ğŸ’", "ğŸ’°", "â­", "7", "ğŸ‡", "ğŸˆ", "ğŸ‰", "ğŸ…", "ğŸ’"];

    this.defaultPrizes = [
      { symbol: "ğŸ’", prize: 100, description: "ç´…åˆ©çé‡‘", probability: 15 },
      { symbol: "ğŸ’°", prize: 500, description: "ç¾é‡‘çå‹µ", probability: 12 },
      { symbol: "â­", prize: 1000, description: "å¹¸é‹æ˜Ÿç", probability: 10 },
      { symbol: "7", prize: 2000, description: "é ­ççé‡‘", probability: 6 },
      { symbol: "ğŸ‡", prize: 300, description: "å¹¸é‹çé …", probability: 12 },
      { symbol: "ğŸˆ", prize: 400, description: "å¥½é‹çé‡‘", probability: 10 },
      { symbol: "ğŸ‰", prize: 600, description: "è¶…ç´šçé …", probability: 8 },
      { symbol: "ğŸ…", prize: 800, description: "é©šå–œçé‡‘", probability: 4 },
      { symbol: "ğŸ’", prize: 3000, description: "é‘½çŸ³å¤§ç", probability: 3 },
    ];

    this.prizes = [];
    this.loadSettings();
    this.setupPrizeTable();
  }

  createPrizeRow(prize, index) {
    const row = document.createElement("tr");

    // Symbol cell
    const symbolCell = document.createElement("td");
    symbolCell.textContent = prize.symbol;
    row.appendChild(symbolCell);

    // Prize amount cell
    const prizeCell = document.createElement("td");
    const prizeInput = document.createElement("input");
    prizeInput.type = "number";
    prizeInput.value = prize.prize;
    prizeInput.min = "0";
    prizeInput.max = "999999";
    prizeCell.appendChild(prizeInput);
    row.appendChild(prizeCell);

    // Description cell
    const descCell = document.createElement("td");
    const descInput = document.createElement("input");
    descInput.type = "text";
    descInput.value = prize.description;
    descInput.maxLength = "20";
    descCell.appendChild(descInput);
    row.appendChild(descCell);

    // Probability cell
    const probCell = document.createElement("td");
    const probInput = document.createElement("input");
    probInput.type = "number";
    probInput.value = prize.probability;
    probInput.min = "0";
    probInput.max = "100";
    probInput.step = "0.1";
    probCell.appendChild(probInput);
    row.appendChild(probCell);

    // Action cell
    const actionCell = document.createElement("td");
    const deleteButton = document.createElement("button");
    deleteButton.textContent = "åˆªé™¤";
    deleteButton.className = "delete-row";
    actionCell.appendChild(deleteButton);
    row.appendChild(actionCell);

    // Event listeners
    prizeInput.onchange = () => {
      this.prizes[index].prize = parseInt(prizeInput.value) || 0;
      this.saveSettings();
    };

    descInput.onchange = () => {
      this.prizes[index].description = descInput.value;
      this.saveSettings();
    };

    probInput.onchange = () => {
      this.prizes[index].probability = parseFloat(probInput.value) || 0;
      this.validateProbabilities();
      this.saveSettings();
    };

    deleteButton.onclick = () => {
      if (this.prizes.length <= 1) {
        alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹çé …ï¼");
        return;
      }
      this.prizes.splice(index, 1);
      this.saveSettings();
      this.setupPrizeTable();
    };

    return row;
  }

  validateProbabilities() {
    const total = this.prizes.reduce(
      (sum, prize) => sum + (prize.probability || 0),
      0
    );
    if (total > 100) {
      alert(`æ‰€æœ‰çé …æ©Ÿç‡ç¸½å’Œä¸èƒ½è¶…é100%ï¼Œç›®å‰ç¸½å’Œç‚º${total.toFixed(1)}%`);
      return false;
    }
    return true;
  }

  setupPrizeTable() {
    const tbody = document.querySelector("#prizeTable tbody");
    if (tbody) {
      tbody.innerHTML = "";
      this.prizes.forEach((prize, index) => {
        tbody.appendChild(this.createPrizeRow(prize, index));
      });
    }
  }

  loadSettings() {
    try {
      const settings = localStorage.getItem("scratchCardSettings");
      if (settings) {
        const parsedSettings = JSON.parse(settings);
        this.prizes = parsedSettings.prizes || [];
        // ç¢ºä¿æ‰€æœ‰çé …éƒ½æœ‰æ©Ÿç‡å€¼
        this.prizes.forEach((prize) => {
          if (typeof prize.probability === "undefined") {
            prize.probability = 100 / this.prizes.length;
          }
        });
      } else {
        this.prizes = JSON.parse(JSON.stringify(this.defaultPrizes)); // æ·±æ‹·è²
        this.saveSettings();
      }
    } catch (error) {
      console.error("è¼‰å…¥è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
      this.prizes = JSON.parse(JSON.stringify(this.defaultPrizes)); // æ·±æ‹·è²
    }
  }

  saveSettings() {
    try {
      const settings = {
        prizes: this.prizes,
      };
      localStorage.setItem("scratchCardSettings", JSON.stringify(settings));
    } catch (error) {
      console.error("å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
    }
  }

  clearSettings(imageHandler) {
    try {
      localStorage.removeItem("scratchCardSettings");
      localStorage.removeItem("scratchCardCover");

      // ä½¿ç”¨æ·±æ‹·è²ä¾†é‡è¨­é è¨­å€¼
      this.prizes = JSON.parse(JSON.stringify(this.defaultPrizes));
      this.saveSettings();
      this.setupPrizeTable();

      const imagePreview = document.getElementById("imagePreview");
      if (imagePreview) {
        imagePreview.innerHTML = "";
      }

      const fileInput = document.getElementById("coverImage");
      if (fileInput) {
        fileInput.value = "";
      }

      if (imageHandler) {
        imageHandler.coverImage = null;
      }

      console.log("è¨­å®šå·²æˆåŠŸæ¸…é™¤");
    } catch (error) {
      console.error("æ¸…é™¤è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
    }
  }

  getPrizes() {
    return this.prizes;
  }

  getAllSymbols() {
    return this.symbols;
  }
}
