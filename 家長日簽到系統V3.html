<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å®¶é•·æ—¥ç°½åˆ°ç³»çµ± (ä¸‹è¼‰PDFç‰ˆ)</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 25px; gap: 15px; }
    h1 { color: #333; margin: 0; font-size: 28px; }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .action-button { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.3s; background-color: #007bff; color: white; text-decoration: none; display: inline-block; }
    .action-button.secondary { background-color: #6c757d; }
    .action-button.print { background-color: #28a745; }
    .action-button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
    .download-link { font-size: 14px; color: #007bff; text-decoration: none; }
    #excel-file-input { display: none; }
    #student-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .student-box { padding: 15px; border-radius: 10px; cursor: pointer; transition: background-color 0.3s ease, transform 0.3s; text-align: center; border: 2px solid transparent; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; }
    .student-info .seat-number { font-size: 14px; font-weight: 500; color: rgba(255, 255, 255, 0.8); }
    .student-info .student-name { font-size: 22px; font-weight: bold; color: #fff; margin-top: 5px; }
    .signature-display { margin-top: 15px; min-height: 60px; display: flex; justify-content: center; align-items: center; background: rgba(255, 255, 255, 0.15); border-radius: 6px; }
    .signature-display img { max-width: 100%; max-height: 58px; display: block; }
    .signature-display .placeholder { font-size: 16px; color: rgba(255, 255, 255, 0.8); }
    .student-box.unsigned { background-color: #3498db; }
    .student-box.unsigned:hover { transform: translateY(-3px); }
    .student-box.signed { background-color: #2ecc71; cursor: not-allowed; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.3s; }
    .modal-content { background: white; padding: 30px 40px; border-radius: 16px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    .modal-content h2 { font-size: 24px; color: #333; margin-top: 0; margin-bottom: 10px; }
    .modal-content p { color: #666; margin-top: 0; margin-bottom: 20px; }
    #signature-pad-container { border: 2px dashed #ccc; border-radius: 12px; margin: 15px 0; }
    canvas { width: 100%; height: 100%; display: block; border-radius: 12px; }
    .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
    .modal-buttons button { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
    #confirm-signature { background-color: #28a745; color: white; }
    #clear-signature { background-color: #ffc107; color: #333; }
    #cancel-signature { background-color: #6c757d; color: white; }

    #spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 2000; background: rgba(255, 255, 255, 0.8); flex-direction: column; }
    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .pdf-export-mode { padding: 2cm; background-color: #fff; }
    .pdf-export-mode #pdf-header-wrapper { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; }
    .pdf-export-mode #pdf-timestamp { font-size: 12pt; color: #555; }
    .pdf-export-mode #pdf-title { font-size: 28pt; font-weight: bold; color: #000; flex-grow: 1; text-align: center; }
    .pdf-export-mode #student-list-container { grid-template-columns: repeat(5, 1fr) !important; gap: 15px !important; }
    .pdf-export-mode .student-box { background-color: #ffffff !important; border: 2px solid #ccc !important; padding: 12px !important; min-height: auto !important; border-radius: 12px !important; }
    .pdf-export-mode .student-box.signed { border-color: #2ecc71 !important; }
    .pdf-export-mode .student-info .seat-number, .pdf-export-mode .student-info .student-name, .pdf-export-mode .signature-display .placeholder { color: #000 !important; }
    .pdf-export-mode .student-info .seat-number { font-size: 10pt; font-weight: normal; text-align: left; }
    .pdf-export-mode .student-info .student-name { font-size: 18pt; margin-top: 2px; }
    .pdf-export-mode .signature-display { margin-top: 10px !important; min-height: 50px !important; background-color: #f8f9fa !important; border-radius: 6px !important; }
    .pdf-export-mode .signature-display .placeholder { color: #888 !important; font-size: 14pt; }
    .pdf-export-mode .signature-display img { max-height: 48px !important; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><span id="class-name-display"></span>å®¶é•·æ—¥ç°½åˆ°ç³»çµ±</h1>
      <div class="actions">
        <button id="set-class-button" class="action-button secondary">è¨­å®šç­ç´š</button>
        <input type="file" id="excel-file-input" accept=".xlsx, .xls">
        <button id="import-button" class="action-button">åŒ¯å…¥å­¸ç”Ÿ</button>
        <a href="#" id="download-template" class="download-link">ä¸‹è¼‰ç¯„ä¾‹æª”</a>
        <button id="print-button" class="action-button print">ğŸ–¨ï¸ åˆ—å°ç°½åˆ°è¡¨</button>
      </div>
    </header>

    <main id="capture-area">
      <div id="pdf-header-wrapper" style="display: none;">
        <div id="pdf-timestamp"></div>
        <div id="pdf-title"></div>
      </div>
      <div id="student-list-container"><p>è«‹å…ˆã€Œè¨­å®šç­ç´šã€ï¼Œå†ã€ŒåŒ¯å…¥å­¸ç”Ÿã€é–‹å§‹ä½¿ç”¨ã€‚</p></div>
    </main>
  </div>

  <div id="signature-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h2>è«‹å®¶é•·ç°½å</h2>
      <p>æ‚¨æ­£åœ¨ç‚º <strong id="student-name-in-modal"></strong> çš„å®¶é•·ç°½åˆ°</p>
      <div id="signature-pad-container"><canvas id="signature-canvas"></canvas></div>
      <div class="modal-buttons">
        <button id="confirm-signature">ç¢ºèªç°½å</button>
        <button id="clear-signature">æ¸…é™¤</button>
        <button id="cancel-signature">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
  <div id="spinner-overlay" style="display: none;">
    <div class="spinner"></div>
    <p style="margin-top: 20px; font-size: 18px; color: #333;">æ­£åœ¨æº–å‚™PDF...</p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let students = [], currentStudentId = null, className = '';
      const printButton = document.getElementById('print-button');
      const spinnerOverlay = document.getElementById('spinner-overlay');
      const captureArea = document.getElementById('capture-area');
      const pdfHeaderWrapper = document.getElementById('pdf-header-wrapper');
      const pdfTimestamp = document.getElementById('pdf-timestamp');
      const pdfTitle = document.getElementById('pdf-title');
      const studentListContainer = document.getElementById('student-list-container');
      const setClassButton = document.getElementById('set-class-button');
      const classNameDisplay = document.getElementById('class-name-display');
      const importButton = document.getElementById('import-button');
      const fileInput = document.getElementById('excel-file-input');
      const downloadLink = document.getElementById('download-template');
      const modal = document.getElementById('signature-modal');
      const studentNameInModal = document.getElementById('student-name-in-modal');
      const confirmBtn = document.getElementById('confirm-signature');
      const cancelBtn = document.getElementById('cancel-signature');
      const clearBtn = document.getElementById('clear-signature');
      const canvas = document.getElementById('signature-canvas');
      const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

      function renderStudentList() {
        studentListContainer.innerHTML = '';
        if (students.length === 0) {
          studentListContainer.innerHTML = '<p>è«‹å…ˆã€Œè¨­å®šç­ç´šã€ï¼Œå†ã€ŒåŒ¯å…¥å­¸ç”Ÿã€é–‹å§‹ä½¿ç”¨ã€‚</p>';
          return;
        }
        students.forEach(student => {
          const box = document.createElement('div');
          box.dataset.id = student.id;
          box.className = `student-box ${student.signed ? 'signed' : 'unsigned'}`;
          box.innerHTML = `
            <div class="student-info">
              <div class="seat-number">åº§è™Ÿ: ${student.seatNumber}</div>
              <div class="student-name">${student.name}</div>
            </div>
            <div class="signature-display">
              ${student.signed ? `<img src="${student.signature}" alt="å®¶é•·ç°½å">` : '<span class="placeholder">å¾…ç°½å</span>'}
            </div>`;
          if (!student.signed) {
            box.addEventListener('click', () => openSignatureModal(student.id));
          }
          studentListContainer.appendChild(box);
        });
      }

      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const padContainer = document.getElementById('signature-pad-container');
        canvas.width = padContainer.offsetWidth * ratio;
        canvas.height = 200 * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
      }

      function openSignatureModal(studentId) {
        currentStudentId = studentId;
        const student = students.find(s => s.id === studentId);
        studentNameInModal.textContent = `${student.seatNumber} ${student.name}`;
        modal.style.display = 'flex';
        setTimeout(() => resizeCanvas(), 0);
      }
      function closeSignatureModal() { modal.style.display = 'none'; signaturePad.clear(); currentStudentId = null; }

      confirmBtn.addEventListener('click', () => {
        if (signaturePad.isEmpty()) { alert('å®¶é•·å°šæœªç°½åï¼'); return; }
        const signatureImage = signaturePad.toDataURL('image/png');
        const student = students.find(s => s.id === currentStudentId);
        if (student) { student.signed = true; student.signature = signatureImage; }
        renderStudentList(); closeSignatureModal();
      });
      cancelBtn.addEventListener('click', closeSignatureModal);
      clearBtn.addEventListener('click', () => signaturePad.clear());
      window.addEventListener('resize', () => { if(modal.style.display === 'flex') resizeCanvas(); });

      // åˆ—å° PDF â†’ æ”¹æˆç›´æ¥ä¸‹è¼‰ PDF
      printButton.addEventListener('click', () => {
        if (students.length === 0) { alert("æ²’æœ‰å­¸ç”Ÿè³‡æ–™"); return; }
        if (!className) { alert("è«‹å…ˆè¨­å®šç­ç´š"); return; }

        spinnerOverlay.style.display = 'flex';
        const { jsPDF } = window.jspdf;
        const now = new Date();

        pdfTimestamp.textContent = now.toLocaleString();
        pdfTitle.textContent = `${className} å®¶é•·æ—¥ç°½åˆ°è¡¨`;
        pdfHeaderWrapper.style.display = 'flex';
        captureArea.classList.add('pdf-export-mode');

        html2canvas(captureArea, { scale: 1.5 }).then(canvas => {
          const img = canvas.toDataURL('image/jpeg', 0.6); // JPEG å£“ç¸®
          const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const imgHeight = (canvas.height * pageWidth) / canvas.width;

          if (imgHeight <= pageHeight) {
            pdf.addImage(img, 'JPEG', 0, 0, pageWidth, imgHeight);
          } else {
            let position = 0;
            let remainingHeight = imgHeight;
            while (remainingHeight > 0) {
              pdf.addImage(img, 'JPEG', 0, position, pageWidth, imgHeight);
              remainingHeight -= pageHeight;
              if (remainingHeight > 0) {
                pdf.addPage();
                position = 0;
              }
            }
          }

          pdf.save(`${className}.pdf`);
        }).catch(() => alert("PDF ç”¢ç”Ÿå¤±æ•—"))
          .finally(() => {
            spinnerOverlay.style.display = 'none';
            pdfHeaderWrapper.style.display = 'none';
            captureArea.classList.remove('pdf-export-mode');
          });
      });

      // å…¶ä»–äº‹ä»¶
      setClassButton.addEventListener('click', () => {
        const newClassName = prompt("è«‹è¼¸å…¥ç­ç´šåç¨± (ä¾‹å¦‚ï¼š701)", className);
        if (newClassName !== null && newClassName.trim() !== '') {
          className = newClassName.trim();
          classNameDisplay.textContent = `${className} `;
        }
      });
      importButton.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            students = json.slice(1).filter(row => row[0] && row[1]).map((row, index) => ({
              id: index + 1,
              seatNumber: String(row[0]).padStart(2, '0'),
              name: row[1],
              signed: false,
              signature: ""
            }));
            renderStudentList();
          } catch (error) {
            alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–å…§å®¹ä¸ç¬¦ã€‚");
          }
        };
        reader.readAsArrayBuffer(file);
        fileInput.value = '';
      });
      downloadLink.addEvent
