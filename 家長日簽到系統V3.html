<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>家長日簽到系統 (iPad 版)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 25px; gap: 15px; }
        h1 { color: #333; margin: 0; font-size: 28px; }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .action-button { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.3s; background-color: #007bff; color: white; }
        .action-button.secondary { background-color: #6c757d; }
        .action-button.print { background-color: #28a745; }
        .action-button:hover { transform: translateY(-2px); }
        .download-link { font-size: 14px; color: #007bff; text-decoration: none; }
        #excel-file-input { display: none; }
        #student-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .student-box { padding: 15px; border-radius: 10px; cursor: pointer; transition: background-color 0.3s ease, transform 0.3s; text-align: center; border: 2px solid transparent; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; }
        .student-info .seat-number { font-size: 14px; font-weight: 500; color: rgba(255, 255, 255, 0.8); }
        .student-info .student-name { font-size: 22px; font-weight: bold; color: #fff; margin-top: 5px; }
        .signature-display { margin-top: 15px; min-height: 60px; display: flex; justify-content: center; align-items: center; background: rgba(255, 255, 255, 0.15); border-radius: 6px; }
        .signature-display img { max-width: 100%; max-height: 58px; }
        .signature-display .placeholder { font-size: 16px; color: rgba(255, 255, 255, 0.8); }
        .student-box.unsigned { background-color: #3498db; }
        .student-box.signed { background-color: #2ecc71; cursor: not-allowed; }
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; }
        #signature-pad-container { border: 2px dashed #ccc; border-radius: 12px; margin: 15px 0; }
        canvas { width: 100%; height: 200px; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .modal-buttons button { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; }
        #confirm-signature { background-color: #28a745; color: white; }
        #clear-signature { background-color: #ffc107; color: black; }
        #cancel-signature { background-color: #6c757d; color: white; }
        #spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 2000; background: rgba(255,255,255,0.8); flex-direction: column; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        /* PDF */
        .pdf-export-mode { padding: 2cm; background: #fff; }
        .pdf-export-mode #student-list-container { grid-template-columns: repeat(5, 1fr) !important; gap: 15px !important; }
        .pdf-export-mode .student-box { background: #fff !important; border: 2px solid #ccc !important; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1><span id="class-name-display"></span>家長日簽到系統</h1>
        <div class="actions">
            <button id="set-class-button" class="action-button secondary">設定班級</button>
            <input type="file" id="excel-file-input" accept=".xlsx,.xls">
            <button id="import-button" class="action-button">匯入學生</button>
            <a href="#" id="download-template" class="download-link">下載範例檔</a>
            <button id="print-button" class="action-button print">🖨️ 列印簽到表</button>
        </div>
    </header>
    <main id="capture-area">
        <div id="pdf-header-wrapper" style="display:none;">
            <div id="pdf-timestamp"></div><div id="pdf-title"></div>
        </div>
        <div id="student-list-container"><p>請先「設定班級」，再「匯入學生」開始使用。</p></div>
    </main>
</div>

<div id="signature-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2>請家長簽名</h2>
        <p>您正在為 <strong id="student-name-in-modal"></strong> 的家長簽到</p>
        <div id="signature-pad-container"><canvas id="signature-canvas"></canvas></div>
        <div class="modal-buttons">
            <button id="confirm-signature">確認簽名</button>
            <button id="clear-signature">清除</button>
            <button id="cancel-signature">取消</button>
        </div>
    </div>
</div>

<div id="spinner-overlay" style="display:none;">
    <div class="spinner"></div><p style="margin-top:20px;">正在準備 PDF ...</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    let students = [], currentStudentId = null, className = '';
    const studentListContainer = document.getElementById('student-list-container');
    const setClassButton = document.getElementById('set-class-button');
    const classNameDisplay = document.getElementById('class-name-display');
    const spinnerOverlay = document.getElementById('spinner-overlay');
    const captureArea = document.getElementById('capture-area');
    const pdfHeaderWrapper = document.getElementById('pdf-header-wrapper');
    const pdfTimestamp = document.getElementById('pdf-timestamp');
    const pdfTitle = document.getElementById('pdf-title');
    const importButton = document.getElementById('import-button');
    const fileInput = document.getElementById('excel-file-input');
    const downloadLink = document.getElementById('download-template');
    const printButton = document.getElementById('print-button');
    const modal = document.getElementById('signature-modal');
    const studentNameInModal = document.getElementById('student-name-in-modal');
    const confirmBtn = document.getElementById('confirm-signature');
    const cancelBtn = document.getElementById('cancel-signature');
    const clearBtn = document.getElementById('clear-signature');
    const canvas = document.getElementById('signature-canvas');
    const signaturePad = new SignaturePad(canvas, { backgroundColor: 'white' });

    function renderStudentList() {
        studentListContainer.innerHTML = '';
        if (students.length === 0) {
            studentListContainer.innerHTML = '<p>請先「設定班級」，再「匯入學生」開始使用。</p>';
            return;
        }
        students.forEach(student => {
            const box = document.createElement('div');
            box.className = `student-box ${student.signed ? 'signed' : 'unsigned'}`;
            box.innerHTML = `
                <div class="student-info">
                    <div class="seat-number">座號: ${student.seatNumber}</div>
                    <div class="student-name">${student.name}</div>
                </div>
                <div class="signature-display">
                    ${student.signed ? `<img src="${student.signature}">` : '<span class="placeholder">待簽名</span>'}
                </div>`;
            if (!student.signed) {
                box.addEventListener('click', () => openSignatureModal(student.id));
            }
            studentListContainer.appendChild(box);
        });
    }

    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const padContainer = document.getElementById('signature-pad-container');
        canvas.width = padContainer.offsetWidth * ratio;
        canvas.height = 200 * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }

    function openSignatureModal(studentId) {
        currentStudentId = studentId;
        const student = students.find(s => s.id === studentId);
        studentNameInModal.textContent = `${student.seatNumber} ${student.name}`;
        modal.style.display = 'flex';
        setTimeout(resizeCanvas, 0);
    }

    function closeSignatureModal() {
        modal.style.display = 'none';
        signaturePad.clear();
        currentStudentId = null;
    }

    // 確認簽名
    confirmBtn.addEventListener('click', () => {
        if (signaturePad.isEmpty()) { alert('請簽名'); return; }
        const img = signaturePad.toDataURL();
        const student = students.find(s => s.id === currentStudentId);
        if (student) { student.signed = true; student.signature = img; }
        renderStudentList();
        closeSignatureModal();
    });
    cancelBtn.addEventListener('click', closeSignatureModal);
    clearBtn.addEventListener('click', () => signaturePad.clear());
    window.addEventListener('resize', () => { if (modal.style.display === 'flex') resizeCanvas(); });

    // 設定班級
    setClassButton.addEventListener('click', () => {
        const newName = prompt("請輸入班級名稱", className);
        if (newName) { className = newName.trim(); classNameDisplay.textContent = className; }
    });

    // 匯入學生
    importButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
            try {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheet];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                students = json.slice(1).filter(r => r[0] && r[1]).map((row, i) => ({
                    id: i+1, seatNumber: String(row[0]).padStart(2,'0'), name: row[1], signed: false, signature: ""
                }));
                renderStudentList();
            } catch { alert("匯入失敗"); }
        };
        reader.readAsArrayBuffer(file);
    });

    // 下載範例
    downloadLink.addEventListener('click', e => {
        e.preventDefault();
        const ws = XLSX.utils.aoa_to_sheet([["座號","姓名"],[1,"王小明"],[2,"陳美麗"]]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "學生名單");
        XLSX.writeFile(wb, "學生名單範本.xlsx");
    });

    // 列印 PDF
    printButton.addEventListener('click', () => {
        if (students.length === 0) { alert("沒有學生資料"); return; }
        if (!className) { alert("請先設定班級"); return; }
        spinnerOverlay.style.display = 'flex';
        const { jsPDF } = window.jspdf;
        const now = new Date();
        pdfTimestamp.textContent = now.toLocaleString();
        pdfTitle.textContent = `${className} 家長日簽到表`;
        pdfHeaderWrapper.style.display = 'flex';
        captureArea.classList.add('pdf-export-mode');
        html2canvas(captureArea, { scale: 2 }).then(canvas => {
            const img = canvas.toDataURL('image/jpeg', 0.8);
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            const w = pdf.internal.pageSize.getWidth();
            const h = (canvas.height * w) / canvas.width;
            pdf.addImage(img, 'JPEG', 0, 0, w, h);
            const blob = pdf.output('blob');
            const url = URL.createObjectURL(blob);
            window.open(url);
        }).catch(()=>alert("PDF 失敗"))
          .finally(()=>{
              spinnerOverlay.style.display = 'none';
              pdfHeaderWrapper.style.display = 'none';
              captureArea.classList.remove('pdf-export-mode');
          });
    });

    renderStudentList();
});
</script>
</body>
</html>
