class SettingsManager {
  constructor() {
    // åˆå§‹åŒ–æª¢æŸ¥
    if (!window.supabaseClient) {
      console.error('Supabase å®¢æˆ¶ç«¯æœªåˆå§‹åŒ–!');
      throw new Error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—');
    }

    this.symbols = ['ğŸ’', 'ğŸ’°', 'â­', '7', 'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸ…', 'ğŸ’'];
    this.defaultPrizes = [
     { symbol: "ğŸ’", prize: 1, description: "ç³–è“1é¡†", probability: 40 },
      { symbol: "ğŸ’°", prize: 2, description: "ç³–è“2é¡†", probability: 30 },
      { symbol: "â­", prize: 3, description: "ç³–è“3é¡†", probability: 10 },
      { symbol: "7", prize: 4, description: "ç³–è“4é¡†", probability: 2 },
      { symbol: "ğŸ‡", prize: 1, description: "å°ç‹å­éºµ1åŒ…", probability: 2 },
      { symbol: "ğŸˆ", prize: 2, description: "å°ç‹å­éºµ1åŒ…", probability: 1 },
      { symbol: "ğŸ‰", prize: 3, description: "å°ç‹å­éºµ1åŒ…", probability: 1 },
      { symbol: "ğŸ…", prize: 3, description: "å°ç‹å­éºµ2åŒ…", probability: 1 },
      { symbol: "ğŸ’", prize: 5, description: "å°ç‹å­éºµ2åŒ…", probability: 1 },

    ];

    this.prizes = [];
    this.currentSettingsId = null;
    this.expiresAt = null;
    this.setupShareButton();
    this.loadSettings().catch(e => console.error('åˆå§‹è¼‰å…¥éŒ¯èª¤:', e));
  }

  setupShareButton() {
    const shareBtn = document.createElement('button');
    shareBtn.id = 'shareSettings';
    shareBtn.textContent = 'ğŸ”— å»ºç«‹åˆ†äº«é€£çµ';
    shareBtn.className = 'share-button';
    shareBtn.onclick = () => this.handleShareSettings();
    
    const clearBtn = document.getElementById('clearSettings');
    if (clearBtn) {
      clearBtn.insertAdjacentElement('afterend', shareBtn);
    }
  }

  async loadSettings() {
    console.log('é–‹å§‹è¼‰å…¥è¨­å®š');
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const settingsId = urlParams.get('settings');

      if (settingsId) {
        const serverSettings = await window.supabaseClient.loadSettingsFromServer(settingsId);
        if (serverSettings) {
          this.currentSettingsId = serverSettings.id;
          this.expiresAt = new Date(serverSettings.expires_at);
          this.prizes = serverSettings.data.prizes;
          
          if (serverSettings.data.cover_image) {
            this.applyServerImage(serverSettings.data.cover_image, serverSettings.image_size_limit);
          }
          
          this.setupPrizeTable();
          this.showExpiryWarning();
          return;
        }
      }
      this.loadLocalSettings();
    } catch (error) {
      console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
      this.loadLocalSettings();
    }
  }

  applyServerImage(imageData, sizeLimit) {
    if (imageData.length > sizeLimit) {
      alert('ä¼ºæœå™¨åœ–ç‰‡å¤§å°é™åˆ¶å·²æ›´æ”¹ï¼Œå·²é‡ç½®ç‚ºé è¨­èƒŒæ™¯');
      localStorage.removeItem('scratchCardCover');
      return;
    }
    
    localStorage.setItem('scratchCardCover', imageData);
    document.getElementById('imagePreview').innerHTML = `<img src="${imageData}">`;
  }

  loadLocalSettings() {
    const localSettings = localStorage.getItem('scratchCardSettings');
    if (localSettings) {
      const { prizes } = JSON.parse(localSettings);
      this.prizes = prizes;
    } else {
      this.prizes = JSON.parse(JSON.stringify(this.defaultPrizes));
    }
    this.setupPrizeTable();
  }

  async saveSettings() {
	   // æ–°å¢åˆ†äº«æ¨¡å¼æª¢æŸ¥
    const isShareMode = new URLSearchParams(window.location.search).has('settings');
    if (isShareMode) {
      console.warn('åˆ†äº«æ¨¡å¼ç¦æ­¢ä¿å­˜è¨­å®š');
      return;
    }
    console.log('é–‹å§‹æœ¬åœ°å„²å­˜æµç¨‹');
    try {
      const settingsData = {
        prizes: this.prizes,
        coverImage: localStorage.getItem('scratchCardCover'),
        imageSizeLimit: 5242880
      };

      if (this.currentSettingsId) {
        settingsData.settingsId = this.currentSettingsId;
      }

      // æ–°å¢ç¶²è·¯ç‹€æ…‹æª¢æŸ¥
      if (!navigator.onLine) {
        console.warn('é›¢ç·šç‹€æ…‹ï¼Œåƒ…å„²å­˜æœ¬åœ°');
        localStorage.setItem('scratchCardSettings', JSON.stringify(settingsData));
        return;
      }

      const { id, expiresAt } = await window.supabaseClient.saveSettingsToServer(settingsData);
      console.log('ä¼ºæœå™¨å„²å­˜å®Œæˆ');
      this.currentSettingsId = id;
      this.expiresAt = new Date(expiresAt);
      localStorage.setItem('scratchCardSettings', JSON.stringify(settingsData));
    } catch (error) {
      console.warn('ä¼ºæœå™¨å„²å­˜å¤±æ•—ï¼Œæ”¹å­˜æœ¬åœ°:', error);
      localStorage.setItem('scratchCardSettings', JSON.stringify(settingsData));
    }
  }

  showExpiryWarning() {
    if (!this.expiresAt) return;
    
    const daysLeft = Math.ceil((this.expiresAt - Date.now()) / 86400000);
    const warning = document.createElement('div');
    warning.className = 'expiry-warning';
    warning.innerHTML = `âš ï¸ æ­¤è¨­å®šå°‡åœ¨ ${daysLeft} å¤©å¾ŒéæœŸ`;
    document.querySelector('.settings-section').prepend(warning);
  }

  async handleShareSettings() {
    try {
      console.log('é–‹å§‹åˆ†äº«æµç¨‹');
      await this.saveSettings();
      if (!this.currentSettingsId) throw new Error('ç„¡æ•ˆçš„è¨­å®šID');
      
      const shareUrl = `${window.location.origin}${window.location.pathname}?settings=${this.currentSettingsId}`;
      console.log('ç”Ÿæˆåˆ†äº«é€£çµ:', shareUrl);
      
      if (navigator.share) {
        navigator.share({ title: 'åˆ®åˆ®æ¨‚è¨­å®š', url: shareUrl });
      } else {
        navigator.clipboard.writeText(shareUrl);
        alert('é€£çµå·²è¤‡è£½ï¼');
      }
    } catch (error) {
      console.error('åˆ†äº«å¤±æ•—:', error);
      alert(`åˆ†äº«å¤±æ•—: ${error.message}`);
    }
  }

  createPrizeRow(prize, index) {
    const row = document.createElement('tr');

    // Symbol cell
    const symbolCell = document.createElement('td');
    symbolCell.textContent = prize.symbol;
    row.appendChild(symbolCell);

    // Prize amount cell
    const prizeCell = document.createElement('td');
    const prizeInput = document.createElement('input');
    prizeInput.type = 'number';
    prizeInput.value = prize.prize;
    prizeInput.min = '0';
    prizeInput.max = '999999';
    prizeInput.onchange = () => {
      this.prizes[index].prize = parseInt(prizeInput.value) || 0;
      this.saveSettings();
    };
    prizeCell.appendChild(prizeInput);
    row.appendChild(prizeCell);

    // Description cell
    const descCell = document.createElement('td');
    const descInput = document.createElement('input');
    descInput.type = 'text';
    descInput.value = prize.description;
    descInput.maxLength = '20';
    descInput.onchange = () => {
      this.prizes[index].description = descInput.value;
      this.saveSettings();
    };
    descCell.appendChild(descInput);
    row.appendChild(descCell);

    // Probability cell
    const probCell = document.createElement('td');
    const probInput = document.createElement('input');
    probInput.type = 'number';
    probInput.value = prize.probability;
    probInput.min = '0';
    probInput.max = '100';
    probInput.step = '0.1';
    probInput.onchange = () => {
      this.prizes[index].probability = parseFloat(probInput.value) || 0;
      if (!this.validateProbabilities()) {
        probInput.value = prize.probability; // æ¢å¾©åŸå€¼
      } else {
        this.saveSettings();
      }
    };
    probCell.appendChild(probInput);
    row.appendChild(probCell);

    // Action cell
    const actionCell = document.createElement('td');
    const deleteButton = document.createElement('button');
    deleteButton.textContent = 'åˆªé™¤';
    deleteButton.className = 'delete-row';
    deleteButton.onclick = () => {
      if (this.prizes.length <= 1) {
        alert('è‡³å°‘è¦ä¿ç•™ä¸€å€‹çé …ï¼');
        return;
      }
      this.prizes.splice(index, 1);
      this.saveSettings();
      this.setupPrizeTable();
    };
    actionCell.appendChild(deleteButton);
    row.appendChild(actionCell);

    return row;
  }

  validateProbabilities() {
    const total = this.prizes.reduce((sum, prize) => sum + (prize.probability || 0), 0);
    if (total > 100) {
      alert(`æ‰€æœ‰çé …æ©Ÿç‡ç¸½å’Œä¸èƒ½è¶…é100%ï¼Œç›®å‰ç¸½å’Œç‚º${total.toFixed(1)}%`);
      return false;
    }
    return true;
  }

  setupPrizeTable() {
    const tbody = document.querySelector('#prizeTable tbody');
    if (tbody) {
      tbody.innerHTML = '';
      this.prizes.forEach((prize, index) => {
        tbody.appendChild(this.createPrizeRow(prize, index));
      });
    }
  }

  clearSettings(imageHandler) {
    try {
      localStorage.removeItem('scratchCardSettings');
      localStorage.removeItem('scratchCardCover');
      
      this.prizes = JSON.parse(JSON.stringify(this.defaultPrizes));
      this.saveSettings();
      this.setupPrizeTable();
      
      const imagePreview = document.getElementById('imagePreview');
      if (imagePreview) {
        imagePreview.innerHTML = '';
      }
      
      const fileInput = document.getElementById('coverImage');
      if (fileInput) {
        fileInput.value = '';
      }
      
      if (imageHandler) {
        imageHandler.coverImage = null;
      }
      
      console.log('è¨­å®šå·²æˆåŠŸæ¸…é™¤');
    } catch (error) {
      console.error('æ¸…é™¤è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
  }

  getPrizes() {
    return this.prizes;
  }

  getAllSymbols() {
    return this.symbols;
  }
}