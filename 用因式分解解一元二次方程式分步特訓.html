<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨å› å¼åˆ†è§£è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼ï¼šåˆ†æ­¥ç‰¹è¨“</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #2ec4b6;
            --error: #e63946;
            --bg: #f8f9fa;
            --gold: #ffb703;
            --purple: #7209b7;
        }

        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 95%;
            max-width: 750px;
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }

        h1 { color: var(--primary); margin-bottom: 0.5rem; font-size: 1.8rem; }
        .sub-title { color: #666; margin-bottom: 1.5rem; font-size: 1rem; }
        
        /* Login */
        .login-group { margin-bottom: 15px; text-align: left; max-width: 300px; margin: 10px auto; }
        .login-label { display: block; margin-bottom: 5px; font-weight: bold; }
        .login-input { width: 100%; padding: 10px; font-size: 1rem; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        /* Course Selector */
        .course-selector { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .course-btn {
            flex: 1; padding: 15px; border: 2px solid #ddd; background: white; border-radius: 10px;
            cursor: pointer; font-weight: bold; color: #555; transition: 0.2s; max-width: 200px;
        }
        .course-btn.active { border-color: var(--primary); background: #eef2ff; color: var(--primary); }
        .course-btn:hover { border-color: var(--primary); }

        /* Menu Buttons */
        .menu-btn { width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; position: relative; }
        .btn-easy { background-color: #4cc9f0; }
        .btn-medium { background-color: #4361ee; }
        .btn-hard { background-color: #3a0ca3; }
        .btn-special { background-color: var(--purple); }
        .btn-submit { background-color: var(--success); margin-top: 15px; }
        .btn-check { background-color: #f72585; margin-top: 15px; color: white;}
        .btn-next { background-color: #fb8500; display: none; margin-top: 20px;}
        .btn-cert { background-color: var(--gold); color: #333; display: none; margin-top: 20px; animation: pulse 2s infinite;}

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .badge { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: white; color: var(--success); padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; display: none; border: 1px solid var(--success); }
        .done .badge { display: block; }

        /* Game Elements */
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .progress-track { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { background: var(--success); height: 100%; width: 0%; transition: width 0.3s; }
        .question-box { font-size: 2rem; font-family: 'Times New Roman', serif; background: #e9ecef; padding: 20px; border-radius: 10px; margin-bottom: 20px; word-break: break-word; }
        
        .step-container { text-align: left; margin-bottom: 15px; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; background: #fff; }
        .step-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block; font-size: 1.1rem; }
        
        /* Inputs */
        .math-input-group { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 5px; font-size: 1.3rem; font-family: 'Times New Roman', serif; }
        input[type="number"], input[type="text"] { padding: 5px; text-align: center; font-size: 1.2rem; border: 2px solid #ced4da; border-radius: 5px; }
        .short-input { width: 50px; } .medium-input { width: 70px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        select { padding: 5px; font-size: 1.2rem; border: 2px solid #ced4da; border-radius: 5px; background: white; cursor: pointer; }
        
        /* General Select Styling */
        .sign-select { 
            background-color: #e7f1ff; 
            color: var(--primary); 
            font-weight: bold; 
            border: 2px solid var(--primary);
            font-size: 1.5rem; /* Larger font for Step 2 as well */
        }

        /* Formula Mode Specifics */
        .formula-options { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .formula-option { padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; text-align: center; font-family: "Times New Roman", serif; font-size: 1.2rem; }
        .formula-option:hover { background: #f0f0f0; }
        .formula-option.selected { border-color: var(--primary); background: #eef2ff; color: var(--primary); font-weight: bold; }
        .hint-text { font-size: 0.9rem; color: #666; margin-bottom: 10px; background: #fff8e1; padding: 8px; border-radius: 5px; border-left: 4px solid #ffc107; }

        /* --- Cross Diagram Layout (Hand-drawn style) --- */
        .cross-layout-container {
            display: flex; justify-content: center; align-items: center; gap: 20px;
            margin: 20px 0; font-family: 'Times New Roman', serif; font-size: 1.5rem;
        }
        .cross-col { display: flex; flex-direction: column; justify-content: space-between; height: 160px; /* Slightly taller for bigger boxes */ }
        .cross-item-row { display: flex; align-items: center; gap: 10px; height: 70px; justify-content: center; }
        .big-x { font-size: 7rem; color: #888; font-family: sans-serif; font-weight: lighter; line-height: 0; margin: 0 10px; transform: scaleY(1.3); }
        
        /* Box Input (Numbers) */
        .box-input { 
            border: 3px solid #4361ee; border-radius: 8px; text-align: center; 
            font-size: 1.8rem; font-weight: bold;
            padding: 5px; width: 80px; background: white; height: 60px; box-sizing: border-box; 
        }
        
        /* ã€ä¿®æ”¹é»ã€‘Box Select (+/- Sign) - HUGE VISIBILITY */
        .box-select { 
            border: 3px solid #4361ee; 
            border-radius: 8px; 
            text-align: center; 
            text-align-last: center; /* For Chrome/Safari centering */
            font-size: 2.2rem; /* Huge Font */
            font-weight: 900; /* Extra Bold */
            color: var(--primary);
            padding: 0; 
            width: 80px; /* Wider */
            background: #f0f4ff; /* Light blue background */
            cursor: pointer; 
            height: 60px; /* Taller */
            box-sizing: border-box; 
        }

        .term-x { font-size: 2.5rem; font-style: italic; font-weight: bold; }
        .cross-check { font-size: 1.2rem; color: #555; text-align: center; margin-top: 20px; border-top: 2px dashed #ccc; padding-top:15px; }
        .hidden-input { display: none; }

        /* Feedback */
        .feedback-area { display: none; background: #fff3cd; border: 1px solid #ffecb5; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; }
        .feedback-area.correct { background: #d1e7dd; border-color: #badbcc; color: #0f5132; }
        .feedback-area.wrong { background: #f8d7da; border-color: #f5c2c7; color: #842029; }

        /* Utilities */
        .hidden { display: none !important; }
        .disabled-step { opacity: 0.5; pointer-events: none; }
        .user-info-display { position: absolute; top: 10px; right: 20px; font-size: 0.9rem; color: #666; font-weight: bold; }
        
        /* Certificate (Responsive) */
        .cert-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
        .cert-content { background: #fff; width: 100%; max-width: 800px; max-height: 95vh; overflow-y: auto; padding: 30px; border: 15px double #daa520; text-align: center; position: relative; background-image: radial-gradient(circle, #fff 0%, #fdfbf7 100%); border-radius: 10px; display: flex; flex-direction: column; justify-content: center; }
        .cert-title { font-size: 2.5rem; color: #b8860b; font-family: "Baskerville", serif; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .cert-name { font-size: 2.2rem; font-weight: bold; color: #333; margin: 15px 0; border-bottom: 2px solid #333; display: inline-block; padding: 0 30px; }
        .cert-seal { width: 100px; height: 100px; border: 4px solid #d62828; border-radius: 50%; color: #d62828; display: flex; justify-content: center; align-items: center; font-weight: bold; transform: rotate(-15deg); font-size: 1.1rem; box-shadow: 0 0 0 4px white, 0 0 0 7px #d62828; opacity: 0.9; margin: 0 auto; }
        .close-cert-btn { margin-top: 15px; padding: 8px 25px; background: #333; color: white; border: none; cursor: pointer; font-size: 1rem; border-radius: 50px; }
        @media (max-width: 600px) { .cert-title { font-size: 1.8rem; } .cert-name { font-size: 1.5rem; } }
    </style>
</head>
<body>

<div class="container" id="login-screen">
    <h1>ğŸ“ æ•¸å­¸ç‰¹è¨“ç³»çµ±</h1>
    <p>è«‹è¼¸å…¥è³‡æ–™ä»¥é–‹å§‹ç‰¹è¨“</p>
    <div class="login-group"><label class="login-label">ç­ç´š</label><input type="text" id="input-class" class="login-input" placeholder="ä¾‹å¦‚ï¼š801"></div>
    <div class="login-group"><label class="login-label">åº§è™Ÿ</label><input type="text" id="input-seat" class="login-input" placeholder="ä¾‹å¦‚ï¼š05"></div>
    <div class="login-group"><label class="login-label">å§“å</label><input type="text" id="input-name" class="login-input" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å"></div>
    <button class="menu-btn btn-medium" onclick="login()">ç™»å…¥ç³»çµ±</button>
</div>

<div class="container hidden" id="menu-screen">
    <div class="user-info-display" id="user-display"></div>
    <h1>ç”¨å› å¼åˆ†è§£è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼ï¼šåˆ†æ­¥ç‰¹è¨“</h1>
    <p class="sub-title">è«‹é¸æ“‡ä½ è¦æŒ‘æˆ°çš„è§£é¡Œæ–¹æ³•</p>
    
    <div class="course-selector">
        <div class="course-btn active" id="course-btn-cross" onclick="selectCourse('cross')">èª²ç¨‹ A<br>åå­—äº¤ä¹˜æ³•</div>
        <div class="course-btn" id="course-btn-formula" onclick="selectCourse('formula')">èª²ç¨‹ B<br>ä¹˜æ³•å…¬å¼</div>
    </div>

    <div id="menu-content-cross">
        <button id="menu-c-easy" class="menu-btn btn-easy" onclick="startGame('cross', 'easy')">ğŸŸ¢ åˆéš (xÂ² ä¿‚æ•¸ç‚º 1)<span class="badge">å·²é€šé—œ âœ…</span></button>
        <button id="menu-c-medium" class="menu-btn btn-medium" onclick="startGame('cross', 'medium')">ğŸ”µ ä¸­éš (xÂ² ä¿‚æ•¸ç‚ºè³ªæ•¸)<span class="badge">å·²é€šé—œ âœ…</span></button>
        <button id="menu-c-hard" class="menu-btn btn-hard" onclick="startGame('cross', 'hard')">ğŸŸ£ é€²éš (xÂ² ä¿‚æ•¸ç‚ºåˆæ•¸)<span class="badge">å·²é€šé—œ âœ…</span></button>
        <button id="cert-cross" class="menu-btn btn-cert hidden" onclick="showFinalCertificate('cross')">ğŸ† é ˜å–ã€Œåå­—äº¤ä¹˜å¤§å¸«ã€è­‰æ›¸</button>
    </div>

    <div id="menu-content-formula" class="hidden">
        <button id="menu-f-easy" class="menu-btn btn-easy" onclick="startGame('formula', 'easy')">ğŸŸ¢ Level 1 å¹³æ–¹å·®å…¬å¼<br><span style="font-size:0.8rem">AÂ² - BÂ² = 0</span><span class="badge">å·²é€šé—œ âœ…</span></button>
        <button id="menu-f-medium" class="menu-btn btn-medium" onclick="startGame('formula', 'medium')">ğŸ”µ Level 2 å®Œå…¨å¹³æ–¹å…¬å¼<br><span style="font-size:0.8rem">(xÂ² Â± 2ax + aÂ² = 0)</span><span class="badge">å·²é€šé—œ âœ…</span></button>
        <button id="menu-f-hard" class="menu-btn btn-special" onclick="startGame('formula', 'hard')">ğŸŸ£ Level 3 é€²éšé¡Œå‹<br><span style="font-size:0.8rem">((ax+b)Â²...çµæ§‹é¡Œ)</span><span class="badge">å·²é€šé—œ âœ…</span></button>
        <button id="cert-formula" class="menu-btn btn-cert hidden" onclick="showFinalCertificate('formula')">ğŸ† é ˜å–ã€Œä¹˜æ³•å…¬å¼å¤§å¸«ã€è­‰æ›¸</button>
    </div>
</div>

<div class="container hidden" id="game-screen">
    <div class="status-bar">
        <span id="level-label">é›£åº¦</span>
        <span>é€²åº¦: <span id="score">0</span> / 10</span>
    </div>
    <div class="progress-track"><div class="progress-fill" id="progress-bar"></div></div>

    <div class="question-box" id="question-display">Loading...</div>

    <div class="step-container" id="step1-container">
        <span class="step-title" id="step1-title">æ­¥é©Ÿä¸€</span>
        
        <div id="step1-cross" class="hidden">
            <div class="cross-layout-container">
                <div class="cross-col" style="text-align: right; align-items: flex-end;">
                    <div class="cross-item-row">
                        <input type="number" id="cross_a1" class="box-input" style="width:70px; margin-right:5px;" placeholder="a"> 
                        <span class="term-x">x</span>
                    </div>
                    <div class="cross-item-row">
                        <input type="number" id="cross_a2" class="box-input" style="width:70px; margin-right:5px;" placeholder="a"> 
                        <span class="term-x">x</span>
                    </div>
                </div>

                <div class="big-x">â•³</div>

                <div class="cross-col" style="text-align: left; align-items: flex-start;">
                    <div class="cross-item-row">
                        <select id="cross_op1" class="box-select" style="margin-right:10px"><option value="1">+</option><option value="-1">-</option></select>
                        <input type="number" id="cross_c1" class="box-input" placeholder="c">
                    </div>
                    <div class="cross-item-row">
                        <select id="cross_op2" class="box-select" style="margin-right:10px"><option value="1">+</option><option value="-1">-</option></select>
                        <input type="number" id="cross_c2" class="box-input" placeholder="c">
                    </div>
                </div>
            </div>

            <div class="cross-check">
                é©—ç®—ä¸­é–“é …ï¼š( <input type="number" id="cross_val1" class="short-input"> x ) + ( <input type="number" id="cross_val2" class="short-input"> x ) = <span id="middle-term-target" style="color:var(--primary); font-weight:bold;">?</span> x
            </div>

            <button class="menu-btn btn-check" onclick="checkStep1()">æª¢æŸ¥åå­—äº¤ä¹˜</button>
        </div>

        <div id="step1-formula" class="hidden">
            <p style="margin-top:0">è«‹è§€å¯Ÿé¡Œç›®ï¼Œé¸æ“‡é©ç”¨çš„ä¹˜æ³•å…¬å¼ï¼š</p>
            <div class="formula-options">
                <div class="formula-option" id="opt-sq-diff" onclick="selectFormulaOption('diff')">1. å¹³æ–¹å·®ï¼šAÂ² - BÂ² = (A+B)(A-B)</div>
                <div class="formula-option" id="opt-sq-sum" onclick="selectFormulaOption('sum')">2. å’Œçš„å¹³æ–¹ï¼šAÂ² + 2AB + BÂ² = (A+B)Â²</div>
                <div class="formula-option" id="opt-sq-sub" onclick="selectFormulaOption('sub')">3. å·®çš„å¹³æ–¹ï¼šAÂ² - 2AB + BÂ² = (A-B)Â²</div>
            </div>
            <button class="menu-btn btn-check" onclick="checkStep1()">ç¢ºèªå…¬å¼</button>
        </div>
        
        <div id="step1-feedback" class="feedback-area"></div>
    </div>

    <div class="step-container disabled-step" id="step2-container">
        <span class="step-title">æ­¥é©ŸäºŒï¼šå¯«å‡ºå› å¼åˆ†è§£</span>
        <div id="step2-hint" class="hint-text hidden"></div>
        <div class="math-input-group" id="step2-input-area">
            </div>
    </div>

    <div class="step-container disabled-step" id="step3-container">
        <span class="step-title">æ­¥é©Ÿä¸‰ï¼šæ±‚è§£ x (è‹¥ç‚ºåˆ†æ•¸è«‹å¡« a/b)</span>
        <div class="math-input-group">
            x = <input type="text" id="step3_x1" class="medium-input"> æˆ– x = <input type="text" id="step3_x2" class="medium-input">
        </div>
    </div>

    <button class="menu-btn btn-submit hidden" id="final-submit-btn" onclick="finalCheck()">é€å‡ºæœ€çµ‚ç­”æ¡ˆ</button>
    <div class="feedback-area" id="final-feedback"></div>
    <button class="menu-btn btn-next" id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
    <button class="menu-btn" style="background:#6c757d; margin-top:10px" onclick="showMenu()">å›ä¸»é¸å–®</button>
</div>

<div class="cert-modal" id="cert-modal">
    <div class="cert-content">
        <div class="cert-title" id="cert-title">æ¦®è­½è­‰æ›¸</div>
        <div class="cert-body" style="margin-top:20px;">
            <p>èŒ²è­‰æ˜</p>
            <div class="cert-name" id="cert-student-info"></div>
            <p>
                åœ¨ã€Œ<span id="cert-course-name">æ•¸å­¸ç‰¹è¨“</span>ã€ä¸­è¡¨ç¾å„ªç•°ï¼Œ<br>
                æˆåŠŸé€šé <strong id="cert-level-name" style="font-size:1.2em; color: #d62828;">é—œå¡</strong> è€ƒé©—ã€‚
            </p>
        </div>
        <div class="cert-seal" id="cert-seal-text">é€šé—œ</div>
        <p style="font-size:0.9rem; margin-top:20px;">æ—¥æœŸï¼š<span id="cert-date"></span></p>
        <button class="close-cert-btn" onclick="closeCert()">é—œé–‰</button>
    </div>
</div>

<script>
    // State
    let student = { class: '', seat: '', name: '' };
    let state = { course: 'cross', level: 'easy', score: 0, target: 10, q: null, formulaType: '' };
    let progress = { 
        cross: { easy: false, medium: false, hard: false },
        formula: { easy: false, medium: false, hard: false }
    };

    // --- Core Functions ---
    function getStorageKey(cls, seat, name) { return `math_v3_${cls}_${seat}_${name}`; }
    function saveProgress() {
        if(!student.name) return;
        localStorage.setItem(getStorageKey(student.class, student.seat, student.name), JSON.stringify(progress));
    }
    function loadProgress(cls, seat, name) {
        let data = localStorage.getItem(getStorageKey(cls, seat, name));
        if(data) progress = JSON.parse(data);
        else progress = { cross: { easy: false, medium: false, hard: false }, formula: { easy: false, medium: false, hard: false } };
    }

    function login() {
        const c = document.getElementById('input-class').value.trim();
        const s = document.getElementById('input-seat').value.trim();
        const n = document.getElementById('input-name').value.trim();
        if(!c || !s || !n) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }
        
        student = { class: c, seat: s, name: n };
        loadProgress(c, s, n);
        document.getElementById('user-display').innerText = `${c}ç­ ${s}è™Ÿ ${n}`;
        showMenu();
    }

    function showMenu() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('menu-screen').classList.remove('hidden');
        selectCourse(state.course);
    }

    function selectCourse(course) {
        state.course = course;
        document.getElementById('course-btn-cross').className = course === 'cross' ? 'course-btn active' : 'course-btn';
        document.getElementById('course-btn-formula').className = course === 'formula' ? 'course-btn active' : 'course-btn';
        
        document.getElementById('menu-content-cross').classList.toggle('hidden', course !== 'cross');
        document.getElementById('menu-content-formula').classList.toggle('hidden', course !== 'formula');

        updateBadges();
    }

    function updateBadges() {
        const setBadge = (id, done) => document.getElementById(id).classList.toggle('done', done);
        setBadge('menu-c-easy', progress.cross.easy);
        setBadge('menu-c-medium', progress.cross.medium);
        setBadge('menu-c-hard', progress.cross.hard);
        document.getElementById('cert-cross').classList.toggle('hidden', !(progress.cross.easy && progress.cross.medium && progress.cross.hard));

        setBadge('menu-f-easy', progress.formula.easy);
        setBadge('menu-f-medium', progress.formula.medium);
        setBadge('menu-f-hard', progress.formula.hard);
        document.getElementById('cert-formula').classList.toggle('hidden', !(progress.formula.easy && progress.formula.medium && progress.formula.hard));
    }

    function startGame(course, level) {
        state.course = course;
        state.level = level;
        state.score = 0;
        updateScore();
        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        document.getElementById('step1-title').innerText = course === 'cross' ? 'æ­¥é©Ÿä¸€ï¼šåå­—äº¤ä¹˜æ¹Šæ•¸' : 'æ­¥é©Ÿä¸€ï¼šåˆ¤æ–·é©ç”¨å…¬å¼';
        document.getElementById('step1-cross').classList.toggle('hidden', course !== 'cross');
        document.getElementById('step1-formula').classList.toggle('hidden', course !== 'formula');
        
        let label = (course==='cross'?'åå­—äº¤ä¹˜ ':'ä¹˜æ³•å…¬å¼ ') + (level==='easy'?'åˆéš':level==='medium'?'ä¸­éš':'é€²éš');
        document.getElementById('level-label').innerText = label;

        nextQuestion();
    }

    // --- Question Generator ---
    function generateQuestion() {
        // Reset UI
        document.getElementById('step1-feedback').style.display = 'none';
        document.getElementById('final-feedback').style.display = 'none';
        document.getElementById('step1-container').classList.remove('disabled-step');
        document.getElementById('step2-container').classList.add('disabled-step');
        document.getElementById('step3-container').classList.add('disabled-step');
        document.getElementById('final-submit-btn').classList.add('hidden');
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('step2-hint').classList.add('hidden');
        document.querySelectorAll('input').forEach(el => el.value = '');
        document.querySelectorAll('.formula-option').forEach(el => el.classList.remove('selected'));
        state.formulaType = '';

        if (state.course === 'cross') {
            generateCrossQuestion();
        } else {
            generateFormulaQuestion();
        }
    }

    function generateCrossQuestion() {
        // Reset inputs visibility (Show all by default)
        document.getElementById('cross_a1').classList.remove('hidden-input');
        document.getElementById('cross_a2').classList.remove('hidden-input');

        // Advanced Logic for Q8, Q9, Q10: Substitution
        if (state.score >= 7) {
            let uA = 1, uC1 = rnd(-5, 5, true), uC2 = rnd(-5, 5, true);
            let k = rnd(1, 5) * (Math.random()<0.5 ? 1 : -1);
            let B = uC1 + uC2;
            let C = uC1 * uC2;
            let kStr = k>0 ? `+${k}` : `${k}`;
            let eqStr = `(x${kStr})Â² ${fmtSign(B)}(x${kStr}) ${fmtSign(C)} = 0`;
            let r1 = -k - uC1;
            let r2 = -k - uC2;
            
            state.q = { 
                type: 'cross', subtype: 'advanced',
                a1: 1, a2: 1, c1: uC1, c2: uC2, 
                A: 1, B: B, C: C, 
                root1: formatFraction(r1, 1), root2: formatFraction(r2, 1),
                displayEq: eqStr
            };
            
            // For advanced mode in easy level, hide inputs
            if (state.level === 'easy') {
                 document.getElementById('cross_a1').value = 1;
                 document.getElementById('cross_a2').value = 1;
                 document.getElementById('cross_a1').classList.add('hidden-input');
                 document.getElementById('cross_a2').classList.add('hidden-input');
            }

            displayEq(eqStr);
            document.getElementById('middle-term-target').innerText = B;
            document.getElementById('step2-hint').innerHTML = `ğŸ’¡ æç¤ºï¼šæ­¤ç‚ºé€²éšé¡Œï¼Œè«‹å…ˆè§£å‡ºåå­—äº¤ä¹˜å¾Œçš„æ‹¬è™Ÿï¼Œå†æ•´ç†æˆ x çš„å› å¼ã€‚<br>ä¾‹å¦‚åå­—äº¤ä¹˜çµæœç‚º (u${uC1>0?'+'+uC1:uC1})(u${uC2>0?'+'+uC2:uC2})ï¼Œé‚„åŸå¾Œç‚º (x${kStr}${uC1>0?'+'+uC1:uC1})...`;
            document.getElementById('step2-hint').classList.remove('hidden');
            return;
        }

        // Standard Logic
        let a1, c1, a2, c2;
        if (state.level === 'easy') {
            a1 = 1; a2 = 1; c1 = rnd(-9, 9, true); c2 = rnd(-9, 9, true);
            // Hide a1, a2 inputs for Easy level
            document.getElementById('cross_a1').value = 1;
            document.getElementById('cross_a2').value = 1;
            document.getElementById('cross_a1').classList.add('hidden-input');
            document.getElementById('cross_a2').classList.add('hidden-input');
        } else if (state.level === 'medium') {
            const primes = [2, 3, 5]; a1 = primes[Math.floor(Math.random()*3)]; a2 = 1;
            c1 = rnd(-5, 5, true); c2 = rnd(-5, 5, true);
        } else {
            a1 = rnd(2, 5); a2 = rnd(2, 4); c1 = rnd(-4, 4, true); c2 = rnd(-4, 4, true);
        }
        if(a1<0){a1=-a1;c1=-c1} if(a2<0){a2=-a2;c2=-c2}
        
        let A = a1*a2, B = a1*c2 + a2*c1, C = c1*c2;
        
        // BUG FIX: Calculate roots for standard cross questions
        let r1 = formatFraction(-c1, a1);
        let r2 = formatFraction(-c2, a2);
        
        state.q = { a1, c1, a2, c2, A, B, C, type: 'cross', subtype: 'standard', root1: r1, root2: r2 };
        
        displayEq(`${fmtCoef(A)}xÂ² ${fmtSign(B)}x ${fmtSign(C)} = 0`);
        document.getElementById('middle-term-target').innerText = B;
    }

    function generateFormulaQuestion() {
        let type, eqStr;
        
        if (state.level === 'easy') {
            // Level 1: Difference of Squares
            type = 'diff';
            if (Math.random() < 0.3) {
                let a = rnd(1, 3);
                let b = rnd(1, 5) * (Math.random()<0.5?1:-1);
                let c = rnd(1, 6);
                let bStr = b>0 ? `+${b}` : `${b}`;
                eqStr = `(${a===1?'':a}x${bStr})Â² - ${c*c} = 0`;
                let r1 = formatFraction(c-b, a);
                let r2 = formatFraction(-c-b, a);
                
                state.q = { 
                    type, subtype: 'advanced',
                    a_val: a, b_val: b, c_val: c,
                    final_a: a, final_c1: b+c, final_c2: b-c,
                    root1: r1, root2: r2 
                };
            } else {
                let a_val = Math.random() < 0.2 ? 1 : rnd(2, 9);
                let b_val;
                do { b_val = rnd(1, 9); } while (b_val === a_val);
                
                let A = a_val*a_val;
                eqStr = `${fmtCoef(A)}xÂ² - ${b_val*b_val} = 0`;
                state.q = { 
                    type, subtype: 'standard', 
                    a_val: a_val, b_val: b_val, 
                    root1: formatFraction(b_val, a_val), root2: formatFraction(-b_val, a_val) 
                };
            }

        } else if (state.level === 'medium') {
            type = Math.random() < 0.5 ? 'sum' : 'sub';
            let a_val = 1, b_val = rnd(1, 8);
            if(Math.random()<0.3) a_val = rnd(2,3);
            
            let A = a_val*a_val;
            let B = (type === 'sum' ? 1 : -1) * 2 * a_val * b_val;
            let C = b_val*b_val;
            eqStr = `${fmtCoef(A)}xÂ² ${fmtSign(B)}x + ${C} = 0`;
            let r = formatFraction((type==='sum'?-b_val:b_val), a_val);
            state.q = { type, a_val, b_val, root1: r, root2: r };

        } else {
            type = Math.random() < 0.5 ? 'sum' : 'sub';
            let a = rnd(2, 5), b = rnd(-5, 5, true), k = rnd(1, 4);
            let signStr = type==='sum' ? '+' : '-';
            let bStr = b >= 0 ? `+${b}` : `${b}`;
            eqStr = `(${a}x${bStr})Â² ${signStr} ${2*k}(${a}x${bStr}) + ${k*k} = 0`;
            
            let final_const = type==='sum' ? (b+k) : (b-k);
            state.q = { 
                type: 'advanced', subtype: type, 
                inner_a: a, inner_b: b, outer_k: k,
                final_a: a, final_b: final_const,
                root1: formatFraction(-final_const, a), root2: formatFraction(-final_const, a)
            };
        }
        
        if (state.q.displayEq) displayEq(state.q.displayEq);
        else displayEq(eqStr);
    }

    // --- Step Logic ---
    function selectFormulaOption(type) {
        state.formulaType = type;
        document.querySelectorAll('.formula-option').forEach(el => el.classList.remove('selected'));
        document.getElementById('opt-sq-'+type).classList.add('selected');
    }

    function checkStep1() {
        let isCorrect = false;
        let msg = "";

        if (state.course === 'cross') {
            const d = state.q;
            let ua1 = parseInt(document.getElementById('cross_a1').value)||0;
            let uc1 = (parseInt(document.getElementById('cross_c1').value)||0) * parseInt(document.getElementById('cross_op1').value);
            let ua2 = parseInt(document.getElementById('cross_a2').value)||0;
            let uc2 = (parseInt(document.getElementById('cross_c2').value)||0) * parseInt(document.getElementById('cross_op2').value);
            let uVal1 = parseInt(document.getElementById('cross_val1').value)||0;
            let uVal2 = parseInt(document.getElementById('cross_val2').value)||0;
            
            let checkA = (ua1*ua2===d.A), checkC = (uc1*uc2===d.C);
            let cp1 = ua1*uc2, cp2 = ua2*uc1;
            let checkMiddle = (cp1+cp2===d.B), checkVals = (uVal1===cp1 && uVal2===cp2)||(uVal1===cp2 && uVal2===cp1);
            
            if(checkA && checkC && checkMiddle && checkVals) isCorrect = true;
            else msg = "âŒ æ•¸å­—æ¹ŠéŒ¯äº†ï¼Œè«‹å†æª¢æŸ¥ç©èˆ‡å’Œï¼";
            
            if(isCorrect) renderStep2Inputs('cross', {ua1, uc1, ua2, uc2});

        } else {
            if(!state.formulaType) { alert("è«‹é¸æ“‡ä¸€å€‹å…¬å¼ï¼"); return; }
            let targetType = state.q.type === 'advanced' ? state.q.subtype : state.q.type;
            if(state.formulaType === targetType) {
                isCorrect = true;
                msg = "âœ… å…¬å¼é¸æ“‡æ­£ç¢ºï¼";
                renderStep2Inputs('formula', state.formulaType);
            } else {
                msg = "âŒ å…¬å¼é¸éŒ¯å›‰ï¼Œè«‹è§€å¯Ÿé¡Œç›®ç‰¹å¾µã€‚";
            }
        }

        let fb = document.getElementById('step1-feedback');
        fb.innerHTML = msg;
        fb.className = `feedback-area ${isCorrect?'correct':'wrong'}`;
        fb.style.display = 'block';

        if(isCorrect) {
            document.getElementById('step1-container').classList.add('disabled-step');
            document.getElementById('step2-container').classList.remove('disabled-step');
            document.getElementById('step3-container').classList.remove('disabled-step');
            document.getElementById('final-submit-btn').classList.remove('hidden');
        }
    }

    function renderStep2Inputs(mode, data) {
        const area = document.getElementById('step2-input-area');
        area.innerHTML = '';
        if (state.course === 'cross' && state.q.subtype === 'advanced') {
            document.getElementById('step2-hint').classList.remove('hidden');
        } else if (state.course === 'cross') {
            document.getElementById('step2-hint').classList.add('hidden');
        }

        if (mode === 'cross') {
            if (state.q.subtype === 'advanced') {
                area.innerHTML = `
                ( <input type="number" id="s2_a1" class="short-input" placeholder="a"> x 
                  <select id="s2_op1" class="sign-select"><option value="1">+</option><option value="-1">-</option></select> 
                  <input type="number" id="s2_c1" class="short-input" placeholder="c"> ) 
                ( <input type="number" id="s2_a2" class="short-input" placeholder="a"> x 
                  <select id="s2_op2" class="sign-select"><option value="1">+</option><option value="-1">-</option></select> 
                  <input type="number" id="s2_c2" class="short-input" placeholder="c"> ) = 0`;
            } else {
                area.innerHTML = `
                ( <input type="number" id="s2_a1" class="short-input" value="${data.ua1}" readonly> x 
                  <select id="s2_op1" class="sign-select" disabled><option value="1" ${data.uc1>=0?'selected':''}>+</option><option value="-1" ${data.uc1<0?'selected':''}>-</option></select> 
                  <input type="number" id="s2_c1" class="short-input" value="${Math.abs(data.uc1)}" readonly> ) 
                ( <input type="number" id="s2_a2" class="short-input" value="${data.ua2}" readonly> x 
                  <select id="s2_op2" class="sign-select" disabled><option value="1" ${data.uc2>=0?'selected':''}>+</option><option value="-1" ${data.uc2<0?'selected':''}>-</option></select> 
                  <input type="number" id="s2_c2" class="short-input" value="${Math.abs(data.uc2)}" readonly> ) = 0`;
            }
        } else {
            if(state.q.type === 'advanced') {
                let op = state.q.subtype === 'sum' ? '+' : '-';
                let bStr = state.q.inner_b >= 0 ? `+${state.q.inner_b}` : state.q.inner_b;
                document.getElementById('step2-hint').innerHTML = `ğŸ’¡ æç¤ºï¼šå› å¼åˆ†è§£ç‚º (A ${op} ${state.q.outer_k})Â² = 0ï¼Œå…¶ä¸­ A = (${state.q.inner_a}x${bStr})ï¼Œè«‹å¡«å…¥æ•´ç†å¾Œçš„ä¿‚æ•¸ã€‚`;
                document.getElementById('step2-hint').classList.remove('hidden');
                area.innerHTML = `( <input type="number" id="s2_fa" class="short-input"> x <select id="s2_fop" class="sign-select"><option value="1">+</option><option value="-1">-</option></select> <input type="number" id="s2_fc" class="short-input"> )Â² = 0`;
            } else if (state.formulaType === 'diff') {
                if (state.q.subtype === 'advanced') {
                     area.innerHTML = `( <input type="number" id="s2_fa1" class="short-input"> x <select id="s2_fop1" class="sign-select"><option value="1">+</option><option value="-1">-</option></select> <input type="number" id="s2_fc1" class="short-input"> ) ( <input type="number" id="s2_fa2" class="short-input"> x <select id="s2_fop2" class="sign-select"><option value="1">+</option><option value="-1">-</option></select> <input type="number" id="s2_fc2" class="short-input"> ) = 0`;
                } else {
                     area.innerHTML = `( <input type="number" id="s2_fa1" class="short-input"> x + <input type="number" id="s2_fc1" class="short-input"> ) ( <input type="number" id="s2_fa2" class="short-input"> x - <input type="number" id="s2_fc2" class="short-input"> ) = 0`;
                }
            } else {
                let op = state.formulaType === 'sum' ? '+' : '-';
                area.innerHTML = `( <input type="number" id="s2_fa" class="short-input"> x ${op} <input type="number" id="s2_fc" class="short-input"> )Â² = 0`;
            }
        }
    }

    function finalCheck() {
        let isCorrect = false;
        let msg = "";
        let q = state.q;
        let s2Correct = true;
        
        if (state.course === 'cross' && q.subtype === 'advanced') {
            let ua1 = parseInt(document.getElementById('s2_a1').value)||0;
            let uc1 = (parseInt(document.getElementById('s2_c1').value)||0) * parseInt(document.getElementById('s2_op1').value);
            let ua2 = parseInt(document.getElementById('s2_a2').value)||0;
            let uc2 = (parseInt(document.getElementById('s2_c2').value)||0) * parseInt(document.getElementById('s2_op2').value);
            let ur1 = -uc1/ua1, ur2 = -uc2/ua2;
            let realR1 = parseFloat(eval(q.root1)), realR2 = parseFloat(eval(q.root2));
            if (! ((Math.abs(ur1 - realR1) < 0.01 && Math.abs(ur2 - realR2) < 0.01) || 
                   (Math.abs(ur1 - realR2) < 0.01 && Math.abs(ur2 - realR1) < 0.01)) ) {
                s2Correct = false;
            }
        } else if (state.course === 'formula') {
             if (q.type === 'advanced') {
                let u_a = parseInt(document.getElementById('s2_fa').value)||0;
                let u_c = (parseInt(document.getElementById('s2_fc').value)||0) * parseInt(document.getElementById('s2_fop').value);
                if (u_a !== q.final_a || u_c !== q.final_b) s2Correct = false;
            } else if (state.formulaType === 'diff') {
                let u_a1 = parseInt(document.getElementById('s2_fa1').value)||0;
                let u_a2 = parseInt(document.getElementById('s2_fa2').value)||0;
                let u_c1, u_c2;
                if (q.subtype === 'advanced') {
                    u_c1 = (parseInt(document.getElementById('s2_fc1').value)||0) * parseInt(document.getElementById('s2_fop1').value);
                    u_c2 = (parseInt(document.getElementById('s2_fc2').value)||0) * parseInt(document.getElementById('s2_fop2').value);
                    let p1 = (u_a1===q.final_a && u_c1===q.final_c1) && (u_a2===q.final_a && u_c2===q.final_c2);
                    let p2 = (u_a1===q.final_a && u_c1===q.final_c2) && (u_a2===q.final_a && u_c2===q.final_c1);
                    if (!p1 && !p2) s2Correct = false;
                } else {
                    u_c1 = parseInt(document.getElementById('s2_fc1').value)||0;
                    u_c2 = parseInt(document.getElementById('s2_fc2').value)||0;
                    if (u_a1!==q.a_val || u_c1!==q.b_val || u_a2!==q.a_val || u_c2!==q.b_val) s2Correct = false;
                }
            } else {
                let u_a = parseInt(document.getElementById('s2_fa').value)||0;
                let u_c = parseInt(document.getElementById('s2_fc').value)||0;
                if (u_a!==q.a_val || u_c!==q.b_val) s2Correct = false;
            }
        }

        let ux1 = normalizeFrac(document.getElementById('step3_x1').value);
        let ux2 = normalizeFrac(document.getElementById('step3_x2').value);
        let r1 = q.root1, r2 = q.root2;
        let rootsMatch = false;
        if(ux1 && ux2) {
            if((ux1===r1 && ux2===r2) || (ux1===r2 && ux2===r1)) rootsMatch = true;
            if(r1===r2 && ux1===r1 && ux2===r1) rootsMatch = true;
        }

        if(s2Correct && rootsMatch) {
            isCorrect = true;
            msg = "ğŸ‰ å®Œå…¨æ­£ç¢ºï¼å¤ªæ£’äº†ï¼";
            state.score++;
            updateScore();
            if(state.score >= state.target) {
                progress[state.course][state.level] = true;
                saveProgress();
                setTimeout(() => showCertModal(), 1000);
            }
        } else {
            msg = "ğŸ¤” ç­”æ¡ˆæœ‰èª¤ã€‚<br>";
            if(!s2Correct) msg += "å› å¼åˆ†è§£æ•´ç†éŒ¯äº†ã€‚<br>";
            if(!rootsMatch) msg += "æœ€å¾Œçš„ x è§£ç®—éŒ¯äº†ã€‚<br>";
            msg += `<br>æ­£ç¢ºç­”æ¡ˆï¼šx = ${r1}, x = ${r2}`;
        }

        let fb = document.getElementById('final-feedback');
        fb.innerHTML = msg;
        fb.className = `feedback-area ${isCorrect?'correct':'wrong'}`;
        fb.style.display = 'block';
        if(isCorrect) {
            document.getElementById('final-submit-btn').classList.add('hidden');
            document.getElementById('next-btn').style.display = 'block';
        }
    }

    // --- Helpers ---
    function rnd(min, max, noZero=false) {
        let n;
        do { n = Math.floor(Math.random()*(max-min+1))+min; } while(noZero && n===0);
        return n;
    }
    function gcd(a, b) { return b===0?a:gcd(b, a%b); }
    function formatFraction(n, d) {
        if(d===0) return "undefined";
        let sign = 1; if(n<0){sign*=-1;n=-n} if(d<0){sign*=-1;d=-d}
        let c=gcd(n,d); n/=c; d/=c;
        return (sign===-1?"-":"") + n + (d===1?"":"/"+d);
    }
    function normalizeFrac(str) {
        str = str.trim(); if(!str) return null;
        if(str.includes('/')) { let [n,d]=str.split('/').map(Number); return formatFraction(n,d); }
        return formatFraction(parseInt(str), 1);
    }
    function fmtCoef(n) { return n===1?"":n===-1?"-":n; }
    function fmtSign(n) { return n>=0 ? `+ ${n}` : `- ${Math.abs(n)}`; }
    function displayEq(s) { document.getElementById('question-display').innerText = s.replace(" 1x", " x").replace("- 1x", "- x").replace(/\+ 0x/g,"").replace(/- 0x/g,""); }
    function updateScore() { document.getElementById('score').innerText = state.score; document.getElementById('progress-bar').style.width = (state.score/state.target*100)+'%'; }
    function nextQuestion() { generateQuestion(); }

    // --- Certificate ---
    function showCertModal() {
        let title = state.course==='cross' ? 'åå­—äº¤ä¹˜' : 'ä¹˜æ³•å…¬å¼';
        let lv = state.level==='easy'?'åˆéš':state.level==='medium'?'ä¸­éš':'é€²éš';
        document.getElementById('cert-student-info').innerText = `${student.class}ç­ ${student.seat}è™Ÿ ${student.name}`;
        document.getElementById('cert-course-name').innerText = title + "ç‰¹è¨“";
        document.getElementById('cert-level-name').innerText = lv + "é—œå¡";
        document.getElementById('cert-seal-text').innerText = lv + "é€šé—œ";
        document.getElementById('cert-date').innerText = new Date().toLocaleDateString();
        document.querySelector('.cert-content').style.borderColor = "#daa520";
        document.getElementById('cert-modal').style.display = 'flex';
    }
    function showFinalCertificate(course) {
        let title = course==='cross' ? 'åå­—äº¤ä¹˜å¤§å¸«' : 'ä¹˜æ³•å…¬å¼å¤§å¸«';
        document.getElementById('cert-student-info').innerText = `${student.class}ç­ ${student.seat}è™Ÿ ${student.name}`;
        document.getElementById('cert-course-name').innerText = "å…¨éšæ®µåˆ¶éœ¸";
        document.getElementById('cert-level-name').innerText = "çµ‚æ¥µæ¦®è­½";
        document.getElementById('cert-title').innerText = "ğŸ… çµ‚æ¥µæ¦®è­½è­‰æ›¸";
        document.getElementById('cert-seal-text').innerText = "å¤§å¸«";
        document.querySelector('.cert-content').style.borderColor = "#ffd700";
        document.getElementById('cert-modal').style.display = 'flex';
    }
    function closeCert() { document.getElementById('cert-modal').style.display = 'none'; showMenu(); }

</script>
</body>
</html>