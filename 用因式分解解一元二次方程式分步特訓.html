<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹ä¸­æ•¸å­¸ï¼šä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼ç‰¹è¨“ (v30 æ ¹è™Ÿé¡Œå‹å¼·åŒ–ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #2ec4b6;
            --error: #e63946;
            --bg: #f8f9fa;
            --pink: #ff006e; 
            --gray: #6c757d;
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            overscroll-behavior: none;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 95%;
            max-width: 750px;
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }

        h1 { color: var(--primary); margin-bottom: 1.5rem; font-size: 1.8rem; font-weight: 800; letter-spacing: 1px; }
        
        /* ç™»å…¥ç•«é¢ */
        .login-container { max-width: 400px; margin: 0 auto; text-align: left; }
        .login-group { margin-bottom: 20px; }
        .login-label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 1.1rem; }
        .login-input { 
            width: 100%; padding: 12px; font-size: 1.2rem; 
            border: 2px solid #e0e0e0; border-radius: 12px; 
            box-sizing: border-box; transition: 0.3s; background: #fff;
        }
        .login-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2); }

        /* é¸å–®æŒ‰éˆ• */
        .course-selector { display: flex; gap: 8px; margin-bottom: 20px; justify-content: center; }
        .course-btn {
            flex: 1; padding: 12px 5px; border: 2px solid #ddd; background: white; border-radius: 10px;
            cursor: pointer; font-weight: bold; color: #666; transition: 0.2s; font-size: 1rem;
        }
        .course-btn.active { border-color: var(--primary); background: #eef2ff; color: var(--primary); }

        .menu-btn { 
            width: 100%; padding: 16px; margin: 10px 0; font-size: 1.1rem; 
            border: none; border-radius: 15px; cursor: pointer; color: white; 
            font-weight: bold; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transition: transform 0.1s;
        }
        .menu-btn:active { transform: scale(0.98); }
        
        .btn-easy { background: linear-gradient(135deg, #4cc9f0, #4361ee) !important; }
        .btn-medium { background: linear-gradient(135deg, #4361ee, #3a0ca3) !important; }
        .btn-hard { background: linear-gradient(135deg, #7209b7, #560bad) !important; }
        .btn-action { background: var(--success) !important; }
        .btn-gray { background: var(--gray) !important; box-shadow: none; }
        .btn-check { background: var(--pink) !important; color: white !important; box-shadow: 0 4px 10px rgba(255, 0, 110, 0.3); margin-top: 15px; }

        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-btn-group { display: flex; justify-content: center; gap: 5px; margin: 10px 0; flex-wrap: wrap; }
        .mode-btn { 
            padding: 6px 15px; font-size: 0.9rem; border: 1px solid #ccc; 
            background: #eee; border-radius: 20px; cursor: pointer; color: #555; transition: 0.2s;
        }
        .mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 5px rgba(67,97,238,0.3); }

        /* Game UI */
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; font-size: 1rem; color: #555; background: #f1f5f9; padding: 12px; border-radius: 10px;}
        .question-box { font-size: 2.2rem; font-family: 'Times New Roman', serif; background: #e9ecef; padding: 25px; border-radius: 15px; margin-bottom: 20px; word-break: break-word;}
        
        .step-container { text-align: left; margin-bottom: 15px; padding: 20px; border: 2px solid #e9ecef; border-radius: 15px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .step-title { font-weight: bold; color: var(--primary); margin-bottom: 15px; display: block; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        
        input[type="number"], input[type="text"] { 
            padding: 8px; text-align: center; font-size: 1.5rem; border: 2px solid #ced4da; border-radius: 10px; 
            -webkit-appearance: none; margin: 0 4px; font-family: 'Times New Roman'; background: #fff;
        }
        .short-input { width: 60px; } .medium-input { width: 100px; }
        
        select { 
            padding: 8px; font-size: 1.5rem; border: 2px solid #ced4da; border-radius: 10px; background: white; cursor: pointer; 
            -webkit-appearance: none; text-align-last: center;
        }
        .sign-select { width: 60px; background-color: #e7f1ff; color: var(--primary); font-weight: bold; border-color: var(--primary); }

        .cross-layout { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 10px 0; }
        .cross-col { display: flex; flex-direction: column; gap: 10px; }
        .cross-row { display: flex; align-items: center; gap: 5px; }
        .big-x { font-size: 8rem; line-height: 0.7; color: #cbd5e1; font-weight: 300; }
        .box-input { width: 80px; height: 60px; font-size: 1.8rem; }
        
        .formula-options { display: grid; gap: 10px; }
        .formula-option { padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: center; font-size: 1.2rem; transition: 0.2s; }
        .formula-option:hover { background: #f8f9fa; }
        .formula-option.selected { border-color: var(--primary); background: #eef2ff; color: var(--primary); font-weight: bold; }

        .radical-wrapper { 
            font-family: 'Times New Roman'; font-size: 1.5rem; 
            display: inline-flex; align-items: center; justify-content: center; gap: 5px; 
            background: #fff8e1; padding: 15px; border-radius: 10px; border: 1px solid #ffe082;
            flex-wrap: wrap;
        }

        .hidden { display: none !important; }
        .disabled-step { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .user-info-display { position: absolute; top: 15px; right: 20px; font-size: 0.9rem; color: #666; font-weight: bold; }
        
        .feedback { margin-top: 20px; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1.1rem; display: none; text-align: center; }
        .feedback.correct { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .feedback.wrong { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        
        /* Certificate */
        .cert-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
        .cert-content { background: #fff; width: 100%; max-width: 800px; max-height: 95vh; overflow-y: auto; padding: 30px; border: 15px double #daa520; text-align: center; position: relative; background-image: radial-gradient(circle, #fff 0%, #fdfbf7 100%); border-radius: 10px; }
        .cert-title { font-size: 2.5rem; color: #b8860b; font-family: "Baskerville", serif; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .cert-name { font-size: 2.2rem; font-weight: bold; color: #333; margin: 15px 0; border-bottom: 2px solid #333; display: inline-block; padding: 0 30px; }
        .close-cert-btn { margin-top: 15px; padding: 10px 30px; background: #333; color: white; border: none; cursor: pointer; font-size: 1rem; border-radius: 50px; }
        
        .menu-section { width: 100%; }
        .radical-symbol { font-size: 1.8rem; font-family: 'Times New Roman'; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container" id="screen-login-container">
    <h1>ğŸ“ æ•¸å­¸ç‰¹è¨“ç³»çµ±</h1>
    <div class="login-container">
        <div class="login-group"><label class="login-label">ç­ç´š</label><input type="text" id="input-class" class="login-input" placeholder="ä¾‹å¦‚ï¼š801"></div>
        <div class="login-group"><label class="login-label">åº§è™Ÿ</label><input type="text" id="input-seat" class="login-input" placeholder="ä¾‹å¦‚ï¼š05"></div>
        <div class="login-group"><label class="login-label">å§“å</label><input type="text" id="input-name" class="login-input" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å"></div>
        <button class="menu-btn btn-action" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
    </div>
</div>

<div class="container hidden" id="screen-menu">
    <div style="text-align:right; margin-bottom:10px; font-weight:bold; color:#666;" id="user-display"></div>
    <h1>é¸æ“‡ç‰¹è¨“èª²ç¨‹</h1>
    <div class="course-selector">
        <div class="course-btn active" id="tab-cross" onclick="switchTab('cross')">A.åå­—äº¤ä¹˜</div>
        <div class="course-btn" id="tab-formula" onclick="switchTab('formula')">B.ä¹˜æ³•å…¬å¼</div>
        <div class="course-btn" id="tab-square" onclick="switchTab('square')">C.é…æ–¹æ³•</div>
    </div>
    
    <div id="menu-cross" class="menu-section">
        <button class="menu-btn btn-easy" onclick="startGame('cross','easy')">ğŸŸ¢ åˆéš (xÂ²ä¿‚æ•¸ç‚º1)</button>
        <button class="menu-btn btn-medium" onclick="startGame('cross','medium')">ğŸ”µ ä¸­éš (xÂ²ä¿‚æ•¸ç‚ºè³ªæ•¸)</button>
        <button class="menu-btn btn-hard" onclick="startGame('cross','hard')">ğŸŸ£ é€²éš (xÂ²ä¿‚æ•¸ç‚ºåˆæ•¸)</button>
    </div>
    <div id="menu-formula" class="menu-section hidden">
        <button class="menu-btn btn-easy" onclick="startGame('formula','easy')">ğŸŸ¢ Level 1 å¹³æ–¹å·®</button>
        <button class="menu-btn btn-medium" onclick="startGame('formula','medium')">ğŸ”µ Level 2 å®Œå…¨å¹³æ–¹</button>
        <button class="menu-btn btn-hard" onclick="startGame('formula','hard')">ğŸŸ£ Level 3 é€²éšé¡Œå‹</button>
    </div>
    <div id="menu-square" class="menu-section hidden">
        <button class="menu-btn btn-easy" onclick="startGame('square','concept')">1ï¸âƒ£ å¹³æ–¹æ ¹æ¦‚å¿µ (3ç¨®é¡Œå‹)</button>
        <button class="menu-btn btn-medium" onclick="startGame('square','move')">2ï¸âƒ£ ç§»é …é–‹æ–¹ (åˆ†æ­¥é©Ÿè§£é¡Œ)</button>
        <button class="menu-btn btn-hard" onclick="startGame('square','complete')">3ï¸âƒ£ é…æ–¹ç·´ç¿’ (5é¡Œéé—œ)</button>
        <button class="menu-btn btn-action" onclick="startGame('square','solve')">4ï¸âƒ£ é…æ–¹æ³•å…¨æ”»ç•¥ (åˆ†å››æ­¥å¼•å°)</button>
    </div>
</div>

<div class="container hidden" id="screen-game">
    <div class="status-bar">
        <span id="level-label"></span>
        <span id="score-display">é€²åº¦: 0 / 10</span>
    </div>
    <div class="question-box" id="q-text">Loading...</div>

    <div class="step-container" id="step1-container">
        <span class="step-title" id="step1-title">æ­¥é©Ÿä¸€</span>
        <div id="game-area-s1"></div>
    </div>

    <div class="step-container hidden" id="step2-container">
        <span class="step-title" id="step2-title">æ­¥é©ŸäºŒ</span>
        <div id="game-area-s2"></div>
    </div>

    <div class="step-container hidden" id="step3-container-root">
        <span class="step-title" id="step3-title">æ­¥é©Ÿä¸‰ï¼šé–‹æ ¹è™Ÿ</span>
        <div id="game-area-s3"></div>
    </div>

    <div class="step-container disabled-step" id="step3-container">
        <span class="step-title" id="solve-title">æ­¥é©Ÿå››ï¼šæ±‚è§£ x</span>
        <div class="mode-btn-group" id="solve-mode-selector">
            <button class="mode-btn active" onclick="setSolveMode('rational')">123 (æ•´æ•¸/åˆ†æ•¸)</button>
            <button class="mode-btn" onclick="setSolveMode('radical_simple')">âˆš (å–®æ ¹è™Ÿ)</button>
            <button class="mode-btn" onclick="setSolveMode('radical_mixed')">kâˆš (ä¿‚æ•¸/åˆ†æ•¸)</button>
        </div>
        <div id="solve-input-area"></div>
    </div>

    <div class="feedback" id="feedback-msg"></div>
    <button class="menu-btn btn-action hidden" id="btn-submit" onclick="checkAnswer()">é€å‡ºæœ€çµ‚ç­”æ¡ˆ</button>
    <button class="menu-btn btn-easy hidden" id="btn-next" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
    <button class="menu-btn btn-gray" style="margin-top:10px;" onclick="showMenu()">å›ä¸»é¸å–®</button>
</div>

<div class="cert-modal" id="cert-modal">
    <div class="cert-content">
        <div class="cert-title">æ¦®è­½è­‰æ›¸</div>
        <div class="cert-body" style="margin-top:20px;">
            <p>èŒ²è­‰æ˜</p>
            <div class="cert-name" id="cert-student-info"></div>
            <p>åœ¨ã€Œ<span id="cert-course-name"></span>ã€ä¸­è¡¨ç¾å„ªç•°ï¼ŒæˆåŠŸé€šé <strong id="cert-level-name" style="font-size:1.2em; color:#d62828;"></strong> è€ƒé©—ã€‚</p>
        </div>
        <div class="cert-seal" id="cert-seal-text">é€šé—œ</div>
        <button class="close-cert-btn" onclick="closeCert()">é—œé–‰</button>
    </div>
</div>

<script>
let user = { cls:'', no:'', name:'' };
let state = { course:'', level:'', q:null, score:0, subStreak:0, subType:1, step1Mode:'rational', solveMode:'rational' };
let questionHistory = []; 

function sanitizeInput(str) {
    if (!str) return "";
    str = String(str).trim();
    str = str.replace(/[\uff01-\uff5e]/g, function(ch) {
        return String.fromCharCode(ch.charCodeAt(0) - 0xfee0);
    }).replace(/[\u3000]/g, ' ').replace(/\s/g, '');
    str = str.replace(/Â²/g, '**2').replace(/\^/g, '**'); 
    return str;
}

function safeEval(val) {
    if (!val) return NaN;
    try {
        let safe = val.replace(/[xX]/g, '*');
        safe = safe.replace(/[^0-9\-\.\/\*\(\)\+]/g, '');
        return eval(safe);
    } catch(e) { return NaN; }
}

function toFractionString(val) {
    if (Number.isInteger(val)) return val;
    return (val * 2) + "/2";
}

function doLogin() {
    let c = document.getElementById('input-class').value.trim();
    let s = document.getElementById('input-seat').value.trim();
    let n = document.getElementById('input-name').value.trim();
    if(!c || !s || !n) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
    try { localStorage.removeItem('math_app_crash_guard'); } catch(e) {}
    user = {cls:c, no:s, name:n};
    document.getElementById('user-display').innerText = `${c}ç­ ${s}è™Ÿ ${n}`;
    document.getElementById('screen-login-container').classList.add('hidden');
    document.getElementById('screen-menu').classList.remove('hidden');
    switchTab('cross');
}

function switchTab(c) {
    state.course = c;
    ['cross','formula','square'].forEach(k => {
        document.getElementById('tab-'+k).className = (k===c?'course-btn active':'course-btn');
        document.getElementById('menu-'+k).classList.toggle('hidden', k!==c);
    });
}

function showMenu() {
    document.getElementById('screen-game').classList.add('hidden');
    document.getElementById('screen-menu').classList.remove('hidden');
}

function startGame(c, lv) {
    state.course = c; state.level = lv; state.score = 0; state.subStreak = 0; state.subType = 1;
    questionHistory = []; 
    document.getElementById('screen-menu').classList.add('hidden');
    document.getElementById('screen-game').classList.remove('hidden');
    let title = (c==='cross'?'åå­—äº¤ä¹˜':c==='formula'?'ä¹˜æ³•å…¬å¼':'é…æ–¹æ³•') + ' - ' + lv;
    document.getElementById('level-label').innerText = title;
    nextQuestion();
}

function nextQuestion() {
    resetInputs();
    try {
        state.q = null; 
        if(state.course === 'cross') genCross();
        else if(state.course === 'formula') genFormula();
        else genSquare();
    } catch(e) { console.error(e); alert("å‡ºé¡ŒéŒ¯èª¤ï¼Œè«‹é‡è©¦"); showMenu(); }
    updateScoreUI();
}

function updateScoreUI() {
    let txt = `é€²åº¦: ${state.score} / 10`;
    if(state.course==='square') {
        if(state.level==='complete') txt = `é€²åº¦: ${state.score} / 5`;
        else {
            let maxT = (state.level==='concept'||state.level==='move')?3:5;
            txt = `ç¬¬ ${state.subType} é—œ (å…± ${maxT} é—œ) - é€£å° ${state.subStreak}/3`;
        }
    }
    document.getElementById('score-display').innerText = txt;
}

function resetInputs() {
    document.getElementById('game-area-s1').innerHTML = ''; 
    document.getElementById('game-area-s2').innerHTML = '';
    document.getElementById('game-area-s3').innerHTML = '';
    document.getElementById('step1-container').classList.remove('disabled-step');
    document.getElementById('step2-container').classList.add('hidden');
    document.getElementById('step2-container').classList.remove('disabled-step');
    document.getElementById('step3-container-root').classList.add('hidden');
    document.getElementById('step3-container-root').classList.remove('disabled-step');
    document.getElementById('step3-container').classList.remove('hidden'); 
    document.getElementById('step3-container').classList.add('disabled-step');
    document.getElementById('feedback-msg').style.display = 'none';
    document.getElementById('btn-submit').classList.add('hidden');
    document.getElementById('btn-next').classList.add('hidden');
    state.step1Mode = 'rational';
    state.solveMode = 'rational';
    renderSolveInput();
}

function setStep1Mode(mode) { state.step1Mode = mode; if(state.course === 'square') renderSqStage1UI(); }
function setSolveMode(mode) { state.solveMode = mode; renderSolveInput(); }

function renderSolveInput() {
    let m = state.solveMode;
    let btns = document.getElementById('solve-mode-selector').children;
    for(let b of btns) b.classList.remove('active');
    if(m==='rational') btns[0].classList.add('active');
    else if(m==='radical_simple') btns[1].classList.add('active');
    else btns[2].classList.add('active');

    let h = '';
    if(m === 'rational') {
        h = `x = <input type="text" id="sol_x1" class="medium-input" inputmode="decimal" placeholder="ä¾‹å¦‚ 4/3"> æˆ– <input type="text" id="sol_x2" class="medium-input" inputmode="decimal" placeholder="ä¾‹å¦‚ -2/3">`;
    } else if(m === 'radical_simple') {
        h = `<div class="radical-wrapper">x = <input type="text" id="rad_a" class="short-input" placeholder="0"> Â± âˆš <input type="text" id="rad_b" class="short-input" placeholder="n"> <span id="rad_div" class="hidden">/ <input type="text" id="rad_c" class="short-input" value="1"></span></div>`;
    } else {
        h = `<div class="radical-wrapper">x = ( <input type="text" id="rad_a" class="short-input" placeholder="a"> Â± <input type="text" id="rad_k" class="short-input" value="1"> âˆš <input type="text" id="rad_b" class="short-input" placeholder="b"> ) / <input type="text" id="rad_c" class="short-input" value="1"></div>`;
    }
    document.getElementById('solve-input-area').innerHTML = h;
}

function rnd(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function rndNz(min,max){let n=0;while(n===0)n=rnd(min,max);return n;}
function fmt(n){return n>=0?`+ ${n}`:`- ${Math.abs(n)}`;}
function fmt2(n){return n>=0?`+${n}`:`${n}`;}
function getSimpRad(n){
    if(n<=0)return{k:0,n:0};
    let k=1;
    for(let i=2;i*i<=n;i++){while(n%(i*i)===0){k*=i;n/=(i*i);}}
    return{k,n};
}

function checkDuplicate(key) {
    if(questionHistory.includes(key)) return true;
    questionHistory.push(key);
    if(questionHistory.length > 5) questionHistory.shift();
    return false;
}

function genCross() {
    let a1=1,a2=1,c1,c2, key;
    do {
        if(state.level==='easy'){c1=rndNz(-9,9);c2=rndNz(-9,9);}
        else if(state.level==='medium'){let ps=[2,3,5];a1=ps[rnd(0,2)];c1=rndNz(-5,5);c2=rndNz(-5,5);}
        else{a1=rnd(2,5);a2=rnd(2,4);c1=rndNz(-4,4);c2=rndNz(-4,4);}
        key = `cross_${a1}_${a2}_${c1}_${c2}`;
    } while(checkDuplicate(key));

    let A=a1*a2,B=a1*c2+a2*c1,C=c1*c2;
    state.q = {type:'cross',step1:{B},roots:[-c1/a1,-c2/a2], ans:[-c1/a1,-c2/a2]};
    document.getElementById('q-text').innerText = `${A===1?'':A}xÂ² ${fmt(B)}x ${fmt(C)} = 0`;
    
    document.getElementById('step1-title').innerText = "æ­¥é©Ÿä¸€ï¼šåå­—äº¤ä¹˜æ¹Šæ•¸";
    document.getElementById('game-area-s1').innerHTML = `
        <div class="cross-layout">
            <div class="cross-col" style="text-align:right">
                <div class="cross-row">${state.level==='easy'?'':'<input type="text" id="cr_a1" class="box-input" placeholder="a">'} <span style="font-size:2rem">x</span></div>
                <div class="cross-row">${state.level==='easy'?'':'<input type="text" id="cr_a2" class="box-input" placeholder="a">'} <span style="font-size:2rem">x</span></div>
            </div>
            <div class="big-x">â•³</div>
            <div class="cross-col">
                <div class="cross-row"><select id="cr_op1" class="box-select"><option value="1">+</option><option value="-1">-</option></select><input type="text" id="cr_c1" class="box-input" placeholder="c"></div>
                <div class="cross-row"><select id="cr_op2" class="box-select"><option value="1">+</option><option value="-1">-</option></select><input type="text" id="cr_c2" class="box-input" placeholder="c"></div>
            </div>
        </div>
        <div style="text-align:center;">é©—ç®—ï¼š( <input type="text" id="chk_1" style="width:60px"> x ) + ( <input type="text" id="chk_2" style="width:60px"> x ) = ?</div>
        <button class="menu-btn btn-check" onclick="checkCrossStep1()">æª¢æŸ¥æ¹Šæ•¸æ­¥é©Ÿ</button>
    `;
    document.getElementById('solve-mode-selector').style.display = 'flex';
}

function genFormula() {
    let type='diff',a=1,b=1, key;
    do {
        if(state.level==='easy'){type='diff';a=(Math.random()<0.3?rnd(2,5):1);b=rnd(1,9);}
        else{type='sum';b=rnd(1,9);}
        key = `form_${type}_${a}_${b}`;
    } while(checkDuplicate(key));

    let eq = (type==='diff') ? `(${a===1?'':a}x)Â² - ${b*b} = 0` : `xÂ² + ${2*b}x + ${b*b} = 0`;
    let r1 = (type==='diff') ? b/a : -b;
    let r2 = (type==='diff') ? -b/a : -b;
    state.q = {type:'formula', ftype:type, roots:[r1, r2], ans:[r1,r2]};
    document.getElementById('q-text').innerText = eq;
    document.getElementById('step1-title').innerText = "æ­¥é©Ÿä¸€ï¼šé¸æ“‡å…¬å¼";
    document.getElementById('game-area-s1').innerHTML = `
        <div class="formula-options">
            <div class="formula-option" id="opt-diff" onclick="selForm('diff')">1. å¹³æ–¹å·® AÂ² - BÂ²</div>
            <div class="formula-option" id="opt-sum" onclick="selForm('sum')">2. å’Œçš„å¹³æ–¹ (A+B)Â²</div>
            <div class="formula-option" id="opt-sub" onclick="selForm('sub')">3. å·®çš„å¹³æ–¹ (A-B)Â²</div>
        </div>
        <button class="menu-btn btn-check" onclick="checkFormStep1()">ç¢ºèªå…¬å¼</button>
    `;
}

function genSquare() {
    let lv = state.level, st = state.subType;
    let q = { type:'square', stage:lv };
    document.getElementById('step1-title').innerText = "æ­¥é©Ÿä¸€ï¼šå»å¹³æ–¹ / ç§»é …";

    let key;
    if(lv === 'concept') {
        let k, a=0;
        do {
            if(st===1) { k=rnd(2,9)**2; key=`sq_c_1_${k}`; }
            else { a=rndNz(-9,9); k=(st===2 ? rnd(2,9)**2 : [2,3,5,6,7][rnd(0,4)]); key=`sq_c_${st}_${a}_${k}`; }
        } while(checkDuplicate(key));

        if(st===1) {
            q.roots=[Math.sqrt(k), -Math.sqrt(k)]; q.ans = q.roots; q.form='rational';
            state.q = q; state.solveMode='rational';
            document.getElementById('q-text').innerText = `xÂ² = ${k}`;
            document.getElementById('step1-container').classList.add('disabled-step');
            document.getElementById('step3-container').classList.remove('disabled-step');
            document.getElementById('btn-submit').classList.remove('hidden');
            renderSolveInput();
        } else {
            document.getElementById('q-text').innerText = `(x${fmt2(a)})Â² = ${k}`;
            if(st===2) {
                q.form='rational'; 
                let r = Math.sqrt(k);
                q.roots = [r-a, -r-a]; q.ans = q.roots;
            } else {
                q.form='radical';
                let simp = getSimpRad(k);
                q.ans = [ (-a + simp.k*Math.sqrt(simp.n)), (-a - simp.k*Math.sqrt(simp.n)) ];
            }
            q.step1_check = k; q.lhs = `x${fmt(a)}`;
            state.q = q;
            state.step1Mode = (q.form==='radical') ? 'radical_simple' : 'rational';
            renderSqStage1UI();
        }
    } 
    else if (lv === 'move') {
        let a, c, d, total;
        do {
            a=(st===1?1:rnd(2,3)); 
            if(st===1) { a=rndNz(-5,5); c=rnd(2,9)**2; d=0; }
            else { c=rnd(1,10); d=rnd(1,5); total=c+d; }
            key = `sq_m_${st}_${a}_${c}_${d}`;
        } while(checkDuplicate(key));

        if(st===1) {
            let k=c; 
            document.getElementById('q-text').innerText = `(x${fmt2(a)})Â² - ${k} = 0`;
            let r=Math.sqrt(k);
            q.ans = [r-a, -r-a]; q.form='rational';
            q.step1_check = k; q.lhs = `x${fmt(a)}`;
            state.q = q;
            state.step1Mode = 'rational';
            renderSqStage1UI(); 
        } else {
            let b = rndNz(-5,5);
            document.getElementById('q-text').innerText = `(${a}x${fmt(b)})Â² - ${c} = ${d}`;
            total = c+d;
            q.step1_check = total; q.lhs = `${a}x${fmt(b)}`;
            let simp = getSimpRad(total);
            q.ans = [ (-b + Math.sqrt(total))/a, (-b - Math.sqrt(total))/a ];
            q.form = (simp.n<=1 ? 'rational' : 'radical');
            state.q = q;
            state.step1Mode = (q.form==='radical' ? 'radical_simple' : 'rational');
            renderSqStage1UI();
        }
    }
    else if (lv === 'complete') {
        let b = rnd(1, 9) * 2; 
        let c = (b/2)**2;
        let half = b/2;
        document.getElementById('q-text').innerText = `xÂ² ${fmt(b)}x + â–¡ = (x + â–³)Â²`;
        document.getElementById('game-area-s1').innerHTML = `
            <div style="font-size:1.5rem; margin-bottom:15px;">
                â–¡ = <input type="text" id="sq_c_val" class="medium-input" placeholder="ä¾‹å¦‚ (2)Â² æˆ– 4"> 
                â–³ = <input type="text" id="sq_b_val" class="medium-input" placeholder="ä¾‹å¦‚ 5/2">
            </div>
            <button class="menu-btn btn-check" onclick="checkSqComplete()">æª¢æŸ¥ç­”æ¡ˆ</button>
        `;
        document.getElementById('step3-container').classList.add('hidden'); 
        state.q = { type: 'complete', ans: [c, half] };
    }
    else if (lv === 'solve') {
        // High probability of irrational roots
        let isRadical = Math.random() < 0.7; 
        let B, C, p;
        
        if (!isRadical) {
            let r1 = rnd(-8, 8);
            let r2 = rnd(-8, 8);
            B = -(r1+r2);
            C = r1*r2;
            while(B===0 || C===0) { r1=rnd(-5,5); r2=rnd(-5,5); B=-(r1+r2); C=r1*r2; }
            state.solveMode = 'rational';
        } else {
            p = rndNz(-6, 6);
            let q_surd = 0;
            while(true) {
                q_surd = rnd(2, 15);
                if (Math.floor(Math.sqrt(q_surd)) !== Math.sqrt(q_surd)) break;
            }
            B = 2 * p;
            C = p**2 - q_surd;
            state.solveMode = 'radical_mixed'; 
        }

        document.getElementById('q-text').innerText = `xÂ² ${fmt(B)}x ${fmt(C)} = 0`;
        
        let s1_add = (B/2)**2;
        let s1_rhs = -C + s1_add;
        let s2_p = B/2;
        let s2_q = s1_rhs;
        let s3_root = Math.sqrt(s2_q);
        
        state.q = { 
            type: 'solve_steps', 
            s1_add: s1_add, 
            s1_rhs: s1_rhs,
            s2_p: s2_p,
            s2_q: s2_q,
            s3_root: s3_root,
            s3_is_perfect: Number.isInteger(s3_root), 
            roots: [0, 0], // Not used for radical check
            ans: isRadical ? null : [(-B/2)+s3_root, (-B/2)-s3_root],
            ans_radical: isRadical ? { a: -B/2, k: 1, b: s2_q, c: 1 } : null
        };

        document.getElementById('step1-title').innerText = "æ­¥é©Ÿä¸€ï¼šç§»é …ä¸¦é…æ–¹";
        document.getElementById('game-area-s1').innerHTML = `
            xÂ² ${fmt(B)}x + <input type="text" id="sq4_s1_add" class="medium-input" placeholder="(b/2)Â²"> = ${-C} + <input type="text" id="sq4_s1_rhs" class="medium-input" placeholder="(b/2)Â²">
            <button class="menu-btn btn-check" style="margin-top:10px" onclick="checkSq4S1()">æª¢æŸ¥æ­¥é©Ÿä¸€</button>
        `;
        
        document.getElementById('step2-title').innerText = "æ­¥é©ŸäºŒï¼šæ•´ç†å¹³æ–¹";
        document.getElementById('game-area-s2').innerHTML = `
            (x + <input type="text" id="sq4_s2_p" class="medium-input">)Â² = <input type="text" id="sq4_s2_q" class="medium-input">
            <button class="menu-btn btn-check" style="margin-top:10px" onclick="checkSq4S2()">æª¢æŸ¥æ­¥é©ŸäºŒ</button>
        `;
        
        let s3_input_html = '';
        if (state.q.s3_is_perfect) {
            s3_input_html = `Â± <input type="text" id="sq4_s3_root" class="medium-input" placeholder="æ•´æ•¸">`;
        } else {
            s3_input_html = `Â± <span class="radical-symbol">âˆš</span> <input type="text" id="sq4_s3_root" class="medium-input" placeholder="æ ¹è™Ÿå…§æ•¸å­—">`;
        }

        document.getElementById('step3-title').innerText = "æ­¥é©Ÿä¸‰ï¼šé–‹æ ¹è™Ÿ";
        document.getElementById('game-area-s3').innerHTML = `
            x + <input type="text" id="sq4_s3_p" class="medium-input" readonly> = ${s3_input_html}
            <button class="menu-btn btn-check" style="margin-top:10px" onclick="checkSq4S3()">æª¢æŸ¥æ­¥é©Ÿä¸‰</button>
        `;
        
        document.getElementById('step3-container').classList.add('hidden'); 
    }
}

function renderSqStage1UI() {
    let m = state.step1Mode;
    let inputHTML = '';
    let buttons = `
        <div class="mode-btn-group">
            <button class="mode-btn ${m==='rational'?'active':''}" onclick="setStep1Mode('rational')">123</button>
            <button class="mode-btn ${m==='radical_simple'?'active':''}" onclick="setStep1Mode('radical_simple')">âˆš</button>
            <button class="mode-btn ${m==='radical_mixed'?'active':''}" onclick="setStep1Mode('radical_mixed')">kâˆš</button>
        </div>
    `;

    if(m === 'rational') inputHTML = `Â± <input type="text" id="sq1_val" class="box-input">`;
    else if (m === 'radical_simple') inputHTML = `Â± âˆš <input type="text" id="sq1_n" class="short-input">`;
    else inputHTML = `Â± <input type="text" id="sq1_k" class="short-input" placeholder="k"> âˆš <input type="text" id="sq1_n" class="short-input" placeholder="n">`;

    document.getElementById('game-area-s1').innerHTML = `
        <div style="text-align:center; font-size:1.5rem; margin-bottom:10px;">
            ${state.q.lhs} = ${inputHTML}
        </div>
        ${buttons}
        <button class="menu-btn btn-check" onclick="checkSqS1()">æª¢æŸ¥æ­¥é©Ÿ</button>
    `;
    
    document.getElementById('step1-container').classList.remove('disabled-step');
    document.getElementById('step3-container').classList.add('disabled-step');
    document.getElementById('btn-submit').classList.add('hidden');
}

function checkSq4S1() {
    let add = safeEval(sanitizeInput(document.getElementById('sq4_s1_add').value));
    let rhs = safeEval(sanitizeInput(document.getElementById('sq4_s1_rhs').value));
    
    if(Math.abs(add - state.q.s1_add) < 0.01 && Math.abs(rhs - state.q.s1_add) < 0.01) { 
        document.getElementById('step1-container').classList.add('disabled-step');
        document.getElementById('step2-container').classList.remove('hidden');
    } else {
        alert("é…æ–¹æ•¸å­—éŒ¯èª¤ï¼Œæç¤ºï¼šå·¦å³å…©é‚Šéƒ½è¦åŠ ä¸Š (b/2)Â²");
    }
}

function checkSq4S2() {
    let p = safeEval(sanitizeInput(document.getElementById('sq4_s2_p').value));
    let q_val = safeEval(sanitizeInput(document.getElementById('sq4_s2_q').value));
    
    if(Math.abs(p - state.q.s2_p) < 0.01 && Math.abs(q_val - state.q.s2_q) < 0.01) {
        document.getElementById('step2-container').classList.add('disabled-step');
        document.getElementById('step3-container-root').classList.remove('hidden');
        // Auto fill p with fraction display
        document.getElementById('sq4_s3_p').value = toFractionString(state.q.s2_p); 
    } else {
        alert("æ•´ç†éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥");
    }
}

function checkSq4S3() {
    let input_val = safeEval(sanitizeInput(document.getElementById('sq4_s3_root').value));
    let isCorrect = false;

    if (state.q.s3_is_perfect) {
        if (Math.abs(input_val - state.q.s3_root) < 0.01) isCorrect = true;
    } else {
        if (Math.abs(input_val - state.q.s2_q) < 0.01) isCorrect = true;
    }

    if(isCorrect) {
        document.getElementById('step3-container-root').classList.add('disabled-step');
        document.getElementById('step3-container').classList.remove('hidden');
        document.getElementById('step3-container').classList.remove('disabled-step');
        document.getElementById('btn-submit').classList.remove('hidden');
        
        if (!state.q.s3_is_perfect) setSolveMode('radical_mixed');
        else setSolveMode('rational');
        
        renderSolveInput();
    } else {
        alert("é–‹æ ¹è™ŸéŒ¯èª¤");
    }
}

function checkSqS1() {
    let m = state.step1Mode;
    let target = state.q.step1_check;
    let userVal = 0;
    
    if(m === 'rational') {
        let v = sanitizeInput(document.getElementById('sq1_val').value);
        if(v==="") return alert("è«‹è¼¸å…¥æ•¸å­—");
        userVal = safeEval(v)**2; 
    } else {
        let k = m==='radical_mixed' ? safeEval(sanitizeInput(document.getElementById('sq1_k').value)) : 1;
        let n = safeEval(sanitizeInput(document.getElementById('sq1_n').value));
        if(isNaN(k) || isNaN(n)) return alert("è«‹è¼¸å…¥æ•¸å­—");
        userVal = (k*k*n);
    }
    
    if(Math.abs(userVal - target) < 0.1) {
        document.getElementById('step1-container').classList.add('disabled-step');
        document.getElementById('step3-container').classList.remove('disabled-step');
        document.getElementById('btn-submit').classList.remove('hidden');
        if(state.q.form === 'radical') setSolveMode('radical_mixed'); 
        else setSolveMode('rational');
    } else alert("æ•¸å€¼éŒ¯èª¤");
}

function checkSqComplete() {
    let c = safeEval(sanitizeInput(document.getElementById('sq_c_val').value));
    let b = safeEval(sanitizeInput(document.getElementById('sq_b_val').value));
    let ans = state.q.ans;
    if(Math.abs(c - ans[0]) < 0.01 && Math.abs(b - ans[1]) < 0.01) {
        passQuestion();
    } else {
        showFeedback(false, "âŒ ç­”æ¡ˆæœ‰èª¤ï¼Œæç¤ºï¼š(b/2)^2");
    }
}

function checkCrossStep1() {
    let v1 = parseInt(document.getElementById('chk_1').value)||0;
    let v2 = parseInt(document.getElementById('chk_2').value)||0;
    if(v1+v2 === state.q.step1.B) {
        alert('é©—ç®—æ­£ç¢º'); document.getElementById('step3-container').classList.remove('disabled-step'); document.getElementById('btn-submit').classList.remove('hidden');
    } else alert('é©—ç®—éŒ¯èª¤');
}

function selForm(t) { state.selectedFormula = t; document.querySelectorAll('.formula-option').forEach(e=>e.classList.remove('selected')); document.getElementById('opt-'+t).classList.add('selected'); }
function checkFormStep1() { if(state.selectedFormula===state.q.ftype){ document.getElementById('step3-container').classList.remove('disabled-step'); document.getElementById('btn-submit').classList.remove('hidden'); } else alert("å…¬å¼é¸éŒ¯"); }

function checkAnswer() {
    try {
        let isCorrect = false;
        
        if (state.solveMode === 'rational') {
            let el1 = document.getElementById('sol_x1');
            let el2 = document.getElementById('sol_x2');
            if(!el1 || !el2) throw new Error("æ‰¾ä¸åˆ°è¼¸å…¥æ¡†");

            let val1 = sanitizeInput(el1.value.trim());
            let val2 = sanitizeInput(el2.value.trim());
            
            if(val1 === "" || val2 === "") return alert("è«‹è¼¸å…¥å®Œæ•´ç­”æ¡ˆ");
            
            let u1 = safeEval(val1);
            let u2 = safeEval(val2);
            
            if(isNaN(u1) || isNaN(u2)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—");
            
            let r1 = state.q.ans ? state.q.ans[0] : 0;
            let r2 = state.q.ans ? state.q.ans[1] : 0;

            if ( (Math.abs(u1-r1)<0.01 && Math.abs(u2-r2)<0.01) || (Math.abs(u1-r2)<0.01 && Math.abs(u2-r1)<0.01) ) isCorrect=true;

        } else {
            let ua = safeEval(sanitizeInput(document.getElementById('rad_a').value));
            let ub = safeEval(sanitizeInput(document.getElementById('rad_b').value));
            let uk = safeEval(sanitizeInput(document.getElementById('rad_k') ? document.getElementById('rad_k').value : 1));
            let uc = safeEval(sanitizeInput(document.getElementById('rad_c') ? document.getElementById('rad_c').value : 1));
            
            if(isNaN(ua)||isNaN(ub)||isNaN(uk)||isNaN(uc)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—");
            
            // Calculate value
            let v = uk*Math.sqrt(ub);
            let u1 = (ua + v)/uc;
            let u2 = (ua - v)/uc;
            
            if (state.q.ans_radical) {
                let target_a = state.q.ans_radical.a;
                let target_b = state.q.ans_radical.b;
                let t1 = target_a + Math.sqrt(target_b);
                let t2 = target_a - Math.sqrt(target_b);
                if ( (Math.abs(u1-t1)<0.01 && Math.abs(u2-t2)<0.01) || (Math.abs(u1-t2)<0.01 && Math.abs(u2-t1)<0.01) ) isCorrect=true;
            } else {
                let r1 = state.q.ans[0];
                let r2 = state.q.ans[1];
                if ( (Math.abs(u1-r1)<0.01 && Math.abs(u2-r2)<0.01) || (Math.abs(u1-r2)<0.01 && Math.abs(u2-r1)<0.01) ) isCorrect=true;
            }
        }

        if(isCorrect) passQuestion();
        else showFeedback(false, "âŒ ç­”æ¡ˆæœ‰èª¤ï¼Œè«‹å†æª¢æŸ¥è¨ˆç®—éç¨‹");
        
    } catch(e) {
        alert("ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
        console.error(e);
    }
}

function passQuestion() {
    state.subStreak++; 
    state.score++;
    
    let leveledUp = false;
    let maxT = (state.level==='concept'||state.level==='move')?3:5;
    
    if (state.level === 'complete') {
        if(state.score >= 5) { passLevel(); return; }
    }
    else if(state.course==='square') {
        if(state.subStreak >= 3) {
            state.subType++;
            state.subStreak = 0;
            leveledUp = true;
            if(state.subType > maxT) { passLevel(); return; }
        }
    } else {
        if(state.score >= 10) { passLevel(); return; }
    }

    document.getElementById('btn-submit').classList.add('hidden');
    document.getElementById('btn-next').classList.remove('hidden');
    
    let msg = leveledUp ? "ğŸ‰ ç­”å°äº†ï¼æ­å–œæ™‰ç´šä¸‹ä¸€ç¨®é¡Œå‹ï¼" : "ğŸ‰ ç­”å°äº†ï¼ç¹¼çºŒä¿æŒï¼";
    showFeedback(true, msg);
    updateScoreUI();
}

function passLevel() {
    let title = (state.course==='cross'?'åå­—äº¤ä¹˜':state.course==='formula'?'ä¹˜æ³•å…¬å¼':'é…æ–¹æ³•') + ' - ' + state.level;
    document.getElementById('cert-student-info').innerText = `${user.cls}ç­ ${user.no}è™Ÿ ${user.name}`;
    document.getElementById('cert-course-name').innerText = title;
    document.getElementById('cert-level-name').innerText = "å…¨æ•¸é€šé—œ";
    document.getElementById('cert-modal').style.display='flex';
}

function showFeedback(ok, text) {
    let el = document.getElementById('feedback-msg');
    el.style.display = 'block';
    el.className = ok ? 'feedback correct' : 'feedback wrong';
    el.innerText = text || (ok ? 'ğŸ‰ ç­”å°äº†ï¼' : 'âŒ ç­”æ¡ˆæœ‰èª¤');
}
function closeCert() { document.getElementById('cert-modal').style.display='none'; showMenu(); }
</script>
</body>
</html>