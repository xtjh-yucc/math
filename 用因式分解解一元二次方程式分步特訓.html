<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹ä¸­æ•¸å­¸ï¼šä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼ç‰¹è¨“ (æ ¹è™Ÿåˆ‡æ›ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #2ec4b6;
            --error: #e63946;
            --bg: #f8f9fa;
            --gold: #ffb703;
            --pink: #ff006e;
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            overscroll-behavior: none;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 650px;
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }

        h1 { color: var(--primary); margin-bottom: 1.5rem; font-size: 1.8rem; font-weight: 800; letter-spacing: 1px; }
        
        /* ç™»å…¥ç•«é¢ */
        .login-container { max-width: 400px; margin: 0 auto; text-align: left; }
        .login-group { margin-bottom: 20px; }
        .login-label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 1.1rem; }
        .login-input { 
            width: 100%; padding: 12px; font-size: 1.2rem; 
            border: 2px solid #e0e0e0; border-radius: 12px; 
            box-sizing: border-box; transition: 0.3s; background: #fff;
        }
        .login-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2); }

        /* é¸å–®æŒ‰éˆ• */
        .course-selector { display: flex; gap: 8px; margin-bottom: 20px; justify-content: center; }
        .course-btn {
            flex: 1; padding: 12px 5px; border: 2px solid #ddd; background: white; border-radius: 10px;
            cursor: pointer; font-weight: bold; color: #666; transition: 0.2s; font-size: 1rem;
        }
        .course-btn.active { border-color: var(--primary); background: #eef2ff; color: var(--primary); }

        .menu-btn { 
            width: 100%; padding: 16px; margin: 10px 0; font-size: 1.1rem; 
            border: none; border-radius: 15px; cursor: pointer; color: white; 
            font-weight: bold; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transition: transform 0.1s;
        }
        .menu-btn:active { transform: scale(0.98); }
        
        .btn-easy { background: linear-gradient(135deg, #4cc9f0, #4361ee) !important; }
        .btn-medium { background: linear-gradient(135deg, #4361ee, #3a0ca3) !important; }
        .btn-hard { background: linear-gradient(135deg, #7209b7, #560bad) !important; }
        .btn-action { background: var(--success) !important; }
        .btn-gray { background: #6c757d !important; box-shadow: none; }
        
        .btn-check { 
            background: var(--pink) !important; 
            color: white !important; 
            box-shadow: 0 4px 10px rgba(255, 0, 110, 0.3);
            margin-top: 15px;
        }
        
        .btn-toggle {
            background: #eee; border: 1px solid #ccc; color: #555; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; margin-left: 10px;
        }

        /* Game UI */
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; font-size: 1rem; color: #555; background: #f1f5f9; padding: 12px; border-radius: 10px;}
        .question-box { font-size: 2.2rem; font-family: 'Times New Roman', serif; background: #e9ecef; padding: 25px; border-radius: 15px; margin-bottom: 20px; }
        
        .step-container { text-align: left; margin-bottom: 15px; padding: 20px; border: 2px solid #e9ecef; border-radius: 15px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .step-title { font-weight: bold; color: var(--primary); margin-bottom: 15px; display: block; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        
        /* Inputs */
        input[type="number"], input[type="text"] { 
            padding: 8px; text-align: center; font-size: 1.5rem; border: 2px solid #ced4da; border-radius: 10px; 
            -webkit-appearance: none; margin: 0 4px; font-family: 'Times New Roman'; background: #fff;
        }
        .short-input { width: 70px; } .medium-input { width: 110px; }
        
        select { 
            padding: 8px; font-size: 1.5rem; border: 2px solid #ced4da; border-radius: 10px; background: white; cursor: pointer; 
            -webkit-appearance: none; text-align-last: center;
        }
        .sign-select { width: 60px; background-color: #e7f1ff; color: var(--primary); font-weight: bold; border-color: var(--primary); }

        .cross-layout { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 10px 0; }
        .cross-col { display: flex; flex-direction: column; gap: 10px; }
        .cross-row { display: flex; align-items: center; gap: 5px; }
        .big-x { font-size: 8rem; line-height: 0.7; color: #cbd5e1; font-weight: 300; }
        .box-input { width: 80px; height: 60px; font-size: 1.8rem; }
        
        .formula-options { display: grid; gap: 10px; }
        .formula-option { padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: center; font-size: 1.2rem; transition: 0.2s; }
        .formula-option:hover { background: #f8f9fa; }
        .formula-option.selected { border-color: var(--primary); background: #eef2ff; color: var(--primary); font-weight: bold; }

        .radical-input { 
            font-family: 'Times New Roman'; font-size: 1.4rem; 
            display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 8px; 
            background: #fff8e1; padding: 20px; border-radius: 12px; border: 2px solid #ffe082;
        }

        .hidden { display: none !important; }
        .disabled-step { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        
        .feedback { margin-top: 15px; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1.1rem; display: none; }
        .feedback.correct { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .feedback.wrong { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        .toggle-container { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .toggle-btn { padding: 8px 25px; background: #eee; border-radius: 20px; cursor: pointer; font-size: 1rem; border: 1px solid #ddd; }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<div class="container" id="screen-login">
    <h1>ğŸ“ æ•¸å­¸ç‰¹è¨“ç³»çµ±</h1>
    <div class="login-container">
        <div class="login-group">
            <label class="login-label">ç­ç´š</label>
            <input type="text" id="in-class" class="login-input" placeholder="ä¾‹å¦‚ï¼š801">
        </div>
        <div class="login-group">
            <label class="login-label">åº§è™Ÿ</label>
            <input type="text" id="in-seat" class="login-input" placeholder="ä¾‹å¦‚ï¼š05">
        </div>
        <div class="login-group">
            <label class="login-label">å§“å</label>
            <input type="text" id="in-name" class="login-input" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
        </div>
        <button class="menu-btn btn-action" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
    </div>
</div>

<div class="container hidden" id="screen-menu">
    <div style="text-align:right; margin-bottom:10px; color:#666; font-weight:bold;" id="user-display"></div>
    <h1>é¸æ“‡ç‰¹è¨“èª²ç¨‹</h1>
    <div class="course-selector">
        <div class="course-btn active" id="tab-cross" onclick="switchTab('cross')">A.åå­—äº¤ä¹˜</div>
        <div class="course-btn" id="tab-formula" onclick="switchTab('formula')">B.ä¹˜æ³•å…¬å¼</div>
        <div class="course-btn" id="tab-square" onclick="switchTab('square')">C.é…æ–¹æ³•</div>
    </div>
    <div id="menu-content"></div>
</div>

<div class="container hidden" id="screen-game">
    <div class="status-bar">
        <span id="level-label"></span>
        <span id="score-display">é€²åº¦: 0 / 10</span>
    </div>
    
    <div class="question-box" id="q-text">Loading...</div>

    <div class="step-container" id="step1-container">
        <span class="step-title" id="step1-title">æ­¥é©Ÿä¸€</span>
        <div id="game-area-s1"></div>
    </div>

    <div class="step-container hidden" id="step2-container">
        <span class="step-title" id="step2-title">æ­¥é©ŸäºŒ</span>
        <div id="game-area-s2"></div>
    </div>

    <div class="step-container disabled-step" id="step3-container">
        <span class="step-title" id="solve-title">æ±‚è§£ x</span>
        <div id="solve-input-area">
            <div id="input-rational">
                x = <input type="text" id="sol-x1" class="medium-input"> æˆ– <input type="text" id="sol-x2" class="medium-input">
            </div>
            <div id="input-radical" class="hidden">
                <div class="radical-input">
                    x = <input type="text" id="rad-a" class="short-input" placeholder="0"> Â± 
                    <input type="text" id="rad-k" style="width:40px" value="1"> âˆš
                    <input type="text" id="rad-b" class="short-input" placeholder="n">
                    <span id="rad-div-part" class="hidden"> / <input type="text" id="rad-c" style="width:40px" value="1"></span>
                </div>
                <div style="font-size:0.8rem; color:#666; margin-top:5px;">æ ¼å¼: (a Â± kâˆšb) / c (è«‹å¡«æœ€ç°¡æ ¹å¼)</div>
            </div>
            <div id="ans-toggle" class="toggle-container hidden">
                <div class="toggle-btn active" id="btn-rat" onclick="setAnsMode('rational')">æ•´æ•¸/åˆ†æ•¸</div>
                <div class="toggle-btn" id="btn-rad" onclick="setAnsMode('radical')">æ ¹è™Ÿè§£</div>
            </div>
        </div>
    </div>

    <div class="feedback" id="feedback-msg"></div>
    <button class="menu-btn btn-action hidden" id="btn-submit" onclick="checkAnswer()">é€å‡ºæœ€çµ‚ç­”æ¡ˆ</button>
    <button class="menu-btn btn-easy hidden" id="btn-next" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
    <button class="menu-btn btn-gray" style="margin-top:10px;" onclick="showMenu()">å›ä¸»é¸å–®</button>
</div>

<div class="cert-modal" id="cert-modal">
    <div class="cert-content">
        <div class="cert-title" id="cert-title">æ¦®è­½è­‰æ›¸</div>
        <div class="cert-body" style="margin-top:20px;">
            <p>èŒ²è­‰æ˜</p>
            <div class="cert-name" id="cert-student-info"></div>
            <p>åœ¨ã€Œ<span id="cert-course-name"></span>ã€ä¸­è¡¨ç¾å„ªç•°ï¼ŒæˆåŠŸé€šé <strong id="cert-level-name" style="font-size:1.2em; color:#d62828;"></strong> è€ƒé©—ã€‚</p>
        </div>
        <div class="cert-seal" id="cert-seal-text">é€šé—œ</div>
        <button class="close-cert-btn" onclick="closeCert()">é—œé–‰</button>
    </div>
</div>

<script>
let user = { cls:'', no:'', name:'' };
let state = { course:'', level:'', q:null, score:0, subStreak:0, subType:1, ansMode:'rational', step1InputMode:'auto' };

function doLogin() {
    let c = document.getElementById('in-class').value.trim();
    let s = document.getElementById('in-seat').value.trim();
    let n = document.getElementById('in-name').value.trim();
    if(!c || !s || !n) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
    user = {cls:c, no:s, name:n};
    document.getElementById('user-display').innerText = `${c}ç­ ${s}è™Ÿ ${n}`;
    document.getElementById('screen-login').classList.add('hidden');
    document.getElementById('screen-menu').classList.remove('hidden');
    switchTab('cross');
}

function switchTab(c) {
    state.course = c;
    ['cross','formula','square'].forEach(k => document.getElementById('tab-'+k).className = (k===c?'course-btn active':'course-btn'));
    
    let html = '';
    if(c === 'cross') {
        html = `<button class="menu-btn btn-easy" onclick="startGame('cross','easy')">ğŸŸ¢ åˆéš (xÂ²ä¿‚æ•¸ç‚º1)</button>
                <button class="menu-btn btn-medium" onclick="startGame('cross','medium')">ğŸ”µ ä¸­éš (è³ªæ•¸ä¿‚æ•¸)</button>
                <button class="menu-btn btn-hard" onclick="startGame('cross','hard')">ğŸŸ£ é€²éš (åˆæ•¸ä¿‚æ•¸)</button>`;
    } else if (c === 'formula') {
        html = `<button class="menu-btn btn-easy" onclick="startGame('formula','easy')">ğŸŸ¢ Level 1 å¹³æ–¹å·®</button>
                <button class="menu-btn btn-medium" onclick="startGame('formula','medium')">ğŸ”µ Level 2 å®Œå…¨å¹³æ–¹</button>
                <button class="menu-btn btn-hard" onclick="startGame('formula','hard')">ğŸŸ£ Level 3 é€²éšé¡Œå‹</button>`;
    } else {
        html = `<button class="menu-btn btn-easy" onclick="startGame('square','concept')">1ï¸âƒ£ å¹³æ–¹æ ¹æ¦‚å¿µ (3ç¨®é¡Œå‹)</button>
                <button class="menu-btn btn-medium" onclick="startGame('square','move')">2ï¸âƒ£ ç§»é …é–‹æ–¹ (ç›´æ¥æ±‚è§£)</button>
                <button class="menu-btn btn-hard" onclick="startGame('square','complete')">3ï¸âƒ£ é…æ–¹ç·´ç¿’ (5é¡Œéé—œ)</button>
                <button class="menu-btn btn-action" onclick="startGame('square','solve')">4ï¸âƒ£ é…æ–¹æ³•å…¨æ”»ç•¥ (5ç¨®é¡Œå‹)</button>`;
    }
    document.getElementById('menu-content').innerHTML = html;
}

function showMenu() {
    document.getElementById('screen-game').classList.add('hidden');
    document.getElementById('screen-menu').classList.remove('hidden');
}

function startGame(c, lv) {
    state.course = c; state.level = lv; state.score = 0; state.subStreak = 0; state.subType = 1;
    document.getElementById('screen-menu').classList.add('hidden');
    document.getElementById('screen-game').classList.remove('hidden');
    
    // Reset UI
    document.getElementById('step2-container').classList.add('hidden');
    document.getElementById('step3-container').classList.remove('hidden');
    document.getElementById('solve-title').innerText = "æ±‚è§£ x";
    document.getElementById('ans-toggle').classList.add('hidden');
    
    let title = (c==='cross'?'åå­—äº¤ä¹˜':c==='formula'?'ä¹˜æ³•å…¬å¼':'é…æ–¹æ³•') + ' - ' + lv;
    document.getElementById('level-label').innerText = title;
    
    nextQuestion();
}

function nextQuestion() {
    // Progression Logic
    if(state.course === 'square') {
        if(state.level === 'complete') {
             if(state.score >= 5) { alert("æ­å–œé€šé—œï¼"); showMenu(); return; }
        } else {
             if(state.subStreak >= 3) {
                state.subType++; state.subStreak = 0;
                let maxT = (state.level==='concept'||state.level==='move')?3 : 5;
                if(state.subType > maxTypes) { alert("æ­å–œé€šé—œï¼"); showMenu(); return; }
            }
        }
    } else {
        if(state.score >= 10) { alert("æ­å–œé€šé—œï¼"); showMenu(); return; }
    }

    resetInputs();
    
    try {
        if(state.course === 'cross') genCross();
        else if(state.course === 'formula') genFormula();
        else genSquare();
    } catch(e) {
        console.error(e); alert("å‡ºé¡ŒéŒ¯èª¤"); showMenu();
    }
    
    // Update Score UI
    if(state.course === 'square') {
        if(state.level === 'complete') {
            document.getElementById('score-display').innerText = `é€²åº¦: ${state.score} / 5`;
        } else {
            let maxT = (state.level==='concept'||state.level==='move')?3 : 5;
            document.getElementById('score-display').innerText = `é¡Œå‹ ${state.subType}/${maxT} (é€£å° ${state.subStreak}/3)`;
        }
    } else {
        document.getElementById('score-display').innerText = `é€²åº¦: ${state.score} / 10`;
    }
}

function resetInputs() {
    document.querySelectorAll('input').forEach(i => i.value = '');
    document.querySelectorAll('select').forEach(s => s.value = '1');
    document.querySelectorAll('.formula-option').forEach(o => o.classList.remove('selected'));
    
    // Clear dynamic containers
    document.getElementById('game-area-s1').innerHTML = '';
    document.getElementById('game-area-s2').innerHTML = '';

    document.getElementById('step1-container').classList.remove('disabled-step');
    document.getElementById('step2-container').classList.add('disabled-step');
    document.getElementById('step3-container').classList.add('disabled-step');
    
    document.getElementById('feedback-msg').style.display = 'none';
    document.getElementById('btn-submit').classList.add('hidden');
    document.getElementById('btn-next').classList.add('hidden');
    
    setAnsMode('rational');
    if(state.course === 'square' && state.level === 'solve') {
        document.getElementById('step2-container').classList.remove('hidden');
    } else {
        document.getElementById('step2-container').classList.add('hidden');
    }
    
    if(document.getElementById('rad-k')) document.getElementById('rad-k').value = 1;
    if(document.getElementById('rad-c')) document.getElementById('rad-c').value = 1;
}

function setAnsMode(m) {
    state.ansMode = m;
    document.getElementById('input-rational').classList.toggle('hidden', m!=='rational');
    document.getElementById('input-radical').classList.toggle('hidden', m!=='radical');
    document.getElementById('btn-rat').className = m==='rational'?'toggle-btn active':'toggle-btn';
    document.getElementById('btn-rad').className = m==='radical'?'toggle-btn active':'toggle-btn';
    document.getElementById('ans-toggle').classList.remove('hidden');
    
    if(state.course==='square' && state.level==='solve' && state.subType>=4) {
        document.getElementById('rad-div-part').classList.remove('hidden');
    } else {
        document.getElementById('rad-div-part').classList.add('hidden');
    }
}

// --- Generators ---
function rnd(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }
function rndNz(min, max) { let n=0; while(n===0) n=rnd(min,max); return n; }
function fmt(n) { return n>=0 ? `+ ${n}` : `- ${Math.abs(n)}`; }
function fmt2(n) { return n>=0 ? `+${n}` : `${n}`; }
function getSimpRad(n) {
    if(n<=0) return {k:0, n:0};
    let k=1;
    for(let i=2; i*i<=n; i++) {
        while(n%(i*i)===0) { k*=i; n/=(i*i); }
    }
    return {k, n};
}

function genCross() {
    let a1=1, a2=1, c1, c2;
    if(state.level==='easy') { c1=rndNz(-9,9); c2=rndNz(-9,9); }
    else if(state.level==='medium') { let ps=[2,3,5]; a1=ps[rnd(0,2)]; c1=rndNz(-5,5); c2=rndNz(-5,5); }
    else { a1=rnd(2,5); a2=rnd(2,4); c1=rndNz(-4,4); c2=rndNz(-4,4); }
    
    let A=a1*a2, B=a1*c2+a2*c1, C=c1*c2;
    document.getElementById('q-text').innerText = `${A===1?'':A}xÂ² ${fmt(B)}x ${fmt(C)} = 0`;
    state.q = { type:'cross', step1:{B}, roots:[-c1/a1, -c2/a2] };
    
    document.getElementById('step1-title').innerText = "æ­¥é©Ÿä¸€ï¼šåå­—äº¤ä¹˜æ¹Šæ•¸";
    document.getElementById('game-area-s1').innerHTML = `
        <div class="cross-layout">
            <div class="cross-col" style="text-align:right">
                <div class="cross-row">${state.level==='easy'?'':'<input type="text" id="cr-a1" class="box-input" placeholder="a">'} <span style="font-size:2rem">x</span></div>
                <div class="cross-row">${state.level==='easy'?'':'<input type="text" id="cr-a2" class="box-input" placeholder="a">'} <span style="font-size:2rem">x</span></div>
            </div>
            <div class="big-x">â•³</div>
            <div class="cross-col">
                <div class="cross-row"><select id="cr-op1" class="box-select"><option value="1">+</option><option value="-1">-</option></select><input type="text" id="cr-c1" class="box-input" placeholder="c"></div>
                <div class="cross-row"><select id="cr-op2" class="box-select"><option value="1">+</option><option value="-1">-</option></select><input type="text" id="cr-c2" class="box-input" placeholder="c"></div>
            </div>
        </div>
        <div style="text-align:center; margin-top:10px;">é©—ç®—ï¼š( <input type="text" id="chk-1" style="width:60px"> x ) + ( <input type="text" id="chk-2" style="width:60px"> x ) = ?</div>
        <button class="menu-btn btn-check" onclick="checkCrossStep1()">æª¢æŸ¥æ¹Šæ•¸æ­¥é©Ÿ</button>
    `;
    document.getElementById('ans-toggle').classList.add('hidden');
}

function genFormula() {
    let type='diff', a=1, b=1, eq='';
    if(state.level==='easy') { type='diff'; a=(Math.random()<0.3?rnd(2,5):1); b=rnd(1,9); eq=`(${a===1?'':a}x)Â² - ${b*b} = 0`; }
    else if(state.level==='medium') { type=Math.random()<0.5?'sum':'sub'; b=rnd(1,9); eq=`xÂ² ${type==='sum'?'+':'-'} ${2*b}x + ${b*b} = 0`; }
    else { type='diff'; a=rnd(2,5); b=rnd(1,9); eq=`(${a}x)Â² - ${b*b} = 0`; }
    
    document.getElementById('q-text').innerText = eq;
    let r1, r2;
    if(type==='diff') { r1=b/a; r2=-b/a; } else { let v=(type==='sum'?-b:b)/a; r1=r2=v; }
    state.q = { type:'formula', ftype:type, roots:[r1,r2] };
    
    document.getElementById('step1-title').innerText = "æ­¥é©Ÿä¸€ï¼šé¸æ“‡å…¬å¼";
    document.getElementById('game-area-s1').innerHTML = `
        <div class="formula-options">
            <div class="formula-option" id="opt-diff" onclick="selForm('diff')">1. å¹³æ–¹å·® AÂ² - BÂ²</div>
            <div class="formula-option" id="opt-sum" onclick="selForm('sum')">2. å’Œçš„å¹³æ–¹ (A+B)Â²</div>
            <div class="formula-option" id="opt-sub" onclick="selForm('sub')">3. å·®çš„å¹³æ–¹ (A-B)Â²</div>
        </div>
        <button class="menu-btn btn-check" onclick="checkFormStep1()">ç¢ºèªå…¬å¼</button>
    `;
    document.getElementById('ans-toggle').classList.add('hidden');
}

function genSquare() {
    let lv = state.level, st = state.subType;
    let q = { type:'square', stage:lv };
    document.getElementById('step1-title').innerText = "æ­¥é©Ÿä¸€ï¼šå»å¹³æ–¹ / ç§»é …";

    if(lv === 'concept') {
        if(st===1) { // x^2 = k
            let k=rnd(2,9)**2; document.getElementById('q-text').innerText = `xÂ² = ${k}`;
            q.roots=[Math.sqrt(k), -Math.sqrt(k)]; q.form='rational';
            document.getElementById('step1-container').classList.add('disabled-step');
            document.getElementById('step3-container').classList.remove('disabled-step');
            document.getElementById('btn-submit').classList.remove('hidden');
            state.q = q; setAnsMode(q.form);
        } else if(st===2) {
            let a=rndNz(-9,9), k=rnd(2,9)**2; 
            document.getElementById('q-text').innerText = `(x${fmt2(a)})Â² = ${k}`;
            let r=Math.sqrt(k); q.roots=[r-a, -r-a]; q.form='rational';
            q.step1_check=r; q.lhs = `x${fmt(a)}`;
            state.q = q;
            renderSqStage1UI();
        } else {
            let a=rndNz(-9,9), k=[2,3,5,6,7][rnd(0,4)]; 
            document.getElementById('q-text').innerText = `(x${fmt2(a)})Â² = ${k}`;
            let simp = getSimpRad(k);
            q.rad = {a:-a, k:simp.k, n:simp.n, c:1}; q.form='radical';
            q.step1_check=k; q.lhs = `x${fmt(a)}`;
            state.q = q;
            renderSqStage1UI();
        }
    } 
    else if (lv === 'move') {
        if(st===1) { // (x+a)^2 = k
            let a=rndNz(-5,5), k=rnd(2,9)**2;
            document.getElementById('q-text').innerText = `(x${fmt2(a)})Â² - ${k} = 0`;
            let r=Math.sqrt(k); q.roots=[r-a, -r-a]; q.form='rational';
        } else { // (ax+b)^2 = total
            let a=rnd(2,3), c=rnd(1,10), d=rnd(1,5); let total = c+d;
            let b=rndNz(-5,5);
            document.getElementById('q-text').innerText = `(${a}x${fmt2(b)})Â² - ${c} = ${d}`;
            if(Number.isInteger(Math.sqrt(total))) {
                let r=Math.sqrt(total); q.roots=[(r-b)/a, (-r-b)/a]; q.form='rational';
            } else {
                let simp = getSimpRad(total);
                q.rad = {a:-b, k:simp.k, n:simp.n, c:a}; q.form='radical';
            }
        }
        // Direct solve for move stage (as requested)
        document.getElementById('step1-container').classList.add('disabled-step');
        document.getElementById('game-area-s1').innerHTML = '<p style="text-align:center; color:#999;">(æ­¤éšæ®µç›´æ¥æ±‚è§£)</p>';
        document.getElementById('step3-container').classList.remove('disabled-step');
        document.getElementById('btn-submit').classList.remove('hidden');
        state.q = q; setAnsMode(q.form);
    }
    else if (lv === 'complete') {
        let a=1, b=rnd(1,9)*2; if(st===2) b=rnd(1,9)*2+1; if(Math.random()<0.5) b=-b;
        document.getElementById('q-text').innerText = `xÂ² ${fmt(b)}x + â–¡ = (x + â–³)Â²`;
        let h = `â–¡ = <input type="text" id="sq3-1" class="box-input"> , â–³ = <input type="text" id="sq3-2" class="box-input">`;
        document.getElementById('game-area-s1').innerHTML = h;
        document.getElementById('step3-container').classList.add('hidden');
        document.getElementById('btn-submit').classList.remove('hidden');
        q.ans1 = (b/2)**2; q.ans2 = b/2;
        state.q = q;
    }
    else if (lv === 'solve') {
        let a=1, b=2, c=1;
        if(st===1) { b=2*rnd(1,5); c=rnd(-10, -1); document.getElementById('q-text').innerText = `xÂ² ${fmt(b)}x ${fmt(c)} = 0`;}
        if(st===2) { b=2*rnd(1,5); c=rnd(1,10); document.getElementById('q-text').innerText = `xÂ² = ${c} ${fmt(-b)}x`; c=-c; }
        if(st===3) { b=2*rnd(10,20); c=rnd(-200,-50); document.getElementById('q-text').innerText = `xÂ² ${fmt(b)}x ${fmt(c)} = 0`;}
        if(st===4) { a=rnd(2,5); b=a*2*rnd(1,3); c=rnd(-20,20); while(b*b-4*a*c<0) c++; document.getElementById('q-text').innerText = `${a}xÂ² ${fmt(b)}x ${fmt(c)} = 0`;}
        if(st===5) { a=-rnd(2,5); b=a*2*rnd(1,3); c=rnd(-20,20); while(b*b-4*a*c<0) c--; document.getElementById('q-text').innerText = `${a}xÂ² ${fmt(b)}x ${fmt(c)} = 0`;}

        let normB = b/a; let normC = c/a;
        let halfB = normB/2; let addVal = halfB*halfB; let rhs = -normC + addVal;
        
        let D = b*b - 4*a*c;
        let simp = getSimpRad(D);
        
        if(simp.n <= 1) { // Rational
            let rD = Math.sqrt(D);
            q.roots = [(-b+rD)/(2*a), (-b-rD)/(2*a)];
            q.form = 'rational';
        } else {
            let den = 2*a; let numA = -b; let numK = simp.k;
            if(den < 0) { den=-den; numA=-numA; } 
            q.rad = {a:numA, k:numK, n:simp.n, c:den};
            q.form = 'radical';
        }
        
        q.s1_add = addVal; q.s2_p = Math.abs(halfB); q.s2_op = halfB>0?1:-1; q.s2_q = rhs;
        
        document.getElementById('step1-title').innerText = "æ­¥é©Ÿä¸€ï¼šç§»é …ä¸¦é…æ–¹";
        document.getElementById('game-area-s1').innerHTML = `xÂ² ${fmt(normB)}x + <input type="text" id="sq4-add1" style="width:60px"> = ${-normC} + <input type="text" id="sq4-add2" style="width:60px"> <button class="menu-btn btn-check" onclick="checkSq4S1()">æª¢æŸ¥æ­¥é©Ÿ</button>`;
        
        document.getElementById('game-area-s2').innerHTML = `( x <select id="sq4-op" class="sign-select"><option value="1">+</option><option value="-1">-</option></select> <input type="text" id="sq4-p" style="width:60px"> )Â² = <input type="text" id="sq4-q" style="width:60px"> <button class="menu-btn btn-check" onclick="checkSq4S2()">æª¢æŸ¥æ­¥é©Ÿ</button>`;
        state.q = q; setAnsMode(q.form);
    }
}

// --- Render Helpers ---
function renderSqStage1UI() {
    let mode = state.step1InputMode || 'auto';
    // Auto-detect if not set manually
    if(mode === 'auto') {
        mode = state.q.form === 'radical' ? 'radical' : 'text';
    }

    let inputHTML = '';
    if(mode === 'radical') {
        let simp = getSimpRad(state.q.step1_check);
        // Ensure k is at least 1 for validation if missing
        state.q.step1_check_k = simp.k || 1;
        state.q.step1_check_n = simp.n;
        inputHTML = `Â± <input type="text" id="sq1-k" class="short-input" value="1"> âˆš <input type="text" id="sq1-n" class="short-input">`;
    } else {
        inputHTML = `Â± <input type="text" id="sq1-val" class="box-input">`;
    }

    let h = `
    <div style="text-align:center; font-size:1.5rem; margin-bottom:10px;">
        ${state.q.lhs} = ${inputHTML}
        <button class="btn-toggle" onclick="toggleStep1Mode()">åˆ‡æ›æ ¹è™Ÿè¼¸å…¥</button>
    </div>
    <button class="menu-btn btn-check" onclick="checkSqS1()">æª¢æŸ¥æ­¥é©Ÿ</button>
    `;
    document.getElementById('game-area-s1').innerHTML = h;
}

function toggleStep1Mode() {
    let current = state.step1InputMode || (state.q.form === 'radical' ? 'radical' : 'text');
    state.step1InputMode = (current === 'text') ? 'radical' : 'text';
    renderSqStage1UI();
}

// --- Check Logic ---
function checkCrossStep1() {
    let v1 = document.getElementById('chk-1').value;
    let v2 = document.getElementById('chk-2').value;
    if(!v1 || !v2) return alert("è«‹å¡«å¯«é©—ç®—");
    if( (parseInt(v1)+parseInt(v2)) === state.q.step1.B ) {
        document.getElementById('step3-container').classList.remove('disabled-step');
        document.getElementById('btn-submit').classList.remove('hidden');
        document.getElementById('step1-container').classList.add('disabled-step');
    } else alert("é©—ç®—éŒ¯èª¤");
}

function selForm(t) {
    state.selectedFormula = t;
    document.querySelectorAll('.formula-option').forEach(el => el.classList.remove('selected'));
    document.getElementById('opt-'+t).classList.add('selected');
}
function checkFormStep1() {
    if(!state.selectedFormula) return alert("è«‹é¸æ“‡å…¬å¼");
    if(state.selectedFormula === state.q.ftype) {
        document.getElementById('step3-container').classList.remove('disabled-step');
        document.getElementById('btn-submit').classList.remove('hidden');
        document.getElementById('step1-container').classList.add('disabled-step');
    } else alert("å…¬å¼é¸éŒ¯å›‰ï¼");
}

function checkSqS1() {
    let isCorrect = false;
    let mode = state.step1InputMode || (state.q.form === 'radical' ? 'radical' : 'text');
    
    if(mode === 'radical') {
        let uk = parseFloat(document.getElementById('sq1-k').value);
        let un = parseFloat(document.getElementById('sq1-n').value);
        let targetK = state.q.step1_check_k || 1; 
        if(uk == targetK && un == state.q.step1_check_n) isCorrect = true;
        // Accept unsimplified e.g. 1 sqrt 12 vs 2 sqrt 3? No, enforce simple.
    } else {
        let val = parseFloat(document.getElementById('sq1-val').value);
        // Allow numeric approx for rational, or strict for int
        if(Math.abs(val - state.q.step1_check) < 0.01) isCorrect = true;
    }

    if(isCorrect) {
        document.getElementById('step3-container').classList.remove('disabled-step');
        document.getElementById('btn-submit').classList.remove('hidden');
        document.getElementById('step1-container').classList.add('disabled-step');
    } else alert("æ•¸å€¼éŒ¯èª¤");
}

function checkSq4S1() {
    let v1 = eval(document.getElementById('sq4-add1').value);
    let v2 = eval(document.getElementById('sq4-add2').value);
    if(Math.abs(v1 - state.q.s1_add)<0.01 && Math.abs(v2 - state.q.s1_add)<0.01) {
        document.getElementById('step1-container').classList.add('disabled-step');
        document.getElementById('step2-container').classList.remove('hidden');
    } else alert("é…æ–¹æ•¸å­—éŒ¯èª¤");
}

function checkSq4S2() {
    let p = eval(document.getElementById('sq4-p').value);
    let op = parseInt(document.getElementById('sq4-op').value);
    let q = parseFloat(eval(document.getElementById('sq4-q').value));
    if(Math.abs(p - state.q.s2_p)<0.01 && op===state.q.s2_op && Math.abs(q - state.q.s2_q)<0.01) {
        document.getElementById('step2-container').classList.add('disabled-step');
        document.getElementById('step3-container').classList.remove('disabled-step');
        document.getElementById('btn-submit').classList.remove('hidden');
    } else alert("æ•´ç†éŒ¯èª¤");
}

function checkAnswer() {
    // Stage 3 Fill
    if(state.course==='square' && state.level==='complete') {
        let u1 = eval(document.getElementById('sq3-1').value);
        let u2 = eval(document.getElementById('sq3-2').value);
        if(Math.abs(u1-state.q.ans1)<0.001 && Math.abs(u2-state.q.ans2)<0.001) passQuestion();
        else showFeedback(false);
        return;
    }

    // Solve Check
    let isCorrect = false;
    if(state.ansMode === 'rational') {
        let x1 = eval(document.getElementById('sol-x1').value);
        let x2 = eval(document.getElementById('sol-x2').value);
        if(x1!==undefined && x2!==undefined) {
            let r1 = state.q.roots[0], r2 = state.q.roots[1];
            if( (Math.abs(x1-r1)<0.01 && Math.abs(x2-r2)<0.01) || (Math.abs(x1-r2)<0.01 && Math.abs(x2-r1)<0.01) ) isCorrect=true;
        }
    } else {
        let ua = parseFloat(document.getElementById('rad-a').value);
        let uk = parseFloat(document.getElementById('rad-k').value);
        let ub = parseFloat(document.getElementById('rad-b').value);
        let uc = parseFloat(document.getElementById('rad-c').value);
        if(Math.abs(ua-state.q.rad.a)<0.1 && uk==state.q.rad.k && ub==state.q.rad.n && uc==state.q.rad.c) isCorrect=true;
    }

    showFeedback(isCorrect);
    if(isCorrect) passQuestion();
}

function passQuestion() {
    document.getElementById('btn-submit').classList.add('hidden');
    document.getElementById('btn-next').classList.remove('hidden');
    
    if(state.course==='square') {
        if(state.level === 'complete') {
            state.score++; 
             if(state.score >= 5) alert("æ­å–œé€šé—œï¼");
        } else {
            state.subStreak++; 
            if(state.subStreak >= 3) {
                state.subType++; state.subStreak = 0;
                let maxT = (state.level==='concept'||state.level==='move')?3:5;
                if(state.subType > maxTypes) alert("æ­å–œï¼æœ¬éšæ®µé€šé—œï¼");
                else alert("æ™‰ç´šä¸‹ä¸€ç¨®é¡Œå‹ï¼");
            }
        }
    } else state.score++;
}

// Utils
function showFeedback(ok, text) {
    let el = document.getElementById('feedback-msg');
    el.style.display = 'block';
    el.className = ok ? 'feedback correct' : 'feedback wrong';
    el.innerText = text ? text : (ok ? "ğŸ‰ ç­”å°äº†ï¼" : "âŒ ç­”æ¡ˆæœ‰èª¤");
}
function setAnsMode(m) {
    state.ansMode = m;
    document.getElementById('input-rational').classList.toggle('hidden', m!=='rational');
    document.getElementById('input-radical').classList.toggle('hidden', m!=='radical');
    document.getElementById('btn-rat').className = m==='rational'?'toggle-btn active':'toggle-btn';
    document.getElementById('btn-rad').className = m==='radical'?'toggle-btn active':'toggle-btn';
    document.getElementById('ans-toggle').classList.remove('hidden');
    
    if(state.course==='square' && state.level==='solve' && state.subType>=4) {
        document.getElementById('rad-div-part').classList.remove('hidden');
    } else {
        document.getElementById('rad-div-part').classList.add('hidden');
    }
}
function showCertModal() { document.getElementById('cert-modal').style.display='flex'; }
function closeCert() { document.getElementById('cert-modal').style.display='none'; showMenu(); }
</script>
</body>
</html>