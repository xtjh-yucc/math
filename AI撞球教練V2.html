<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÊíûÁêÉÊïôÁ∑¥ - Êô∫ËÉΩÂãï‰ΩúÂàÜÊûê</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- html2pdf.js for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Google Fonts: Noto Sans TC & Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Roboto', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        // Billiards Theme Colors (Green/Felt/Chalk)
                        primary: '#4ADE80', // Bright Green
                        onPrimary: '#022C22',
                        primaryContainer: '#064E3B',
                        onPrimaryContainer: '#D1FAE5',
                        
                        secondary: '#2DD4BF', // Teal/Cyan (Chalk color)
                        onSecondary: '#003833',
                        secondaryContainer: '#004F49',
                        onSecondaryContainer: '#99F6E4',
                        
                        tertiary: '#FACC15', // Yellow (9-ball stripe color)
                        onTertiary: '#422006',
                        tertiaryContainer: '#713F12',
                        onTertiaryContainer: '#FEF9C3',
                        
                        // Background: Deep Pool Table Green
                        background: '#062C26', 
                        onBackground: '#ECFDF5',
                        
                        surface: '#022C22',
                        onSurface: '#ECFDF5',
                        'surface-variant': '#064E3B',
                        'on-surface-variant': '#A7F3D0',
                        
                        outline: '#34D399',
                        
                        error: '#F87171',
                        onError: '#450A0A',
                    },
                    boxShadow: {
                        'elevation-1': '0px 1px 3px 1px rgba(0, 0, 0, 0.3), 0px 1px 2px 0px rgba(0, 0, 0, 0.5)',
                        'elevation-2': '0px 2px 6px 2px rgba(0, 0, 0, 0.3), 0px 1px 2px 0px rgba(0, 0, 0, 0.5)',
                        'elevation-3': '0px 4px 8px 3px rgba(0, 0, 0, 0.3), 0px 1px 3px 0px rgba(0, 0, 0, 0.5)',
                    },
                    backgroundImage: {
                        'felt-pattern': "radial-gradient(circle at 50% 50%, #064e3b 0%, #062c26 100%)",
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #062C26;
            background-image: radial-gradient(circle at 50% 50%, #0f463a 0%, #022c22 100%);
            background-attachment: fixed;
            color: #ECFDF5;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #022C22; 
        }
        ::-webkit-scrollbar-thumb {
            background: #064E3B; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #34D399; 
        }

        /* ---- Web UI Markdown Styles (Green Theme) ---- */
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            color: #D1FAE5;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 700;
        }
        .markdown-body h2 { border-bottom: 1px solid #064E3B; padding-bottom: 0.3em; }
        .markdown-body p { margin-bottom: 1em; line-height: 1.7; color: #ECFDF5; }
        .markdown-body ul, .markdown-body ol { margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.5em; }
        .markdown-body strong { color: #4ADE80; font-weight: 700; }
        .markdown-body blockquote {
            border-left: 4px solid #4ADE80;
            padding-left: 1em;
            color: #A7F3D0;
            font-style: italic;
            margin: 1em 0;
            background: rgba(6, 78, 59, 0.3);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
        }
        .markdown-body code {
            background-color: #022C22;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            color: #FACC15;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            background-color: #064E3B;
            border-radius: 8px;
            overflow: hidden;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #34D399;
            padding: 12px;
            text-align: left;
        }
        .markdown-body th {
            background-color: #022C22;
            color: #4ADE80;
        }
        /* Style for links in markdown to make them stand out */
        .markdown-body a {
            color: #2DD4BF;
            text-decoration: none;
            border-bottom: 1px dashed #2DD4BF;
            transition: all 0.2s;
        }
        .markdown-body a:hover {
            color: #D1FAE5;
            border-bottom-style: solid;
        }

        /* ---- PDF Export Override Styles (White Background, Red Theme) ---- */
        /* These styles only apply when the .pdf-export class is added during generation */
        .pdf-export {
            background-color: #ffffff !important;
            background-image: none !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: none !important;
            color: #000000 !important;
            font-family: 'Noto Sans TC', sans-serif !important;
            padding: 20px !important;
            border-radius: 0 !important;
        }

        /* Override Header in PDF */
        .pdf-export h2 {
            color: #991b1b !important; /* Red-800 */
            border-bottom-color: #fca5a5 !important; /* Red-300 */
        }
        .pdf-export p {
            color: #374151 !important; /* Gray-700 */
        }

        /* Override Markdown Content in PDF - Green to Red */
        .pdf-export .markdown-body h1,
        .pdf-export .markdown-body h2,
        .pdf-export .markdown-body h3,
        .pdf-export .markdown-body h4 {
            color: #991b1b !important; /* Red-800 */
            border-bottom-color: #fca5a5 !important;
        }

        .pdf-export .markdown-body strong {
            color: #dc2626 !important; /* Red-600 */
        }

        .pdf-export .markdown-body blockquote {
            border-left-color: #dc2626 !important;
            background-color: #fff1f2 !important; /* Very light red */
            color: #4b5563 !important; /* Gray-600 */
        }

        .pdf-export .markdown-body code {
            background-color: #f3f4f6 !important;
            color: #b91c1c !important;
            border: 1px solid #e5e7eb !important;
        }

        .pdf-export .markdown-body table {
            background-color: transparent !important;
            border-radius: 0 !important;
        }

        .pdf-export .markdown-body th {
            background-color: #fee2e2 !important; /* Red-50 */
            color: #991b1b !important; /* Red-800 */
            border-color: #fecaca !important; /* Red-200 */
        }

        .pdf-export .markdown-body td {
            border-color: #e5e7eb !important;
            color: #1f2937 !important;
        }

        .pdf-export .markdown-body ul, 
        .pdf-export .markdown-body ol {
            color: #1f2937 !important;
        }

        .pdf-export .markdown-body li {
            color: #1f2937 !important;
        }
        
        /* Links in PDF */
        .pdf-export .markdown-body a {
            color: #dc2626 !important;
            border-bottom-color: #dc2626 !important;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Loading Spinner - Billiards Style */
        .loader {
            border: 4px solid rgba(74, 222, 128, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: #4ADE80;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Inline Icon Components ---
        const Icon = ({ children, className, size = 24, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
                {...props}
            >
                {children}
            </svg>
        );

        // 8-Ball Icon: Black Background, White Circle, Black Number 8
        const EightBallIcon = ({ size = 24, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                className={className}
                {...props}
            >
                {/* Black Circle Background */}
                <circle cx="12" cy="12" r="10" fill="black" stroke="none" />
                
                {/* White Inner Circle */}
                <circle cx="12" cy="12" r="5" fill="white" stroke="none" />
                
                {/* Black Number 8 using text for best look */}
                <text 
                    x="12" 
                    y="14" 
                    fontSize="6" 
                    fontWeight="bold" 
                    textAnchor="middle" 
                    fill="black" 
                    fontFamily="Arial, sans-serif"
                    stroke="none"
                >8</text>
            </svg>
        );

        const Activity = (props) => (
            <Icon {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2" /></Icon>
        );
        const CheckCircle2 = (props) => (
            <Icon {...props}>
                <circle cx="12" cy="12" r="10" />
                <path d="m9 12 2 2 4-4" />
            </Icon>
        );
        const Trophy = (props) => (
            <Icon {...props}>
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                <path d="M4 22h16" />
                <path d="M10 14.66V17" />
                <path d="M14 14.66V17" />
                <path d="M17 22v-4.13a2 2 0 0 0-1-1.73l-7-4.14a2 2 0 0 0-2 0l-7 4.14a2 2 0 0 0-1 1.73V22" />
                <path d="M12 2a8 8 0 0 1 8 8v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V10a8 8 0 0 1 8-8z" />
            </Icon>
        );
        const Circle = (props) => (
            <Icon {...props}><circle cx="12" cy="12" r="10" /></Icon>
        );
        const ChevronRight = (props) => (
            <Icon {...props}><path d="m9 18 6-6-6-6" /></Icon>
        );
        const FileVideo = (props) => (
            <Icon {...props}>
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                <polyline points="14 2 14 8 20 8" />
                <path d="m10 11 5 3-5 3v-6z" />
            </Icon>
        );
        const AlertCircle = (props) => (
            <Icon {...props}>
                <circle cx="12" cy="12" r="10" />
                <line x1="12" x2="12" y1="8" y2="12" />
                <line x1="12" x2="12.01" y1="16" y2="16" />
            </Icon>
        );
        const Globe = (props) => (
            <Icon {...props}>
                <circle cx="12" cy="12" r="10" />
                <line x1="2" x2="22" y1="12" y2="12" />
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
            </Icon>
        );
        const Zap = (props) => (
            <Icon {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></Icon>
        );
        const Download = (props) => (
            <Icon {...props}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" x2="12" y1="15" y2="3" />
            </Icon>
        );

        // --- Model Priority List ---
        const MODEL_PRIORITY_LIST = [
            'gemini-2.5-flash-preview-09-2025',
            'gemini-2.0-flash-exp',
            'gemini-1.5-pro-002',
            'gemini-1.5-pro',
            'gemini-1.5-flash-002',
            'gemini-1.5-flash',
            'gemini-1.5-flash-001'
        ];

        // --- Translations ---
        const translations = {
            'zh-TW': {
                appTitle: "AIÊíûÁêÉÊïôÁ∑¥",
                appSubtitle: "Êô∫ËÉΩÂãï‰ΩúÂàÜÊûê",
                heroTitle: "Á≤æÊ∫ñÊéåÊéßÊØè‰∏ÄÊ°ø",
                heroSubtitle: "‰∏äÂÇ≥ÊÇ®ÁöÑÊìäÁêÉÂΩ±ÁâáÔºåAI Â∞áÈáùÂ∞çÁ´ôÂßø„ÄÅÈÅãÊ°ø„ÄÅÊû∂Ê°øËàáÂª∂‰º∏ÈÄ≤Ë°åÂ∞àÊ•≠ÂàÜÊûê„ÄÇ",
                selectSport: "ÈñãÂßãÂàÜÊûê",
                uploadAreaTitle: "‰∏äÂÇ≥ÊàñÈåÑË£ΩÊíûÁêÉÂΩ±Áâá",
                uploadAreaSubtitle: "ÊîØÊè¥ MP4, MOV, AVI Ê†ºÂºè (ÊúÄÂ§ß 20MB)",
                analyzing: "AI Ê≠£Âú®ÂàÜÊûêÊÇ®ÁöÑÊìäÁêÉÂãï‰Ωú...",
                analyzingSubtitle: "Ê≠£Âú®Ë≠òÂà•Êû∂Ê°ø„ÄÅÈÅãÊ°øËªåË∑°ËàáË∫´È´îÁ©©ÂÆöÊÄß...",
                negotiating: "Ê≠£Âú®Ê∏¨Ë©¶ÊúÄ‰Ω≥ AI Ê®°Âûã...",
                resultTitle: "ÊíûÁêÉÂãï‰ΩúÂàÜÊûêÂ†±Âëä",
                score: "ÊäÄË°ìË©ïÂàÜ",
                keyStrengths: "‰∏ªË¶ÅÂÑ™Âã¢",
                areasForImprovement: "ÊîπÈÄ≤Âª∫Ë≠∞",
                detailedAnalysis: "Ë©≥Á¥∞ÊäÄË°ìÂàÜÊûê",
                actionFrame: "ÈóúÈçµÂΩ±Ê†º",
                reanalyze: "ÂàÜÊûê‰∏ã‰∏ÄÊ°ø",
                downloadPdf: "‰∏ãËºâÊàêPDF",
                footer: "¬© 2025 AI Billiards Coach. Powered by ",
                contact: "Contact:",
                apiKeyPlaceholder: "Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ Google Gemini API Key",
                apiKeyHelp: "ÈúÄË¶Å API Key ÊâçËÉΩ‰ΩøÁî® AI ÂäüËÉΩ„ÄÇ",
                startAnalysis: "ÈñãÂßãÂàÜÊûê",
                demoMode: "Ë©¶Áî®Ê®°Âºè (ÁÑ° API Key)",
                sports: {
                    billiards: "ÊíûÁêÉ"
                }
            },
            'en': {
                appTitle: "AI Billiards Coach",
                appSubtitle: "Smart Motion Analysis",
                heroTitle: "Master Every Shot",
                heroSubtitle: "Upload your video for professional AI analysis of your stance, bridge, stroke, and follow-through.",
                selectSport: "Start Analysis",
                uploadAreaTitle: "Upload or Record Video",
                uploadAreaSubtitle: "Supports MP4, MOV, AVI (Max 20MB)",
                analyzing: "AI is analyzing your shot...",
                analyzingSubtitle: "Identifying bridge stability, cue stroke, and body alignment...",
                negotiating: "Negotiating best AI model...",
                resultTitle: "Analysis Report",
                score: "Technique Score",
                keyStrengths: "Key Strengths",
                areasForImprovement: "Areas for Improvement",
                detailedAnalysis: "Detailed Analysis",
                actionFrame: "Key Frames",
                reanalyze: "Analyze Another Shot",
                downloadPdf: "Download PDF",
                footer: "¬© 2025 AI Billiards Coach. Powered by ",
                contact: "Contact:",
                apiKeyPlaceholder: "Enter your Google Gemini API Key",
                apiKeyHelp: "API Key required for AI functionality.",
                startAnalysis: "Start Analysis",
                demoMode: "Demo Mode (No API Key)",
                sports: {
                    billiards: "Billiards"
                }
            }
        };

        // --- Sport Definitions (Only Billiards) ---
        const sportsData = [
            { id: 'billiards', icon: 'EightBallIcon', color: 'text-tertiary', bg: 'bg-surface-variant' },
        ];

        // --- Icons Mapping ---
        const IconComponent = ({ name, className, size }) => {
            if (name === 'EightBallIcon') return <EightBallIcon className={className} size={size} />;
            const icons = {
                Zap: <Zap className={className} size={size} />,
                Activity: <Activity className={className} size={size} />,
                CheckCircle2: <CheckCircle2 className={className} size={size} />,
                Trophy: <Trophy className={className} size={size} />,
                Circle: <Circle className={className} size={size} />,
            };
            return icons[name] || <Activity className={className} size={size} />;
        };

        const App = () => {
            const [lang, setLang] = useState('zh-TW');
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [selectedSport, setSelectedSport] = useState(null); 
            const [videoFile, setVideoFile] = useState(null);
            const [videoUrl, setVideoUrl] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [statusMessage, setStatusMessage] = useState('');
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const [activeModel, setActiveModel] = useState(localStorage.getItem('gemini_active_model') || null);
            
            const t = translations[lang];

            useEffect(() => {
                if (apiKey) {
                    localStorage.setItem('gemini_api_key', apiKey);
                }
            }, [apiKey]);

            // Open links in new tab logic
            useEffect(() => {
                if (result) {
                    const links = document.querySelectorAll('.markdown-body a');
                    links.forEach(link => {
                        link.setAttribute('target', '_blank');
                        link.setAttribute('rel', 'noopener noreferrer');
                    });
                }
            }, [result]);

            const toggleLanguage = () => {
                setLang(prev => prev === 'zh-TW' ? 'en' : 'zh-TW');
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 20 * 1024 * 1024) {
                        alert(lang === 'zh-TW' ? "Ê™îÊ°àÂ§™Â§ßÔºåË´ã‰∏äÂÇ≥Â∞èÊñº 20MB ÁöÑÂΩ±Áâá" : "File too large. Please upload < 20MB.");
                        return;
                    }
                    setVideoFile(file);
                    setVideoUrl(URL.createObjectURL(file));
                    setResult(null);
                    setError(null);
                }
            };

            const tryModel = async (modelName, systemPrompt, base64Video) => {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: systemPrompt },
                                { inline_data: { mime_type: videoFile.type || "video/mp4", data: base64Video } }
                            ]
                        }]
                    })
                });
                
                if (!response.ok) {
                    let errMessage = `Model ${modelName} failed: ${response.status} ${response.statusText}`;
                    try {
                        const errJson = await response.json();
                        if (errJson.error && errJson.error.message) {
                            errMessage += ` - ${errJson.error.message}`;
                        }
                    } catch (e) {
                        try {
                            const errText = await response.text();
                            errMessage += ` - ${errText}`;
                        } catch (textErr) {}
                    }
                    throw new Error(errMessage);
                }
                
                return await response.json();
            };

            const analyzeVideo = async () => {
                if (!videoFile) return;
                if (!apiKey) {
                    setError(lang === 'zh-TW' ? "Ë´ãÂÖàËº∏ÂÖ• API Key" : "Please enter API Key first.");
                    return;
                }

                setIsAnalyzing(true);
                setError(null);
                setStatusMessage(t.analyzingSubtitle);

                try {
                    const base64Video = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const result = reader.result;
                            const base64Part = result.split(',')[1];
                            resolve(base64Part);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(videoFile);
                    });

                    // Force billiards criteria
                    const sportName = "Billiards/Pool/Snooker";
                    const specificCriteria = `
                        Focus strictly on:
                        1. **Stance (Á´ôÂßø)**: Stability, balance, foot placement, and alignment with the shot line.
                        2. **Bridge (Êû∂Ê°ø)**: Hand stability, finger placement, bridge type (open/closed), and distance from cue ball.
                        3. **Stroke (ÈÅãÊ°ø)**: Smoothness, straightness (backswing and delivery), pause, acceleration, and follow-through (Âª∂‰º∏).
                        4. **Head/Eye (È†≠ÈÉ®ËàáË¶ñÁ∑ö)**: Stillness of head during the shot, chin position over cue, and eye focus.
                        Analyze the shot mechanics specifically for Billiards/Pool.
                        `;
                    
                    const systemPrompt = `
                        You are an Olympic-level AI Motion Coach specializing in ${sportName}.
                        Analyze the uploaded video of a user performing ${sportName} actions.
                        ${specificCriteria}
                        
                        Provide the output in Markdown format with the following structure:
                        
                        # ${sportName} Analysis Report
                        
                        ## üèÜ Overall Score: [0-100] / 100
                        (Give a strict professional score based on biomechanics and efficiency)

                        ## ‚úÖ Key Strengths
                        * [Strength 1]
                        * [Strength 2]
                        
                        ## ‚ö†Ô∏è Areas for Improvement (Prioritized)
                        For each issue, append a YouTube search link for demonstration videos.
                        1.  **[Issue 1]**: [Detailed observation]
                            * **Correction**: [Actionable advice]
                            * **üé• Demo/Drill**: [Click to Watch on YouTube](https://www.youtube.com/results?search_query=billiards+[relevant_keywords_for_issue])
                        2.  **[Issue 2]**: [Detailed observation]
                            * **Correction**: [Actionable advice]
                            * **üé• Demo/Drill**: [Click to Watch on YouTube](https://www.youtube.com/results?search_query=billiards+[relevant_keywords_for_issue])
                        3.  **[Issue 3]**: [Detailed observation]
                            * **Correction**: [Actionable advice]
                            * **üé• Demo/Drill**: [Click to Watch on YouTube](https://www.youtube.com/results?search_query=billiards+[relevant_keywords_for_issue])

                        ## üî¨ Detailed Technical Analysis
                        * **Phase 1 (Preparation/Stance)**: [Analysis]
                        * **Phase 2 (Execution/Impact)**: [Analysis]
                        * **Phase 3 (Follow-through/Recovery)**: [Analysis]
                        
                        ## üí° Pro Tip
                        [One specific, high-impact tip to instantly improve performance]
                        
                        Language: ${lang === 'zh-TW' ? 'Traditional Chinese (zh-TW)' : 'English'}
                    `;

                    let modelsToTry = [...MODEL_PRIORITY_LIST];
                    if (activeModel) {
                        modelsToTry = modelsToTry.filter(m => m !== activeModel);
                        modelsToTry.unshift(activeModel);
                    }

                    let finalData = null;
                    let successModel = null;
                    let modelErrors = [];

                    for (const model of modelsToTry) {
                        try {
                            setStatusMessage(`${t.negotiating} (${model})`);
                            console.log(`Attempting to use model: ${model}`);
                            
                            finalData = await tryModel(model, systemPrompt, base64Video);
                            
                            successModel = model;
                            console.log(`Success with model: ${model}`);
                            break; 
                        } catch (err) {
                            console.warn(`Failed with model ${model}:`, err);
                            modelErrors.push({ model, error: err });
                        }
                    }

                    if (!finalData || !successModel) {
                        let selectedError = modelErrors[modelErrors.length - 1].error; 
                        
                        const clientError = modelErrors.find(e => {
                            const msg = e.error.message || "";
                            return msg.includes("400") || msg.includes("403") || (msg.includes("404") && !msg.includes("not found for API version"));
                        });
                        
                        if (clientError) {
                            selectedError = clientError.error;
                        } else {
                            const stableError = modelErrors.find(e => e.model === 'gemini-1.5-flash' || e.model === 'gemini-1.5-flash-001');
                            if (stableError) selectedError = stableError.error;
                        }
                        
                        throw selectedError;
                    }

                    setActiveModel(successModel);
                    localStorage.setItem('gemini_active_model', successModel);

                    const text = finalData.candidates[0].content.parts[0].text;
                    setResult(text);

                } catch (err) {
                    console.error("Analysis failed:", err);
                    let errorMessage = err.message || "Analysis failed. Please check your API Key and internet connection.";
                    
                    if (errorMessage.includes("API key not valid") || errorMessage.includes("leaked") || errorMessage.includes("403")) {
                        errorMessage = "API Error: ÁÑ°ÊïàÊàñÂ∑≤Ê¥©ÊºèÁöÑ API Key (Invalid/Leaked API Key)„ÄÇÂ∑≤ÈáçÁΩÆÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•Ê≠£Á¢∫ÁöÑ Key„ÄÇ";
                        setApiKey('');
                        localStorage.removeItem('gemini_api_key');
                        setActiveModel(null);
                        localStorage.removeItem('gemini_active_model');
                    } else if (errorMessage.includes("429") || errorMessage.includes("quota")) {
                        errorMessage = "API Quota Exceeded (429). The system tried multiple AI models but all are currently busy or limited by your API key tier. Please try again in a minute.";
                    } else if (errorMessage.includes("404")) {
                         errorMessage = "API Error (404): Models not found. This typically happens if your API Key doesn't have access to the Generative Language API, or the region is restricted.";
                    } else if (errorMessage.includes("400") && !errorMessage.includes("API key not valid")) {
                        errorMessage = "API Error: Bad Request. The video format might not be supported or is too large.";
                    }
                    
                    setError(errorMessage);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const downloadPDF = () => {
                const element = document.getElementById('analysis-result-content');
                if (!element) return;

                // Create a clone to modify for PDF without affecting the UI
                const clone = element.cloneNode(true);
                
                // Add the special export class which forces white background and red text
                clone.classList.add('pdf-export');
                
                // Remove visual effect classes that don't print well
                clone.classList.remove('bg-black/40', 'backdrop-blur-md', 'shadow-2xl', 'border', 'border-primary/20');
                
                // Ensure the clone is visible for html2canvas but hidden from user
                // We wrap it in a container positioned off-screen
                const container = document.createElement('div');
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                container.style.top = '0';
                container.style.width = '800px'; // Set a fixed width for consistent PDF layout
                container.appendChild(clone);
                document.body.appendChild(container);

                const opt = {
                    margin: 10,
                    filename: 'billiards-analysis.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' }, // Force white background
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(clone).save().then(() => {
                    // Cleanup
                    document.body.removeChild(container);
                });
            };

            const renderContent = () => {
                if (selectedSport === null) {
                    // Hero Screen for Billiards
                    return (
                        <div className="space-y-8 animate-fade-in py-10">
                            <div className="text-center space-y-6">
                                <div className="inline-block p-4 rounded-full bg-primary/20 mb-4 animate-pulse">
                                    <EightBallIcon size={64} className="text-primary" />
                                </div>
                                <h2 className="text-4xl md:text-6xl font-bold text-white tracking-tight drop-shadow-lg">
                                    {t.heroTitle}
                                </h2>
                                <p className="text-lg md:text-xl text-primaryContainer bg-primary/90 inline-block px-4 py-1 rounded-full font-medium">
                                    {t.heroSubtitle}
                                </p>
                            </div>
                            
                            <div className="flex justify-center mt-10">
                                <button
                                    onClick={() => setSelectedSport('billiards')}
                                    className="group relative overflow-hidden px-12 py-6 rounded-full bg-gradient-to-r from-primary to-secondary hover:from-primary/80 hover:to-secondary/80 transition-all duration-300 shadow-elevation-3 hover:scale-105 flex items-center gap-4"
                                >
                                    <span className="font-bold text-2xl text-onPrimary tracking-wide">{t.selectSport}</span>
                                    <ChevronRight size={32} className="text-onPrimary group-hover:translate-x-1 transition-transform" />
                                </button>
                            </div>
                        </div>
                    );
                }

                if (isAnalyzing) {
                    return (
                        <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-8 animate-fade-in">
                            <div className="relative">
                                <div className="loader"></div>
                                <div className="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                                    <EightBallIcon size={20} className="text-primary animate-pulse" />
                                </div>
                            </div>
                            <div className="text-center space-y-2">
                                <h3 className="text-2xl font-bold text-white drop-shadow-md">{t.analyzing}</h3>
                                <p className="text-gray-300">{statusMessage}</p>
                            </div>
                        </div>
                    );
                }

                if (result) {
                    return (
                        <div className="max-w-4xl mx-auto space-y-8 animate-fade-in">
                            {/* Added 'no-print' class to hide buttons in PDF */}
                            <div className="flex justify-between items-center mb-4 no-print">
                                <button 
                                    onClick={() => setResult(null)}
                                    className="flex items-center gap-2 text-primary hover:text-white transition-colors font-bold bg-black/30 px-4 py-2 rounded-full w-fit"
                                >
                                    <ChevronRight className="rotate-180" size={20} />
                                    {t.reanalyze}
                                </button>
                                
                                <button 
                                    onClick={downloadPDF}
                                    className="flex items-center gap-2 text-white bg-primary hover:bg-primary/80 transition-colors font-bold px-4 py-2 rounded-full shadow-lg"
                                >
                                    <Download size={20} />
                                    {t.downloadPdf}
                                </button>
                            </div>

                            <div id="analysis-result-content" className="bg-black/40 backdrop-blur-md rounded-3xl p-6 md:p-10 border border-primary/20 shadow-2xl">
                                {/* Added IDs for targeted PDF styling */}
                                <div id="pdf-header-container" className="mb-6 text-center border-b border-primary/30 pb-6">
                                    <h2 id="pdf-header-title" className="text-3xl font-bold text-white">{t.resultTitle}</h2>
                                    <p id="pdf-header-subtitle" className="text-gray-400 text-sm mt-2">Generated by AI Billiards Coach</p>
                                </div>
                                <div className="prose prose-invert max-w-none markdown-body" dangerouslySetInnerHTML={{ __html: marked.parse(result) }} />
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="max-w-2xl mx-auto space-y-8 animate-fade-in">
                        <button 
                            onClick={() => setSelectedSport(null)}
                            className="flex items-center gap-2 text-gray-300 hover:text-white transition-colors"
                        >
                            <ChevronRight className="rotate-180" size={20} />
                            Back to Home
                        </button>

                        <div className="bg-black/30 backdrop-blur-sm border-2 border-dashed border-primary/30 rounded-3xl p-10 text-center hover:border-primary/60 transition-all duration-300 relative group cursor-pointer">
                            <input 
                                type="file" 
                                accept="video/*" 
                                onChange={handleFileChange}
                                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                            />
                            <div className="flex flex-col items-center gap-6">
                                <div className="w-20 h-20 rounded-full bg-primary/20 flex items-center justify-center text-primary group-hover:scale-110 transition-transform duration-300 border border-primary/30">
                                    <FileVideo size={40} />
                                </div>
                                <div>
                                    <h3 className="text-2xl font-bold mb-2 text-white">{t.uploadAreaTitle}</h3>
                                    <p className="text-sm text-gray-300">{t.uploadAreaSubtitle}</p>
                                </div>
                            </div>
                        </div>

                        {videoUrl && (
                            <div className="rounded-2xl overflow-hidden border-2 border-primary/20 bg-black shadow-2xl">
                                <video src={videoUrl} controls className="w-full max-h-[60vh]" />
                            </div>
                        )}

                        {error && (
                            <div className="bg-error/20 border border-error/50 p-4 rounded-xl flex items-start gap-3 text-red-200 animate-fade-in backdrop-blur-md">
                                <AlertCircle size={20} className="mt-0.5 shrink-0 text-error" />
                                <div className="text-sm font-medium">
                                    {error}
                                </div>
                            </div>
                        )}

                        <div className="space-y-4">
                            {!apiKey && (
                                <div className="bg-black/40 border border-primary/20 p-6 rounded-2xl flex flex-col gap-3 backdrop-blur-md">
                                    <div className="flex items-center gap-2 text-primary font-bold">
                                        <AlertCircle size={20} />
                                        <span>{t.apiKeyHelp}</span>
                                    </div>
                                    <input 
                                        type="password" 
                                        placeholder={t.apiKeyPlaceholder}
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value.trim())}
                                        className="w-full bg-black/50 border border-primary/30 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-primary focus:outline-none placeholder-gray-500 transition-all"
                                    />
                                </div>
                            )}

                            <button
                                onClick={analyzeVideo}
                                disabled={!videoFile || !apiKey}
                                className={`w-full py-4 rounded-xl font-bold text-xl flex items-center justify-center gap-3 transition-all duration-300
                                    ${(!videoFile || !apiKey) 
                                        ? 'bg-gray-700/50 text-gray-400 cursor-not-allowed' 
                                        : 'bg-primary text-onPrimary hover:bg-primary/90 hover:scale-[1.02] shadow-lg shadow-primary/20'
                                    }`}
                            >
                                <EightBallIcon size={24} />
                                {t.startAnalysis}
                            </button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen font-sans selection:bg-primary selection:text-onPrimary">
                    <header className="fixed top-0 left-0 right-0 z-50 bg-black/20 backdrop-blur-md border-b border-white/5 px-6 py-4">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primaryContainer flex items-center justify-center text-onPrimary shadow-lg ring-2 ring-primary/30">
                                    <EightBallIcon size={28} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold tracking-tight text-white">{t.appTitle}</h1>
                                    <p className="text-xs text-primary font-medium hidden sm:block">{t.appSubtitle}</p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <button onClick={toggleLanguage} className="flex items-center gap-2 hover:bg-white/10 px-4 py-2 rounded-full text-sm font-medium text-gray-300 hover:text-white transition-colors border border-white/5">
                                    <Globe size={18} />
                                    <span className={lang === 'zh-TW' ? 'text-primary font-bold' : ''}>ÁπÅ</span>
                                    <span className="opacity-30">|</span>
                                    <span className={lang === 'en' ? 'text-primary font-bold' : ''}>EN</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="pt-28 pb-12 px-6 max-w-7xl mx-auto min-h-screen flex flex-col">
                        {renderContent()}
                    </main>

                    <footer className="py-8 text-center text-gray-400 text-sm border-t border-white/5 bg-black/20 backdrop-blur-sm">
                        <p>
                            {t.footer} {activeModel ? <span className="text-primary font-bold">{activeModel}</span> : "Gemini AI"}
                        </p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>