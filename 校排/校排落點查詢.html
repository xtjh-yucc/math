<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校排落點查詢系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f8f9fa; padding-top: 40px; font-family: "Microsoft JhengHei", sans-serif; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; border-radius: 12px; }
        .result-box { background-color: #e9ecef; padding: 25px; border-radius: 10px; display: none; margin-top: 20px;}
        .highlight { color: #d63384; font-weight: bold; font-size: 2.5rem; margin: 10px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .footer-note { font-size: 0.9em; color: #6c757d; margin-top: 15px; }
        
        /* 檔案上傳區塊樣式 (預設隱藏，讀取失敗時顯示) */
        #fileUploadSection { display: none; border: 2px dashed #ced4da; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fff; }
        .status-badge { font-size: 0.9rem; padding: 5px 10px; border-radius: 20px; display: inline-block; margin-bottom: 15px; }
        .status-ready { background-color: #d1e7dd; color: #0f5132; }
        .status-error { background-color: #f8d7da; color: #842029; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                
                <div class="card">
                    <div class="card-body p-4">
                        <h3 class="text-center mb-4 fw-bold text-primary">校排落點查詢</h3>

                        <div class="text-center">
                            <span id="systemStatus" class="status-badge status-ready">系統準備中...</span>
                        </div>

                        <div id="fileUploadSection" class="text-center">
                            <p class="text-danger mb-2"><small>⚠️ 無法自動讀取檔案(瀏覽器安全限制)</small></p>
                            <label class="form-label">請手動選擇 <strong>data.xlsx</strong>：</label>
                            <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls">
                        </div>
                        
                        <div id="querySection" style="opacity: 0.5; pointer-events: none;"> <div class="mb-3">
                                <label for="gradeSelect" class="form-label fw-bold">請選擇年級：</label>
                                <select class="form-select form-select-lg" id="gradeSelect">
                                    <option value="7年級" selected>7年級</option>
                                    <option value="8年級">8年級</option>
                                    <option value="9年級">9年級</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label for="scoreInput" class="form-label fw-bold">請輸入總分：</label>
                                <input type="number" class="form-control form-control-lg" id="scoreInput" placeholder="例如: 380" step="0.1">
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-lg" onclick="calculateRank()">查詢落點</button>
                            </div>
                        </div>

                        <div id="resultArea" class="result-box text-center">
                            <h5 class="text-secondary">預估落點區間 (10名一組)</h5>
                            <div class="highlight" id="rangeRank"></div>
                            <hr>
                            <p class="footer-note" id="disclaimerText"></p>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // 全域變數儲存 Excel 資料
        let workbook = null;
        const fileName = 'data.xlsx'; 

        // 頁面載入時嘗試讀取
        window.onload = function() {
            loadExcelAutomatically();
        };

        // 1. 嘗試自動讀取 (適用於網頁伺服器環境)
        async function loadExcelAutomatically() {
            try {
                const response = await fetch(fileName);
                if (!response.ok) throw new Error("File not found");
                const arrayBuffer = await response.arrayBuffer();
                workbook = XLSX.read(arrayBuffer, {type: 'array'});
                
                enableSystem("已成功載入資料檔");
            } catch (error) {
                console.warn("自動讀取失敗，切換為手動模式", error);
                showManualUpload();
            }
        }

        // 2. 顯示手動上傳區塊 (當自動讀取失敗時)
        function showManualUpload() {
            const status = document.getElementById('systemStatus');
            status.className = 'status-badge status-error';
            status.innerText = '請匯入資料檔';
            document.getElementById('fileUploadSection').style.display = 'block';
        }

        // 3. 處理手動檔案上傳
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                workbook = XLSX.read(data, {type: 'array'});
                enableSystem("已手動載入資料");
                document.getElementById('fileUploadSection').style.display = 'none'; // 隱藏上傳框
            };
            reader.readAsArrayBuffer(file);
        });

        // 4. 啟用查詢系統
        function enableSystem(msg) {
            const status = document.getElementById('systemStatus');
            status.className = 'status-badge status-ready';
            status.innerText = msg;
            
            // 解鎖介面
            const section = document.getElementById('querySection');
            section.style.opacity = '1';
            section.style.pointerEvents = 'auto';
        }

        // 5. 核心計算邏輯 (與之前的 GAS 版本邏輯相同)
        function calculateRank() {
            if (!workbook) {
                alert("尚未載入資料檔！");
                return;
            }

            const grade = document.getElementById('gradeSelect').value;
            const scoreInput = document.getElementById('scoreInput').value;

            if (scoreInput === "") {
                alert("請輸入分數！");
                return;
            }

            // 檢查是否有該年級的工作表
            if (!workbook.Sheets[grade]) {
                alert(`找不到工作表 "${grade}"，請確認 Excel 頁籤名稱。`);
                return;
            }

            // 將工作表轉為 JSON (Array of Arrays)
            const worksheet = workbook.Sheets[grade];
            // header:1 代表輸出二維陣列 [[A1, B1], [A2, B2]...]
            let data = XLSX.utils.sheet_to_json(worksheet, {header: 1});

            // 去除標題列 (第一列)
            data.shift();

            // 資料清理：確保分數和排名都有值，並轉為數字
            let cleanData = [];
            data.forEach(row => {
                if (row[0] != null && row[1] != null) {
                    cleanData.push({
                        score: parseFloat(row[0]),
                        rank: parseFloat(row[1])
                    });
                }
            });

            // 排序 (分數由高到低)
            cleanData.sort((a, b) => b.score - a.score);

            const scores = cleanData.map(d => d.score);
            const ranks = cleanData.map(d => d.rank);
            const maxRank = Math.max(...ranks); // 總人數

            const score = parseFloat(scoreInput);
            let estimatedRank = -1;

            // 插值法運算
            if (score >= scores[0]) {
                estimatedRank = 1;
            } else if (score <= scores[scores.length - 1]) {
                estimatedRank = ranks[ranks.length - 1];
            } else {
                for (let i = 0; i < scores.length - 1; i++) {
                    let highKey = scores[i];
                    let lowKey = scores[i+1];

                    if (score <= highKey && score >= lowKey) {
                        let highRank = ranks[i];
                        let lowRank = ranks[i+1];
                        
                        // 計算比例
                        let ratio = (score - lowKey) / (highKey - lowKey);
                        estimatedRank = lowRank - (ratio * (lowRank - highRank));
                        break;
                    }
                }
            }

            // 顯示結果
            displayResult(estimatedRank, maxRank, grade);
        }

        function displayResult(rank, maxRank, grade) {
            const exactRank = Math.round(rank);
            const startGroup = Math.floor((exactRank - 1) / 10) * 10 + 1;
            const endGroup = startGroup + 9;

            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('rangeRank').innerText = `${startGroup} ~ ${endGroup} 名`;
            
            const note = `*${grade}人數共 ${maxRank} 人，此結果依現有數據推算之估計值，僅供參考。`;
            document.getElementById('disclaimerText').innerText = note;
        }
    </script>
</body>
</html>