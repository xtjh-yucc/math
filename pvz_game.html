<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xtjh-yucc çš„æ¤ç‰©ä¿è¡›æˆ°</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body {
            background-color: #222;
            color: white;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; /* é¿å…ä¸€ç›´é¸å–åˆ°æ–‡å­— */
        }

        h1 { margin: 10px 0; font-size: 2rem; }

        /* --- UI æ§åˆ¶åˆ— --- */
        #ui-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px 20px;
            background: #444;
            border-radius: 10px;
            font-size: 1.2rem;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* æ¤ç‰©é¸æ“‡æŒ‰éˆ• */
        .plant-btn {
            padding: 8px 15px;
            font-size: 1rem;
            cursor: pointer;
            background: #eee;
            border: 3px solid #999;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .plant-btn:hover { background: #fff; }

        /* è¢«é¸ä¸­çš„æŒ‰éˆ•æ¨£å¼ */
        .plant-btn.selected {
            background: #ffeb3b;
            border-color: #fbc02d;
            font-weight: bold;
            transform: scale(1.05);
            box-shadow: 0 0 10px #ffeb3b;
        }

        /* --- éŠæˆ²ä¸»æˆ°å ´ --- */
        #game-board {
            display: grid;
            grid-template-columns: repeat(9, 60px);
            grid-template-rows: repeat(5, 60px);
            gap: 2px;
            background-color: #333;
            border: 8px solid #5d4037; /* æ·±æ£•è‰²é‚Šæ¡† */
            border-radius: 5px;
            position: relative; /* é—œéµï¼šè®“æ®­å±å’Œå­å½ˆå¯ä»¥å®šä½ */
            overflow: hidden;   /* é¿å…æ±è¥¿è·‘å‡ºæ¡†æ¡† */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- æ¯ä¸€æ ¼è‰åœ° --- */
        .cell {
            width: 60px;
            height: 60px;
            background-color: #2d8f2d;
            border: 1px solid #1e6b1e;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 35px; /* æ¤ç‰©çš„å¤§å° */
            position: relative;
            z-index: 1; /* ç¢ºä¿æ¤ç‰©åœ¨è‰åœ°ä¸Š */
        }

        .cell:hover { background-color: #3cb03c; }
        .cell.dark { background-color: #267f26; } /* æ·±è‰²æ ¼å­ */

        /* --- å …æœæ¨£å¼ (ç¨å¾®ä¸åŒ) --- */
        .nut { font-size: 32px; filter: drop-shadow(2px 2px 0px #3e2723); }

        /* --- éŠæˆ²è§’è‰²èˆ‡ç‰©ä»¶ (çµ•å°å®šä½) --- */
        .zombie {
            position: absolute;
            width: 60px;
            height: 60px;
            font-size: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10; /* æ®­å±åœ¨æœ€ä¸Šé¢ */
            transition: opacity 0.2s; /* å—å‚·æ™‚çš„é–ƒçˆæ•ˆæœ */
            filter: drop-shadow(3px 3px 2px rgba(0,0,0,0.5));
        }

        .bullet {
            position: absolute;
            width: 18px;
            height: 18px;
            background-color: #32CD32;
            border-radius: 50%;
            box-shadow: 0 0 5px #76ff03;
            z-index: 5;
        }

        /* é å°¾ */
        .footer {
            margin-top: 20px;
            font-size: 0.8rem;
            color: #777;
        }
    </style>
</head>
<body>

    <h1>ğŸŒ± æ¤ç‰©ä¿è¡›æˆ° ğŸ§Ÿ</h1>

    <div id="ui-bar">
        <div style="margin-right: 10px;">ğŸŒ é™½å…‰: <span id="sun-display">100</span></div>
        
        <div id="controls" style="display:flex; gap:10px;">
            <button class="plant-btn selected" onclick="selectPlant('shooter')">ğŸŒ± å°„æ‰‹ ($50)</button>
            <button class="plant-btn" onclick="selectPlant('nut')">ğŸ¥” å …æœ ($50)</button>
        </div>

        <div style="margin-left: 20px;">ğŸ§Ÿ æ®­å±å‰©é¤˜: <span id="wave-display">10</span></div>
    </div>

    <div id="game-board">
        </div>

    <div class="footer">Made by Xtjh-yucc | é»æ“Šæ ¼å­ç¨®æ¤ | å …æœå¯ä»¥æ“‹å¾ˆä¹…</div>

    <script>
        // --- éŠæˆ²åƒæ•¸è¨­å®š ---
        const rows = 5;
        const cols = 9;
        const cellSize = 60;
        
        let sun = 150;            // åˆå§‹é™½å…‰ (çµ¦å¤šä¸€é»å¥½ä¸Šæ‰‹)
        let currentPlantType = 'shooter'; 
        
        // é—œå¡è¨­å®š
        const totalZombiesInWave = 10; // ç¸½å…±è¦æ‰“å¹¾éš»
        let zombiesSpawned = 0;        
        let gameActive = true;         

        // éŠæˆ²ç‰©ä»¶å®¹å™¨
        let zombies = []; 
        let bullets = [];

        // DOM å…ƒç´ 
        const board = document.getElementById('game-board');
        const sunDisplay = document.getElementById('sun-display');
        const waveDisplay = document.getElementById('wave-display');
        const btns = document.querySelectorAll('.plant-btn');

        // ==========================================
        // 1. åˆå§‹åŒ–éŠæˆ²èˆ‡åœ°åœ–
        // ==========================================
        function createBoard() {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.dataset.hp = 0; // æ¤ç‰©è¡€é‡
                    
                    // æ£‹ç›¤æ ¼ç´‹è·¯
                    if ((r + c) % 2 === 1) cell.classList.add('dark');
                    
                    // é»æ“Šäº‹ä»¶
                    cell.addEventListener('click', () => plantTower(cell));
                    
                    board.appendChild(cell);
                }
            }
            updateUI();
        }

        // ==========================================
        // 2. ç¨®æ¤ç³»çµ±
        // ==========================================
        
        // åˆ‡æ›æ¤ç‰©é¡å‹
        window.selectPlant = function(type) {
            currentPlantType = type;
            btns.forEach(btn => btn.classList.remove('selected'));
            if(type === 'shooter') btns[0].classList.add('selected');
            else btns[1].classList.add('selected');
        }

        // ç¨®ä¸‹æ¤ç‰©
        function plantTower(cell) {
            if (!gameActive) return;
            if (cell.innerHTML !== "") return; // å·²ç¶“æœ‰æ¤ç‰©äº†

            const cost = 50; 
            if (sun >= cost) {
                sun -= cost;
                updateUI();

                if (currentPlantType === 'shooter') {
                    cell.innerHTML = "ğŸŒ±";
                    cell.dataset.hp = 3;   // å°„æ‰‹è¡€é‡
                    cell.dataset.type = 'shooter';
                } else if (currentPlantType === 'nut') {
                    cell.innerHTML = "<div class='nut'>ğŸ¥”</div>";
                    cell.dataset.hp = 20;  // å …æœè¡€é‡ (è¶…åš)
                    cell.dataset.type = 'nut';
                }
            } else {
                alert("é™½å…‰ä¸è¶³ï¼éœ€è¦ 50 ğŸŒ");
            }
        }

        function updateUI() {
            sunDisplay.textContent = sun;
            waveDisplay.textContent = totalZombiesInWave - zombiesSpawned;
        }

        // ==========================================
        // 3. æ®­å±é‚è¼¯ (ç”Ÿæˆã€ç§»å‹•ã€åƒ)
        // ==========================================
        
        function spawnZombie() {
            if (!gameActive) return;
            if (zombiesSpawned >= totalZombiesInWave) return;

            const row = Math.floor(Math.random() * rows);
            const zombieEl = document.createElement('div');
            zombieEl.classList.add('zombie');
            zombieEl.innerHTML = "ğŸ§Ÿ";
            
            // åˆå§‹ä½ç½®è¨­å®šåœ¨ç•«é¢å¤–æœ€å³é‚Š
            zombieEl.style.top = (row * cellSize) + 'px';
            zombieEl.style.left = (cols * cellSize) + 'px';
            
            board.appendChild(zombieEl);

            zombies.push({
                el: zombieEl,
                row: row,
                x: cols * cellSize,
                speed: 0.5,     // ç§»å‹•é€Ÿåº¦
                health: 3,      // æ®­å±è¡€é‡
                isEating: false,
                biteTimer: 0    // å•ƒå’¬è¨ˆæ™‚å™¨
            });

            zombiesSpawned++;
            updateUI();
        }

        function moveZombies() {
            if (!gameActive) return;

            // --- å‹åˆ©åˆ¤å®š ---
            if (zombiesSpawned >= totalZombiesInWave && zombies.length === 0) {
                gameActive = false;
                setTimeout(() => alert("ğŸ† æ­å–œï¼ä½ çš„èŠ±åœ’å®‰å…¨äº†ï¼"), 100);
                return;
            }

            zombies.forEach((z, index) => {
                // --- åƒæ¤ç‰©é‚è¼¯ ---
                if (z.isEating) {
                    z.biteTimer++;
                    if (z.biteTimer > 20) { // æ¯ 20 å¹€ (ç´„0.6ç§’) å’¬ä¸€å£
                        z.biteTimer = 0;
                        bitePlant(z); 
                    }
                    return; // åƒæ±è¥¿æ™‚ä¸ç§»å‹•
                }

                // --- ç§»å‹•é‚è¼¯ ---
                z.x -= z.speed;
                z.el.style.left = z.x + 'px';

                // æª¢æŸ¥æ˜¯å¦ç¢°åˆ°æ¤ç‰©
                const currentCol = Math.floor((z.x + 30) / cellSize);
                const cell = document.querySelector(`.cell[data-row='${z.row}'][data-col='${currentCol}']`);

                if (cell && cell.dataset.hp > 0) { 
                    z.isEating = true; // åœä¸‹ä¾†é–‹å§‹åƒ
                }

                // --- Game Over åˆ¤å®š ---
                if (z.x < -30) {
                    gameActive = false;
                    alert("ğŸ§Ÿ æ…˜äº†ï¼æ®­å±åƒæ‰äº†ä½ çš„è…¦è¢‹ï¼(é‡æ–°æ•´ç†å†ä¾†ä¸€æ¬¡)");
                    location.reload();
                }
            });
        }

        // æ®­å±å•ƒå’¬å‹•ä½œ
        function bitePlant(zombie) {
            const currentCol = Math.floor((zombie.x + 30) / cellSize);
            const cell = document.querySelector(`.cell[data-row='${zombie.row}'][data-col='${currentCol}']`);

            if (cell && cell.dataset.hp > 0) {
                let hp = parseInt(cell.dataset.hp);
                hp -= 1;
                cell.dataset.hp = hp;
                
                // è¦–è¦ºå›é¥‹ï¼šæ¤ç‰©è®Šæ·¡
                cell.style.opacity = 0.5 + (hp/10); 

                if (hp <= 0) {
                    cell.innerHTML = ""; // æ¤ç‰©æ­»äº¡
                    cell.style.opacity = 1;
                    cell.dataset.hp = 0;
                    cell.dataset.type = "";
                    zombie.isEating = false; // åƒé£½äº†ç¹¼çºŒèµ°
                }
            } else {
                zombie.isEating = false; // æ¤ç‰©ä¸è¦‹äº†ï¼Œç¹¼çºŒèµ°
            }
        }

        // ==========================================
        // 4. æˆ°é¬¥ç³»çµ± (ç™¼å°„å­å½ˆã€ç¢°æ’)
        // ==========================================
        
        function plantsShoot() {
            if (!gameActive) return;

            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                // åªæœ‰å°„æ‰‹æœƒæ”»æ“Š
                if (cell.dataset.type === 'shooter') {
                    const plantRow = parseInt(cell.dataset.row);
                    const plantCol = parseInt(cell.dataset.col);
                    const plantX = plantCol * cellSize;

                    // ç´¢æ•µï¼šåŒä¸€æ’ä¸”åœ¨å³é‚Šæœ‰æ®­å±æ‰å°„æ“Š
                    const enemyInSight = zombies.some(z => z.row === plantRow && z.x > plantX);
                    if (enemyInSight) {
                        createBullet(cell);
                    }
                }
            });
        }

        function createBullet(cell) {
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            const bulletEl = document.createElement('div');
            bulletEl.classList.add('bullet');
            
            const startX = (col * cellSize) + 30;
            const startY = (row * cellSize) + 20;
            
            bulletEl.style.left = startX + 'px';
            bulletEl.style.top = startY + 'px';
            board.appendChild(bulletEl);

            bullets.push({ el: bulletEl, row: row, x: startX, speed: 5 });
        }

        function moveBullets() {
            if (!gameActive) return;
            
            bullets.forEach((b, bIndex) => {
                b.x += b.speed;
                b.el.style.left = b.x + 'px';

                // ç¢°æ’åµæ¸¬
                zombies.forEach((z, zIndex) => {
                    if (b.row === z.row && b.x > z.x && b.x < z.x + 40) {
                        // å‘½ä¸­ï¼
                        b.el.remove();
                        bullets.splice(bIndex, 1);
                        
                        // æ®­å±æ‰£è¡€
                        z.health -= 1;
                        if (z.health <= 0) {
                            z.el.remove();
                            zombies.splice(zIndex, 1);
                        } else {
                            // å—å‚·é–ƒçˆ
                            z.el.style.opacity = 0.5;
                            setTimeout(()=> z.el.style.opacity = 1, 100);
                        }
                    }
                });

                // å­å½ˆé£›å‡ºç•«é¢ç§»é™¤
                if (b.x > cols * cellSize) {
                    b.el.remove();
                    bullets.splice(bIndex, 1);
                }
            });
        }

        // ==========================================
        // 5. éŠæˆ²è¿´åœˆ (Game Loop)
        // ==========================================
        
        // å•Ÿå‹•ç•«é¢
        createBoard();

        // ç•«é¢èˆ‡ç‰©ç†è¨ˆç®— (æ¯ 30ms ä¸€æ¬¡ï¼Œç´„ 33 FPS)
        setInterval(() => {
            moveZombies();
            moveBullets();
        }, 30);

        // æ®­å±ç”Ÿæˆ (æ¯ 2 ç§’ä¸€éš»)
        setInterval(spawnZombie, 2000);

        // æ¤ç‰©æ”»æ“Š (æ¯ 1.4 ç§’ä¸€æ¬¡)
        setInterval(plantsShoot, 1400);

    </script>
</body>
</html>