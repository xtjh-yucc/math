<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤ç‰©ä¿è¡›æˆ° V4.0ï¼šéŸ³æ•ˆå…¨é–‹ç‰ˆ</title>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        body {
            background-color: #222;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            margin: 0;
            padding: 10px;
        }

        /* --- é ‚éƒ¨è³‡è¨Šåˆ— --- */
        #ui-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            padding: 10px 20px;
            background: #444;
            border-radius: 10px;
            font-size: 1.1rem;
            align-items: center;
            width: 620px;
            justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .resource-box { font-weight: bold; color: #ffeb3b; }
        .level-box { font-weight: bold; color: #00e5ff; }

        /* éŸ³æ•ˆé–‹é—œ */
        #sound-toggle {
            cursor: pointer;
            font-size: 1.2rem;
            background: none;
            border: none;
            filter: grayscale(0);
            transition: filter 0.2s;
        }
        #sound-toggle.muted { filter: grayscale(1); opacity: 0.5; }

        /* --- æ¤ç‰©é¸å–® --- */
        #controls { display: flex; gap: 8px; }

        .plant-btn {
            padding: 5px 10px;
            cursor: pointer;
            background: #eee;
            border: 3px solid #999;
            border-radius: 5px;
            color: #333;
            font-size: 0.9rem;
            display: none; 
            position: relative;
        }
        .plant-btn:hover { background: #fff; transform: translateY(-2px); }
        .plant-btn.selected {
            background: #fff59d;
            border-color: #fbc02d;
            box-shadow: 0 0 8px #ffeb3b;
        }

        /* --- éŠæˆ²ä¸»ç•«é¢ --- */
        #game-container {
            position: relative;
            width: 558px; 
            height: 316px; 
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(9, 60px);
            grid-template-rows: repeat(5, 60px);
            gap: 2px;
            background-color: #333;
            border: 8px solid #5d4037;
            border-radius: 5px;
            position: absolute;
            top: 0; left: 0;
            overflow: hidden;
        }

        .cell {
            width: 60px; height: 60px;
            background-color: #2d8f2d;
            border: 1px solid #1e6b1e;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 35px;
            position: relative; z-index: 1;
        }
        .cell.dark { background-color: #267f26; }
        .nut { filter: drop-shadow(2px 2px 0 #3e2723); }
        .double-shooter { filter: drop-shadow(0 0 5px #ff0000); }

        .zombie {
            position: absolute;
            width: 60px; height: 60px;
            font-size: 40px;
            display: flex; justify-content: center; align-items: center;
            z-index: 10;
            transition: opacity 0.1s;
        }
        .zombie.bucket { filter: hue-rotate(180deg) drop-shadow(2px 2px 0 #000); font-size: 42px; }

        .bullet {
            position: absolute;
            width: 18px; height: 18px;
            background-color: #32CD32;
            border-radius: 50%;
            box-shadow: 0 0 5px #76ff03;
            z-index: 5;
        }

        /* --- å½ˆè·³è¦–çª— --- */
        #modal-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
        }
        .modal-btn {
            padding: 10px 20px; font-size: 1.5rem;
            background: #4CAF50; color: white;
            border: none; border-radius: 5px; cursor: pointer;
            margin-top: 20px;
        }
        .modal-btn:hover { background: #45a049; }
        .hidden { display: none !important; }

        .footer { margin-top: 10px; color: #aaa; font-size: 0.8rem; }
    </style>
</head>
<body>

    <h1>ğŸŒ± æ¤ç‰©ä¿è¡›æˆ° V4.0 (éŸ³æ•ˆç‰ˆ)</h1>

    <div id="ui-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button id="sound-toggle" onclick="toggleSound()">ğŸ”Š</button>
            <span class="level-box">LV.<span id="level-display">1</span></span>
            <span class="resource-box">ğŸŒ<span id="sun-display">150</span></span>
        </div>
        
        <div id="controls">
            <button id="btn-shooter" class="plant-btn selected" onclick="selectPlant('shooter')">ğŸŒ± å°„æ‰‹($50)</button>
            <button id="btn-nut" class="plant-btn" onclick="selectPlant('nut')">ğŸ¥” å …æœ($50)</button>
            <button id="btn-double" class="plant-btn" onclick="selectPlant('double')">ğŸ’ é›™ç™¼($100)</button>
        </div>

        <div>ğŸ§Ÿ <span id="wave-display">0</span></div>
    </div>

    <div id="game-container">
        <div id="game-board"></div>
        <div id="modal-overlay">
            <h2 id="modal-title">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
            <p id="modal-desc">é»æ“Šé–‹å§‹å¾Œï¼ŒéŸ³æ•ˆå¼•æ“å°‡æœƒå•Ÿå‹•ã€‚</p>
            <button class="modal-btn" onclick="startGame()">â–¶ é–‹å§‹éŠæˆ²</button>
        </div>
    </div>

    <div class="footer">Made by Xtjh-yucc | âš ï¸ æ²’è²éŸ³ï¼Ÿè«‹æª¢æŸ¥é›»è…¦å–‡å­æˆ–ç€è¦½å™¨åˆ†é æ˜¯å¦éœéŸ³</div>

    <script>
        // ==========================================
        // ğŸµ éŸ³æ•ˆå¼•æ“ (Web Audio API) - ç´”ä»£ç¢¼åˆæˆéŸ³æ•ˆ
        // ==========================================
        const AudioEngine = {
            ctx: null,
            muted: false,

            init: function() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                // ç€è¦½å™¨æ”¿ç­–è¦æ±‚ï¼šå¿…é ˆåœ¨ä½¿ç”¨è€…äº’å‹•(é»æ“Š)å¾Œæ‰èƒ½æ¢å¾© AudioContext
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },

            playTone: function(freq, type, duration, volume = 0.1) {
                if (this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gainNode = this.ctx.createGain();
                
                osc.type = type; // 'sine', 'square', 'sawtooth', 'triangle'
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                
                gainNode.gain.setValueAtTime(volume, this.ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

                osc.connect(gainNode);
                gainNode.connect(this.ctx.destination);
                
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            // å„ç¨®éŸ³æ•ˆé è¨­
            playShoot: function() {
                // å’»å’»è²ï¼šé«˜éŸ³æ»‘è½
                if (this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, this.ctx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.15);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.15);
            },

            playHit: function() {
                // æ“Šä¸­è²ï¼šçŸ­ä¿ƒçš„ä½éŸ³
                this.playTone(150, 'sawtooth', 0.1, 0.05);
            },

            playPlant: function() {
                // ç¨®æ¤è²ï¼šå¯æ„›çš„æ°£æ³¡éŸ³
                if (this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(600, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.1);
            },

            playZombie: function() {
                // æ®­å±å‡ºç¾ï¼šä½æ²‰è©­ç•°
                this.playTone(80, 'square', 0.5, 0.03);
            },

            playWin: function() {
                // å‹åˆ©ï¼šå¤§ä¸‰å’Œå¼¦
                setTimeout(() => this.playTone(523.25, 'sine', 0.2, 0.1), 0);   // C5
                setTimeout(() => this.playTone(659.25, 'sine', 0.2, 0.1), 200); // E5
                setTimeout(() => this.playTone(783.99, 'sine', 0.4, 0.1), 400); // G5
            },

            playLose: function() {
                // å¤±æ•—ï¼šä¸å”å’ŒéŸ³
                setTimeout(() => this.playTone(300, 'sawtooth', 0.5, 0.1), 0);
                setTimeout(() => this.playTone(200, 'sawtooth', 1.0, 0.1), 400);
            }
        };

        // ==========================================
        // ğŸ® éŠæˆ²é‚è¼¯ (èˆ‡ V3.0 ç›¸åŒï¼Œæ’å…¥éŸ³æ•ˆ)
        // ==========================================
        
        const rows = 5;
        const cols = 9;
        const cellSize = 60;

        const levels = [
            { id: 1, zombies: 5,  interval: 3000, types: ['normal'], unlock: 'shooter', intro: "ç¬¬1é—œï¼šæ–°æ‰‹æ•™å­¸\né»æ“Šæ ¼å­ç¨®æ¤æ¤ç‰©ï¼" },
            { id: 2, zombies: 8,  interval: 2800, types: ['normal'], unlock: 'nut', intro: "ç¬¬2é—œï¼šå …æœç‰†è§£é–\nç”¨å®ƒä¾†æ“‹ä½æ®­å±ï¼" },
            { id: 3, zombies: 12, interval: 2500, types: ['normal'], unlock: 'double', intro: "ç¬¬3é—œï¼šé›™ç™¼å°„æ‰‹\nç«åŠ›åŠ å€ï¼" },
            { id: 4, zombies: 10, interval: 3000, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬4é—œï¼šéµæ¡¶ä¾†è¥²\né€™å‚¢ä¼™è¶…ç¡¬ï¼" },
            { id: 5, zombies: 15, interval: 2000, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬5é—œï¼šå±æ½®è­¦å ±" },
            { id: 6, zombies: 20, interval: 1800, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬6é—œï¼šå …å®ˆé™£åœ°" },
            { id: 7, zombies: 25, interval: 1500, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬7é—œï¼šç˜‹ç‹‚æ¨¡å¼" },
            { id: 8, zombies: 30, interval: 1200, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬8é—œï¼šå¿«ç¯€å¥" },
            { id: 9, zombies: 40, interval: 1000, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬9é—œï¼šçµ•æœ›æ·±æ·µ" },
            { id: 10,zombies: 50, interval: 800,  types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬10é—œï¼šæœ€çµ‚æ±ºæˆ°" }
        ];

        let currentLevelIndex = 0;
        let sun = 150;
        let currentPlantType = 'shooter';
        let zombiesSpawned = 0;
        let gameActive = false;
        
        let gameLoopTimer, zombieSpawnerTimer, plantShootTimer, sunTimer;
        let zombies = [], bullets = [];

        const board = document.getElementById('game-board');
        const sunDisplay = document.getElementById('sun-display');
        const waveDisplay = document.getElementById('wave-display');
        const levelDisplay = document.getElementById('level-display');
        const modal = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalDesc = document.getElementById('modal-desc');
        const modalBtn = document.querySelector('.modal-btn');
        const soundBtn = document.getElementById('sound-toggle');

        const btns = {
            shooter: document.getElementById('btn-shooter'),
            nut: document.getElementById('btn-nut'),
            double: document.getElementById('btn-double')
        };

        // --- éŸ³æ•ˆé–‹é—œ ---
        function toggleSound() {
            AudioEngine.muted = !AudioEngine.muted;
            if (AudioEngine.muted) {
                soundBtn.textContent = "ğŸ”‡";
                soundBtn.classList.add('muted');
            } else {
                soundBtn.textContent = "ğŸ”Š";
                soundBtn.classList.remove('muted');
                // å˜—è©¦æ¢å¾© AudioContext
                AudioEngine.init();
            }
        }

        // --- åˆå§‹åŒ– ---
        function createBoard() {
            board.innerHTML = ''; 
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = r; cell.dataset.col = c;
                    cell.dataset.hp = 0; 
                    if ((r + c) % 2 === 1) cell.classList.add('dark');
                    cell.addEventListener('click', () => plantTower(cell));
                    board.appendChild(cell);
                }
            }
        }

        function updateUnlockState() {
            btns.shooter.style.display = 'block';
            if (currentLevelIndex + 1 >= 2) btns.nut.style.display = 'block';
            if (currentLevelIndex + 1 >= 3) btns.double.style.display = 'block';
        }

        function showModal(title, desc, btnText, action) {
            modalTitle.textContent = title;
            modalDesc.textContent = desc; 
            modalDesc.style.whiteSpace = 'pre-line'; 
            modalBtn.textContent = btnText;
            modalBtn.onclick = action;
            modal.classList.remove('hidden');
        }

        function startGame() {
            // é»æ“Šé–‹å§‹æ™‚ï¼Œåˆå§‹åŒ–éŸ³æ•ˆå¼•æ“
            AudioEngine.init();
            
            modal.classList.add('hidden');
            const config = levels[currentLevelIndex];
            zombiesSpawned = 0;
            sun = 200; 
            zombies = []; bullets = [];
            createBoard(); 
            updateUI();
            updateUnlockState(); // ç¢ºä¿æŒ‰éˆ•ç‹€æ…‹æ­£ç¢º
            
            gameActive = true;
            
            gameLoopTimer = setInterval(() => { moveZombies(); moveBullets(); }, 30);
            zombieSpawnerTimer = setInterval(spawnZombie, config.interval);
            plantShootTimer = setInterval(plantsShoot, 1200);
            sunTimer = setInterval(autoSun, 3000);
        }

        function stopGame() {
            gameActive = false;
            clearInterval(gameLoopTimer);
            clearInterval(zombieSpawnerTimer);
            clearInterval(plantShootTimer);
            clearInterval(sunTimer);
        }

        function levelComplete() {
            stopGame();
            AudioEngine.playWin(); // æ’­æ”¾å‹åˆ©éŸ³æ•ˆ
            if (currentLevelIndex + 1 >= levels.length) {
                showModal("ğŸ† éŠæˆ²é€šé—œï¼", "å¤ªç¥å•¦ï¼ä½ å®ˆä½äº†æ‰€æœ‰çš„æ”»å‹¢ï¼", "é‡æ–°é–‹å§‹", () => location.reload());
            } else {
                currentLevelIndex++;
                const nextConfig = levels[currentLevelIndex];
                showModal("ğŸ‰ é—œå¡å®Œæˆï¼", nextConfig.intro, "ä¸‹ä¸€é—œ", startGame);
            }
        }

        function gameOver() {
            stopGame();
            AudioEngine.playLose(); // æ’­æ”¾å¤±æ•—éŸ³æ•ˆ
            showModal("ğŸ§Ÿ å¤±æ•—...", "è…¦è¢‹è¢«åƒäº†...", "é‡è©¦æœ¬é—œ", startGame);
        }

        // --- æ ¸å¿ƒæ“ä½œ ---
        window.selectPlant = function(type) {
            currentPlantType = type;
            Object.values(btns).forEach(b => b.classList.remove('selected'));
            btns[type].classList.add('selected');
        }

        function plantTower(cell) {
            if (!gameActive || cell.innerHTML !== "") return;
            
            let cost = 0, html = "", hp = 0;
            if (currentPlantType === 'shooter') { cost = 50; html = "ğŸŒ±"; hp = 4; }
            else if (currentPlantType === 'nut') { cost = 50; html = "<div class='nut'>ğŸ¥”</div>"; hp = 25; }
            else if (currentPlantType === 'double') { cost = 100; html = "<div class='double-shooter'>ğŸ’</div>"; hp = 4; }

            if (sun >= cost) {
                sun -= cost;
                cell.innerHTML = html;
                cell.dataset.hp = hp;
                cell.dataset.type = currentPlantType;
                AudioEngine.playPlant(); // æ’­æ”¾ç¨®æ¤éŸ³æ•ˆ
                updateUI();
            } else {
                sunDisplay.style.color = 'red';
                setTimeout(()=> sunDisplay.style.color = '#ffeb3b', 200);
            }
        }

        function autoSun() {
            if(gameActive) {
                sun += 25;
                updateUI();
            }
        }

        function spawnZombie() {
            const config = levels[currentLevelIndex];
            if (zombiesSpawned >= config.zombies) return;

            let type = 'normal';
            if (config.types.includes('bucket') && Math.random() > 0.7) type = 'bucket';

            const row = Math.floor(Math.random() * rows);
            const zEl = document.createElement('div');
            zEl.classList.add('zombie');
            
            let hp = 5; 
            if (type === 'bucket') {
                zEl.classList.add('bucket');
                zEl.innerHTML = "ğŸ‘¹";
                hp = 15;
            } else {
                zEl.innerHTML = "ğŸ§Ÿ";
            }

            zEl.style.top = (row * cellSize) + 'px';
            zEl.style.left = (cols * cellSize) + 'px';
            board.appendChild(zEl);
            
            // åªæœ‰ç•¶å ´ä¸Šæ®­å±ä¸å¤šæ™‚æ‰æ’­æ”¾éŸ³æ•ˆï¼Œé¿å…å¤ªåµ
            if(zombies.length < 5) AudioEngine.playZombie();

            zombies.push({
                el: zEl, row: row, x: cols * cellSize,
                speed: type === 'bucket' ? 0.4 : 0.6 + (Math.random() * 0.2),
                hp: hp, isEating: false, biteTimer: 0
            });

            zombiesSpawned++;
            updateUI();
        }

        function moveZombies() {
            const config = levels[currentLevelIndex];
            if (zombiesSpawned >= config.zombies && zombies.length === 0) {
                levelComplete();
                return;
            }

            zombies.forEach((z, idx) => {
                if (z.isEating) {
                    z.biteTimer++;
                    if (z.biteTimer > 20) {
                        z.biteTimer = 0;
                        bitePlant(z);
                    }
                    return;
                }
                z.x -= z.speed;
                z.el.style.left = z.x + 'px';

                const currentCol = Math.floor((z.x + 30) / cellSize);
                const cell = document.querySelector(`.cell[data-row='${z.row}'][data-col='${currentCol}']`);
                if (cell && cell.dataset.hp > 0) z.isEating = true;

                if (z.x < -30) gameOver();
            });
        }

        function bitePlant(z) {
            const currentCol = Math.floor((z.x + 30) / cellSize);
            const cell = document.querySelector(`.cell[data-row='${z.row}'][data-col='${currentCol}']`);
            
            if (cell && cell.dataset.hp > 0) {
                let hp = parseInt(cell.dataset.hp);
                hp--;
                cell.dataset.hp = hp;
                cell.style.opacity = 0.5 + (hp/20);
                // é€™è£¡åŠ å…¥å•ƒå’¬éŸ³æ•ˆæœƒå¤ªåµï¼Œæ‰€ä»¥çœç•¥
                if (hp <= 0) {
                    cell.innerHTML = ""; cell.dataset.hp = 0; cell.dataset.type = "";
                    cell.style.opacity = 1; z.isEating = false;
                }
            } else {
                z.isEating = false;
            }
        }

        function plantsShoot() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const type = cell.dataset.type;
                if (type === 'shooter' || type === 'double') {
                    const r = parseInt(cell.dataset.row);
                    const c = parseInt(cell.dataset.col);
                    const pX = c * cellSize;
                    if (zombies.some(z => z.row === r && z.x > pX)) {
                        createBullet(r, c, type);
                    }
                }
            });
        }

        function createBullet(r, c, type) {
            const startX = (c * cellSize) + 30;
            const startY = (r * cellSize) + 20;

            const fire = (delay) => {
                setTimeout(() => {
                    const bEl = document.createElement('div');
                    bEl.classList.add('bullet');
                    bEl.style.left = startX + 'px';
                    bEl.style.top = startY + 'px';
                    board.appendChild(bEl);
                    bullets.push({ el: bEl, row: r, x: startX, speed: 6 });
                    
                    // æ’­æ”¾ç™¼å°„éŸ³æ•ˆ
                    AudioEngine.playShoot();
                }, delay);
            };

            fire(0);
            if (type === 'double') fire(150);
        }

        function moveBullets() {
            bullets.forEach((b, bIdx) => {
                b.x += b.speed;
                b.el.style.left = b.x + 'px';
                
                let hit = false;
                for (let i = zombies.length - 1; i >= 0; i--) {
                    const z = zombies[i];
                    if (b.row === z.row && b.x > z.x && b.x < z.x + 40) {
                        hit = true;
                        z.hp--;
                        z.el.style.opacity = 0.5;
                        setTimeout(() => z.el.style.opacity = 1, 100);
                        
                        // æ’­æ”¾æ“Šä¸­éŸ³æ•ˆ
                        AudioEngine.playHit();

                        if (z.hp <= 0) {
                            z.el.remove();
                            zombies.splice(i, 1);
                        }
                        break;
                    }
                }
                if (hit || b.x > cols * cellSize) {
                    b.el.remove();
                    bullets.splice(bIdx, 1);
                }
            });
        }

        function updateUI() {
            sunDisplay.textContent = sun;
            levelDisplay.textContent = currentLevelIndex + 1;
            const config = levels[currentLevelIndex];
            waveDisplay.textContent = config.zombies - zombiesSpawned;
        }

        createBoard();
        // åˆå§‹è¼‰å…¥æ™‚æŒ‰éˆ•é è¨­éš±è—ï¼Œç­‰å¾…é–‹å§‹
    </script>
</body>
</html>