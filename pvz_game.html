<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¤ç‰©ä¿è¡›æˆ° V5.0ï¼šå…¨è£ç½®é©é…ç‰ˆ</title>
    <style>
        /* --- 1. å…¨å±€éŸ¿æ‡‰å¼è¨­å®š --- */
        body {
            background-color: #222;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            margin: 0;
            padding: 10px;
            overflow-x: hidden; /* é˜²æ­¢å·¦å³æ²å‹• */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤æ‰‹æ©Ÿé»æ“Šè—æ¡† */
        }

        h1 { 
            margin: 5px 0; 
            font-size: 1.5rem; 
            text-align: center;
        }

        /* --- 2. UI æ§åˆ¶åˆ— (å½ˆæ€§ä½ˆå±€) --- */
        #ui-bar {
            display: flex;
            flex-wrap: wrap; /* æ‰‹æ©Ÿä¸Šç©ºé–“ä¸å¤ æœƒè‡ªå‹•æ›è¡Œ */
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background: #444;
            border-radius: 10px;
            font-size: 1rem;
            width: 95%; /* å¯¬åº¦è·Ÿéš¨è¢å¹• */
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .info-group {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap; /* æ–‡å­—ä¸æ›è¡Œ */
        }

        .resource-box { font-weight: bold; color: #ffeb3b; }
        .level-box { font-weight: bold; color: #00e5ff; }

        #controls { display: flex; gap: 5px; }

        .plant-btn {
            padding: 8px 10px; /* åŠ å¤§æŒ‰éˆ•æ–¹ä¾¿æ‰‹æŒ‡é»æ“Š */
            cursor: pointer;
            background: #eee;
            border: 2px solid #999;
            border-radius: 5px;
            color: #333;
            font-size: 0.9rem;
            display: none; 
            min-width: 80px; /* ç¢ºä¿æŒ‰éˆ•æœ‰æœ€å°å¯¬åº¦ */
        }
        .plant-btn:active { transform: scale(0.95); } /* æ‰‹æ©ŸæŒ‰ä¸‹çš„å›é¥‹æ„Ÿ */
        .plant-btn.selected {
            background: #fff59d;
            border-color: #fbc02d;
            box-shadow: 0 0 8px #ffeb3b;
        }

        /* --- 3. éŠæˆ²ç¸®æ”¾å®¹å™¨ (é—œéµæŠ€è¡“) --- */
        /* é€™æ˜¯ä¸€å€‹åŒ…è£¹å±¤ï¼Œç”¨ä¾†åŸ·è¡Œç¸®æ”¾ */
        #game-scaler {
            transform-origin: top center; /* å¾ä¸Šæ–¹ä¸­é–“é–‹å§‹ç¸®æ”¾ */
            transition: transform 0.2s;   /* è½‰å‘æ™‚æœ‰å‹•ç•« */
            margin-top: 5px;
        }

        /* éŠæˆ²æœ¬é«”ä¿æŒåŸå§‹å°ºå¯¸ (540px + é‚Šæ¡†) */
        #game-container {
            position: relative;
            width: 558px; 
            height: 316px; 
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(9, 60px);
            grid-template-rows: repeat(5, 60px);
            gap: 2px;
            background-color: #333;
            border: 8px solid #5d4037;
            border-radius: 5px;
            position: absolute;
            top: 0; left: 0;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- è§’è‰²ç‰©ä»¶ --- */
        .cell {
            width: 60px; height: 60px;
            background-color: #2d8f2d;
            border: 1px solid #1e6b1e;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 35px;
            position: relative; z-index: 1;
        }
        .cell.dark { background-color: #267f26; }
        .nut { filter: drop-shadow(2px 2px 0 #3e2723); }
        .double-shooter { filter: drop-shadow(0 0 5px #ff0000); }

        .zombie {
            position: absolute;
            width: 60px; height: 60px;
            font-size: 40px;
            display: flex; justify-content: center; align-items: center;
            z-index: 10;
            transition: opacity 0.1s;
            pointer-events: none; /* è®“é»æ“Šå¯ä»¥ç©¿é€æ®­å±é»åˆ°æ ¼å­ */
        }
        .zombie.bucket { filter: hue-rotate(180deg) drop-shadow(2px 2px 0 #000); font-size: 42px; }

        .bullet {
            position: absolute;
            width: 18px; height: 18px;
            background-color: #32CD32;
            border-radius: 50%;
            box-shadow: 0 0 5px #76ff03;
            z-index: 5;
        }

        /* --- å½ˆè·³è¦–çª— --- */
        #modal-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal-btn {
            padding: 15px 30px; /* åŠ å¤§æŒ‰éˆ• */
            font-size: 1.5rem;
            background: #4CAF50; color: white;
            border: none; border-radius: 10px; cursor: pointer;
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
        }
        .hidden { display: none !important; }

        /* æ—‹è½‰æç¤º */
        #rotate-hint {
            display: none;
            color: #ffeb3b;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .footer { margin-top: 20px; color: #aaa; font-size: 0.8rem; text-align: center;}
    </style>
</head>
<body>

    <h1>ğŸŒ± æ¤ç‰©ä¿è¡›æˆ° V5.0</h1>
    <div id="rotate-hint">ğŸ“± å»ºè­°å°‡æ‰‹æ©Ÿæ©«æ”¾éŠç©é«”é©—æ›´ä½³</div>

    <div id="ui-bar">
        <div class="info-group">
            <button id="sound-toggle" onclick="toggleSound()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">ğŸ”Š</button>
            <span class="level-box">LV.<span id="level-display">1</span></span>
            <span class="resource-box">ğŸŒ<span id="sun-display">150</span></span>
            <span style="font-size:0.9rem">ğŸ§Ÿ<span id="wave-display">0</span></span>
        </div>
        
        <div style="width: 100%; height: 0;"></div> 

        <div id="controls">
            <button id="btn-shooter" class="plant-btn selected" onclick="selectPlant('shooter')">ğŸŒ± å°„æ‰‹<br><small>$50</small></button>
            <button id="btn-nut" class="plant-btn" onclick="selectPlant('nut')">ğŸ¥” å …æœ<br><small>$50</small></button>
            <button id="btn-double" class="plant-btn" onclick="selectPlant('double')">ğŸ’ é›™ç™¼<br><small>$100</small></button>
        </div>
    </div>

    <div id="game-scaler">
        <div id="game-container">
            <div id="game-board"></div>
            <div id="modal-overlay">
                <h2 id="modal-title">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
                <p id="modal-desc">è‡ªå‹•é©é…è¢å¹•å°ºå¯¸ï¼</p>
                <button class="modal-btn" onclick="startGame()">â–¶ é–‹å§‹éŠæˆ²</button>
            </div>
        </div>
    </div>

    <div class="footer">
        Made by Xtjh-yucc | æ”¯æ´æ‰‹æ©Ÿ/å¹³æ¿/é›»è…¦<br>
        é»æ“Šæ ¼å­ç¨®æ¤
    </div>

    <script>
        // ==========================================
        // ğŸ“± éŸ¿æ‡‰å¼ç¸®æ”¾é‚è¼¯ (RWD Logic)
        // ==========================================
        function resizeGame() {
            const gameWidth = 560; // éŠæˆ²åŸå§‹å¯¬åº¦ (9æ ¼ * 60 + é‚Šæ¡†)
            const padding = 20;    // å·¦å³ç•™ç™½
            const availableWidth = window.innerWidth - padding;
            
            const scaler = document.getElementById('game-scaler');
            const hint = document.getElementById('rotate-hint');

            // å¦‚æœè¢å¹•æ¯”éŠæˆ²çª„ï¼Œå°±ç¸®å°
            if (availableWidth < gameWidth) {
                const scale = availableWidth / gameWidth;
                scaler.style.transform = `scale(${scale})`;
                // èª¿æ•´é«˜åº¦ï¼Œé¿å…ç¸®æ”¾å¾Œä¸‹æ–¹ç•™ç™½å¤ªå¤§
                scaler.style.height = `${316 * scale}px`; 
                hint.style.display = 'block'; // æ‰‹æ©Ÿé¡¯ç¤ºæ—‹è½‰æç¤º
            } else {
                scaler.style.transform = `scale(1)`;
                scaler.style.height = '316px';
                hint.style.display = 'none';
            }
        }

        // ç›£è½è¦–çª—æ”¹è®Šå¤§å°
        window.addEventListener('resize', resizeGame);
        // åˆå§‹åŒ–åŸ·è¡Œä¸€æ¬¡
        window.addEventListener('load', resizeGame);


        // ==========================================
        // ğŸµ éŸ³æ•ˆå¼•æ“ (åŒ V4.0)
        // ==========================================
        const AudioEngine = {
            ctx: null, muted: false,
            init: function() {
                if (!this.ctx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(freq, type, dur, vol=0.1) {
                if (this.muted || !this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = type; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
                g.gain.setValueAtTime(vol, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+dur);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime+dur);
            },
            playShoot: function() { this.playTone(800, 'triangle', 0.15, 0.1); }, // ç°¡å–®åŒ–ä»¥ç¯€çœä»£ç¢¼
            playHit: function() { this.playTone(150, 'sawtooth', 0.1, 0.05); },
            playPlant: function() { this.playTone(400, 'sine', 0.1, 0.1); },
            playZombie: function() { this.playTone(80, 'square', 0.3, 0.03); },
            playWin: function() { 
                [523, 659, 783].forEach((f, i) => setTimeout(()=>this.playTone(f, 'sine', 0.3, 0.1), i*200));
            },
            playLose: function() { 
                 [300, 200].forEach((f, i) => setTimeout(()=>this.playTone(f, 'sawtooth', 0.5, 0.1), i*300));
            }
        };

        // ==========================================
        // ğŸ® éŠæˆ²æ ¸å¿ƒé‚è¼¯
        // ==========================================
        const rows = 5;
        const cols = 9;
        const cellSize = 60; // é‚è¼¯ä¸Šçš„æ ¼å­—å¤§å°ä¸è®Šï¼Œé¡¯ç¤ºé  CSS ç¸®æ”¾

        const levels = [
            { id: 1, zombies: 5,  interval: 3000, types: ['normal'], unlock: 'shooter', intro: "ç¬¬1é—œ\né»æ“Šæ ¼å­ç¨®æ¤ï¼" },
            { id: 2, zombies: 8,  interval: 2800, types: ['normal'], unlock: 'nut', intro: "ç¬¬2é—œ\nå …æœç‰†è§£é–ï¼" },
            { id: 3, zombies: 12, interval: 2500, types: ['normal'], unlock: 'double', intro: "ç¬¬3é—œ\né›™ç™¼å°„æ‰‹ï¼" },
            { id: 4, zombies: 10, interval: 3000, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬4é—œ\néµæ¡¶æ®­å±å‡ºç¾" },
            { id: 5, zombies: 15, interval: 2000, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬5é—œ\nå±æ½®è­¦å ±" },
            { id: 6, zombies: 20, interval: 1800, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬6é—œ" },
            { id: 7, zombies: 25, interval: 1500, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬7é—œ" },
            { id: 8, zombies: 30, interval: 1200, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬8é—œ" },
            { id: 9, zombies: 40, interval: 1000, types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬9é—œ" },
            { id: 10,zombies: 50, interval: 800,  types: ['normal', 'bucket'], unlock: '', intro: "ç¬¬10é—œ" }
        ];

        let currentLevelIndex = 0;
        let sun = 150;
        let currentPlantType = 'shooter';
        let zombiesSpawned = 0;
        let gameActive = false;
        let zombies = [], bullets = [];
        let timers = [];

        const board = document.getElementById('game-board');
        const sunDisplay = document.getElementById('sun-display');
        const waveDisplay = document.getElementById('wave-display');
        const levelDisplay = document.getElementById('level-display');
        const modal = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalDesc = document.getElementById('modal-desc');
        const modalBtn = document.querySelector('.modal-btn');
        const soundBtn = document.getElementById('sound-toggle');
        const btns = {
            shooter: document.getElementById('btn-shooter'),
            nut: document.getElementById('btn-nut'),
            double: document.getElementById('btn-double')
        };

        function toggleSound() {
            AudioEngine.muted = !AudioEngine.muted;
            soundBtn.textContent = AudioEngine.muted ? "ğŸ”‡" : "ğŸ”Š";
            if (!AudioEngine.muted) AudioEngine.init();
        }

        function createBoard() {
            board.innerHTML = ''; 
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = r; cell.dataset.col = c;
                    cell.dataset.hp = 0; 
                    if ((r + c) % 2 === 1) cell.classList.add('dark');
                    // touchstart æ”¯æ´æ‰‹æ©Ÿå¿«é€Ÿåæ‡‰ï¼Œä½† click å…¼å®¹æ€§æœ€å¥½
                    cell.addEventListener('click', () => plantTower(cell));
                    board.appendChild(cell);
                }
            }
        }

        function updateUnlockState() {
            btns.shooter.style.display = 'block';
            btns.nut.style.display = (currentLevelIndex >= 1) ? 'block' : 'none';
            btns.double.style.display = (currentLevelIndex >= 2) ? 'block' : 'none';
        }

        function showModal(title, desc, btnText, action) {
            modalTitle.textContent = title;
            modalDesc.textContent = desc; 
            modalDesc.style.whiteSpace = 'pre-line'; 
            modalBtn.textContent = btnText;
            modalBtn.onclick = action;
            modal.classList.remove('hidden');
        }

        function startGame() {
            AudioEngine.init();
            modal.classList.add('hidden');
            const config = levels[currentLevelIndex];
            zombiesSpawned = 0;
            sun = 200; 
            zombies = []; bullets = [];
            createBoard(); 
            updateUI();
            updateUnlockState();
            gameActive = true;
            resizeGame(); // å¼·åˆ¶æª¢æŸ¥ä¸€æ¬¡å°ºå¯¸

            timers.forEach(clearInterval);
            timers = [
                setInterval(() => { moveZombies(); moveBullets(); }, 30),
                setInterval(spawnZombie, config.interval),
                setInterval(plantsShoot, 1200),
                setInterval(autoSun, 3000)
            ];
        }

        function stopGame() {
            gameActive = false;
            timers.forEach(clearInterval);
        }

        function levelComplete() {
            stopGame();
            AudioEngine.playWin();
            if (currentLevelIndex + 1 >= levels.length) {
                showModal("ğŸ† é€šé—œï¼", "ä½ æ˜¯æ¤ç‰©å¤§å¸«ï¼", "é‡ç©", () => location.reload());
            } else {
                currentLevelIndex++;
                showModal("ğŸ‰ éé—œï¼", levels[currentLevelIndex].intro, "ä¸‹ä¸€é—œ", startGame);
            }
        }

        function gameOver() {
            stopGame();
            AudioEngine.playLose();
            showModal("ğŸ§Ÿ å¤±æ•—...", "è…¦è¢‹è¢«åƒäº†...", "é‡è©¦", startGame);
        }

        window.selectPlant = function(type) {
            currentPlantType = type;
            Object.values(btns).forEach(b => b.classList.remove('selected'));
            btns[type].classList.add('selected');
        }

        function plantTower(cell) {
            if (!gameActive || cell.innerHTML !== "") return;
            let cost = 0, html = "", hp = 0;
            if (currentPlantType === 'shooter') { cost = 50; html = "ğŸŒ±"; hp = 4; }
            else if (currentPlantType === 'nut') { cost = 50; html = "<div class='nut'>ğŸ¥”</div>"; hp = 25; }
            else if (currentPlantType === 'double') { cost = 100; html = "<div class='double-shooter'>ğŸ’</div>"; hp = 4; }

            if (sun >= cost) {
                sun -= cost;
                cell.innerHTML = html;
                cell.dataset.hp = hp;
                cell.dataset.type = currentPlantType;
                AudioEngine.playPlant();
                updateUI();
            } else {
                sunDisplay.style.color = 'red';
                setTimeout(()=> sunDisplay.style.color = '#ffeb3b', 200);
            }
        }

        function autoSun() { if(gameActive) { sun += 25; updateUI(); } }

        function spawnZombie() {
            const config = levels[currentLevelIndex];
            if (zombiesSpawned >= config.zombies) return;
            let type = 'normal';
            if (config.types.includes('bucket') && Math.random() > 0.7) type = 'bucket';

            const row = Math.floor(Math.random() * rows);
            const zEl = document.createElement('div');
            zEl.classList.add('zombie');
            let hp = type === 'bucket' ? 15 : 5;
            zEl.innerHTML = type === 'bucket' ? "ğŸ‘¹" : "ğŸ§Ÿ";
            if(type === 'bucket') zEl.classList.add('bucket');

            zEl.style.top = (row * cellSize) + 'px';
            zEl.style.left = (cols * cellSize) + 'px';
            board.appendChild(zEl);
            if(zombies.length < 5) AudioEngine.playZombie();

            zombies.push({
                el: zEl, row: row, x: cols * cellSize,
                speed: type === 'bucket' ? 0.4 : 0.6 + (Math.random() * 0.2),
                hp: hp, isEating: false, biteTimer: 0
            });
            zombiesSpawned++;
            updateUI();
        }

        function moveZombies() {
            const config = levels[currentLevelIndex];
            if (zombiesSpawned >= config.zombies && zombies.length === 0) { levelComplete(); return; }

            zombies.forEach((z) => {
                if (z.isEating) {
                    z.biteTimer++;
                    if (z.biteTimer > 20) { z.biteTimer = 0; bitePlant(z); }
                    return;
                }
                z.x -= z.speed;
                z.el.style.left = z.x + 'px';
                const col = Math.floor((z.x + 30) / cellSize);
                const cell = document.querySelector(`.cell[data-row='${z.row}'][data-col='${col}']`);
                if (cell && cell.dataset.hp > 0) z.isEating = true;
                if (z.x < -30) gameOver();
            });
        }

        function bitePlant(z) {
            const col = Math.floor((z.x + 30) / cellSize);
            const cell = document.querySelector(`.cell[data-row='${z.row}'][data-col='${col}']`);
            if (cell && cell.dataset.hp > 0) {
                let hp = parseInt(cell.dataset.hp) - 1;
                cell.dataset.hp = hp;
                cell.style.opacity = 0.5 + (hp/20);
                if (hp <= 0) {
                    cell.innerHTML = ""; cell.dataset.hp = 0; cell.dataset.type = "";
                    cell.style.opacity = 1; z.isEating = false;
                }
            } else { z.isEating = false; }
        }

        function plantsShoot() {
            document.querySelectorAll('.cell').forEach(cell => {
                const type = cell.dataset.type;
                if (type === 'shooter' || type === 'double') {
                    const r = parseInt(cell.dataset.row);
                    const c = parseInt(cell.dataset.col);
                    if (zombies.some(z => z.row === r && z.x > c * cellSize)) createBullet(r, c, type);
                }
            });
        }

        function createBullet(r, c, type) {
            const startX = (c * cellSize) + 30;
            const startY = (r * cellSize) + 20;
            const fire = (delay) => {
                setTimeout(() => {
                    const bEl = document.createElement('div');
                    bEl.classList.add('bullet');
                    bEl.style.left = startX + 'px';
                    bEl.style.top = startY + 'px';
                    board.appendChild(bEl);
                    bullets.push({ el: bEl, row: r, x: startX, speed: 6 });
                    AudioEngine.playShoot();
                }, delay);
            };
            fire(0);
            if (type === 'double') fire(150);
        }

        function moveBullets() {
            bullets.forEach((b, bIdx) => {
                b.x += b.speed;
                b.el.style.left = b.x + 'px';
                let hit = false;
                for (let i = zombies.length - 1; i >= 0; i--) {
                    const z = zombies[i];
                    if (b.row === z.row && b.x > z.x && b.x < z.x + 40) {
                        hit = true; z.hp--; 
                        z.el.style.opacity = 0.5; setTimeout(() => z.el.style.opacity = 1, 100);
                        AudioEngine.playHit();
                        if (z.hp <= 0) { z.el.remove(); zombies.splice(i, 1); }
                        break;
                    }
                }
                if (hit || b.x > cols * cellSize) { b.el.remove(); bullets.splice(bIdx, 1); }
            });
        }

        function updateUI() {
            sunDisplay.textContent = sun;
            levelDisplay.textContent = currentLevelIndex + 1;
            waveDisplay.textContent = levels[currentLevelIndex].zombies - zombiesSpawned;
        }

        resizeGame();
    </script>
</body>
</html>