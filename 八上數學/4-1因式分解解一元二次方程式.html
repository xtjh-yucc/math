<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å› å¼åˆ†è§£è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼ å­¸ç¿’å¤¥ä¼´</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨ Inter å­—é«” -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ç¢ºä¿ pre å€å¡Šçš„æ’ç‰ˆï¼Œæ¨¡ä»¿åœ‹ä¸­å°åˆ·é«” */
        pre {
            white-space: pre-wrap;
            font-size: 1rem;
            line-height: 1.6;
            font-family: sans-serif; /* ä½¿ç”¨æ¨™æº–å­—é«”ä»¥ç¢ºä¿ xÂ² ç­‰ç¬¦è™Ÿé¡¯ç¤ºæ­£å¸¸ */
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div id="app" class="flex justify-center items-start min-h-screen">
        <!-- æ‡‰ç”¨ç¨‹å¼å…§å®¹å°‡ç”± JavaScript æ¸²æŸ“åˆ°é€™è£¡ -->
        <div class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-6">
            <div class="flex justify-center items-center h-40">
                <p class="text-xl font-semibold text-gray-500 animate-pulse">
                    æ­£åœ¨è¼‰å…¥å­¸ç¿’å¤¥ä¼´...
                </p>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™èˆ‡è¨­å®š ---
        const learningTopics = [
            { 
                id: 1, 
                title: "1. åˆ¤åˆ¥ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼èˆ‡è§£", 
                focus: "æ¦‚å¿µ",
                examplePrompt: "é¡Œç›®å¿…é ˆæ˜¯åˆ¤æ–·æŸå€‹æ•¸æ˜¯å¦ç‚ºä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼çš„è§£ï¼Œä¾‹å¦‚ï¼šåˆ¤æ–· 5 æ˜¯å¦ç‚ºæ–¹ç¨‹å¼ 2xÂ²ï¼10ï¼8x çš„è§£ï¼Ÿ"
            },
            { 
                id: 2, 
                title: "2. è‹¥AÃ—Bï¼0ï¼Œå‰‡Aï¼0æˆ–Bï¼0", 
                focus: "é›¶ç©æ€§è³ª",
                examplePrompt: "é¡Œç›®å¿…é ˆæ˜¯æ‡‰ç”¨é›¶ç©æ€§è³ªæ±‚è§£ï¼Œä¾‹å¦‚ï¼šæ±‚è§£æ–¹ç¨‹å¼ (xï¼6)(xï¼2)ï¼0ã€‚è«‹ç¢ºä¿æ–¹ç¨‹å¼å·²ç¶“æ˜¯å› å¼åˆ†è§£å½¢å¼ä¸¦ç­‰æ–¼é›¶ã€‚"
            },
            { 
                id: 3, 
                title: "3. åˆ©ç”¨æå‡ºå…¬å› å¼è§£æ–¹ç¨‹å¼", 
                focus: "å…¬å› å¼æ³•",
                examplePrompt: "é¡Œç›®å¿…é ˆæ˜¯åˆ©ç”¨æå‡ºå…¬å› å¼çš„æ–¹æ³•æ±‚è§£ï¼Œä¾‹å¦‚ï¼šæ±‚è§£ 3xÂ²ï¼‹9xï¼0ï¼Œæˆ– (2xï¼1)(xï¼‹3)ï¼4(xï¼‹3)ï¼0 ç­‰å¯ä»¥æå‡ºå…¬å› å¼çš„æ–¹ç¨‹å¼ã€‚"
            },
            { 
                id: 4, 
                title: "4. åˆ©ç”¨åå­—äº¤ä¹˜æ³•è§£æ–¹ç¨‹å¼", 
                focus: "åå­—äº¤ä¹˜æ³•",
                examplePrompt: "é¡Œç›®å¿…é ˆæ˜¯åˆ©ç”¨åå­—äº¤ä¹˜æ³•æ±‚è§£ã€‚è«‹ç¢ºä¿é¡Œç›®å„ªå…ˆç”Ÿæˆå¹³æ–¹é …ä¿‚æ•¸ç‚º 1 çš„å½¢å¼ (ä¾‹å¦‚ï¼šxÂ²ï¼‹xï¼2ï¼0 æˆ– xÂ²ï¼ï¼•xï¼‹ï¼–ï¼0)ï¼Œç„¶å¾Œé€æ­¥ç´å…¥ä¿‚æ•¸ä¸ç‚º 1 æˆ–æœªæ•´ç†æˆç­‰æ–¼é›¶çš„å½¢å¼ (ä¾‹å¦‚ï¼š4xÂ²ï¼2xï¼30ã€ï¼10xÂ²ï¼15xï¼ï¼25)ã€‚**æ¥µåº¦é‡è¦ï¼šè«‹ç¢ºä¿æ¯é“é¡Œç›®åœ¨æ•¸å­—ã€ä¿‚æ•¸å’Œæ–¹ç¨‹å¼é¡å‹ä¸Šå…·å‚™é«˜å¤šæ¨£æ€§ï¼Œåˆ‡å‹¿é€£çºŒå‡ºç›¸ä¼¼çš„é¡Œç›®ã€‚**"
            },
            { 
                id: 5, 
                title: "5. åˆ©ç”¨ä¹˜æ³•å…¬å¼è§£æ–¹ç¨‹å¼", 
                focus: "ä¹˜æ³•å…¬å¼",
                examplePrompt: "é¡Œç›®å¿…é ˆæ˜¯åˆ©ç”¨ä¹˜æ³•å…¬å¼æ±‚è§£ã€‚è«‹ç¢ºä¿é¡Œç›®æ¶µè“‹ä»¥ä¸‹ä¸‰ç¨®åŸºæœ¬é¡Œå‹ï¼š(a+b)Â²=0, (a-b)Â²=0, ä»¥åŠ (a+b)(a-b)=0ï¼ˆå¹³æ–¹å·®ï¼‰ã€‚**è«‹å‹™å¿…åœ¨é€£çºŒçš„é¡Œç›®ä¸­è¼ªæµç”Ÿæˆé€™ä¸‰ç¨®é¡Œå‹ï¼Œä»¥ç¢ºä¿å‰äº”é¡Œè¦†è“‹æ‰€æœ‰é¡å‹ã€‚** å¦‚æœè§£ç‚ºé‡æ ¹ï¼Œè«‹åœ¨é¸é …æˆ–è§£æä¸­æ˜ç¢ºæ¨™ç¤ºç‚ºã€Œx = k (é‡æ ¹)ã€æˆ–ã€Œx = k æˆ– x = kã€ã€‚"
            },
            { 
                id: 6, 
                title: "6. ç¶œåˆæ‡‰ç”¨ (é€²éš)", 
                focus: "ç¶œåˆæ‡‰ç”¨",
                examplePrompt: "é¡Œç›®å¿…é ˆæ˜¯ç¶œåˆæ‡‰ç”¨é¡Œå‹ï¼Œä¾‹å¦‚ï¼šæ±‚è§£ (xï¼4)(xï¼‹5)ï¼10 (å…ˆå±•é–‹å†åˆ†è§£)ï¼Œæˆ–å·²çŸ¥ä¸€æ ¹ç‚ºï¼2æ±‚å¦ä¸€æ ¹ï¼Œæˆ–å·²çŸ¥å…©æ ¹æ±‚ä¿‚æ•¸ a, b çš„å€¼ç­‰è¤‡é›œæ‡‰ç”¨é¡Œå‹ã€‚"
            },
        ];

        const CORRECT_TO_PASS = 5;
        const API_KEY = ""; // Canvas å°‡åœ¨é‹è¡Œæ™‚è‡ªå‹•æä¾›
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;


        // --- ç‹€æ…‹ç®¡ç† (ä½¿ç”¨ vanilla JS ç‰©ä»¶) ---
        let state = {
            selectedTopicId: 4, // é è¨­é¸ä¸­ä¸»é¡Œ 4
            currentTopic: learningTopics.find(t => t.id === 4),
            quizState: {
                correctCount: 0,
                totalQuestions: 0,
                hasPassed: false,
                questionHistory: [] // ç”¨æ–¼è¿½è¹¤ç¬¬ 4 é—œçš„é¡Œç›®æ­·å²
            },
            currentQuestionData: null,
            userAnswerIndex: null,
            isAnswerSubmitted: false,
            userNotes: "",
            aiResponse: "",
            isLoading: false
        };

        // ç‹€æ…‹æ›´æ–°å‡½æ•¸ (æ¨¡æ“¬ React çš„ useState)
        function setState(newState) {
            state = { ...state, ...newState };
            renderApp(); // æ¯æ¬¡ç‹€æ…‹æ”¹è®Šæ™‚é‡æ–°æ¸²æŸ“
        }
        
        function setQuizState(newQuizState) {
            state.quizState = { ...state.quizState, ...newQuizState };
            renderApp();
        }


        // --- è¼”åŠ©å‡½æ•¸ï¼šAPI å‘¼å«èˆ‡é‡è©¦é‚è¼¯ ---
        async function fetchWithRetry(payload) {
            let response;
            let retries = 0;
            const maxRetries = 5;
            let delay = 1000;

            while (retries < maxRetries) {
                try {
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response;
                    }

                    if (response.status === 429 || response.status >= 500) {
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
                    }
                } catch (error) {
                    if (retries >= maxRetries - 1) {
                         throw error;
                    }
                    retries++;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }

            throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸`);
        }

        // --- æ ¸å¿ƒé‚è¼¯å‡½æ•¸ ---

        // 1. AI ç”¢ç”Ÿæ¸¬é©—é¡Œç›® (ä½¿ç”¨ JSON çµæ§‹åŒ–è¼¸å‡º)
        async function generateQuizQuestion(topicId = state.selectedTopicId) {
            setState({ isLoading: true, isAnswerSubmitted: false, userAnswerIndex: null, currentQuestionData: null });
            
            const topic = learningTopics.find(t => t.id === topicId);
            if (!topic) {
                setState({ aiResponse: "æ‰¾ä¸åˆ°è©²ä¸»é¡Œçš„è³‡æ–™ã€‚", isLoading: false });
                return;
            }

            const systemPrompt = "ä½ æ˜¯ä¸€ä½å‹å–„ä¸”å°ˆæ¥­çš„åœ‹ä¸­æ•¸å­¸è€å¸«ï¼Œå°ˆé–€è¨­è¨ˆã€Œå› å¼åˆ†è§£è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼ã€çš„é¸æ“‡é¡Œã€‚è«‹ç¢ºä¿é¡Œç›®å…§å®¹å’Œè§£æ**åš´æ ¼éµå®ˆ**åœ‹ä¸­å°åˆ·æ ¼å¼ï¼Œ**ä¸ä½¿ç”¨** ä»»ä½• Markdown èªæ³•ï¼ˆä¾‹å¦‚ï¼š`*`ã€`###`ï¼‰æˆ–ä»»ä½• LaTeX ç¬¦è™Ÿï¼ˆä¾‹å¦‚ï¼š`$x^2$`ï¼‰ã€‚é¡Œç›®å¿…é ˆæ˜¯é¸æ“‡é¡Œï¼Œä¸¦æœ‰å››å€‹é¸é …ï¼Œå…¶ä¸­åŒ…å«ä¸€å€‹æ­£ç¢ºç­”æ¡ˆã€‚";
            
            const currentQCount = state.quizState.totalQuestions;
            const isTopic5 = topicId === 5;
            
            let repetitionGuard = "";
            if (topicId === 4) {
                // ç¬¬ 4 é—œï¼šé¿å…é‡è¤‡
                const history = state.quizState.questionHistory.slice(-3).join(", ");
                repetitionGuard = `**è«‹å‹™å¿…ç¢ºä¿æ­¤é¡Œèˆ‡æ‚¨ä¹‹å‰ç”Ÿæˆçš„é¡Œç›®ï¼ˆä¾‹å¦‚ï¼š${history}ï¼‰åœ¨æ•¸å€¼å’Œçµæ§‹ä¸Šé¡¯è‘—ä¸åŒã€‚**`;
            }
            
            // ç¬¬ 5 é—œï¼šå¼·åˆ¶åˆ†é…ä¸‰ç¨®é¡Œå‹
            let topic5DistributionHint = "";
            if (isTopic5 && currentQCount < 5) {
                topic5DistributionHint = `é€™æ˜¯ç¬¬ ${currentQCount + 1} é¡Œã€‚è«‹ç¢ºä¿é¡Œç›®é¡å‹åœ¨ (a+b)Â²=0ã€(a-b)Â²=0 å’Œ (a+b)(a-b)=0 ä¸‰ç¨®å½¢å¼ä¸­è¼ªæµç”Ÿæˆï¼Œä»¥é”åˆ°å‡è¡¡ç·´ç¿’çš„ç›®çš„ã€‚`;
            }

            const userQuery = `è«‹ç‚ºä¸»é¡Œã€Œ${topic.title}ã€è¨­è¨ˆä¸€é¡Œé¸æ“‡é¡Œã€‚é¡Œç›®å¿…é ˆåŒ…å«ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼çš„è§£æ³•ï¼Œä¸¦æ¸¬è©¦å­¸ç”Ÿå°è©²ä¸»é¡Œçš„ç†è§£ã€‚è«‹åš´æ ¼åƒè€ƒä»¥ä¸‹é¡Œå‹ç¯„ä¾‹ä¾†è¨­è¨ˆé¡Œç›®ï¼š${topic.examplePrompt}ã€‚${repetitionGuard}${topic5DistributionHint}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "question": { "type": "STRING", "description": "æ•¸å­¸é¸æ“‡é¡Œçš„é¡Œç›®å…§å®¹ï¼Œä½¿ç”¨å°åˆ·æ ¼å¼ xÂ²" },
                            "options": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" },
                                "description": "å››å€‹éš¨æ©Ÿæ’åˆ—çš„é¸é …ï¼ŒåŒ…å«ä¸€å€‹æ­£ç¢ºç­”æ¡ˆ"
                            },
                            "correctAnswerIndex": { "type": "NUMBER", "description": "æ­£ç¢ºç­”æ¡ˆåœ¨ options é™£åˆ—ä¸­çš„ç´¢å¼•ï¼ˆå¾ 0 é–‹å§‹ï¼‰" },
                            "explanation": { "type": "STRING", "description": "è©³ç´°çš„è§£é¡Œæ­¥é©Ÿå’Œè§£æï¼Œå¿…é ˆåš´æ ¼éµå®ˆåœ‹ä¸­å°åˆ·æ ¼å¼ï¼Œä¸ä½¿ç”¨ Markdown æˆ– LaTeX" }
                        },
                        propertyOrdering: ["question", "options", "correctAnswerIndex", "explanation"]
                    }
                }
            };

            try {
                const response = await fetchWithRetry(payload);
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    const parsedData = JSON.parse(jsonText);
                    
                    // æ›´æ–°æ­·å²è¨˜éŒ„å’Œè¨ˆæ•¸
                    setQuizState({ 
                        totalQuestions: state.quizState.totalQuestions + 1,
                        questionHistory: [...state.quizState.questionHistory, parsedData.question] // è¨˜éŒ„é¡Œç›®å…§å®¹
                    });
                    
                    setState({ currentQuestionData: parsedData, aiResponse: "" });

                } else {
                    setState({ aiResponse: "æŠ±æ­‰ï¼ŒAI æš«æ™‚ç„¡æ³•ç”Ÿæˆé¡Œç›®ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", currentQuestionData: null });
                }
            } catch (error) {
                console.error("AI é¡Œç›®ç”Ÿæˆå¤±æ•—:", error);
                setState({ aiResponse: `ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`, currentQuestionData: null });
            } finally {
                setState({ isLoading: false });
            }
        }

        // 2. åˆ‡æ›ä¸»é¡Œï¼ˆé–‹å§‹æ–°çš„æ¸¬é©—ï¼‰
        function handleTopicSelect(topicId) {
            if (state.isLoading) return;
            const newTopic = learningTopics.find(t => t.id === topicId);

            setState({
                selectedTopicId: topicId,
                currentTopic: newTopic,
                userNotes: "",
                aiResponse: "",
                currentQuestionData: null,
                userAnswerIndex: null,
                isAnswerSubmitted: false,
            });

            setQuizState({ correctCount: 0, totalQuestions: 0, hasPassed: false, questionHistory: [] });
            
            // ç«‹å³ç”Ÿæˆç¬¬ä¸€é“é¡Œ
            generateQuizQuestion(topicId);
        }

        // 3. è™•ç†å­¸ç”Ÿé¸æ“‡ç­”æ¡ˆ
        function handleAnswer(index) {
            if (state.isAnswerSubmitted || state.isLoading) return;
            setState({ userAnswerIndex: index });
        }
        
        // 4. æäº¤ç­”æ¡ˆä¸¦é¡¯ç¤ºå›é¥‹
        function handleSubmitAnswer() {
            if (state.userAnswerIndex === null || state.isAnswerSubmitted) return;
            
            setState({ isAnswerSubmitted: true });
            
            const isCorrect = state.userAnswerIndex === state.currentQuestionData.correctAnswerIndex;
            
            if (isCorrect) {
                const newCorrectCount = state.quizState.correctCount + 1;
                const hasPassed = newCorrectCount >= CORRECT_TO_PASS;
                
                setQuizState({ 
                    correctCount: newCorrectCount,
                    hasPassed: hasPassed
                });
            }
        }

        // 5. ä¸‹ä¸€é¡Œï¼ˆç¹¼çºŒç”Ÿæˆæ–°é¡Œç›®ï¼‰
        function handleNextQuestion() {
            if (state.quizState.hasPassed) {
                setQuizState({ hasPassed: false });
            }
            generateQuizQuestion(state.selectedTopicId);
        }
        
        // 6. AI ç”¢ç”Ÿè§€å¿µè§£æ (å‚™ç”¨åŠŸèƒ½)
        async function handleAIGenerateConcept() {
            setState({ isLoading: true, aiResponse: "" });
            
            const topic = learningTopics.find(t => t.id === state.selectedTopicId);
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å‹å–„ä¸”å°ˆæ¥­çš„åœ‹ä¸­æ•¸å­¸è€å¸«ï¼Œå°ˆé–€ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚ä½ çš„ä»»å‹™æ˜¯æ¸…æ™°åœ°è§£é‡‹ã€Œå› å¼åˆ†è§£è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼ã€çš„ç‰¹å®šä¸»é¡Œã€‚\n\n**æ ¼å¼è¦æ±‚ (éå¸¸é‡è¦)ï¼š**\n1.  **è«‹å‹¿ä½¿ç”¨** ä»»ä½• Markdown èªæ³•ï¼Œä¾‹å¦‚ `###` (æ¨™é¡Œ), `*` (ç²—é«”/æ¸…å–®), `-` (æ¸…å–®)ã€‚\n2.  **è«‹å‹¿ä½¿ç”¨** ä»»ä½• LaTeX æ•¸å­¸ç¬¦è™Ÿï¼Œä¾‹å¦‚ `$x^2$` æˆ– `$$...$$`ã€‚\n3.  **è«‹å‹¿ä½¿ç”¨** `^` ç¬¦è™Ÿä¾†è¡¨ç¤ºå¹³æ–¹ï¼Œä¾‹å¦‚ `x^2`ã€‚\n4.  **è«‹å‹™å¿…ä½¿ç”¨** åœ‹ä¸­ç”Ÿç¿’æ…£çš„å°åˆ·æ’ç‰ˆæ ¼å¼ï¼Œä¾‹å¦‚ `xÂ²` (å¹³æ–¹), `+` (åŠ è™Ÿ), `-` (æ¸›è™Ÿ)ï¼Œä¸¦ä½¿ç”¨é©ç•¶çš„æ›è¡Œå’Œç©ºæ ¼ä¾†åˆ†éš”æ­¥é©Ÿã€‚\n5.  è«‹ç›´æ¥ä½¿ç”¨ç´”æ–‡å­—å’Œé©ç•¶çš„æ›è¡Œä¾†æ’ç‰ˆï¼Œæ¨¡æ“¬åœ¨èª²æœ¬æˆ–è¬›ç¾©ä¸Šçœ‹åˆ°çš„æ¨£å­ã€‚\n\n**ä»»å‹™å…§å®¹ï¼š**\nè«‹æ ¹æ“šä½¿ç”¨è€…é¸å®šçš„ä¸»é¡Œï¼Œè©³ç´°è§£é‡‹è©²è§€å¿µä¸¦æä¾›ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹çš„å®Œæ•´è§£é¡Œéç¨‹ã€‚";
            
            const userQuery = `è«‹é‡å°ä¸»é¡Œ ${topic.title} è©³ç´°è§£é‡‹è§€å¿µä¸¦æä¾›ç¯„ä¾‹è§£èªªã€‚`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(payload);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                setState({ aiResponse: text || "AI æ¦‚å¿µè§£æå¤±æ•—ã€‚" });
            } catch (error) {
                setState({ aiResponse: `ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}` });
            } finally {
                setState({ isLoading: false });
            }
        }


        // --- æ¸²æŸ“å‡½æ•¸ ---
        function renderApp() {
            const app = document.getElementById('app');
            if (!app) return;

            const { 
                currentTopic, 
                selectedTopicId, 
                quizState, 
                currentQuestionData, 
                userAnswerIndex, 
                isAnswerSubmitted, 
                userNotes, 
                aiResponse, 
                isLoading 
            } = state;

            // è¼”åŠ©å‡½å¼ï¼šå–å¾—é¸é …æŒ‰éˆ•çš„æ¨£å¼
            const getOptionClasses = (index) => {
                const isCorrect = isAnswerSubmitted && index === currentQuestionData.correctAnswerIndex;
                const isUserSelected = index === userAnswerIndex;
                const isWrong = isAnswerSubmitted && isUserSelected && !isCorrect;

                if (!isAnswerSubmitted) {
                    return isUserSelected 
                        ? 'bg-blue-200 ring-4 ring-blue-500 shadow-lg' 
                        : 'bg-white hover:bg-gray-50';
                }
                
                if (isCorrect) {
                    return 'bg-green-100 border-4 border-green-500 text-green-700 font-bold shadow-xl';
                } else if (isWrong) {
                    return 'bg-red-100 border-4 border-red-500 text-red-700 font-bold shadow-xl';
                } else {
                    return 'bg-gray-200 text-gray-500 cursor-not-allowed';
                }
            };

            // æ¸²æŸ“ HTML çµæ§‹
            app.innerHTML = `
                <div class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-6">
                    
                    <!-- æ¨™é¡Œ -->
                    <div class="text-center">
                        <h1 class="text-2xl md:text-3xl font-bold text-red-700">
                            å› å¼åˆ†è§£è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼ å­¸ç¿’å¤¥ä¼´
                        </h1>
                        <p class="text-md text-gray-500 mt-1">äº’å‹•å¼é—–é—œæ¸¬é©—ï¼Œç­”å° ${CORRECT_TO_PASS} é¡Œéé—œï¼</p>
                    </div>
                    
                    <!-- å­¸ç¿’ä¸»é¡Œåˆ‡æ›å€ -->
                    <div class="space-y-3 p-4 border border-gray-300 rounded-lg bg-gray-50">
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">
                            è«‹é¸æ“‡å­¸ç¿’ä¸»é¡Œ (${currentTopic ? currentTopic.title : 'è«‹é¸æ“‡'})
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="topic-buttons">
                            ${learningTopics.map(topic => `
                                <button
                                    onclick="handleTopicSelect(${topic.id})"
                                    ${isLoading && topic.id !== selectedTopicId ? 'disabled' : ''}
                                    class="px-3 py-2 text-sm md:text-base rounded-lg transition duration-150 text-left w-full 
                                        ${topic.id === selectedTopicId 
                                            ? 'bg-purple-700 text-white font-semibold shadow-lg ring-4 ring-purple-300' 
                                            : 'bg-gray-200 text-gray-800 hover:bg-purple-200 disabled:opacity-50'
                                        }"
                                >
                                    ${topic.title}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- æ¸¬é©—å€å¡Š -->
                    <div class="space-y-6">
                        
                        <!-- é¡Œç›®èˆ‡é€²åº¦ -->
                        <div class="p-5 border-2 border-dashed border-gray-400 rounded-xl bg-yellow-50 shadow-inner">
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-xl font-bold text-gray-800">
                                    ç›®å‰é—œå¡ï¼š${currentTopic ? currentTopic.title : 'æœªé¸æ“‡'}
                                </p>
                                <div class="text-lg font-semibold px-3 py-1 rounded-full ${quizState.correctCount >= CORRECT_TO_PASS ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}">
                                    ç­”å° ${quizState.correctCount} / ${CORRECT_TO_PASS} é¡Œ
                                </div>
                            </div>
                            
                            <!-- é¡Œç›®å…§å®¹ -->
                            <h3 class="text-2xl font-bold text-gray-900 leading-relaxed min-h-[100px] flex items-center justify-center text-center">
                                ${isLoading && !currentQuestionData ? (
                                    '<span class="text-blue-500 animate-pulse">æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆé¡Œç›®...</span>'
                                ) : (
                                    currentQuestionData ? currentQuestionData.question : 'è«‹å…ˆé»é¸ä¸Šæ–¹çš„ã€Œè«‹é¸æ“‡å­¸ç¿’ä¸»é¡Œã€æŒ‰éˆ•é–‹å§‹æ¸¬é©—ï¼'
                                )}
                            </h3>
                        </div>
                        
                        <!-- é¸é …å€å¡Š -->
                        ${currentQuestionData ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${currentQuestionData.options.map((option, index) => `
                                    <button
                                        onclick="handleAnswer(${index})"
                                        ${isAnswerSubmitted || isLoading ? 'disabled' : ''}
                                        class="p-4 border-2 rounded-xl text-lg text-left transition-all duration-200 shadow-md ${getOptionClasses(index)}"
                                    >
                                        <span class="font-semibold mr-3 text-purple-700">(${String.fromCharCode(65 + index)})</span>
                                        ${option}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- æ§åˆ¶æŒ‰éˆ•å€ -->
                        <div class="flex justify-center space-x-4 pt-4">
                            ${currentQuestionData && !isAnswerSubmitted ? `
                                <button
                                    onclick="handleSubmitAnswer()"
                                    ${userAnswerIndex === null || isLoading ? 'disabled' : ''}
                                    class="px-6 py-3 bg-red-600 text-white rounded-lg shadow-xl hover:bg-red-700 transition duration-150 disabled:bg-gray-400 font-bold text-lg transform hover:scale-105"
                                >
                                    æäº¤ç­”æ¡ˆ
                                </button>
                            ` : ''}
                            
                            ${currentQuestionData && isAnswerSubmitted ? `
                                <button
                                    onclick="handleNextQuestion()"
                                    ${isLoading ? 'disabled' : ''}
                                    class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-xl hover:bg-green-700 transition duration-150 disabled:bg-gray-400 font-bold text-lg transform hover:scale-105"
                                >
                                    ${quizState.hasPassed ? 'ğŸ‰ æŒ‘æˆ°ä¸‹ä¸€å€‹ä¸»é¡Œ' : 'ä¸‹ä¸€é¡Œ'}
                                </button>
                            ` : ''}
                        </div>

                        <!-- å›é¥‹èˆ‡è§£æå€å¡Š -->
                        ${isAnswerSubmitted && currentQuestionData ? `
                            <div class="mt-6 p-5 rounded-xl border-4 ${userAnswerIndex === currentQuestionData.correctAnswerIndex ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'}">
                                <h4 class="text-xl font-bold mb-3">
                                    ${userAnswerIndex === currentQuestionData.correctAnswerIndex ? 'âœ… æ­å–œä½ ï¼Œç­”å°äº†ï¼' : 'âŒ ç­”éŒ¯äº†ï¼Œæ²’é—œä¿‚ï¼'}
                                </h4>
                                ${quizState.hasPassed ? `
                                    <p class="text-2xl font-black text-purple-700 mb-3 animate-bounce">
                                        ğŸ‰ æ­å–œå®Œæˆæœ¬é—œæŒ‘æˆ°ï¼ä½ å¯ä»¥ç¹¼çºŒç·´ç¿’æˆ–æŒ‘æˆ°ä¸‹ä¸€å€‹ä¸»é¡Œï¼
                                    </p>
                                ` : ''}
                                
                                <h5 class="text-lg font-semibold text-gray-800 mt-4 mb-2">
                                    ğŸ“ è€å¸«çš„è©³ç´°è§£æ (ç¬¦åˆå°åˆ·æ ¼å¼)ï¼š
                                </h5>
                                <pre class="whitespace-pre-wrap font-sans text-gray-800 text-sm md:text-base leading-relaxed p-3 bg-white border border-gray-300 rounded-lg">
                                    ${currentQuestionData.explanation}
                                </pre>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- è£œå……æƒ³æ³• (å­¸ç¿’ç­†è¨˜) -->
                    <div class="space-y-2 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">
                            è£œå……ä½ çš„æƒ³æ³• (å­¸ç¿’ç­†è¨˜)
                        </h3>
                        <textarea
                            id="user-notes"
                            oninput="setState({ userNotes: this.value })"
                            class="w-full h-24 p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-2 focus:ring-blue-400 focus:outline-none"
                            placeholder="ä¾‹å¦‚ï¼šæˆ‘ç™¼ç¾é¡Œç›® 4 å¾ˆå®¹æ˜“å› ç‚ºç¬¦è™ŸéŒ¯èª¤è€Œç®—éŒ¯ï¼Œä»¥å¾Œè¦ç‰¹åˆ¥æ³¨æ„ï¼..."
                        >${userNotes}</textarea>
                    </div>

                    <!-- AI ç”¢ç”Ÿè§€å¿µè§£æ (å‚™ç”¨åŠŸèƒ½) -->
                    <div class="space-y-3">
                        <h3 class="text-lg font-semibold text-gray-800">
                            è®“ AI è€å¸«ç¤ºç¯„ (è§€å¿µè§£æ / ç¯„ä¾‹ç”¢å‡º)
                        </h3>
                        <button
                            onclick="handleAIGenerateConcept()"
                            ${isLoading ? 'disabled' : ''}
                            class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center"
                        >
                            ${isLoading ? `
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                AI è€å¸«æ­£åœ¨æº–å‚™ ${currentTopic ? currentTopic.title : 'è§€å¿µ'} çš„è§£æ...
                            ` : (
                                `å–®ç´”ç”Ÿæˆ ${currentTopic ? currentTopic.title : 'è§€å¿µ'} çš„è§€å¿µè§£æèˆ‡ç¯„ä¾‹`
                            )}
                        </button>
                        
                        ${aiResponse ? `
                            <div class="mt-4 p-4 border border-purple-200 bg-purple-50 rounded-lg">
                                <h4 class="text-md font-semibold text-purple-800 mb-2">AI è€å¸«çš„ç¤ºç¯„/è§£æï¼š</h4>
                                <pre class="whitespace-pre-wrap font-sans text-gray-800 text-sm md:text-base leading-relaxed">
                                    ${aiResponse}
                                </pre>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            // ç¢ºä¿ textarea çš„å€¼è¢«æ­£ç¢ºè¨­ç½®
            document.getElementById('user-notes').value = userNotes;
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        window.onload = function() {
            // ç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼Œé¡¯ç¤ºåˆå§‹ç‹€æ…‹
            renderApp(); 
            // è¼‰å…¥å¾Œé è¨­é¸ä¸­ä¸»é¡Œ 4 ä¸¦é–‹å§‹ç”Ÿæˆç¬¬ä¸€é“é¡Œ
            handleTopicSelect(state.selectedTopicId);
        };

    </script>
</body>
</html>