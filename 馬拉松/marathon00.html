<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡åœ’é¦¬æ‹‰æ¾ç™»éŒ„ç³»çµ± - æ­£å¼ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        .login-card { max-width: 400px; margin: 80px auto; border: none; }
        .header-bar { background-color: #2c3e50; color: white; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .lap-input { width: 80px; text-align: center; font-weight: bold; color: #0d6efd; }
        
        /* å„€è¡¨æ¿èˆ‡æ’åæ¨£å¼ */
        .stat-card { border-radius: 12px; border: none; transition: all 0.2s; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
        .rank-badge { width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-weight: bold; font-size: 0.9rem; margin-right: 10px;}
        .rank-1 { background: linear-gradient(45deg, #FFD700, #FDB931); box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4); }
        .rank-2 { background: linear-gradient(45deg, #E0E0E0, #BDBDBD); box-shadow: 0 2px 5px rgba(192, 192, 192, 0.4); }
        .rank-3 { background: linear-gradient(45deg, #CD7F32, #A0522D); box-shadow: 0 2px 5px rgba(205, 127, 50, 0.4); }
        .rank-other { background-color: #6c757d; }
        
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <div class="header-bar d-flex justify-content-between align-items-center" v-if="currentPage !== 'login'">
        <div class="d-flex align-items-center">
            <h4 class="m-0 fw-bold me-3">ğŸƒ æ ¡åœ’é¦¬æ‹‰æ¾</h4>
            <span class="badge bg-warning text-dark" v-if="userRole === 'admin'">è¶…ç´šç®¡ç†å“¡</span>
            <span class="badge bg-success" v-else>{{ currentClass }} ç­ç´šé¢æ¿</span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="text-end d-none d-md-block">
                <div class="fw-bold">{{ todayDate }}</div>
                <small class="opacity-75">ç³»çµ±æ™‚é–“</small>
            </div>
            <button class="btn btn-outline-light btn-sm" @click="logout">ç™»å‡º</button>
        </div>
    </div>

    <div class="container pb-5">
        
        <div class="card login-card shadow-lg" v-if="currentPage === 'login'">
            <div class="card-header bg-primary text-white text-center py-3">
                <h5 class="m-0 fw-bold">ç³»çµ±ç™»å…¥</h5>
            </div>
            <div class="card-body p-4">
                <div class="mb-3">
                    <label class="form-label">è«‹è¼¸å…¥å¯†ç¢¼</label>
                    <input type="password" class="form-control form-control-lg" v-model="loginInput" @keyup.enter="handleLogin" placeholder="ç­ç´šå¯†ç¢¼ / è¶…ç´šå¯†ç¢¼">
                    <div class="form-text text-muted mt-2">æç¤ºï¼šé è¨­ 1234ï¼Œè¶…ç´šå¯†ç¢¼ xtjh</div>
                </div>
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" @click="handleLogin">ç™»å…¥ç³»çµ±</button>
                </div>
                <div class="alert alert-danger mt-3" v-if="loginError">{{ loginError }}</div>
            </div>
        </div>

        <div v-if="currentPage === 'leader'">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card stat-card shadow-sm h-100 bg-white">
                        <div class="card-body text-center">
                            <h6 class="text-muted text-uppercase fw-bold mb-3">{{ currentClass }} ä»Šæ—¥æˆ°ç¸¾</h6>
                            <h2 class="text-primary fw-bold">{{ myClassTodayLaps }} <small class="fs-6 text-muted">åœˆ</small></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card shadow-sm h-100 bg-white">
                        <div class="card-body text-center">
                            <h6 class="text-muted text-uppercase fw-bold mb-3">ç­ç´šç¸½ç´¯ç©</h6>
                            <h2 class="text-success fw-bold">{{ myClassTotalLaps }} <small class="fs-6 text-muted">åœˆ</small></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card shadow-sm h-100 bg-warning bg-opacity-10">
                        <div class="card-body text-center">
                            <h6 class="text-muted text-uppercase fw-bold mb-3">ç›®å‰å…¨æ ¡ç¬¬ä¸€</h6>
                            <h3 class="fw-bold text-dark">
                                ğŸ‘‘ {{ fullRankings[0]?.class }} ç­ 
                                <span class="fs-6">({{ fullRankings[0]?.total }}åœˆ)</span>
                            </h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="m-0 fw-bold text-primary">ğŸ“ {{ currentClass }} è·‘æ­¥ç™»éŒ„</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">åº§è™Ÿ</th>
                                    <th>å§“å</th>
                                    <th>ä»Šæ—¥åœˆæ•¸</th>
                                    <th class="text-end pe-4">ç´¯ç©</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="student in classStudents" :key="student.id">
                                    <td class="ps-4 fw-bold text-muted">{{ student.seat }}</td>
                                    <td class="fw-bold">{{ student.name }}</td>
                                    <td>
                                        <input type="number" class="form-control lap-input" 
                                               v-model.number="student.todayLaps" min="0" onfocus="this.select()">
                                    </td>
                                    <td class="text-end pe-4">{{ student.totalLaps + (student.todayLaps || 0) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white p-3 text-end">
                    <button class="btn btn-success btn-lg px-4 shadow" @click="saveData">ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„</button>
                </div>
            </div>
        </div>

        <div v-if="currentPage === 'admin'">
            
            <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm">
                <li class="nav-item"><a class="nav-link" :class="{active: adminTab === 'dashboard'}" href="#" @click="adminTab = 'dashboard'">ğŸ“Š æˆ°æƒ…å„€è¡¨æ¿</a></li>
                <li class="nav-item"><a class="nav-link" :class="{active: adminTab === 'data'}" href="#" @click="adminTab = 'data'">ğŸ“ è³‡æ–™ç®¡ç†</a></li>
                <li class="nav-item"><a class="nav-link" :class="{active: adminTab === 'pass'}" href="#" @click="adminTab = 'pass'">ğŸ”‘ å¯†ç¢¼ç®¡ç†</a></li>
                <li class="nav-item"><a class="nav-link" :class="{active: adminTab === 'system'}" href="#" @click="adminTab = 'system'">âš™ï¸ ç³»çµ±ç¶­è­·</a></li>
            </ul>

            <div v-if="adminTab === 'dashboard'">
                <div class="row g-3">
                    <div class="col-md-12 mb-3">
                        <div class="card text-white bg-primary shadow-sm">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div><h5 class="card-title opacity-75">å…¨æ ¡ç¸½ç´¯ç©åœˆæ•¸</h5><h1 class="display-4 fw-bold">{{ totalSchoolLaps }}</h1></div>
                                <div class="opacity-50"><span style="font-size:3rem">ğŸ†</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white py-3"><h5 class="m-0 fw-bold">ğŸ† å…¨æ ¡ç­ç´šæ’è¡Œæ¦œ</h5></div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr><th class="ps-4">æ’å</th><th>ç­ç´š</th><th>ç´¯ç©åœˆæ•¸</th><th class="text-end pe-4">æ“ä½œ</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(rank, index) in fullRankings" :key="rank.class" :class="{'table-warning': index < 3}">
                                                <td class="ps-4"><span class="rank-badge" :class="index < 3 ? 'rank-' + (index+1) : 'rank-other'">{{ index + 1 }}</span></td>
                                                <td class="fw-bold fs-5">{{ rank.class }}</td>
                                                <td class="fw-bold text-primary">{{ rank.total }}</td>
                                                <td class="text-end pe-4"><button class="btn btn-sm btn-outline-primary" @click="viewClassDetails(rank.class)">æŸ¥çœ‹æ˜ç´°</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="adminTab === 'data'">
                <div class="card border-danger mb-4 shadow-sm">
                    <div class="card-header bg-danger text-white fw-bold">âš ï¸ å±éšªæ“ä½œå€ï¼šå­¸æœŸé‡ç½®</div>
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div class="text-danger">
                            <strong>æ­£å¼å•Ÿç”¨å‰è«‹åŸ·è¡Œæ­¤æ­¥é©Ÿï¼</strong><br>
                            æ­¤å‹•ä½œå°‡æŠŠå…¨æ ¡å­¸ç”Ÿçš„ã€Œç´¯ç©åœˆæ•¸ã€å…¨éƒ¨è¨­ç‚º 0ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚
                        </div>
                        <button class="btn btn-danger btn-lg shadow" @click="resetAllLaps">
                            âš ï¸ ä¸€éµå…¨æ ¡æ­¸é›¶
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="m-0 fw-bold">ç­ç´šè³‡æ–™ç·¨è¼¯</h5>
                            <select class="form-select w-auto" v-model="selectedAdminClass">
                                <option value="" disabled>è«‹é¸æ“‡ç­ç´š</option>
                                <option v-for="cls in classList" :value="cls">{{ cls }} ç­</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body" v-if="selectedAdminClass">
                        <table class="table table-bordered table-striped">
                            <thead><tr><th>åº§è™Ÿ</th><th>å§“å</th><th>ç›®å‰ç¸½åœˆæ•¸</th><th>æ“ä½œ</th></tr></thead>
                            <tbody>
                                <tr v-for="stu in getStudentsByClass(selectedAdminClass)" :key="stu.id">
                                    <td><input v-model="stu.seat" class="form-control form-control-sm"></td>
                                    <td><input v-model="stu.name" class="form-control form-control-sm"></td>
                                    <td><input type="number" v-model="stu.totalLaps" class="form-control form-control-sm"></td>
                                    <td><button class="btn btn-sm btn-danger" @click="removeStudent(stu.id)">åˆªé™¤</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button class="btn btn-primary" @click="saveData">å„²å­˜ä¿®æ”¹</button>
                    </div>
                    <div class="card-body text-center text-muted py-5" v-else>è«‹é¸æ“‡ç­ç´šä»¥ç·¨è¼¯å­¸ç”Ÿè³‡æ–™</div>
                </div>
            </div>

            <div v-if="adminTab === 'pass'">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
                        <span>ğŸ”‘ ç­ç´šç™»å…¥å¯†ç¢¼ç®¡ç†</span>
                        <div>
                            <button class="btn btn-sm btn-warning me-2" @click="randomizePasswords">ğŸ² éš¨æ©Ÿé‡è¨­æ‰€æœ‰å¯†ç¢¼</button>
                            <button class="btn btn-sm btn-success" @click="exportPasswordsExcel">ğŸ“¥ åŒ¯å‡ºå¯†ç¢¼ Excel</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info py-2 small">
                            ğŸ’¡ æç¤ºï¼šé»æ“Šã€Œéš¨æ©Ÿé‡è¨­ã€å¾Œï¼Œè«‹è¨˜å¾—é»æ“Šã€ŒåŒ¯å‡ºå¯†ç¢¼ã€ä¸‹è¼‰ Excel æª”åˆ†ç™¼çµ¦å„ç­é«”è‚²çµ„é•·ã€‚
                        </div>
                        <div class="table-responsive">
                            <table class="table align-middle table-striped">
                                <thead><tr><th>ç­ç´š</th><th>ç›®å‰å¯†ç¢¼</th></tr></thead>
                                <tbody>
                                    <tr v-for="(pwd, cls) in classPasswords" :key="cls">
                                        <td class="fw-bold">{{ cls }}</td>
                                        <td><input type="text" class="form-control font-monospace" v-model="classPasswords[cls]"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-dark float-end mt-3" @click="saveData">æ›´æ–°å¯†ç¢¼è¨­å®š</button>
                    </div>
                </div>
            </div>

             <div v-if="adminTab === 'system'">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-success text-white fw-bold">ğŸ“‚ Excel å­¸ç”Ÿè³‡æ–™åŒ¯å…¥</div>
                            <div class="card-body">
                                <p class="card-text text-muted">åŒ¯å…¥æ–°å­¸æœŸçš„å­¸ç”Ÿåå–®ã€‚</p>
                                <button class="btn btn-outline-success btn-sm mb-3" @click="downloadSampleExcel">â¬‡ï¸ ä¸‹è¼‰ç¯„ä¾‹æ ¼å¼</button>
                                <input type="file" class="form-control mb-3" @change="handleFileUpload" accept=".xlsx, .xls">
                                <button class="btn btn-success w-100" :disabled="!uploadedFile" @click="processImport">ç¢ºèªåŒ¯å…¥è³‡æ–™</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-secondary text-white fw-bold">ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</div>
                            <div class="card-body">
                                <button class="btn btn-dark w-100 mb-3" @click="backupData">â¬‡ï¸ ä¸‹è¼‰ç³»çµ±å‚™ä»½æª”</button>
                                <div class="input-group">
                                    <input type="file" class="form-control" ref="backupInput" accept=".json">
                                    <button class="btn btn-outline-secondary" @click="restoreData">é‚„åŸ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="showDetailModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold">{{ detailClass }} ç­æ˜ç´°</h5>
                            <button type="button" class="btn-close" @click="showDetailModal = false"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table table-sm table-striped">
                                <thead><tr><th>åº§è™Ÿ</th><th>å§“å</th><th>ç´¯ç©åœˆæ•¸</th></tr></thead>
                                <tbody>
                                    <tr v-for="s in getStudentsByClass(detailClass)" :key="s.id"><td>{{ s.seat }}</td><td>{{ s.name }}</td><td class="fw-bold">{{ s.totalLaps }}</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            currentPage: 'login',
            userRole: '',
            loginInput: '',
            loginError: '',
            currentClass: '',
            adminTab: 'dashboard',
            selectedAdminClass: '',
            showDetailModal: false,
            detailClass: '',
            uploadedFile: null,
            classPasswords: { '701': '1234', '702': '1234', '703': '1234', '704': '1234', '705': '1234' },
            students: [],
            classList: ['701', '702', '703', '704', '705']
        }
    },
    computed: {
        todayDate() {
            const d = new Date();
            const days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} (é€±${days[d.getDay()]})`;
        },
        classStudents() {
            return this.students.filter(s => s.class === this.currentClass).sort((a, b) => a.seat - b.seat);
        },
        myClassTodayLaps() {
            return this.classStudents.reduce((sum, s) => sum + (s.todayLaps || 0), 0);
        },
        myClassTotalLaps() {
            return this.classStudents.reduce((sum, s) => sum + s.totalLaps + (s.todayLaps || 0), 0);
        },
        fullRankings() {
            const ranks = this.classList.map(cls => {
                const clsStudents = this.students.filter(s => s.class === cls);
                const total = clsStudents.reduce((sum, s) => {
                    const pending = (s.class === this.currentClass) ? (s.todayLaps || 0) : 0;
                    return sum + s.totalLaps + pending;
                }, 0);
                return { class: cls, total: total };
            });
            return ranks.sort((a, b) => b.total - a.total);
        },
        totalSchoolLaps() {
            return this.fullRankings.reduce((sum, r) => sum + r.total, 0);
        }
    },
    created() {
        this.generateMockData();
    },
    methods: {
        generateMockData() {
            const namesPool = [
                ['ç‹å°æ˜', 'å¼µé˜¿ç¾', 'æå¤§è¯'], ['é™³å¿—è±ª', 'æ—é›…å©·', 'é»ƒåœ‹å¼·'], 
                ['åŠ‰å®¶è±ª', 'æ¥Šæ€¡å›', 'å³å† å®‡'], ['è”¡å®—ç¿°', 'è¨±æ·‘èŠ¬', 'é„­å©·å©·'], ['è¬å‡±æ–‡', 'æ´ªä½©çŠ', 'æ›¾æ¬£æ€¡']
            ];
            const baseLaps = [120, 300, 180, 90, 220]; 
            this.students = [];
            this.classList.forEach((cls, index) => {
                namesPool[index].forEach((name, i) => {
                    this.students.push({
                        id: cls + '_' + (i+1),
                        class: cls,
                        seat: i + 1,
                        name: name,
                        totalLaps: Math.floor(baseLaps[index] / 3) + Math.floor(Math.random() * 20),
                        todayLaps: 0
                    });
                });
            });
        },
        handleLogin() {
            this.loginError = '';
            if (this.loginInput === 'xtjh') {
                this.userRole = 'admin'; this.currentPage = 'admin'; this.adminTab = 'dashboard'; return;
            }
            const foundClass = Object.entries(this.classPasswords).find(([cls, pwd]) => pwd === this.loginInput);
            if (foundClass) {
                this.userRole = 'leader'; this.currentClass = foundClass[0]; this.currentPage = 'leader';
            } else {
                this.loginError = 'å¯†ç¢¼éŒ¯èª¤ã€‚';
            }
        },
        logout() {
            this.currentPage = 'login'; this.loginInput = ''; this.userRole = ''; this.currentClass = '';
        },
        getStudentsByClass(cls) {
            return this.students.filter(s => s.class === cls).sort((a, b) => a.seat - b.seat);
        },
        viewClassDetails(cls) {
            this.detailClass = cls; this.showDetailModal = true;
        },
        removeStudent(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ')) this.students = this.students.filter(s => s.id !== id);
        },
        saveData() {
            if (this.userRole === 'leader') {
                this.classStudents.forEach(s => {
                    if(s.todayLaps > 0) { s.totalLaps += s.todayLaps; s.todayLaps = 0; }
                });
            }
            alert('è³‡æ–™å·²å„²å­˜ï¼');
        },

        // --- æ–°å¢çš„åŠŸèƒ½å€å¡Š ---

        // 1. ä¸€éµæ­¸é›¶
        resetAllLaps() {
            if (confirm("âš ï¸ å±éšªè­¦å‘Š âš ï¸\n\né€™å°‡æŠŠã€Œå…¨æ ¡æ‰€æœ‰å­¸ç”Ÿã€çš„è·‘æ­¥åœˆæ•¸å…¨éƒ¨æ­¸é›¶ï¼\n\né€šå¸¸ç”¨æ–¼æ–°å­¸æœŸé–‹å§‹æˆ–æ­£å¼å•Ÿç”¨å‰ã€‚\n\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) {
                if (confirm("ğŸš¨ å†æ¬¡ç¢ºèª ğŸš¨\n\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼\n\næ‚¨çœŸçš„è¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
                    this.students.forEach(s => {
                        s.totalLaps = 0;
                        s.todayLaps = 0;
                    });
                    alert("å…¨æ ¡è³‡æ–™å·²æˆåŠŸæ­¸é›¶ã€‚");
                }
            }
        },

        // 2. éš¨æ©Ÿç”¢ç”Ÿå¯†ç¢¼ (4ä½æ•¸å­—+è‹±æ–‡æ··åˆï¼Œé¿å…å¤ªå®¹æ˜“è¢«çŒœåˆ°ï¼Œä¹Ÿä¸æœƒå¤ªé›£æ‰“)
        randomizePasswords() {
            if (confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰ç­ç´šçš„å¯†ç¢¼é‡è¨­ç‚ºéš¨æ©Ÿäº‚ç¢¼å—ï¼Ÿ\n\né‡è¨­å¾Œï¼ŒèˆŠå¯†ç¢¼å°‡å¤±æ•ˆã€‚")) {
                for (const cls in this.classPasswords) {
                    // ç”¢ç”Ÿ 4 ä½æ•¸äº‚ç¢¼ (æ“·å– Base36 å­—ä¸²)
                    const randomPwd = Math.random().toString(36).substring(2, 6); 
                    this.classPasswords[cls] = randomPwd;
                }
                alert("æ‰€æœ‰ç­ç´šå¯†ç¢¼å·²æ›´æ–°ï¼\nè«‹å‹™å¿…é»æ“Šã€ŒåŒ¯å‡ºå¯†ç¢¼ Excelã€ä»¥ä¸‹è¼‰æ–°å¯†ç¢¼è¡¨ã€‚");
            }
        },

        // 3. åŒ¯å‡ºå¯†ç¢¼ Excel
        exportPasswordsExcel() {
            // è½‰æ›è³‡æ–™æ ¼å¼
            const data = Object.entries(this.classPasswords).map(([cls, pwd]) => ({
                'ç­ç´š': cls,
                'ç™»å…¥å¯†ç¢¼': pwd
            }));
            
            // å»ºç«‹å·¥ä½œè¡¨
            const ws = XLSX.utils.json_to_sheet(data);
            // è¨­å®šæ¬„å¯¬ (ç¾è§€ç”¨)
            ws['!cols'] = [{ wch: 10 }, { wch: 20 }];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å„ç­å¯†ç¢¼è¡¨");
            
            // ä¸‹è¼‰æª”æ¡ˆ
            XLSX.writeFile(wb, `ç­ç´šå¯†ç¢¼è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
        },

        // --- åŸæœ‰åŠŸèƒ½ ---
        backupData() {
            const backup = { version: "1.1", timestamp: new Date().toISOString(), passwords: this.classPasswords, classList: this.classList, students: this.students };
            const blob = new Blob([JSON.stringify(backup, null, 2)], {type : 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        },
        restoreData() {
            const file = this.$refs.backupInput.files[0];
            if (!file) return alert('è«‹å…ˆé¸æ“‡å‚™ä»½æª”');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.students) {
                        if(confirm(`ç¢ºå®šé‚„åŸï¼Ÿ`)) { this.classPasswords = data.passwords; this.classList = data.classList; this.students = data.students; alert('é‚„åŸæˆåŠŸï¼'); }
                    }
                } catch(err){ alert('è®€å–å¤±æ•—'); }
            };
            reader.readAsText(file);
        },
        downloadSampleExcel() {
            const ws = XLSX.utils.json_to_sheet([{ class: "701", seat: 1, name: "ç¯„ä¾‹å­¸ç”Ÿ" }]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "å­¸ç”Ÿè³‡æ–™");
            XLSX.writeFile(wb, "sample.xlsx");
        },
        handleFileUpload(event) { this.uploadedFile = event.target.files[0]; },
        processImport() {
            if (!this.uploadedFile) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if(confirm(`è®€å–åˆ° ${jsonData.length} ç­†ï¼Œç¢ºå®šåŒ¯å…¥ï¼Ÿ`)) {
                    this.students = []; const newClasses = new Set();
                    jsonData.forEach((row, idx) => {
                        const cls = String(row.class||row['ç­ç´š']), name = row.name||row['å§“å'], seat = row.seat||row['åº§è™Ÿ']||(idx+1);
                        newClasses.add(cls);
                        this.students.push({ id: `${cls}_${seat}`, class: cls, seat: Number(seat), name: name, totalLaps: 0, todayLaps: 0 });
                    });
                    this.classList = Array.from(newClasses).sort();
                    this.classList.forEach(c => { if(!this.classPasswords[c]) this.classPasswords[c] = '1234'; });
                    alert('åŒ¯å…¥æˆåŠŸï¼'); this.uploadedFile = null;
                }
            };
            reader.readAsArrayBuffer(this.uploadedFile);
        }
    }
}).mount('#app');
</script>

</body>
</html>