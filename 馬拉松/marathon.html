<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡åœ’é¦¬æ‹‰æ¾ç³»çµ± (Firebaseé€£ç·šç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        .login-card { max-width: 400px; margin: 80px auto; }
        .header-bar { background-color: #2c3e50; color: white; padding: 15px; margin-bottom: 20px; }
        .lap-input { width: 80px; text-align: center; font-weight: bold; color: #0d6efd; }
        .rank-badge { width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: white; margin-right: 10px;}
        .rank-1 { background: #FFD700; } .rank-2 { background: #C0C0C0; } .rank-3 { background: #CD7F32; } .rank-other { background: #6c757d; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<div id="app">
    <div class="loading-overlay" v-if="isLoading">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <div class="header-bar d-flex justify-content-between align-items-center" v-if="currentPage !== 'login'">
        <div class="d-flex align-items-center">
            <h4 class="m-0 fw-bold me-3">ğŸƒ æ ¡åœ’é¦¬æ‹‰æ¾</h4>
            <span class="badge bg-warning text-dark" v-if="userRole === 'admin'">è¶…ç´šç®¡ç†å“¡</span>
            <span class="badge bg-success" v-else>{{ currentClass }} ç­ç´šé¢æ¿</span>
        </div>
        <button class="btn btn-outline-light btn-sm" @click="logout">ç™»å‡º</button>
    </div>

    <div class="container pb-5">
        <div class="card login-card shadow" v-if="currentPage === 'login'">
            <div class="card-header bg-primary text-white text-center"><h5>ç³»çµ±ç™»å…¥</h5></div>
            <div class="card-body p-4">
                <input type="password" class="form-control mb-3" v-model="loginInput" @keyup.enter="handleLogin" placeholder="è¼¸å…¥å¯†ç¢¼">
                <div class="d-grid"><button class="btn btn-primary" @click="handleLogin">ç™»å…¥</button></div>
                <div class="alert alert-danger mt-3" v-if="loginError">{{ loginError }}</div>
            </div>
        </div>

        <div v-if="currentPage === 'leader'">
            <div class="row g-3 mb-4">
                <div class="col-md-4"><div class="card p-3 text-center"><h6>ä»Šæ—¥æˆ°ç¸¾</h6><h2 class="text-primary">{{ myClassTodayLaps }}</h2></div></div>
                <div class="col-md-4"><div class="card p-3 text-center"><h6>ç¸½ç´¯ç©</h6><h2 class="text-success">{{ myClassTotalLaps }}</h2></div></div>
                <div class="col-md-4"><div class="card p-3 text-center bg-warning bg-opacity-10"><h6>å…¨æ ¡ç¬¬ä¸€</h6><h3>ğŸ‘‘ {{ fullRankings[0]?.class || '-' }}</h3></div></div>
            </div>
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3"><h5>ğŸ“ {{ currentClass }} ç™»éŒ„</h5></div>
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light"><tr><th class="ps-4">åº§è™Ÿ</th><th>å§“å</th><th>ä»Šæ—¥åœˆæ•¸</th><th class="text-end pe-4">ç´¯ç©</th></tr></thead>
                    <tbody>
                        <tr v-for="student in classStudents" :key="student.id">
                            <td class="ps-4">{{ student.seat }}</td><td>{{ student.name }}</td>
                            <td><input type="number" class="form-control lap-input" v-model.number="student.todayLaps" min="0"></td>
                            <td class="text-end pe-4">{{ student.totalLaps + (student.todayLaps || 0) }}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="card-footer bg-white text-end"><button class="btn btn-success" @click="saveDailyLaps">ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„</button></div>
            </div>
        </div>

        <div v-if="currentPage === 'admin'">
            <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm">
                <li class="nav-item"><a class="nav-link" :class="{active: adminTab==='dash'}" href="#" @click="adminTab='dash'">ğŸ“Š å„€è¡¨æ¿</a></li>
                <li class="nav-item"><a class="nav-link" :class="{active: adminTab==='sys'}" href="#" @click="adminTab='sys'">âš™ï¸ ç³»çµ±ç¶­è­· (åŒ¯å…¥/å¯†ç¢¼)</a></li>
            </ul>

            <div v-if="adminTab === 'dash'">
                <div class="card shadow-sm">
                    <div class="card-header bg-white"><h5>ğŸ† å…¨æ ¡æ’è¡Œæ¦œ</h5></div>
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th class="ps-4">æ’å</th><th>ç­ç´š</th><th>ç´¯ç©åœˆæ•¸</th></tr></thead>
                        <tbody>
                            <tr v-for="(rank, index) in fullRankings" :key="rank.class">
                                <td class="ps-4"><span class="rank-badge" :class="index<3?'rank-'+(index+1):'rank-other'">{{index+1}}</span></td>
                                <td class="fw-bold">{{ rank.class }}</td><td class="fw-bold text-primary">{{ rank.total }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="adminTab === 'sys'">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">ğŸ“‚ å­¸ç”ŸåŒ¯å…¥ (åˆå§‹åŒ–)</div>
                            <div class="card-body">
                                <button class="btn btn-outline-success btn-sm mb-3" @click="downloadSample">â¬‡ï¸ ä¸‹è¼‰ç¯„ä¾‹æª”</button>
                                <input type="file" class="form-control mb-3" @change="handleFileUpload">
                                <button class="btn btn-success w-100" :disabled="!uploadedFile" @click="importData">ç¢ºèªåŒ¯å…¥è‡³è³‡æ–™åº«</button>
                                <small class="text-muted d-block mt-2">* é€™æœƒè¦†è“‹ç¾æœ‰å­¸ç”Ÿè³‡æ–™</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-dark text-white">ğŸ”‘ å¯†ç¢¼ç®¡ç†</div>
                            <div class="card-body">
                                <button class="btn btn-warning w-100 mb-2" @click="resetPasswords">ğŸ² éš¨æ©Ÿé‡è¨­æ‰€æœ‰å¯†ç¢¼</button>
                                <button class="btn btn-outline-dark w-100" @click="exportPasswords">ğŸ“¥ åŒ¯å‡ºå¯†ç¢¼ Excel</button>
                                <hr>
                                <button class="btn btn-danger w-100" @click="resetAllLaps">âš ï¸ å…¨æ ¡åœˆæ•¸æ­¸é›¶</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, writeBatch, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ==========================================
    // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šä½ çš„ Firebase Config âš ï¸
    // ==========================================
    const firebaseConfig = {
  apiKey: "AIzaSyC8kOlTTE3EqszGY4Etf6M0J1zj7QavYTM",
  authDomain: "school-marathon.firebaseapp.com",
  projectId: "school-marathon",
  storageBucket: "school-marathon.firebasestorage.app",
  messagingSenderId: "772211390274",
  appId: "1:772211390274:web:c207e9c0433a1ffd50badb",
  measurementId: "G-NFRT2ZE03T"
    };
    
    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    createApp({
        data() {
            return {
                isLoading: false,
                currentPage: 'login',
                userRole: '',
                loginInput: '',
                loginError: '',
                currentClass: '',
                adminTab: 'dash',
                uploadedFile: null,
                
                // è³‡æ–™å®¹å™¨
                students: [], // å¾ Firestore è®€å–
                passwords: {}, // å¾ Firestore è®€å–
                classList: []
            }
        },
        computed: {
            classStudents() { return this.students.filter(s => s.class === this.currentClass).sort((a,b)=>a.seat-b.seat); },
            myClassTodayLaps() { return this.classStudents.reduce((sum,s)=>sum+(s.todayLaps||0),0); },
            myClassTotalLaps() { return this.classStudents.reduce((sum,s)=>sum+s.totalLaps+(s.todayLaps||0),0); },
            fullRankings() {
                const ranks = this.classList.map(cls => {
                    const total = this.students.filter(s=>s.class===cls)
                        .reduce((sum,s) => sum + s.totalLaps + (s.class===this.currentClass?(s.todayLaps||0):0), 0);
                    return { class: cls, total: total };
                });
                return ranks.sort((a,b)=>b.total-a.total);
            }
        },
        methods: {
            // --- æ ¸å¿ƒï¼šå¾è³‡æ–™åº«è®€å– ---
            async fetchData() {
                this.isLoading = true;
                try {
                    // 1. è®€å–å¯†ç¢¼è¡¨
                    const pwdSnap = await getDoc(doc(db, "settings", "passwords"));
                    if (pwdSnap.exists()) {
                        this.passwords = pwdSnap.data();
                        this.classList = Object.keys(this.passwords).sort();
                    }

                    // 2. è®€å–å­¸ç”Ÿè³‡æ–™
                    const stuSnap = await getDocs(collection(db, "students"));
                    this.students = [];
                    stuSnap.forEach(doc => {
                        this.students.push({ ...doc.data(), todayLaps: 0 }); // todayLaps æœ¬åœ°æš«å­˜
                    });

                    // å¦‚æœè³‡æ–™åº«æ˜¯ç©ºçš„ (ç¬¬ä¸€æ¬¡ä½¿ç”¨)
                    if (this.classList.length === 0) {
                        alert("ç›®å‰è³‡æ–™åº«ç‚ºç©ºï¼Œè«‹ä½¿ç”¨è¶…ç´šå¯†ç¢¼ç™»å…¥ä¸¦åŒ¯å…¥ Excelã€‚");
                    }
                } catch (e) {
                    console.error(e);
                    alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®š");
                }
                this.isLoading = false;
            },

            async handleLogin() {
                await this.fetchData(); // ç™»å…¥æ™‚æ‰æ‹‰å–æœ€æ–°è³‡æ–™
                
                if (this.loginInput === 'xtjh') {
                    this.userRole = 'admin'; this.currentPage = 'admin'; return;
                }
                // æ¯”å°å¯†ç¢¼
                const foundClass = Object.entries(this.passwords).find(([cls, pwd]) => pwd === this.loginInput);
                if (foundClass) {
                    this.userRole = 'leader'; this.currentClass = foundClass[0]; this.currentPage = 'leader';
                } else {
                    this.loginError = 'å¯†ç¢¼éŒ¯èª¤';
                }
            },
            logout() { location.reload(); }, // ç™»å‡ºç›´æ¥é‡æ•´æœ€ä¹¾æ·¨

            // --- æ ¸å¿ƒï¼šå„²å­˜è³‡æ–™ ---
            async saveDailyLaps() {
                this.isLoading = true;
                const batch = writeBatch(db);
                let count = 0;
                
                this.classStudents.forEach(s => {
                    if (s.todayLaps > 0) {
                        const sRef = doc(db, "students", s.id);
                        // æ›´æ–°è³‡æ–™åº«ç¸½åœˆæ•¸
                        batch.update(sRef, { totalLaps: s.totalLaps + s.todayLaps });
                        // æ›´æ–°æœ¬åœ°é¡¯ç¤º
                        s.totalLaps += s.todayLaps;
                        s.todayLaps = 0;
                        count++;
                    }
                });

                if (count > 0) {
                    await batch.commit();
                    alert("å„²å­˜æˆåŠŸï¼");
                } else {
                    alert("æ²’æœ‰è¼¸å…¥ä»»ä½•åœˆæ•¸å–”");
                }
                this.isLoading = false;
            },

            // --- åŒ¯å…¥èˆ‡ç®¡ç† ---
            downloadSample() {
                const ws = XLSX.utils.json_to_sheet([{ class: "701", seat: 1, name: "ç‹å°æ˜" }]);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, "sample.xlsx");
            },
            handleFileUpload(e) { this.uploadedFile = e.target.files[0]; },
            
            async importData() {
                if(!confirm("ç¢ºå®šåŒ¯å…¥ï¼Ÿé€™æœƒæ¸…ç©ºè³‡æ–™åº«ç¾æœ‰å­¸ç”Ÿè³‡æ–™ï¼")) return;
                this.isLoading = true;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    
                    // 1. æ•´ç†è³‡æ–™
                    const batch = writeBatch(db);
                    const newPasswords = {};
                    
                    // å…ˆæ¸…ç©ºèˆŠè³‡æ–™ (é€™æ­¥åœ¨å¤§é‡è³‡æ–™æ™‚éœ€å„ªåŒ–ï¼Œé€™è£¡ç°¡åŒ–è™•ç†)
                    // å¯¦å‹™ä¸Šå»ºè­°ç›´æ¥è¦†è“‹æˆ–åˆ†æ‰¹åˆªé™¤
                    
                    json.forEach(row => {
                        const cls = String(row.class||row['ç­ç´š']);
                        const name = row.name||row['å§“å'];
                        const seat = row.seat||row['åº§è™Ÿ'];
                        const id = `${cls}_${seat}`;
                        
                        // è¨­å®šå­¸ç”Ÿæ–‡ä»¶
                        const sRef = doc(db, "students", id);
                        batch.set(sRef, { id, class: cls, seat, name, totalLaps: 0 });
                        
                        // å»ºç«‹å¯†ç¢¼è¡¨
                        if (!newPasswords[cls]) newPasswords[cls] = "1234"; 
                    });

                    // 2. å¯«å…¥å¯†ç¢¼è¡¨
                    batch.set(doc(db, "settings", "passwords"), newPasswords);

                    await batch.commit();
                    alert("åŒ¯å…¥æˆåŠŸï¼è«‹é‡æ–°ç™»å…¥");
                    location.reload();
                };
                reader.readAsArrayBuffer(this.uploadedFile);
            },

            async resetPasswords() {
                if(!confirm("ç¢ºå®šé‡è¨­æ‰€æœ‰å¯†ç¢¼ï¼Ÿ")) return;
                this.isLoading = true;
                const newPwds = {};
                this.classList.forEach(c => newPwds[c] = Math.random().toString(36).substring(2,6));
                
                await setDoc(doc(db, "settings", "passwords"), newPwds);
                this.passwords = newPwds;
                alert("å¯†ç¢¼å·²é‡è¨­ï¼Œè«‹åŒ¯å‡º Excel");
                this.isLoading = false;
            },
            
            exportPasswords() {
                const data = Object.entries(this.passwords).map(([c,p])=>({'ç­ç´š':c, 'å¯†ç¢¼':p}));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Passwords");
                XLSX.writeFile(wb, "passwords.xlsx");
            },

            async resetAllLaps() {
                if(!confirm("âš ï¸ ç¢ºå®šå°‡å…¨æ ¡åœˆæ•¸æ­¸é›¶ï¼Ÿ")) return;
                this.isLoading = true;
                const batch = writeBatch(db);
                this.students.forEach(s => {
                    batch.update(doc(db, "students", s.id), { totalLaps: 0 });
                });
                await batch.commit();
                alert("å·²æ­¸é›¶");
                location.reload();
            }
        },
        mounted() {
            // ä¸å†è‡ªå‹•ç”¢ç”Ÿå‡è³‡æ–™ï¼Œç­‰å¾…ä½¿ç”¨è€…ç™»å…¥è§¸ç™¼ fetchData
        }
    }).mount('#app');
</script>

</body>
</html>