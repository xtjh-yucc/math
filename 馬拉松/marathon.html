<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡åœ’é¦¬æ‹‰æ¾ç³»çµ± (å®Œæ•´å‚™ä»½ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        .login-card { max-width: 400px; margin: 80px auto; }
        .header-bar { background-color: #2c3e50; color: white; padding: 15px; margin-bottom: 20px; }
        .lap-input { width: 80px; text-align: center; font-weight: bold; color: #0d6efd; }
        /* æ’è¡Œæ¦œæ¨£å¼ */
        .rank-badge { width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 0.8rem; margin-right: 8px;}
        .rank-1 { background: #FFD700; } .rank-2 { background: #C0C0C0; } .rank-3 { background: #CD7F32; } .rank-other { background: #6c757d; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<div id="app">
    <div class="loading-overlay" v-if="isLoading">
        <div class="text-center">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <div>è™•ç†ä¸­...</div>
        </div>
    </div>

    <div class="header-bar d-flex justify-content-between align-items-center" v-if="currentPage !== 'login'">
        <div class="d-flex align-items-center">
            <h4 class="m-0 fw-bold me-3">ğŸƒ æ ¡åœ’é¦¬æ‹‰æ¾</h4>
            <span class="badge bg-warning text-dark" v-if="userRole === 'admin'">è¶…ç´šç®¡ç†å“¡</span>
            <span class="badge bg-success" v-else>{{ currentClass }} ç­ç´šé¢æ¿</span>
        </div>
        <button class="btn btn-outline-light btn-sm" @click="logout">ç™»å‡º</button>
    </div>

    <div class="container pb-5">
        <div class="card login-card shadow" v-if="currentPage === 'login'">
            <div class="card-header bg-primary text-white text-center"><h5>ç³»çµ±ç™»å…¥</h5></div>
            <div class="card-body p-4">
                <input type="password" class="form-control mb-3" v-model="loginInput" @keyup.enter="handleLogin" placeholder="è¼¸å…¥å¯†ç¢¼">
                <div class="d-grid"><button class="btn btn-primary" @click="handleLogin">ç™»å…¥</button></div>
                <div class="alert alert-danger mt-3" v-if="loginError">{{ loginError }}</div>
            </div>
        </div>

        <div v-if="currentPage === 'leader'">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card p-3 text-center h-100 shadow-sm">
                        <h6 class="text-muted">æœ¬ç­ä»Šæ—¥æˆ°ç¸¾</h6>
                        <h2 class="text-primary fw-bold">{{ myClassTodayLaps }} <small class="fs-6">åœˆ</small></h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 text-center h-100 shadow-sm">
                        <h6 class="text-muted">æœ¬ç­ç¸½ç´¯ç©</h6>
                        <h2 class="text-success fw-bold">{{ myClassTotalLaps }} <small class="fs-6">åœˆ</small></h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm border-warning">
                        <div class="card-header bg-warning bg-opacity-10 py-2">
                            <h6 class="m-0 fw-bold text-center">ğŸ† å…¨æ ¡å‰ä¸‰å</h6>
                        </div>
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item d-flex justify-content-between align-items-center" 
                                v-for="(rank, index) in fullRankings.slice(0,3)" :key="rank.class">
                                <span>
                                    <span class="rank-badge" :class="'rank-'+(index+1)">{{index+1}}</span>
                                    {{ rank.class }} ç­
                                </span>
                                <span class="fw-bold">{{ rank.total }} åœˆ</span>
                            </li>
                            <li class="list-group-item text-center text-muted" v-if="fullRankings.length === 0">
                                æš«ç„¡è³‡æ–™
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white py-3"><h5>ğŸ“ {{ currentClass }} ç™»éŒ„</h5></div>
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light"><tr><th class="ps-4">åº§è™Ÿ</th><th>å§“å</th><th>ä»Šæ—¥åœˆæ•¸</th><th class="text-end pe-4">ç´¯ç©</th></tr></thead>
                    <tbody>
                        <tr v-for="student in classStudents" :key="student.id">
                            <td class="ps-4">{{ student.seat }}</td><td>{{ student.name }}</td>
                            <td><input type="number" class="form-control lap-input" v-model.number="student.todayLaps" min="0"></td>
                            <td class="text-end pe-4">{{ student.totalLaps + (student.todayLaps || 0) }}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="card-footer bg-white text-end"><button class="btn btn-success" @click="saveDailyLaps">ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„</button></div>
            </div>
        </div>

        <div v-if="currentPage === 'admin'">
            <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm">
                <li class="nav-item"><a class="nav-link" :class="{active: adminTab==='dash'}" href="#" @click="adminTab='dash'">ğŸ“Š å„€è¡¨æ¿</a></li>
                <li class="nav-item"><a class="nav-link" :class="{active: adminTab==='sys'}" href="#" @click="adminTab='sys'">âš™ï¸ ç³»çµ±ç¶­è­· (å‚™ä»½/åŒ¯å…¥)</a></li>
            </ul>

            <div v-if="adminTab === 'dash'">
                <div class="card shadow-sm">
                    <div class="card-header bg-white"><h5>ğŸ† å…¨æ ¡æ’è¡Œæ¦œ</h5></div>
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th class="ps-4">æ’å</th><th>ç­ç´š</th><th>ç´¯ç©åœˆæ•¸</th></tr></thead>
                        <tbody>
                            <tr v-for="(rank, index) in fullRankings" :key="rank.class">
                                <td class="ps-4"><span class="rank-badge" :class="index<3?'rank-'+(index+1):'rank-other'">{{index+1}}</span></td>
                                <td class="fw-bold">{{ rank.class }}</td><td class="fw-bold text-primary">{{ rank.total }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="adminTab === 'sys'">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-success text-white">ğŸ“‚ å­¸ç”Ÿè³‡æ–™åŒ¯å…¥ (Excel)</div>
                            <div class="card-body">
                                <p class="small text-muted">ç”¨æ–¼å­¸æœŸåˆå»ºç«‹è³‡æ–™ã€‚æ³¨æ„ï¼šæœƒè¦†è“‹ç¾æœ‰å­¸ç”Ÿè³‡æ–™ã€‚</p>
                                <button class="btn btn-outline-success btn-sm mb-3" @click="downloadSample">â¬‡ï¸ ä¸‹è¼‰ç¯„ä¾‹æ ¼å¼</button>
                                <input type="file" class="form-control mb-3" @change="handleFileUpload">
                                <button class="btn btn-success w-100" :disabled="!uploadedFile" @click="importData">ç¢ºèªåŒ¯å…¥ Excel</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-dark text-white">ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ (JSON)</div>
                            <div class="card-body">
                                <label class="form-label fw-bold">1. å‚™ä»½è³‡æ–™</label>
                                <button class="btn btn-dark w-100 mb-3" @click="backupDataJSON">â¬‡ï¸ ä¸‹è¼‰å®Œæ•´å‚™ä»½æª” (.json)</button>
                                <hr>
                                <label class="form-label fw-bold">2. é‚„åŸè³‡æ–™</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" ref="jsonInput" accept=".json">
                                    <button class="btn btn-outline-danger" @click="restoreDataJSON">é‚„åŸ</button>
                                </div>
                                <small class="text-danger d-block mt-1">* é‚„åŸå°‡è¦†è“‹ç›®å‰æ‰€æœ‰è³‡æ–™åº«å…§å®¹</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12">
                        <div class="card shadow-sm border-danger">
                            <div class="card-header bg-light text-danger fw-bold">âš ï¸ é€²éšç®¡ç†å€</div>
                            <div class="card-body d-flex gap-2">
                                <button class="btn btn-warning flex-grow-1" @click="resetPasswords">ğŸ² éš¨æ©Ÿé‡è¨­å¯†ç¢¼</button>
                                <button class="btn btn-outline-dark flex-grow-1" @click="exportPasswords">ğŸ“¥ åŒ¯å‡ºå¯†ç¢¼è¡¨</button>
                                <button class="btn btn-danger flex-grow-1" @click="resetAllLaps">æ­¸é›¶å…¨æ ¡åœˆæ•¸</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, writeBatch, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ==========================================
    // âš ï¸ è¨˜å¾—æ›¿æ›æˆä½ çš„ Firebase Config âš ï¸
    // ==========================================
    const firebaseConfig = {
  apiKey: "AIzaSyC8kOlTTE3EqszGY4Etf6M0J1zj7QavYTM",
  authDomain: "school-marathon.firebaseapp.com",
  projectId: "school-marathon",
  storageBucket: "school-marathon.firebasestorage.app",
  messagingSenderId: "772211390274",
  appId: "1:772211390274:web:c207e9c0433a1ffd50badb",
  measurementId: "G-NFRT2ZE03T"
    };
    
    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    createApp({
        data() {
            return {
                isLoading: false,
                currentPage: 'login',
                userRole: '',
                loginInput: '',
                loginError: '',
                currentClass: '',
                adminTab: 'dash',
                uploadedFile: null,
                
                // è³‡æ–™å®¹å™¨
                students: [], 
                passwords: {}, 
                classList: []
            }
        },
        computed: {
            classStudents() { return this.students.filter(s => s.class === this.currentClass).sort((a,b)=>a.seat-b.seat); },
            myClassTodayLaps() { return this.classStudents.reduce((sum,s)=>sum+(s.todayLaps||0),0); },
            myClassTotalLaps() { return this.classStudents.reduce((sum,s)=>sum+s.totalLaps+(s.todayLaps||0),0); },
            fullRankings() {
                const ranks = this.classList.map(cls => {
                    const total = this.students.filter(s=>s.class===cls)
                        .reduce((sum,s) => sum + s.totalLaps + (s.class===this.currentClass?(s.todayLaps||0):0), 0);
                    return { class: cls, total: total };
                });
                return ranks.sort((a,b)=>b.total-a.total);
            }
        },
        methods: {
            async fetchData() {
                this.isLoading = true;
                try {
                    const pwdSnap = await getDoc(doc(db, "settings", "passwords"));
                    if (pwdSnap.exists()) {
                        this.passwords = pwdSnap.data();
                        this.classList = Object.keys(this.passwords).sort();
                    }
                    const stuSnap = await getDocs(collection(db, "students"));
                    this.students = [];
                    stuSnap.forEach(doc => {
                        this.students.push({ ...doc.data(), todayLaps: 0 }); 
                    });
                } catch (e) {
                    console.error(e);
                    alert("è®€å–è³‡æ–™å¤±æ•—: " + e.message);
                }
                this.isLoading = false;
            },

            async handleLogin() {
                await this.fetchData(); 
                if (this.loginInput === 'xtjh') {
                    this.userRole = 'admin'; this.currentPage = 'admin'; return;
                }
                const foundClass = Object.entries(this.passwords).find(([cls, pwd]) => pwd === this.loginInput);
                if (foundClass) {
                    this.userRole = 'leader'; this.currentClass = foundClass[0]; this.currentPage = 'leader';
                } else {
                    this.loginError = 'å¯†ç¢¼éŒ¯èª¤';
                }
            },
            logout() { location.reload(); }, 

            async saveDailyLaps() {
                this.isLoading = true;
                const batch = writeBatch(db);
                let count = 0;
                this.classStudents.forEach(s => {
                    if (s.todayLaps > 0) {
                        const sRef = doc(db, "students", s.id);
                        batch.update(sRef, { totalLaps: s.totalLaps + s.todayLaps });
                        s.totalLaps += s.todayLaps;
                        s.todayLaps = 0;
                        count++;
                    }
                });
                if (count > 0) { await batch.commit(); alert("å„²å­˜æˆåŠŸï¼"); } else { alert("æœªè¼¸å…¥æ•¸å€¼"); }
                this.isLoading = false;
            },

            // --- Excel åŒ¯å…¥ ---
            downloadSample() {
                const ws = XLSX.utils.json_to_sheet([{ class: "701", seat: 1, name: "ç‹å°æ˜" }]);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, "sample.xlsx");
            },
            handleFileUpload(e) { this.uploadedFile = e.target.files[0]; },
            async importData() {
                if(!confirm("ç¢ºå®šåŒ¯å…¥ï¼Ÿç¾æœ‰è³‡æ–™å°‡è¢«è¦†è“‹ï¼")) return;
                this.isLoading = true;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    const batch = writeBatch(db);
                    const newPasswords = {};
                    json.forEach(row => {
                        const cls = String(row.class||row['ç­ç´š']), name = row.name||row['å§“å'], seat = row.seat||row['åº§è™Ÿ'];
                        const id = `${cls}_${seat}`;
                        batch.set(doc(db, "students", id), { id, class: cls, seat, name, totalLaps: 0 });
                        if (!newPasswords[cls]) newPasswords[cls] = "1234"; 
                    });
                    batch.set(doc(db, "settings", "passwords"), newPasswords);
                    await batch.commit();
                    alert("Excel åŒ¯å…¥æˆåŠŸï¼"); location.reload();
                };
                reader.readAsArrayBuffer(this.uploadedFile);
            },

            // --- å‚™ä»½èˆ‡é‚„åŸ (JSON) ---
            backupDataJSON() {
                if (this.students.length === 0) return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯å‚™ä»½");
                const backupData = {
                    version: "2.0",
                    timestamp: new Date().toISOString(),
                    passwords: this.passwords,
                    students: this.students.map(s => ({...s, todayLaps: 0})) // å»é™¤æš«å­˜æ¬„ä½
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], {type : 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `marathon_full_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            },

            async restoreDataJSON() {
                const file = this.$refs.jsonInput.files[0];
                if (!file) return alert('è«‹é¸æ“‡å‚™ä»½æª” (.json)');
                if(!confirm("âš ï¸ è­¦å‘Šï¼šé‚„åŸå°‡è¦†å¯«ç›®å‰æ‰€æœ‰è³‡æ–™åº«å…§å®¹ï¼Œç¢ºå®šåŸ·è¡Œï¼Ÿ")) return;

                this.isLoading = true;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.students || !data.passwords) throw new Error("æ ¼å¼éŒ¯èª¤");

                        // ç”±æ–¼ Firebase Batch é™åˆ¶ 500 ç­†ï¼Œé€™è£¡ç°¡å–®ç”¨åˆ†æ‰¹æˆ–å€‹åˆ¥å¯«å…¥è™•ç†
                        // ç‚ºæ±‚ç©©å®šï¼Œé€™è£¡ä½¿ç”¨ writeBatch åˆ†æ‰¹ (æ¯æ‰¹ 400 ç­†)
                        const chunkSize = 400;
                        const allStudents = data.students;
                        
                        for (let i = 0; i < allStudents.length; i += chunkSize) {
                            const batch = writeBatch(db);
                            const chunk = allStudents.slice(i, i + chunkSize);
                            chunk.forEach(s => {
                                batch.set(doc(db, "students", s.id), s);
                            });
                            // ç¬¬ä¸€æ‰¹é †ä¾¿å¯«å…¥å¯†ç¢¼
                            if (i === 0) {
                                batch.set(doc(db, "settings", "passwords"), data.passwords);
                            }
                            await batch.commit();
                        }
                        
                        alert("è³‡æ–™é‚„åŸæˆåŠŸï¼");
                        location.reload();
                    } catch (err) {
                        alert('é‚„åŸå¤±æ•—ï¼š' + err.message);
                        this.isLoading = false;
                    }
                };
                reader.readAsText(file);
            },

            // --- å…¶ä»–ç®¡ç†åŠŸèƒ½ ---
            async resetPasswords() {
                if(!confirm("ç¢ºå®šé‡è¨­æ‰€æœ‰å¯†ç¢¼ï¼Ÿ")) return;
                this.isLoading = true;
                const newPwds = {};
                this.classList.forEach(c => newPwds[c] = Math.random().toString(36).substring(2,6));
                await setDoc(doc(db, "settings", "passwords"), newPwds);
                alert("å¯†ç¢¼å·²é‡è¨­ï¼Œè«‹åŒ¯å‡º Excel"); location.reload();
            },
            exportPasswords() {
                const data = Object.entries(this.passwords).map(([c,p])=>({'ç­ç´š':c, 'å¯†ç¢¼':p}));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "PW");
                XLSX.writeFile(wb, "passwords.xlsx");
            },
            async resetAllLaps() {
                if(!confirm("âš ï¸ ç¢ºå®šå°‡å…¨æ ¡åœˆæ•¸æ­¸é›¶ï¼Ÿ")) return;
                this.isLoading = true;
                // åˆ†æ‰¹è™•ç†æ­¸é›¶
                const chunkSize = 400;
                for (let i = 0; i < this.students.length; i += chunkSize) {
                    const batch = writeBatch(db);
                    const chunk = this.students.slice(i, i + chunkSize);
                    chunk.forEach(s => {
                        batch.update(doc(db, "students", s.id), { totalLaps: 0 });
                    });
                    await batch.commit();
                }
                alert("å·²æ­¸é›¶"); location.reload();
            }
        },
        mounted() {
            // è‡ªå‹•åµæ¸¬ï¼šè‹¥æœ‰ API Key ä½†æ²’è³‡æ–™ï¼Œè‡ªå‹•æç¤º
        }
    }).mount('#app');
</script>

</body>
</html>