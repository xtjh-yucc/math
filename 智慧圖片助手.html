<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puti-AI æ™ºæ…§åœ–ç‰‡åŠ©æ‰‹</title>
    <!-- å¼•å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts çš„ Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºæœ¬æ¨£å¼å’Œè‡ªè¨‚æ•ˆæœ --- */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif; /* è¨­å®šå„ªå…ˆå­—é«” */
            background-color: #f8fafc; /* è¨­å®šé é¢èƒŒæ™¯é¡è‰² */
        }
        /* æ¼¸å±¤æ–‡å­—æ•ˆæœ */
        .gradient-text {
            background: linear-gradient(to right, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* æ‹–æ›³å€åŸŸçš„è™›ç·šé‚Šæ¡† */
        #drop-zone {
            border-style: dashed;
        }
        /* ç•¶æª”æ¡ˆæ‹–æ›³åˆ°å€åŸŸä¸Šæ–¹æ™‚çš„æ¨£å¼ */
        #drop-zone.drag-over {
            border-color: #8b5cf6;
            background-color: #f5f3ff;
        }
        /* åŠŸèƒ½æŒ‰éˆ•çš„å…±ç”¨æ¨£å¼ */
        .feature-btn {
            transition: all 0.2s ease-in-out;
        }
        /* åŠŸèƒ½æŒ‰éˆ•çš„æ»‘é¼ æ‡¸åœæ•ˆæœ */
        .feature-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* è®€å–ä¸­çš„å‹•ç•«æ•ˆæœ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ç·¨è¼¯å½ˆå‡ºè¦–çª—é è¨­éš±è— */
        #edit-modal, #message-box {
            display: none;
        }
        /* ç·¨è¼¯ç•«å¸ƒçš„æ»‘é¼ æ¸¸æ¨™æ¨£å¼ */
        #edit-canvas {
            cursor: crosshair;
        }
        /* --- AI å°è©±æ¡†æ¨£å¼ --- */
        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        /* ä½¿ç”¨è€…ç™¼é€çš„è¨Šæ¯æ¨£å¼ */
        .chat-bubble.user {
            background-color: #8b5cf6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        /* AI å›è¦†çš„è¨Šæ¯æ¨£å¼ */
        .chat-bubble.ai {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        /* AI æ­£åœ¨è¼¸å…¥ä¸­çš„æŒ‡ç¤ºå™¨å‹•ç•« */
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- é é¦– -->
    <header class="bg-white shadow-sm sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">
                <span class="gradient-text">Puti-AI</span>
                <span class="text-gray-700">æ™ºæ…§åœ–ç‰‡åŠ©æ‰‹</span>
            </h1>
            <p class="text-gray-500 mt-1">ä¸Šå‚³åœ–ç‰‡ï¼Œé‡‹æ”¾ AI çš„æ½›åŠ›</p>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="container mx-auto p-4 sm:p-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- å·¦å´æ¬„ï¼šåœ–ç‰‡ä¸Šå‚³èˆ‡é¡¯ç¤º -->
            <div class="flex flex-col space-y-6">
                <label for="file-input" id="drop-zone" class="relative w-full h-80 bg-white border-2 border-gray-300 rounded-2xl flex flex-col justify-center items-center text-center p-6 cursor-pointer hover:border-purple-400 transition-colors">
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                    <div id="upload-prompt" class="space-y-2">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="text-gray-600 font-medium">æ‹–æ›³ã€è²¼ä¸Šåœ–ç‰‡ï¼Œæˆ–<span class="text-purple-600">é»æ“Šä¸Šå‚³</span></p>
                        <p class="text-xs text-gray-500">æ”¯æ´ PNG, JPG, WEBP ç­‰æ ¼å¼</p>
                    </div>
                    <img id="image-preview" src="#" alt="ä¸Šå‚³çš„åœ–ç‰‡" class="hidden max-w-full max-h-full rounded-lg object-contain"/>
                </label>
                
                <div id="image-controls" class="hidden flex justify-center">
                    <button id="edit-btn" class="feature-btn bg-white text-gray-700 font-semibold py-2 px-5 border border-gray-300 rounded-full shadow-sm hover:bg-gray-50">
                        ğŸ¨ åœ–ç‰‡ç·¨è¼¯èˆ‡æ¨™è¨»
                    </button>
                </div>
            </div>

            <!-- å³å´æ¬„ï¼šAI åŠŸèƒ½èˆ‡è¼¸å‡ºçµæœ -->
            <div class="flex flex-col space-y-6">
                <!-- API é‡‘é‘°è¼¸å…¥å€ -->
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-2">æ‚¨çš„ API é‡‘é‘°</label>
                    <div class="flex items-center space-x-3">
                        <input type="password" id="api-key-input" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Gemini API é‡‘é‘°" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-sm text-purple-600 hover:text-purple-800 whitespace-nowrap font-medium">ç”³è«‹é‡‘é‘°</a>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">æ‚¨çš„é‡‘é‘°åƒ…æœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒè¢«ä¸Šå‚³ã€‚</p>
                </div>

                <div id="features" class="hidden">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">AI åŠŸèƒ½</h2>
                    <div class="flex flex-wrap gap-3">
                        <button data-action="ocr" class="feature-btn bg-purple-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">æ–‡å­—è¾¨è­˜</button>
                        <button data-action="translate" class="feature-btn bg-purple-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">ç¿»è­¯ (ç¹ä¸­)</button>
                        <button data-action="summarize" class="feature-btn bg-purple-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">æ‘˜è¦åˆ—èˆ‰</button>
                        <button data-action="formula" class="feature-btn bg-indigo-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">å…¬å¼è¾¨è­˜</button>
                        <button data-action="table" class="feature-btn bg-indigo-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">è¡¨æ ¼è¾¨è­˜</button>
                        <button data-action="describe" class="feature-btn bg-pink-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">å½±åƒæè¿°</button>
                        <button data-action="solve" class="feature-btn bg-pink-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">å•é¡Œè§£æ±º</button>
                        <button data-action="code" class="feature-btn bg-teal-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">ç¨‹å¼ç¢¼è¾¨è­˜</button>
                        <button data-action="color" class="feature-btn bg-teal-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">é¡è‰²æå–</button>
                        <button data-action="mindmap" class="feature-btn bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md">å¿ƒæ™ºåœ–</button>
                        <button data-action="slides" class="feature-btn bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md">ç”Ÿæˆç°¡å ±</button>
                        <button data-action="studyguide" class="feature-btn bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md">ç ”è®€æŒ‡å—</button>
                        <button data-action="faq" class="feature-btn bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md">å¸¸è¦‹å•é¡Œ</button>
                        <button data-action="chat" class="feature-btn bg-amber-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md">AIå°è©±</button>
                    </div>
                </div>

                <div id="output-container" class="bg-white rounded-2xl shadow-sm min-h-[400px] p-5 flex flex-col">
                    <div class="flex-shrink-0 flex justify-between items-center mb-3">
                        <h3 id="output-title" class="text-lg font-semibold text-gray-700">çµæœ</h3>
                        <button id="copy-btn" class="hidden bg-gray-200 text-gray-600 text-sm font-medium py-1 px-3 rounded-md hover:bg-gray-300 transition-colors">è¤‡è£½</button>
                    </div>
                    <div id="output-content" class="flex-grow text-gray-600 whitespace-pre-wrap break-words font-mono text-sm leading-relaxed">
                        <p class="font-sans text-base text-gray-400">è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼Œç„¶å¾Œé¸æ“‡ä¸€é … AI åŠŸèƒ½ã€‚</p>
                    </div>
                    <!-- AI å°è©±ä»‹é¢ -->
                    <div id="chat-interface" class="hidden flex-grow flex flex-col justify-between">
                        <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 pr-2 space-y-4 flex flex-col">
                            <!-- å°è©±è¨Šæ¯å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                        </div>
                        <div class="flex-shrink-0 flex space-x-2 border-t pt-4">
                            <input type="text" id="chat-input" placeholder="é‡å°åœ–ç‰‡å…§å®¹æå•..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                            <button id="chat-send-btn" class="bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-600 transition-colors">å‚³é€</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åœ–ç‰‡ç·¨è¼¯å½ˆå‡ºè¦–çª— -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col p-4">
            <div class="flex-shrink-0 flex items-center justify-between mb-3">
                <div id="toolbar" class="flex items-center space-x-2 bg-gray-900 p-2 rounded-lg">
                    <!-- å·¥å…·æŒ‰éˆ• -->
                    <button data-tool="brush" class="tool-btn p-2 rounded-md bg-purple-600 text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></button>
                    <button data-tool="arrow" class="tool-btn p-2 rounded-md hover:bg-gray-700 text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></button>
                    <button data-tool="rect" class="tool-btn p-2 rounded-md hover:bg-gray-700 text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></button>
                    <button data-tool="text" class="tool-btn p-2 rounded-md hover:bg-gray-700 text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg></button>
                    <input type="color" id="color-picker" value="#FF0000" class="w-8 h-8 bg-transparent rounded-md cursor-pointer">
                </div>
                <div class="flex items-center space-x-2">
                    <button id="download-btn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">ä¸‹è¼‰åœ–ç‰‡</button>
                    <button id="close-modal-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700">é—œé–‰</button>
                </div>
            </div>
            <div class="flex-grow bg-gray-900 rounded-lg overflow-hidden flex items-center justify-center">
                <canvas id="edit-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <!-- è‡ªè¨‚è¨Šæ¯æç¤ºæ¡† -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="message-text" class="text-gray-700 mb-4"></p>
            <button id="message-close-btn" class="bg-purple-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-600">ç¢ºå®š</button>
        </div>
    </div>

    <script>
        // --- ç²å–é é¢ä¸Šçš„ HTML å…ƒç´  ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadPrompt = document.getElementById('upload-prompt');
        const imagePreview = document.getElementById('image-preview');
        const imageControls = document.getElementById('image-controls');
        const featuresContainer = document.getElementById('features');
        const outputContainer = document.getElementById('output-container');
        const outputTitle = document.getElementById('output-title');
        const outputContent = document.getElementById('output-content');
        const copyBtn = document.getElementById('copy-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        
        // å°è©±ä»‹é¢å…ƒç´ 
        const chatInterface = document.getElementById('chat-interface');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');

        // åœ–ç‰‡ç·¨è¼¯å½ˆå‡ºè¦–çª—å…ƒç´ 
        const editBtn = document.getElementById('edit-btn');
        const editModal = document.getElementById('edit-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const downloadBtn = document.getElementById('download-btn');
        const canvas = document.getElementById('edit-canvas');
        const ctx = canvas.getContext('2d');
        const toolbar = document.getElementById('toolbar');
        const colorPicker = document.getElementById('color-picker');

        // è¨Šæ¯æç¤ºæ¡†å…ƒç´ 
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageCloseBtn = document.getElementById('message-close-btn');

        // --- å…¨åŸŸè®Šæ•¸ ---
        let imageBase64 = null; // ç”¨æ–¼å„²å­˜ä¸Šå‚³åœ–ç‰‡çš„ Base64 ç·¨ç¢¼
        let currentOutputText = ''; // ç”¨æ–¼å„²å­˜ç•¶å‰ AI è¼¸å‡ºçš„ç´”æ–‡å­—

        // --- è¨Šæ¯æç¤ºæ¡†é‚è¼¯ ---
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.style.display = 'flex';
        }
        messageCloseBtn.addEventListener('click', () => {
            messageBox.style.display = 'none';
        });

        // --- åœ–ç‰‡ä¸Šå‚³è™•ç†é‚è¼¯ ---
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        // è¨­å®šæ‹–æ›³å€åŸŸçš„äº‹ä»¶ç›£è½
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, preventDefaults, false));
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag-over'));
        dropZone.addEventListener('dragover', () => dropZone.classList.add('drag-over'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            dropZone.classList.remove('drag-over');
            handleFile(e.dataTransfer.files[0]);
        });

        // ä¿®æ­£ï¼šè²¼ä¸Šåœ–ç‰‡çš„äº‹ä»¶ç›£è½
        window.addEventListener('paste', e => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let imageFound = false;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    if (file) {
                        e.preventDefault(); // åªæœ‰åœ¨æ‰¾åˆ°ä¸¦è™•ç†åœ–ç‰‡æ™‚æ‰é˜»æ­¢é è¨­è¡Œç‚º
                        handleFile(file);
                        imageFound = true;
                    }
                    break; // åªè™•ç†ç¬¬ä¸€å¼µåœ–ç‰‡
                }
            }
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°åœ–ç‰‡ï¼Œå‰‡ä¸åŸ·è¡Œ e.preventDefault()ï¼Œå…è¨±æ­£å¸¸çš„æ–‡å­—è²¼ä¸Š
        });

        // è™•ç†ä¸Šå‚³çš„æª”æ¡ˆ
        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // é¡¯ç¤ºåœ–ç‰‡é è¦½
                    imagePreview.src = e.target.result;
                    imageBase64 = e.target.result.split(',')[1]; // å–å¾— Base64 è³‡æ–™
                    // æ›´æ–° UI é¡¯ç¤º
                    uploadPrompt.classList.add('hidden');
                    imagePreview.classList.remove('hidden');
                    imageControls.classList.remove('hidden');
                    featuresContainer.classList.remove('hidden');
                    switchToNormalOutput('<p class="font-sans text-base text-gray-400">åœ–ç‰‡å·²è¼‰å…¥ï¼Œè«‹é¸æ“‡ä¸€é … AI åŠŸèƒ½ã€‚</p>', 'çµæœ');
                };
                reader.readAsDataURL(file);
            }
        }

        // --- AI åŠŸèƒ½èˆ‡ UI äº’å‹•é‚è¼¯ ---
        featuresContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.action) {
                const action = e.target.dataset.action;
                if (!imageBase64) {
                    switchToNormalOutput('<p class="font-sans text-base text-red-500">è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼</p>', 'éŒ¯èª¤');
                    return;
                }
                
                // å¦‚æœæ˜¯ AI å°è©±åŠŸèƒ½ï¼Œå‰‡è¨­å®šå°è©±ä»‹é¢
                if (action === 'chat') {
                    setupChatInterface();
                } else {
                    // å¦å‰‡ï¼Œç™¼é€ AI è«‹æ±‚
                    handleAIRequest(action);
                }
            }
        });

        // è™•ç†å° AI æ¨¡å‹çš„è«‹æ±‚
        async function handleAIRequest(action, options = {}) {
            // é©—è­‰ API é‡‘é‘°æ˜¯å¦å­˜åœ¨
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                const errorMessage = 'è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥æ¡†è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°ã€‚';
                if (action === 'chat') {
                    removeChatLoading();
                    appendChatMessage(errorMessage, 'ai');
                } else {
                    switchToNormalOutput(`<p class="font-sans text-base text-red-500">${errorMessage}</p>`, 'éŒ¯èª¤');
                }
                return;
            }

            if (action !== 'chat') {
                showLoading(); // éå°è©±æ¨¡å¼ä¸‹é¡¯ç¤ºå…¨åŸŸè®€å–å‹•ç•«
            }
            let prompt = '';
            let title = '';
            let isJsonOutput = false;

            // å®šç¾©ä¸åŒ AI åŠŸèƒ½å°æ‡‰çš„æç¤ºè©å’Œæ¨™é¡Œ
            const actionMap = {
                ocr: { title: 'æ–‡å­—è¾¨è­˜ (OCR)', prompt: 'Extract all text from this image. Output only the raw text.' },
                translate: { title: 'ç¿»è­¯ (ç¹é«”ä¸­æ–‡)', prompt: 'Extract all text from this image and translate it into Traditional Chinese. Output only the translated text.' },
                summarize: { title: 'æ‘˜è¦åˆ—èˆ‰', prompt: 'Extract the key points from the text in this image and list them out clearly using bullet points (e.g., - Point 1) in Traditional Chinese.' },
                formula: { title: 'å…¬å¼è¾¨è­˜ (LaTeX)', prompt: 'Identify any mathematical formulas in this image and provide their LaTeX representation. Only output the LaTeX code block.' },
                table: { title: 'è¡¨æ ¼è¾¨è­˜ (Markdown)', prompt: 'Find the table in this image and convert it to Markdown format. Output only the Markdown table.' },
                describe: { title: 'å½±åƒæè¿°', prompt: 'Describe this image in detail in one paragraph, in Traditional Chinese.' },
                solve: { title: 'å•é¡Œè§£æ±º', prompt: 'Analyze the mathematical problem in this image. Provide a step-by-step solution in Traditional Chinese. Your entire response must be plain text. The explanation should be clear and easy for a junior high school student to understand. IMPORTANT: The final answer and all mathematical expressions in your explanation MUST use plain text with standard notation. Use "Ã—" for multiplication, "Ã·" for division, and superscript characters like "Â²" and "Â³" for powers (e.g., 4xÂ² - 2x + 5). Do NOT use LaTeX or Markdown code blocks for the math expressions. Mimic the visual style of the math in the image.' },
                code: { title: 'ç¨‹å¼ç¢¼è¾¨è­˜', prompt: 'Identify the programming code in this image. Identify the language and explain what the code does in Traditional Chinese.' },
                color: { title: 'é¡è‰²æå–', isJson: true, prompt: 'Analyze the main colors of this image. Return a JSON object with a single key "colors" which is an array of 6 hex color codes that represent the color palette.' },
                mindmap: { title: 'å¿ƒæ™ºåœ– (Markdown)', prompt: 'Based on the content of this image, generate a concise mind map in Markdown format. Use nested lists with indentation for hierarchy. The central topic should be the main subject of the image. The response must be in Traditional Chinese.' },
                slides: { title: 'ç°¡å ±å¤§ç¶± (Markdown)', prompt: 'Analyze the content of this image and generate a brief slide presentation outline based on it. Provide a title for each slide and 3-5 bullet points per slide. Format the output in Markdown. The response must be in Traditional Chinese.' },
                studyguide: { title: 'ç ”è®€æŒ‡å—', prompt: 'Based on the image, create a study guide. The guide should include key concepts, important definitions, and potential questions for review. Format it clearly using Markdown with headings. The response must be in Traditional Chinese.' },
                faq: { title: 'å¸¸è¦‹å•é¡Œ (Q&A)', prompt: 'From the information in this image, generate a list of 3-5 frequently asked questions (FAQs) and their answers. Format it as Q&A pairs using Markdown (e.g., "**Q1:** ..."). The response must be in Traditional Chinese.' },
            };
            
            if (action === 'chat') {
                title = 'AI å°è©±';
                prompt = `Based on the image, answer the following question in Traditional Chinese: "${options.question}"`;
            } else if (actionMap[action]) {
                title = actionMap[action].title;
                prompt = actionMap[action].prompt;
                isJsonOutput = actionMap[action].isJson || false;
            } else {
                displayResult('æœªçŸ¥çš„åŠŸèƒ½');
                return;
            }

            if (action !== 'chat') {
                outputTitle.textContent = title;
            }

            try {
                // æº–å‚™ API è«‹æ±‚çš„ payload
                const payload = { contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/png", data: imageBase64 } } ] }] };
                if (isJsonOutput) { payload.generationConfig = { responseMimeType: "application/json" }; }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                // ç™¼é€è«‹æ±‚
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                
                if (!response.ok) throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š ${response.status}`);
                const result = await response.json();
                
                // è™•ç† API å›æ‡‰
                if (result.candidates && result.candidates.length > 0) {
                    const part = result.candidates[0].content.parts[0];
                    if (action === 'chat') {
                        removeChatLoading();
                        appendChatMessage(part.text, 'ai');
                    } else if (isJsonOutput) {
                        const jsonData = JSON.parse(part.text);
                        displayColors(jsonData.colors);
                        currentOutputText = JSON.stringify(jsonData.colors, null, 2);
                    } else {
                        displayResult(part.text);
                        currentOutputText = part.text;
                    }
                } else {
                    throw new Error('AI æœªè¿”å›æœ‰æ•ˆçµæœã€‚');
                }
            } catch (error) {
                console.error('AI è«‹æ±‚éŒ¯èª¤:', error);
                const errorMessage = `ç™¼ç”ŸéŒ¯èª¤ï¼š\n${error.message}`;
                if (action === 'chat') {
                    removeChatLoading();
                    appendChatMessage(errorMessage, 'ai');
                } else {
                    displayResult(errorMessage);
                }
                currentOutputText = '';
            }
        }

        // åˆ‡æ›å›æ¨™æº–çš„çµæœé¡¯ç¤ºå€
        function switchToNormalOutput(htmlContent, title) {
            chatInterface.classList.add('hidden');
            outputContent.classList.remove('hidden');
            outputContent.innerHTML = htmlContent;
            outputTitle.textContent = title;
            copyBtn.classList.add('hidden');
        }

        // é¡¯ç¤ºè®€å–ä¸­å‹•ç•«
        function showLoading() {
            switchToNormalOutput('<div class="flex justify-center items-center h-full"><div class="loader"></div></div>', 'è™•ç†ä¸­...');
        }

        // é¡¯ç¤ºæ–‡å­—çµæœ
        function displayResult(text) {
            outputContent.textContent = text;
            copyBtn.classList.remove('hidden');
        }

        // é¡¯ç¤ºé¡è‰²æå–çµæœ
        function displayColors(colors) {
            let html = '<div class="flex flex-wrap gap-4">';
            colors.forEach(color => {
                html += `<div class="flex flex-col items-center"><div class="w-16 h-16 rounded-full border-2 border-gray-200" style="background-color: ${color};"></div><p class="mt-2 text-sm font-mono">${color}</p></div>`;
            });
            html += '</div>';
            outputContent.innerHTML = html;
            copyBtn.classList.remove('hidden');
        }

        // è¤‡è£½æŒ‰éˆ•çš„äº‹ä»¶ç›£è½
        copyBtn.addEventListener('click', () => {
            if (!currentOutputText) return;

            const textArea = document.createElement('textarea');
            textArea.value = currentOutputText;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                copyBtn.textContent = successful ? 'å·²è¤‡è£½ï¼' : 'è¤‡è£½å¤±æ•—!';
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—:', err);
                copyBtn.textContent = 'è¤‡è£½å¤±æ•—!';
            }

            document.body.removeChild(textArea);
            
            setTimeout(() => { copyBtn.textContent = 'è¤‡è£½'; }, 2000);
        });

        // --- AI å°è©±ä»‹é¢ç›¸é—œå‡½å¼ ---
        function setupChatInterface() {
            outputContent.classList.add('hidden');
            copyBtn.classList.add('hidden');
            chatInterface.classList.remove('hidden');
            outputTitle.textContent = 'AI å°è©±';
            if (chatMessages.children.length === 0) {
                appendChatMessage('ä½ å¥½ï¼è«‹å•é€™å¼µåœ–ç‰‡æœ‰ä»€éº¼æˆ‘å¯ä»¥å”åŠ©ä½ çš„åœ°æ–¹å—ï¼Ÿ', 'ai');
            }
        }

        function sendChatMessage() {
            const question = chatInput.value.trim();
            if (!question || !imageBase64) return;
            appendChatMessage(question, 'user');
            chatInput.value = '';
            showChatLoading();
            handleAIRequest('chat', { question });
        }

        chatSendBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });

        function appendChatMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${sender}`;
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showChatLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'chat-loading';
            loadingDiv.className = 'chat-bubble ai typing-indicator';
            loadingDiv.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function removeChatLoading() {
            const loadingDiv = document.getElementById('chat-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // --- åœ–ç‰‡ç·¨è¼¯å½ˆå‡ºè¦–çª—èˆ‡ Canvas é‚è¼¯ ---
        let currentTool = 'brush', isDrawing = false, startX, startY, lastX, lastY, savedImageData;
        let activeTextInput = null; // è¿½è¹¤ç•¶å‰æ´»å‹•çš„æ–‡å­—è¼¸å…¥æ¡†
        
        editBtn.addEventListener('click', () => {
            if (!imagePreview.src || imagePreview.src.endsWith('#')) return;
            editModal.style.display = 'flex';
            const img = new Image();
            img.onload = () => {
                // æ ¹æ“šå®¹å™¨å¤§å°å’Œåœ–ç‰‡æ¯”ä¾‹ï¼Œèª¿æ•´ canvas å°ºå¯¸ä»¥é¿å…è®Šå½¢
                const container = canvas.parentElement;
                const containerRatio = container.clientWidth / container.clientHeight;
                const imgRatio = img.width / img.height;
                if (containerRatio > imgRatio) {
                    canvas.height = container.clientHeight;
                    canvas.width = imgRatio * canvas.height;
                } else {
                    canvas.width = container.clientWidth;
                    canvas.height = canvas.width / imgRatio;
                }
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                savedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            };
            img.src = imagePreview.src;
        });

        closeModalBtn.addEventListener('click', () => { 
            commitActiveText(); // åœ¨é—œé–‰ modal å‰ï¼Œå…ˆæäº¤å¯èƒ½æ­£åœ¨ç·¨è¼¯çš„æ–‡å­—
            editModal.style.display = 'none'; 
        });

        toolbar.addEventListener('click', e => {
            const button = e.target.closest('.tool-btn');
            if (button) {
                commitActiveText(); // åˆ‡æ›å·¥å…·å‰ï¼Œå…ˆæäº¤å¯èƒ½æ­£åœ¨ç·¨è¼¯çš„æ–‡å­—
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('bg-purple-600'));
                button.classList.add('bg-purple-600');
                currentTool = button.dataset.tool;
            }
        });

        // --- æ–‡å­—è¼¸å…¥åŠŸèƒ½æ›´æ–° ---
        // å°‡æ­£åœ¨è¼¸å…¥çš„æ–‡å­—æäº¤ä¸¦ç¹ªè£½åˆ°ç•«å¸ƒä¸Š
        function commitActiveText() {
            if (!activeTextInput) return;
            const input = activeTextInput;
            const text = input.value;
            const x = parseFloat(input.dataset.x);
            const y = parseFloat(input.dataset.y);

            if (text) {
                ctx.fillStyle = colorPicker.value;
                ctx.font = '20px sans-serif';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText(text, x, y);
                savedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            input.remove();
            activeTextInput = null;
        }

        // åœ¨ç•«å¸ƒä¸ŠæŒ‡å®šä½ç½®å‰µå»ºæ–‡å­—è¼¸å…¥æ¡†
        function createTextInput(x, y) {
            commitActiveText(); // å…ˆæäº¤ä¸Šä¸€å€‹å¯èƒ½æœªå®Œæˆçš„è¼¸å…¥

            const input = document.createElement('input');
            input.type = 'text';
            input.style.position = 'absolute';
            const canvasRect = canvas.getBoundingClientRect();
            input.style.left = `${canvasRect.left + x}px`;
            input.style.top = `${canvasRect.top + y}px`;
            input.style.border = '1px solid #8b5cf6';
            input.style.padding = '4px';
            input.style.font = '20px sans-serif';
            input.style.zIndex = '100';
            input.style.backgroundColor = '#fff';
            input.dataset.x = x; // å°‡åº§æ¨™å„²å­˜åœ¨ dataset ä¸­
            input.dataset.y = y;

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    commitActiveText();
                    e.preventDefault();
                } else if (e.key === 'Escape') {
                    activeTextInput.remove();
                    activeTextInput = null;
                }
            });

            editModal.addEventListener('mousedown', (e) => {
                if (activeTextInput && e.target !== activeTextInput) {
                    commitActiveText();
                }
            }, { once: true }); 

            document.body.appendChild(input);
            activeTextInput = input;
            input.focus();
        }

        canvas.addEventListener('mousedown', (e) => {
            if (currentTool === 'text') {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                createTextInput(x, y);
                return; 
            }
            
            if (activeTextInput) return;

            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            lastX = startX;
            lastY = startY;
            savedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            ctx.putImageData(savedImageData, 0, 0); 
            ctx.strokeStyle = colorPicker.value;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            switch (currentTool) {
                case 'brush':
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(currentX, currentY);
                    ctx.stroke();
                    lastX = currentX;
                    lastY = currentY;
                    savedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height); 
                    break;
                case 'rect':
                    ctx.beginPath();
                    ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
                    break;
                case 'arrow':
                    drawArrow(startX, startY, currentX, currentY);
                    break;
            }
        });

        canvas.addEventListener('mouseup', () => { isDrawing = false; });
        canvas.addEventListener('mouseleave', () => { isDrawing = false; });

        function drawArrow(fromx, fromy, tox, toy) {
            const headlen = 15;
            const dx = tox - fromx;
            const dy = toy - fromy;
            const angle = Math.atan2(dy, dx);
            ctx.beginPath();
            ctx.moveTo(fromx, fromy);
            ctx.lineTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
        }

        downloadBtn.addEventListener('click', () => {
            commitActiveText(); 
            const link = document.createElement('a');
            link.download = 'edited-image.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    </script>
</body>
</html>
